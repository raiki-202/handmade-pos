<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ハンドメイドPOS ログインテスト</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg1: #e3ddd4;
      --bg2: #d4ccc1;
      --glass-bg: rgba(255, 255, 255, 0.85);
      --glass-border: rgba(0, 0, 0, 0.06);
      --glass-shadow: 0 18px 45px rgba(0, 0, 0, 0.14);
      --accent: #e18a6a;
      --accent2: #d06463;
      --text-main: #222222;
      --text-sub: #555555;
      --line-soft: rgba(0, 0, 0, 0.1);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .app-shell {
      width: 100%;
      max-width: 960px;
      margin: 0 auto;
    }

    .card {
      background: var(--glass-bg);
      border-radius: 20px;
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding: 18px 20px 20px;
    }

    /* ヘッダー＆ナビ */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    h1 {
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-main {
      font-family: "Georgia", "Times New Roman", serif;
      font-size: 20px;
      font-weight: 600;
      letter-spacing: 0.08em;
    }

    .brand-sub {
      font-size: 11px;
      color: var(--text-sub);
    }

    .nav-buttons {
      display: none; /* ログイン前は非表示 */
      gap: 8px;
    }

    .nav-btn {
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      background: rgba(255, 255, 255, 0.9);
      color: var(--text-main);
      padding: 6px 12px;
      font-size: 11px;
      cursor: pointer;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.2s ease, border-color 0.2s ease, transform 0.1s ease;
    }

    .nav-btn:hover {
      background: #f4ede3;
      transform: translateY(-1px);
    }

    .nav-btn.active {
      background: #f1e0d4;
      border-color: var(--accent);
      color: var(--text-main);
    }

    /* フォーム/ボタン */
    label {
      display: block;
      margin-top: 10px;
      font-size: 13px;
      color: var(--text-main);
    }

    input {
      margin-top: 4px;
      padding: 8px 10px;
      width: 100%;
      max-width: 320px;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      background: #f7f3ee;
      color: var(--text-main);
      font-size: 13px;
      outline: none;
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(225, 138, 106, 0.5);
      background: #fff;
    }

    button {
      margin-top: 12px;
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff;
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.16);
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.15s ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.2);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.16);
      opacity: 0.95;
    }

    #msg {
      margin-top: 8px;
      color: #b91c1c;
      font-size: 12px;
    }

    #auth {
      margin-bottom: 12px;
    }

    #app {
      display: none;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed var(--line-soft);
    }

    #user,
    #logout {
      display: none !important;
    }

    #homeView,
    #historyView {
      margin-top: 10px;
    }

    /* ===== HOME・商品エリア ===== */

    #productsArea {
      margin-top: 10px;
      padding-top: 6px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .products-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
      width: 100%;
      flex-wrap: wrap;
    }

    .products-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .products-header h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-main);
    }

    .sell-meta {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: var(--text-sub);
      flex-wrap: wrap;
    }

    .sell-meta label {
      margin: 0;
      font-size: 11px;
    }

    .sell-select {
      margin: 0;
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      background: #f7f3ee;
      font-size: 11px;
      outline: none;
      max-width: 140px;
    }

    .sell-edit-btn {
      margin-top: 0;
      padding: 2px 8px;
      font-size: 10px;
      box-shadow: none;
      background: #ffffff;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      color: var(--text-sub);
    }

    .icon-btn {
      margin-top: 0;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      background: rgba(255, 255, 255, 0.9);
      color: var(--text-main);
      font-size: 12px;
      box-shadow: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .icon-btn.active {
      background: #f1e0d4;
      border-color: var(--accent);
    }

    .icon-btn.edit-close {
      width: 28px;
      height: 28px;
      padding: 0;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0;
      font-size: 16px;
    }

    #productsList {
      width: 100%;
    }

    .product-row {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 10px;
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(0, 0, 0, 0.06);
      margin-bottom: 6px;
      max-width: 420px;
      width: 100%;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .product-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--text-main);
      flex: 1;
    }

    .product-label input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--accent2);
      cursor: pointer;
    }

    .product-name {
      white-space: nowrap;
    }

    .product-qty {
      margin-left: 8px;
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      background: #f7f3ee;
      color: var(--text-main);
      font-size: 12px;
      cursor: pointer;
      min-width: 52px;
    }

    .product-qty:disabled {
      opacity: 0.35;
      cursor: default;
    }

    #total {
      margin-top: 10px;
      font-size: 14px;
      font-weight: 500;
      text-align: right;
      color: var(--text-main);
      align-self: stretch;
    }

    .edit-small-btn {
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      background: #f7f3ee;
      color: var(--text-main);
      font-size: 11px;
      cursor: pointer;
      box-shadow: none;
      margin-top: 0;
    }

    .edit-small-btn.danger {
      color: #b91c1c;
      border-color: #fca5a5;
      background: #fef2f2;
    }

    .add-form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      max-width: 420px;
    }

    .add-form-row input {
      max-width: 180px;
      font-size: 12px;
      padding: 6px 8px;
    }

    .add-form-row button {
      margin-top: 0;
      padding: 6px 12px;
      font-size: 12px;
    }

    .add-hint {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 4px;
    }

    .drag-handle {
      width: 18px;
      margin-right: 6px;
      text-align: center;
      cursor: grab;
      user-select: none;
      font-size: 14px;
      color: var(--text-sub);
    }

    .product-row.dragging {
      opacity: 0.6;
      transform: scale(1.01);
      box-shadow: 0 12px 26px rgba(0, 0, 0, 0.18);
    }

    .product-row.edit-mode {
      cursor: grab;
    }

    /* レシートモーダル */
    #receiptModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.3);
      justify-content: center;
      align-items: center;
      z-index: 50;
    }

    #receiptInner {
      background: #f7f3ee;
      border-radius: 18px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      padding: 16px 18px 14px;
      max-width: 400px;
      width: 90%;
      box-sizing: border-box;
      box-shadow: var(--glass-shadow);
    }

    #receiptInner h3 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 15px;
    }

    #receiptMeta {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 6px;
    }

    /* ★ 決済方法 選択エリア */
    #receiptPaymentRow {
      margin-bottom: 6px;
      font-size: 12px;
    }

    #receiptPaymentRow label {
      margin-top: 0;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #receiptPaymentSelect {
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      background: #ffffff;
      font-size: 12px;
      outline: none;
    }

    #receiptList {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid rgba(0, 0, 0, 0.08);
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 10px;
      background: #ffffff;
      font-size: 13px;
    }

    #receiptTotal {
      font-size: 14px;
      font-weight: 600;
      text-align: right;
      margin-bottom: 8px;
    }

    #confirmSale,
    #cancelSale {
      margin-top: 0;
      font-size: 13px;
    }

    #cancelSale {
      margin-left: 8px;
      background: #ffffff;
      color: var(--text-main);
      border: 1px solid rgba(0, 0, 0, 0.12);
      box-shadow: none;
    }

    /* ===== 購入履歴ビュー ===== */

    #historyView {
      padding-top: 6px;
    }

    #historyHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
      width: 100%;
      flex-wrap: wrap;
    }

    #historyHeader h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-main);
    }

    #historyInfo {
      margin: 4px 0 6px;
      font-size: 11px;
      color: var(--text-sub);
    }

    #historyBulkTools {
      display: none;
      margin-bottom: 8px;
      font-size: 11px;
      color: var(--text-sub);
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(0,0,0,0.05);
      max-width: 480px;
    }

    #historyBulkTools select {
      margin: 0 4px;
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.12);
      background: #f7f3ee;
      font-size: 11px;
    }

    #historyBulkTools button {
      margin-top: 0;
      padding: 4px 10px;
      font-size: 11px;
    }

    #historyList {
      margin-top: 6px;
      width: 100%;
      max-width: 480px;
    }

    .history-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid rgba(0, 0, 0, 0.06);
      margin-bottom: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.15s ease, transform 0.1s ease;
    }

    .history-row:hover {
      background: #f5efe7;
      transform: translateY(-1px);
    }

    .history-row-select {
      cursor: default;
    }

    .history-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .history-date {
      font-weight: 500;
    }

    .history-meta {
      font-size: 11px;
      color: var(--text-sub);
    }

    .history-total {
      white-space: nowrap;
      font-weight: 600;
    }

    .history-tags {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      font-size: 10px;
    }

    .history-tag {
      padding: 2px 6px;
      border-radius: 999px;
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .history-tag.mistake {
      background: #eff6ff;
      color: #1d4ed8;
      border-color: #bfdbfe;
    }

    /* 購入履歴 詳細モーダル */
    #historyModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      justify-content: center;
      align-items: center;
      z-index: 60;
    }

    #historyInner {
      background: #f7f3ee;
      border-radius: 18px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      padding: 14px 16px 14px;
      max-width: 460px;
      width: 92%;
      box-sizing: border-box;
      box-shadow: var(--glass-shadow);
      font-size: 13px;
    }

    .history-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .history-header h3 {
      margin: 0;
      font-size: 14px;
    }

    .history-header-buttons {
      display: flex;
      gap: 4px;
    }

    #historyMeta {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 4px;
    }

    #historySellMeta {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 6px;
    }

    #historySellMeta select {
      margin-left: 4px;
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.12);
      background: #ffffff;
      font-size: 11px;
    }

    #historyItems {
      max-height: 220px;
      overflow-y: auto;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.06);
      background: #ffffff;
      padding: 6px 8px;
      margin-bottom: 6px;
    }

    .history-item-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 4px 2px;
      border-bottom: 1px dashed rgba(0, 0, 0, 0.05);
    }

    .history-item-row:last-child {
      border-bottom: none;
    }

    .history-item-name {
      flex: 1;
    }

    .history-item-qty {
      min-width: 48px;
      text-align: right;
    }

    .history-item-qty button {
      margin-top: 0;
      padding: 2px 8px;
      font-size: 11px;
      box-shadow: none;
    }

    .history-item-subtotal {
      min-width: 80px;
      text-align: right;
    }

    #historyTotal {
      margin: 4px 0 4px;
      text-align: right;
      font-weight: 600;
    }

    #historyAdjustments {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 6px;
    }

    .history-adjust-row {
      margin-bottom: 2px;
    }

    #historyActions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
    }

    /* 数量変更ポップアップ */
    #qtyModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      justify-content: center;
      align-items: center;
      z-index: 70;
    }

    #qtyInner {
      background: #f7f3ee;
      border-radius: 14px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      padding: 12px 14px 10px;
      max-width: 320px;
      width: 90%;
      box-shadow: var(--glass-shadow);
      font-size: 13px;
    }

    #qtyTitle {
      margin: 0 0 4px;
      font-size: 13px;
      font-weight: 600;
    }

    #qtyLabel {
      margin: 4px 0;
      font-size: 12px;
      color: var(--text-sub);
    }

    #qtySelect {
      width: 100%;
      margin: 4px 0 8px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.15);
      background: #fff;
      font-size: 13px;
    }

    .qty-buttons {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-top: 2px;
    }

    #qtyClaim,
    #qtyMistake {
      flex: 1;
      margin-top: 0;
      font-size: 12px;
      padding: 6px 8px;
    }

    #qtyCancel {
      margin-top: 6px;
      width: 100%;
      background: #ffffff;
      color: var(--text-main);
      box-shadow: none;
      border: 1px solid rgba(0, 0, 0, 0.15);
      font-size: 12px;
      padding: 6px 8px;
    }

    /* 販売方法・開催場所 設定用モーダル */
    #listEditModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      justify-content: center;
      align-items: center;
      z-index: 80;
    }

    #listEditInner {
      background: #f7f3ee;
      border-radius: 14px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      padding: 12px 14px 10px;
      max-width: 360px;
      width: 90%;
      box-shadow: var(--glass-shadow);
      font-size: 13px;
    }

    #listEditInner h3 {
      margin: 0 0 6px;
      font-size: 14px;
    }

    #listEditList {
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 6px;
    }

    .list-edit-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      padding: 4px 0;
      border-bottom: 1px dashed rgba(0,0,0,0.06);
      font-size: 12px;
    }

    .list-edit-row:last-child {
      border-bottom: none;
    }

    .list-edit-name {
      flex: 1;
    }

    .list-edit-row button {
      margin-top: 0;
      padding: 2px 6px;
      font-size: 11px;
      box-shadow: none;
    }

    #listEditAddRow {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 4px;
    }

    #listEditAddInput {
      flex: 1;
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.15);
      font-size: 12px;
      background: #ffffff;
    }

    #listEditAddBtn {
      margin-top: 0;
      padding: 4px 8px;
      font-size: 11px;
    }

    #listEditClose {
      margin-top: 8px;
      width: 100%;
      background: #ffffff;
      color: var(--text-main);
      border: 1px solid rgba(0,0,0,0.15);
      box-shadow: none;
      font-size: 12px;
      padding: 6px 8px;
    }

    /* スマホ向け */
    @media (max-width: 600px) {
      body { padding: 10px; }
      .card { padding: 14px 12px 16px; }
      .brand-main { font-size: 18px; }
      .brand-sub { font-size: 10px; }
      .nav-btn { padding: 4px 8px; font-size: 10px; }
      .product-row { padding: 4px 6px; max-width: 100%; }
      .product-label { font-size: 12px; }
      .history-row { font-size: 12px; }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="card">
      <!-- ヘッダー -->
      <div class="top-bar">
        <h1>
          <span class="brand-main">e.nue</span>
          <span class="brand-sub">＼ 毎日に、ひとさじのときめきを ／</span>
        </h1>
        <div class="nav-buttons" id="navArea">
          <button class="nav-btn active" data-view="home" id="navHome">HOME</button>
          <button class="nav-btn" data-view="history" id="navHistory">購入履歴</button>
          <button class="nav-btn" data-view="calendar" id="navCalendar">カレンダー</button>
          <button class="nav-btn" data-view="analysis" id="navAnalysis">分析</button>
        </div>
      </div>

      <!-- ログイン -->
      <div id="auth">
        <label>
          メールアドレス
          <input id="email" type="email">
        </label>
        <label>
          パスワード
          <input id="password" type="password">
        </label>
        <button id="login">ログイン</button>
        <p id="msg"></p>
      </div>

      <!-- ログイン後 -->
      <div id="app">
        <p id="user"></p>
        <button id="logout">ログアウト</button>
        <hr style="border:none;border-top:1px dashed rgba(0,0,0,0.1);margin:10px 0 8px;">

        <!-- HOMEビュー -->
        <div id="homeView"></div>

        <!-- 購入履歴ビュー -->
        <div id="historyView" style="display:none;">
          <div id="historyHeader">
            <h3>購入履歴</h3>
            <button id="historyBulkToggle" class="icon-btn" type="button">一括編集</button>
          </div>
          <p id="historyInfo">タップすると詳細が開きます。一括編集モードでは複数の履歴の販売方法をまとめて変更できます。</p>
          <div id="historyBulkTools">
            <span>選択した履歴に適用：</span>
            <label>販売方法
              <select id="bulkChannelSelect"></select>
            </label>
            <label>開催場所
              <select id="bulkVenueSelect"></select>
            </label>
            <button id="bulkApplyBtn" type="button">一括適用</button>
          </div>
          <div id="historyList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- レシートモーダル -->
  <div id="receiptModal">
    <div id="receiptInner">
      <h3>レシート確認</h3>
      <div id="receiptMeta"></div>

      <!-- ★ 決済方法選択 -->
      <div id="receiptPaymentRow">
        <label>
          決済方法
          <select id="receiptPaymentSelect">
            <option value="現金">現金</option>
            <option value="PayPay">PayPay</option>
            <option value="クレカ">クレカ</option>
            <option value="その他">その他</option>
          </select>
        </label>
      </div>

      <div id="receiptList"></div>
      <p id="receiptTotal"></p>
      <button id="confirmSale">確定</button>
      <button id="cancelSale">キャンセル</button>
    </div>
  </div>

  <!-- 購入履歴 詳細モーダル -->
  <div id="historyModal">
    <div id="historyInner">
      <div class="history-header">
        <h3 id="historyTitle">購入詳細</h3>
        <div class="history-header-buttons">
          <button id="historyEditToggle" class="icon-btn" title="編集モード">✎</button>
          <button id="historyClose" class="icon-btn edit-close" title="閉じる">×</button>
        </div>
      </div>
      <div id="historyMeta"></div>
      <div id="historySellMeta"></div>
      <div id="historyItems"></div>
      <p id="historyTotal"></p>
      <div id="historyAdjustments"></div>
      <div id="historyActions">
        <button id="historyRefundAll" class="edit-small-btn danger" type="button">すべて返金</button>
        <button id="historySave" class="edit-small-btn" type="button">保存</button>
      </div>
    </div>
  </div>

  <!-- 数量変更ポップアップ -->
  <div id="qtyModal">
    <div id="qtyInner">
      <p id="qtyTitle"></p>
      <p id="qtyLabel"></p>
      <select id="qtySelect"></select>
      <div class="qty-buttons">
        <button id="qtyClaim" type="button">クレーム処理</button>
        <button id="qtyMistake" type="button">打ち間違い</button>
      </div>
      <button id="qtyCancel" type="button">キャンセル</button>
    </div>
  </div>

  <!-- 販売方法・開催場所 設定モーダル -->
  <div id="listEditModal">
    <div id="listEditInner">
      <h3 id="listEditTitle"></h3>
      <div id="listEditList"></div>
      <div id="listEditAddRow">
        <input id="listEditAddInput" placeholder="名前を入力" />
        <button id="listEditAddBtn" type="button">追加</button>
      </div>
      <button id="listEditClose" type="button">閉じる</button>
    </div>
  </div>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyAhPCgPoJK6S6BWVcBZOruYqMPXVQXQFRk",
      authDomain: "handmade-pos.firebaseapp.com",
      projectId: "handmade-pos",
      storageBucket: "handmade-pos.firebasestorage.app",
      messagingSenderId: "174873514252",
      appId: "1:174873514252:web:c26659bffca850d475f929",
      measurementId: "G-3F8BYRBXDC"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut,
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      getDocs,
      addDoc,
      serverTimestamp,
      doc,
      updateDoc,
      deleteDoc,
      query,
      orderBy,
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $email = document.getElementById("email");
    const $password = document.getElementById("password");
    const $login = document.getElementById("login");
    const $logout = document.getElementById("logout");
    const $msg = document.getElementById("msg");
    const $authArea = document.getElementById("auth");
    const $appArea = document.getElementById("app");
    const $navArea = document.getElementById("navArea");
    const $homeView = document.getElementById("homeView");
    const $historyView = document.getElementById("historyView");
    const $historyList = document.getElementById("historyList");
    const $historyBulkToggle = document.getElementById("historyBulkToggle");
    const $historyBulkTools = document.getElementById("historyBulkTools");
    const $bulkChannelSelect = document.getElementById("bulkChannelSelect");
    const $bulkVenueSelect = document.getElementById("bulkVenueSelect");
    const $bulkApplyBtn = document.getElementById("bulkApplyBtn");

    const navButtons = document.querySelectorAll(".nav-btn");

    /* ===== 販売方法＆開催場所 設定 ===== */

    let channels = [];
    let venues = [];
    let currentChannel = "";
    let currentVenue = "";
    let listEditType = null; // "channel" | "venue"

    const defaultChannels = ["マルシェ", "インスタグラム"];
    const defaultVenues = ["cafe1400"];

    function loadSettingsFromStorage() {
      try {
        const ch = localStorage.getItem("pos_channels");
        const ve = localStorage.getItem("pos_venues");
        channels = ch ? JSON.parse(ch) : [...defaultChannels];
        venues = ve ? JSON.parse(ve) : [...defaultVenues];
      } catch {
        channels = [...defaultChannels];
        venues = [...defaultVenues];
      }
      if (!Array.isArray(channels) || channels.length === 0) {
        channels = [...defaultChannels];
      }
      if (!Array.isArray(venues) || venues.length === 0) {
        venues = [...defaultVenues];
      }

      const savedCh = localStorage.getItem("pos_currentChannel");
      const savedVe = localStorage.getItem("pos_currentVenue");

      currentChannel = (savedCh && channels.includes(savedCh)) ? savedCh : channels[0] || "";
      currentVenue = (savedVe && venues.includes(savedVe)) ? savedVe : venues[0] || "";

      saveSettingsToStorage();
    }

    function saveSettingsToStorage() {
      localStorage.setItem("pos_channels", JSON.stringify(channels));
      localStorage.setItem("pos_venues", JSON.stringify(venues));
      localStorage.setItem("pos_currentChannel", currentChannel || "");
      localStorage.setItem("pos_currentVenue", currentVenue || "");
    }

    loadSettingsFromStorage();

    /* ===== ナビ＆ビュー切替 ===== */

    let currentView = "home";
    function setView(view) {
      currentView = view;
      navButtons.forEach(b => b.classList.toggle("active", b.dataset.view === view));
      if ($homeView) $homeView.style.display = (view === "home") ? "block" : "none";
      if ($historyView) $historyView.style.display = (view === "history") ? "block" : "none";
    }

    navButtons.forEach(btn => {
      btn.addEventListener("click", async () => {
        const view = btn.dataset.view;
        if (view === "home") {
          setView("home");
        } else if (view === "history") {
          setView("history");
          await loadSalesHistory();
        } else if (view === "calendar") {
          alert("カレンダー画面はこれから実装します！");
        } else if (view === "analysis") {
          alert("分析画面はこれから実装します！");
        }
      });
    });

    /* ===== レシートモーダル ===== */

    const $receiptModal = document.getElementById("receiptModal");
    const $receiptList = document.getElementById("receiptList");
    const $receiptTotal = document.getElementById("receiptTotal");
    const $receiptMeta = document.getElementById("receiptMeta");
    const $confirmSale = document.getElementById("confirmSale");
    const $cancelSale = document.getElementById("cancelSale");
    const $receiptPaymentSelect = document.getElementById("receiptPaymentSelect");

    /* 決済方法候補 */
    const paymentMethods = ["現金", "PayPay", "クレカ", "その他"];

    /* ===== 購入履歴 詳細モーダル ===== */

    const $historyModal = document.getElementById("historyModal");
    const $historyTitle = document.getElementById("historyTitle");
    const $historyMeta = document.getElementById("historyMeta");
    const $historySellMeta = document.getElementById("historySellMeta");
    const $historyItems = document.getElementById("historyItems");
    const $historyTotal = document.getElementById("historyTotal");
    const $historyAdjustments = document.getElementById("historyAdjustments");
    const $historyEditToggle = document.getElementById("historyEditToggle");
    const $historyClose = document.getElementById("historyClose");
    const $historyRefundAll = document.getElementById("historyRefundAll");
    const $historySave = document.getElementById("historySave");

    /* ===== 数量変更モーダル ===== */

    const $qtyModal = document.getElementById("qtyModal");
    const $qtyInnerTitle = document.getElementById("qtyTitle");
    const $qtyLabel = document.getElementById("qtyLabel");
    const $qtySelect = document.getElementById("qtySelect");
    const $qtyClaim = document.getElementById("qtyClaim");
    const $qtyMistake = document.getElementById("qtyMistake");
    const $qtyCancel = document.getElementById("qtyCancel");

    /* ===== 販売方法・開催場所 設定モーダル ===== */

    const $listEditModal = document.getElementById("listEditModal");
    const $listEditTitle = document.getElementById("listEditTitle");
    const $listEditList = document.getElementById("listEditList");
    const $listEditAddInput = document.getElementById("listEditAddInput");
    const $listEditAddBtn = document.getElementById("listEditAddBtn");
    const $listEditClose = document.getElementById("listEditClose");

    /* ===== HOMEビュー用 商品 ===== */

    let productListDiv;
    let products = [];      // {id, name, price, sortOrder?}
    let isEditMode = false; // 商品リスト編集モード
    let dragIndex = null;

    /* ===== 購入履歴用 ===== */

    let sales = [];
    let currentSale = null;
    let isHistoryEditing = false;
    let qtyEditMode = "item"; // "item" | "all"
    let qtyEditIndex = null;
    let isHistoryBulkEditing = false;

    /* ===== ログイン状態 ===== */

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        $authArea.style.display = "none";
        $appArea.style.display = "block";
        if ($navArea) $navArea.style.display = "flex";
        $msg.textContent = "";

        if (!productListDiv) {
          productListDiv = document.createElement("div");
          productListDiv.id = "productsArea";
          $homeView.appendChild(productListDiv);
        }
        await loadProducts();
        await loadSalesHistory();
        setView("home");
      } else {
        $authArea.style.display = "block";
        $appArea.style.display = "none";
        if ($navArea) $navArea.style.display = "none";
      }
    });

    $login.addEventListener("click", async () => {
      $msg.textContent = "";
      try {
        await signInWithEmailAndPassword(auth, $email.value, $password.value);
      } catch (e) {
        $msg.textContent = "ログイン失敗：" + e.message;
      }
    });

    $logout.addEventListener("click", async () => {
      await signOut(auth);
    });

    /* ===== Firestore: 商品一覧 ===== */

    async function loadProducts() {
      const snap = await getDocs(collection(db, "products"));
      const arr = [];
      snap.forEach((docSnap) => {
        const data = docSnap.data();
        arr.push({
          id: docSnap.id,
          name: data.name,
          price: data.price,
          sortOrder: typeof data.sortOrder === "number" ? data.sortOrder : null,
        });
      });

      arr.sort((a, b) => {
        const ao = a.sortOrder ?? 999999;
        const bo = b.sortOrder ?? 999999;
        if (ao !== bo) return ao - bo;
        return String(a.name).localeCompare(String(b.name), "ja");
      });

      products = arr;
      renderProductsUI();
    }

    function renderProductsUI() {
      if (!productListDiv) return;
      productListDiv.innerHTML = "";

      const header = document.createElement("div");
      header.className = "products-header";

      const left = document.createElement("div");
      left.className = "products-header-left";
      const h3 = document.createElement("h3");
      h3.textContent = "商品一覧";
      left.appendChild(h3);

      // 販売方法・開催場所ラベル
      const meta = document.createElement("div");
      meta.className = "sell-meta";

      const chLabel = document.createElement("label");
      chLabel.textContent = "販売方法";
      const chSelect = document.createElement("select");
      chSelect.className = "sell-select";
      channels.forEach(ch => {
        const opt = document.createElement("option");
        opt.value = ch;
        opt.textContent = ch;
        if (ch === currentChannel) opt.selected = true;
        chSelect.appendChild(opt);
      });
      chSelect.addEventListener("change", () => {
        currentChannel = chSelect.value;
        if (!channels.includes(currentChannel)) channels.push(currentChannel);
        if (!venues.includes(currentVenue) && venues.length) currentVenue = venues[0];
        saveSettingsToStorage();
        renderProductsUI(); // 開催場所表示のON/OFF更新のため
      });
      chLabel.appendChild(chSelect);
      meta.appendChild(chLabel);

      const venueWrapper = document.createElement("span");
      venueWrapper.style.display = (currentChannel === "マルシェ") ? "inline-flex" : "none";
      venueWrapper.style.alignItems = "center";
      venueWrapper.style.gap = "4px";

      const vLabel = document.createElement("label");
      vLabel.textContent = "開催場所";
      const vSelect = document.createElement("select");
      vSelect.className = "sell-select";
      venues.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        if (v === currentVenue) opt.selected = true;
        vSelect.appendChild(opt);
      });
      vSelect.addEventListener("change", () => {
        currentVenue = vSelect.value;
        saveSettingsToStorage();
      });
      vLabel.appendChild(vSelect);
      venueWrapper.appendChild(vLabel);
      meta.appendChild(venueWrapper);

      // 編集モード中だけ 設定ボタン
      if (isEditMode) {
        const chEditBtn = document.createElement("button");
        chEditBtn.className = "sell-edit-btn";
        chEditBtn.textContent = "販売方法設定";
        chEditBtn.type = "button";
        chEditBtn.addEventListener("click", () => {
          openListEditModal("channel");
        });
        meta.appendChild(chEditBtn);

        const vEditBtn = document.createElement("button");
        vEditBtn.className = "sell-edit-btn";
        vEditBtn.textContent = "開催場所設定";
        vEditBtn.type = "button";
        vEditBtn.addEventListener("click", () => {
          openListEditModal("venue");
        });
        meta.appendChild(vEditBtn);
      }

      left.appendChild(meta);
      header.appendChild(left);

      const editBtn = document.createElement("button");
      editBtn.id = "editProductsBtn";
      editBtn.className = "icon-btn";
      if (isEditMode) {
        editBtn.classList.add("active", "edit-close");
        editBtn.title = "編集を終了";
        editBtn.textContent = "×";
      } else {
        editBtn.title = "商品を編集（並び替え／追加／削除）";
        editBtn.textContent = "✎";
      }
      editBtn.addEventListener("click", () => {
        isEditMode = !isEditMode;
        renderProductsUI();
      });
      header.appendChild(editBtn);

      productListDiv.appendChild(header);

      const listDiv = document.createElement("div");
      listDiv.id = "productsList";
      productListDiv.appendChild(listDiv);

      if (!isEditMode) {
        // ── 通常モード ──
        products.forEach((p) => {
          const row = document.createElement("div");
          row.className = "product-row";

          const label = document.createElement("label");
          label.className = "product-label";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.className = "product-check";
          checkbox.dataset.price = p.price;
          checkbox.dataset.name = p.name;

          const nameSpan = document.createElement("span");
          nameSpan.className = "product-name";
          nameSpan.textContent = `${p.name}（￥${p.price}）`;

          label.appendChild(checkbox);
          label.appendChild(nameSpan);
          row.appendChild(label);

          const qtySelect = document.createElement("select");
          qtySelect.className = "product-qty";
          for (let i = 1; i <= 10; i++) {
            const opt = document.createElement("option");
            opt.value = String(i);
            opt.textContent = i;
            if (i === 1) opt.selected = true;
            qtySelect.appendChild(opt);
          }
          qtySelect.disabled = true;
          row.appendChild(qtySelect);
          row.appendChild(document.createTextNode(" 個"));

          checkbox.addEventListener("change", () => {
            const checked = checkbox.checked;
            qtySelect.disabled = !checked;
            if (!checked) qtySelect.value = "1";
            updateTotal();
          });

          qtySelect.addEventListener("change", updateTotal);
          listDiv.appendChild(row);
        });

        const checkoutBtn = document.createElement("button");
        checkoutBtn.textContent = "決済へ進む";
        checkoutBtn.type = "button";
        checkoutBtn.addEventListener("click", openReceipt);
        productListDiv.appendChild(checkoutBtn);

        const result = document.createElement("p");
        result.id = "total";
        result.textContent = "合計：￥0";
        productListDiv.appendChild(result);

        updateTotal();
      } else {
        // ── 編集モード ──
        products.forEach((p, index) => {
          const row = document.createElement("div");
          row.className = "product-row edit-mode";
          row.draggable = true;
          row.dataset.index = String(index);
          row.dataset.id = p.id;

          const handle = document.createElement("span");
          handle.className = "drag-handle";
          handle.title = "ドラッグして並び替え";
          handle.textContent = "⋮⋮";
          row.appendChild(handle);

          const nameSpan = document.createElement("span");
          nameSpan.className = "product-name";
          nameSpan.textContent = `${p.name}（￥${p.price}）`;

          const label = document.createElement("div");
          label.className = "product-label";
          label.appendChild(nameSpan);
          row.appendChild(label);

          const delBtn = document.createElement("button");
          delBtn.className = "edit-small-btn danger";
          delBtn.textContent = "削除";
          delBtn.title = "商品を削除";
          delBtn.type = "button";
          delBtn.addEventListener("click", async () => {
            if (!confirm(`「${p.name}」を削除しますか？`)) return;
            await deleteDoc(doc(db, "products", p.id));
            await loadProducts();
            isEditMode = true;
            renderProductsUI();
          });
          row.appendChild(delBtn);

          listDiv.appendChild(row);

          row.addEventListener("dragstart", (e) => {
            dragIndex = index;
            row.classList.add("dragging");
            e.dataTransfer?.setData("text/plain", String(index));
          });

          row.addEventListener("dragend", async () => {
            row.classList.remove("dragging");
            dragIndex = null;

            const rows = Array.from(listDiv.querySelectorAll(".product-row"));
            const orderedIds = rows.map(r => r.dataset.id);
            products.sort((a, b) => orderedIds.indexOf(a.id) - orderedIds.indexOf(b.id));

            await saveSortOrder();
            isEditMode = true;
            renderProductsUI();
          });
        });

        listDiv.addEventListener("dragover", (e) => {
          e.preventDefault();
          const dragging = listDiv.querySelector(".product-row.dragging");
          if (!dragging) return;
          const afterElement = getDragAfterElement(listDiv, e.clientY);
          if (afterElement == null) {
            listDiv.appendChild(dragging);
          } else {
            listDiv.insertBefore(dragging, afterElement);
          }
        });

        const addRow = document.createElement("div");
        addRow.className = "add-form-row";

        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.placeholder = "商品名";
        addRow.appendChild(nameInput);

        const priceInput = document.createElement("input");
        priceInput.type = "number";
        priceInput.placeholder = "価格（円）";
        priceInput.inputMode = "numeric";
        addRow.appendChild(priceInput);

        const addBtn = document.createElement("button");
        addBtn.textContent = "商品を追加";
        addBtn.type = "button";
        addBtn.addEventListener("click", async () => {
          const name = nameInput.value.trim();
          const price = Number(priceInput.value);
          if (!name || !price || price <= 0) {
            alert("商品名と価格を正しく入力してください。");
            return;
          }
          const sortOrder = products.length;
          await addDoc(collection(db, "products"), { name, price, sortOrder });
          nameInput.value = "";
          priceInput.value = "";
          await loadProducts();
          isEditMode = true;
          renderProductsUI();
        });
        addRow.appendChild(addBtn);

        productListDiv.appendChild(addRow);

        const hint = document.createElement("p");
        hint.className = "add-hint";
        hint.textContent = "※ 並び順はドラッグした順番で保存されます。販売方法・開催場所の候補も編集できます。";
        productListDiv.appendChild(hint);
      }
    }

    async function saveSortOrder() {
      const updates = [];
      for (let i = 0; i < products.length; i++) {
        const p = products[i];
        if (p.sortOrder !== i) {
          p.sortOrder = i;
          updates.push(updateDoc(doc(db, "products", p.id), { sortOrder: i }));
        }
      }
      await Promise.all(updates);
    }

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll(".product-row.edit-mode:not(.dragging)")];
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
    }

    /* ===== POS 合計計算 ===== */

    function getSelectedItems() {
      const checks = document.querySelectorAll(".product-check:checked");
      const items = [];
      let total = 0;

      checks.forEach((c) => {
        const price = Number(c.dataset.price);
        const name = c.dataset.name;
        const row = c.closest(".product-row") || c.closest("div");
        const qtySelect = row.querySelector(".product-qty");
        const qty = Number(qtySelect?.value ?? 1);
        const subtotal = price * qty;
        items.push({ name, price, qty, subtotal });
        total += subtotal;
      });

      return { items, total };
    }

    function updateTotal() {
      const { total } = getSelectedItems();
      const totalEl = document.getElementById("total");
      if (totalEl) {
        totalEl.textContent = `合計：￥${total}`;
      }
    }

    /* ===== POS → レシート確認 ===== */

    function openReceipt() {
      const { items, total } = getSelectedItems();
      if (items.length === 0) {
        alert("商品が選択されていません。");
        return;
      }

      $receiptList.innerHTML = "";
      items.forEach((item) => {
        const p = document.createElement("p");
        p.textContent = `${item.name} ×${item.qty}：￥${item.subtotal}`;
        $receiptList.appendChild(p);
      });
      $receiptTotal.textContent = `合計：￥${total}`;

      const metaText = [];
      metaText.push(`販売方法：${currentChannel || "未設定"}`);
      if (currentChannel === "マルシェ") {
        metaText.push(`開催場所：${currentVenue || "-"}`);
      }
      $receiptMeta.textContent = metaText.join("　");

      // ★ 毎回「現金」をデフォルトにリセット
      if ($receiptPaymentSelect) {
        $receiptPaymentSelect.value = "現金";
      }

      $receiptModal.style.display = "flex";
    }

    $cancelSale.addEventListener("click", () => {
      $receiptModal.style.display = "none";
    });

    $confirmSale.addEventListener("click", async () => {
      const { items, total } = getSelectedItems();
      if (items.length === 0) {
        alert("商品が選択されていません。");
        $receiptModal.style.display = "none";
        return;
      }

      const paymentMethod = $receiptPaymentSelect ? ($receiptPaymentSelect.value || "現金") : "現金";

      try {
        await addDoc(collection(db, "sales"), {
          createdAt: serverTimestamp(),
          userId: auth.currentUser ? auth.currentUser.uid : null,
          items,
          total,
          adjustments: [],
          channel: currentChannel || "",
          venue: currentChannel === "マルシェ" ? (currentVenue || "") : "",
          paymentMethod, // ★ 決済方法を保存
        });

        alert("決済完了！");
        $receiptModal.style.display = "none";

        document.querySelectorAll(".product-check").forEach(c => {
          c.checked = false;
        });
        document.querySelectorAll(".product-qty").forEach(sel => {
          sel.disabled = true;
          sel.value = "1";
        });
        updateTotal();

        await loadSalesHistory();
      } catch (e) {
        console.error(e);
        alert("売上保存中にエラーが発生しました：" + e.message);
      }
    });

    /* ===== 購入履歴リスト ===== */

    async function loadSalesHistory() {
      const qRef = query(collection(db, "sales"), orderBy("createdAt", "desc"));
      const snap = await getDocs(qRef);
      const arr = [];
      snap.forEach((docSnap) => {
        const data = docSnap.data();
        arr.push({
          id: docSnap.id,
          createdAt: data.createdAt || null,
          items: data.items || [],
          total: data.total || 0,
          adjustments: data.adjustments || [],
          channel: data.channel || "",
          venue: data.venue || "",
          paymentMethod: data.paymentMethod || "現金", // ★ 既存データは現金扱い
        });
      });
      sales = arr;
      renderHistoryList();
      refreshBulkSelectors();
    }

    function formatDate(ts) {
      if (!ts || !ts.toDate) return "-";
      const d = ts.toDate();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${y}/${m}/${day} ${hh}:${mm}`;
    }

    function renderHistoryList() {
      if (!$historyList) return;
      $historyList.innerHTML = "";

      if (sales.length === 0) {
        const p = document.createElement("p");
        p.textContent = "まだ購入履歴がありません。";
        p.style.fontSize = "12px";
        p.style.color = "var(--text-sub)";
        $historyList.appendChild(p);
        return;
      }

      sales.forEach((s) => {
        const row = document.createElement("div");
        row.className = "history-row";

        const mainWrap = document.createElement("div");
        mainWrap.style.display = "flex";
        mainWrap.style.alignItems = "center";
        mainWrap.style.gap = "6px";
        mainWrap.style.flex = "1";

        if (isHistoryBulkEditing) {
          const sel = document.createElement("input");
          sel.type = "checkbox";
          sel.className = "history-row-select";
          sel.dataset.id = s.id;
          sel.addEventListener("click", (e) => e.stopPropagation());
          mainWrap.appendChild(sel);
        }

        const main = document.createElement("div");
        main.className = "history-main";

        const dateSpan = document.createElement("span");
        dateSpan.className = "history-date";
        dateSpan.textContent = formatDate(s.createdAt);
        main.appendChild(dateSpan);

        const metaSpan = document.createElement("span");
        metaSpan.className = "history-meta";
        const itemCount = s.items.reduce((sum, it) => sum + (it.qty || 0), 0);
        let metaStr = `商品点数：${itemCount}点`;
        if (s.channel) {
          metaStr += `　販売方法：${s.channel}`;
          if (s.channel === "マルシェ" && s.venue) {
            metaStr += `（${s.venue}）`;
          }
        }
        // ★ 決済方法表示
        if (s.paymentMethod) {
          metaStr += `　決済方法：${s.paymentMethod}`;
        }
        metaSpan.textContent = metaStr;
        main.appendChild(metaSpan);

        mainWrap.appendChild(main);
        row.appendChild(mainWrap);

        const right = document.createElement("div");
        right.style.display = "flex";
        right.style.flexDirection = "column";
        right.style.alignItems = "flex-end";
        right.style.gap = "2px";

        const totalSpan = document.createElement("span");
        totalSpan.className = "history-total";
        totalSpan.textContent = `￥${s.total}`;
        right.appendChild(totalSpan);

        const tagsDiv = document.createElement("div");
        tagsDiv.className = "history-tags";

        const hasClaim = s.adjustments.some(a => a.reason === "claim");
        const hasMistake = s.adjustments.some(a => a.reason === "mistake");

        if (hasClaim) {
          const tag = document.createElement("span");
          tag.className = "history-tag";
          tag.textContent = "クレーム処理";
          tagsDiv.appendChild(tag);
        }
        if (hasMistake) {
          const tag = document.createElement("span");
          tag.className = "history-tag mistake";
          tag.textContent = "打ち間違い";
          tagsDiv.appendChild(tag);
        }

        right.appendChild(tagsDiv);
        row.appendChild(right);

        row.addEventListener("click", () => {
          if (isHistoryBulkEditing) return; // 一括編集中は詳細ポップアップなし
          openHistoryDetail(s);
        });

        $historyList.appendChild(row);
      });
    }

    /* ===== 購入履歴 詳細 ===== */

    function openHistoryDetail(sale) {
      currentSale = {
        id: sale.id,
        createdAt: sale.createdAt,
        items: sale.items.map(it => ({ ...it })),
        total: sale.total,
        adjustments: Array.isArray(sale.adjustments) ? [...sale.adjustments] : [],
        channel: sale.channel || "",
        venue: sale.venue || "",
        paymentMethod: sale.paymentMethod || "現金",
      };
      isHistoryEditing = false;
      renderHistoryDetail();
      $historyModal.style.display = "flex";
    }

    function renderHistoryDetail() {
      if (!currentSale) return;

      $historyTitle.textContent = `${formatDate(currentSale.createdAt)} の購入`;
      const itemCount = currentSale.items.reduce((sum, it) => sum + (it.qty || 0), 0);
      $historyMeta.textContent = `商品点数：${itemCount}点`;

      // 販売方法 / 開催場所 / 決済方法 表示
      $historySellMeta.innerHTML = "";

      // 1行目：販売方法・開催場所
      const line = document.createElement("div");

      if (isHistoryEditing) {
        const chLabel = document.createElement("label");
        chLabel.textContent = "販売方法：";
        const chSelect = document.createElement("select");
        channels.forEach(ch => {
          const opt = document.createElement("option");
          opt.value = ch;
          opt.textContent = ch;
          if (ch === currentSale.channel) opt.selected = true;
        });
        chSelect.addEventListener("change", () => {
          currentSale.channel = chSelect.value;
          if (currentSale.channel !== "マルシェ") {
            // マルシェじゃないときは開催場所はそのままでもOK（必要ならリセット）
          }
          renderHistoryDetail();
        });
        chLabel.appendChild(chSelect);
        line.appendChild(chLabel);

        const vWrapper = document.createElement("span");
        vWrapper.style.marginLeft = "8px";
        vWrapper.style.display = (currentSale.channel === "マルシェ") ? "inline-flex" : "none";
        vWrapper.style.alignItems = "center";
        vWrapper.style.gap = "4px";

        const vLabel = document.createElement("label");
        vLabel.textContent = "開催場所：";
        const vSelect = document.createElement("select");
        venues.forEach(v => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          if (v === currentSale.venue) opt.selected = true;
        });
        vSelect.addEventListener("change", () => {
          currentSale.venue = vSelect.value;
        });
        vLabel.appendChild(vSelect);
        vWrapper.appendChild(vLabel);
        line.appendChild(vWrapper);
      } else {
        let text = `販売方法：${currentSale.channel || "未設定"}`;
        if (currentSale.channel === "マルシェ" && currentSale.venue) {
          text += `　開催場所：${currentSale.venue}`;
        }
        line.textContent = text;
      }
      $historySellMeta.appendChild(line);

      // 2行目：決済方法
      const payLine = document.createElement("div");
      if (isHistoryEditing) {
        const payLabel = document.createElement("label");
        payLabel.textContent = "決済方法：";
        const paySelect = document.createElement("select");

        paymentMethods.forEach(pm => {
          const opt = document.createElement("option");
          opt.value = pm;
          opt.textContent = pm;
          if (pm === currentSale.paymentMethod) opt.selected = true;
          paySelect.appendChild(opt);
        });

        paySelect.addEventListener("change", () => {
          currentSale.paymentMethod = paySelect.value;
        });

        payLabel.appendChild(paySelect);
        payLine.appendChild(payLabel);
      } else {
        payLine.textContent = `決済方法：${currentSale.paymentMethod || "現金"}`;
      }
      $historySellMeta.appendChild(payLine);

      // アイテム一覧
      $historyItems.innerHTML = "";
      currentSale.items.forEach((it, index) => {
        const row = document.createElement("div");
        row.className = "history-item-row";

        const nameSpan = document.createElement("span");
        nameSpan.className = "history-item-name";
        nameSpan.textContent = it.name;
        row.appendChild(nameSpan);

        const qtySpan = document.createElement("span");
        qtySpan.className = "history-item-qty";

        if (isHistoryEditing) {
          const btn = document.createElement("button");
          btn.textContent = `×${it.qty}`;
          btn.title = "数量を変更";
          btn.type = "button";
          btn.addEventListener("click", () => {
            openQtyModal("item", index, it);
          });
          qtySpan.appendChild(btn);
        } else {
          qtySpan.textContent = `×${it.qty}`;
        }

        row.appendChild(qtySpan);

        const subSpan = document.createElement("span");
        subSpan.className = "history-item-subtotal";
        subSpan.textContent = `￥${it.subtotal ?? (it.price || 0) * (it.qty || 0)}`;
        row.appendChild(subSpan);

        $historyItems.appendChild(row);
      });

      const total = currentSale.items.reduce((sum, it) => sum + (it.subtotal ?? (it.price || 0) * (it.qty || 0)), 0);
      currentSale.total = total;
      $historyTotal.textContent = `合計：￥${currentSale.total}`;

      // 調整履歴
      $historyAdjustments.innerHTML = "";
      if (!currentSale.adjustments || currentSale.adjustments.length === 0) {
        const p = document.createElement("p");
        p.textContent = "調整履歴はありません。";
        p.className = "history-adjust-row";
        $historyAdjustments.appendChild(p);
      } else {
        currentSale.adjustments.forEach((adj) => {
          const row = document.createElement("div");
          row.className = "history-adjust-row";

          const reasonLabel = adj.reason === "claim" ? "クレーム処理"
                            : adj.reason === "mistake" ? "打ち間違い"
                            : "調整";

          if (adj.type === "item") {
            row.textContent = `${adj.itemName ?? "商品"}：数量 ${adj.beforeQty} → ${adj.afterQty}（${reasonLabel}）`;
          } else if (adj.type === "all") {
            row.textContent = `すべて返金：￥${adj.beforeTotal} → ￥${adj.afterTotal}（${reasonLabel}）`;
          } else {
            row.textContent = `${reasonLabel}`;
          }

          $historyAdjustments.appendChild(row);
        });
      }

      // 編集ボタン表示
      if (isHistoryEditing) {
        $historyEditToggle.classList.add("active");
        $historyEditToggle.textContent = "編集中";
      } else {
        $historyEditToggle.classList.remove("active");
        $historyEditToggle.textContent = "✎";
      }

      // ★ すべて返金ボタンは編集モードのときだけ表示
      $historyRefundAll.style.display = isHistoryEditing ? "inline-flex" : "none";
    }

    $historyClose.addEventListener("click", () => {
      currentSale = null;
      isHistoryEditing = false;
      $historyModal.style.display = "none";
    });

    $historyEditToggle.addEventListener("click", () => {
      if (!currentSale) return;
      isHistoryEditing = !isHistoryEditing;
      renderHistoryDetail();
    });

    $historyRefundAll.addEventListener("click", () => {
      if (!currentSale) return;
      if (!isHistoryEditing) {
        alert("編集モードにしてから操作してください。");
        return;
      }
      openQtyModal("all", null, null);
    });

    $historySave.addEventListener("click", async () => {
      if (!currentSale) return;
      try {
        const itemsClean = currentSale.items.map(it => ({
          name: it.name,
          price: it.price,
          qty: it.qty,
          subtotal: it.subtotal ?? (it.price || 0) * (it.qty || 0),
        }));

        const saleRef = doc(db, "sales", currentSale.id);
        await updateDoc(saleRef, {
          items: itemsClean,
          total: currentSale.total,
          adjustments: currentSale.adjustments || [],
          channel: currentSale.channel || "",
          venue: currentSale.venue || "",
          paymentMethod: currentSale.paymentMethod || "現金", // ★ 決済方法も保存
        });

        alert("保存しました。");
        $historyModal.style.display = "none";
        currentSale = null;
        isHistoryEditing = false;

        await loadSalesHistory();
      } catch (e) {
        console.error(e);
        alert("保存中にエラーが発生しました：" + e.message);
      }
    });

    /* ===== 数量変更モーダル ===== */

    function openQtyModal(mode, index, item) {
      qtyEditMode = mode;
      qtyEditIndex = index ?? null;

      $qtySelect.innerHTML = "";
      for (let i = 0; i <= 10; i++) {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = i;
        $qtySelect.appendChild(opt);
      }

      if (mode === "item" && item) {
        $qtyInnerTitle.textContent = `${item.name} の数量変更`;
        $qtyLabel.textContent = "0〜10の中から数量を選んでください。";
        $qtySelect.value = String(item.qty ?? 0);
        $qtySelect.disabled = false;
      } else {
        $qtyInnerTitle.textContent = "すべて返金";
        $qtyLabel.textContent = "クレーム処理か打ち間違いを選んでください。数量は自動で0になります。";
        $qtySelect.value = "0";
        $qtySelect.disabled = true;
      }

      $qtyModal.style.display = "flex";
    }

    function closeQtyModal() {
      $qtyModal.style.display = "none";
      qtyEditMode = "item";
      qtyEditIndex = null;
    }

    $qtyCancel.addEventListener("click", () => {
      closeQtyModal();
    });

    $qtyClaim.addEventListener("click", () => {
      applyQtyChange("claim");
    });

    $qtyMistake.addEventListener("click", () => {
      applyQtyChange("mistake");
    });

    function applyQtyChange(reason) {
      if (!currentSale) return;

      const adjustments = currentSale.adjustments || [];
      const nowIso = new Date().toISOString();

      if (qtyEditMode === "item") {
        if (qtyEditIndex == null) return;
        const item = currentSale.items[qtyEditIndex];
        const beforeQty = item.qty ?? 0;
        const newQty = Number($qtySelect.value);
        if (newQty === beforeQty) {
          closeQtyModal();
          return;
        }
        item.qty = newQty;
        item.subtotal = (item.price || 0) * newQty;

        adjustments.push({
          at: nowIso,
          type: "item",
          reason,
          itemName: item.name,
          beforeQty,
          afterQty: newQty,
        });
      } else if (qtyEditMode === "all") {
        const beforeTotal = currentSale.total;
        currentSale.items.forEach(it => {
          it.qty = 0;
          it.subtotal = 0;
        });
        const afterTotal = 0;
        adjustments.push({
          at: nowIso,
          type: "all",
          reason,
          beforeTotal,
          afterTotal,
        });
      }

      currentSale.adjustments = adjustments;
      closeQtyModal();
      renderHistoryDetail();
    }

    /* ===== 販売方法・開催場所 設定モーダル ===== */

    function openListEditModal(type) {
      listEditType = type; // "channel" or "venue"
      $listEditTitle.textContent = type === "channel" ? "販売方法の設定" : "開催場所の設定";
      $listEditAddInput.value = "";
      renderListEditModal();
      $listEditModal.style.display = "flex";
    }

    function renderListEditModal() {
      if (!listEditType) return;
      $listEditList.innerHTML = "";

      const arr = listEditType === "channel" ? channels : venues;

      arr.forEach((name, index) => {
        const row = document.createElement("div");
        row.className = "list-edit-row";

        const nameSpan = document.createElement("span");
        nameSpan.className = "list-edit-name";
        nameSpan.textContent = name;
        row.appendChild(nameSpan);

        const btnWrap = document.createElement("div");
        btnWrap.style.display = "flex";
        btnWrap.style.gap = "4px";

        const editBtn = document.createElement("button");
        editBtn.type = "button";
        editBtn.textContent = "編集";
        editBtn.addEventListener("click", () => {
          const newName = prompt("名前を変更", name);
          if (!newName) return;
          arr[index] = newName;
          if (listEditType === "channel") {
            if (currentChannel === name) currentChannel = newName;
            channels = arr;
          } else {
            if (currentVenue === name) currentVenue = newName;
            venues = arr;
          }
          saveSettingsToStorage();
          renderListEditModal();
          renderProductsUI();
          refreshBulkSelectors();
        });
        btnWrap.appendChild(editBtn);

        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.textContent = "削除";
        delBtn.addEventListener("click", () => {
          if (!confirm(`「${name}」を削除しますか？`)) return;
          arr.splice(index, 1);
          if (listEditType === "channel") {
            if (currentChannel === name) currentChannel = arr[0] || "";
            channels = arr;
          } else {
            if (currentVenue === name) currentVenue = arr[0] || "";
            venues = arr;
          }
          saveSettingsToStorage();
          renderListEditModal();
          renderProductsUI();
          refreshBulkSelectors();
        });
        btnWrap.appendChild(delBtn);

        row.appendChild(btnWrap);
        $listEditList.appendChild(row);
      });
    }

    $listEditAddBtn.addEventListener("click", () => {
      if (!listEditType) return;
      const val = $listEditAddInput.value.trim();
      if (!val) return;
      if (listEditType === "channel") {
        if (!channels.includes(val)) channels.push(val);
        currentChannel = currentChannel || val;
      } else {
        if (!venues.includes(val)) venues.push(val);
        currentVenue = currentVenue || val;
      }
      $listEditAddInput.value = "";
      saveSettingsToStorage();
      renderListEditModal();
      renderProductsUI();
      refreshBulkSelectors();
    });

    $listEditClose.addEventListener("click", () => {
      $listEditModal.style.display = "none";
      listEditType = null;
    });

    /* ===== 購入履歴 一括編集 ===== */

    $historyBulkToggle.addEventListener("click", () => {
      isHistoryBulkEditing = !isHistoryBulkEditing;
      $historyBulkToggle.classList.toggle("active", isHistoryBulkEditing);
      $historyBulkToggle.textContent = isHistoryBulkEditing ? "一括編集中" : "一括編集";
      $historyBulkTools.style.display = isHistoryBulkEditing ? "block" : "none";
      renderHistoryList();
    });

    function refreshBulkSelectors() {
      if (!$bulkChannelSelect || !$bulkVenueSelect) return;
      $bulkChannelSelect.innerHTML = "";
      channels.forEach(ch => {
        const opt = document.createElement("option");
        opt.value = ch;
        opt.textContent = ch;
        if (ch === currentChannel) opt.selected = true;
        $bulkChannelSelect.appendChild(opt);
      });

      $bulkVenueSelect.innerHTML = "";
      venues.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        if (v === currentVenue) opt.selected = true;
        $bulkVenueSelect.appendChild(opt);
      });
    }

    $bulkApplyBtn.addEventListener("click", async () => {
      if (!isHistoryBulkEditing) {
        alert("一括編集モードをONにしてください。");
        return;
      }
      const channel = $bulkChannelSelect.value || "";
      const venue = channel === "マルシェ" ? ($bulkVenueSelect.value || "") : "";

      const checks = document.querySelectorAll(".history-row-select:checked");
      if (!checks.length) {
        alert("対象の履歴を選択してください。");
        return;
      }

      if (!confirm(`選択した ${checks.length} 件の履歴の販売方法を「${channel}」に更新しますか？`)) return;

      try {
        const promises = [];
        checks.forEach(c => {
          const id = c.dataset.id;
          const ref = doc(db, "sales", id);
          promises.push(updateDoc(ref, {
            channel,
            venue,
          }));
        });
        await Promise.all(promises);
        alert("一括更新しました。");
        await loadSalesHistory();
      } catch (e) {
        console.error(e);
        alert("一括更新中にエラーが発生しました：" + e.message);
      }
    });
  </script>
</body>
</html>
