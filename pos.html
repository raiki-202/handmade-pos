<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>e.nue POS (COMPLETE build 2025-12-27)</title>

  <style>
    :root{
      --bg1:#e3ddd4;
      --bg2:#d4ccc1;

      /* é€æ˜æ„ŸUPï¼ˆèƒŒæ™¯ãŒé€ã‘ã‚‹æ–¹å‘ï¼‰ */
      --glass-bg: rgba(255,255,255,.62);
      --glass-bg2: rgba(255,255,255,.48);
      --glass-border: rgba(0,0,0,.06);
      --line-soft: rgba(0,0,0,.10);
      --shadow: 0 18px 45px rgba(0,0,0,.14);

      --text-main:#222;
      --text-sub:#555;
      --muted: rgba(34,34,34,.55);

      --accent:#e18a6a;
      --accent2:#d06463;

      --r:20px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding: 12px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }

    .safe{
      max-width: 980px;
      margin: 0 auto;
    }

    /* ====== glass card ====== */
    .shell{
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 26px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      overflow:hidden;
    }

    /* ===== header ===== */
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 14px 14px 10px;
      border-bottom: 1px dashed var(--line-soft);
    }
    h1{
      margin:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand-main{
      font-family: "Georgia", "Times New Roman", serif;
      font-weight: 700;
      letter-spacing:.08em;
      font-size: 20px;
      line-height:1.1;
    }
    .brand-sub{
      font-size: 11px;
      color: var(--text-sub);
      letter-spacing:.02em;
    }

    .nav{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .nav-btn{
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.70);
      color: var(--text-main);
      padding: 6px 12px;
      font-size: 11px;
      cursor:pointer;
      white-space:nowrap;
      transition: transform .12s ease, background .2s ease, border-color .2s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .nav-btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.82); }

    .content{ padding: 12px; }

    .section{
      background: rgba(255,255,255,.58);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: var(--r);
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
      overflow:hidden;
    }

    .sectionHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px 10px;
      border-bottom: 1px dashed var(--line-soft);
    }
    .sectionHead h3{
      margin:0;
      font-size: 13px;
      font-weight: 700;
    }
    .sectionHead .sub{
      font-size: 11px;
      color: var(--text-sub);
    }

    /* ===== POS ===== */
    .posBody{ padding: 12px; }
    .row2{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .label{
      font-size: 10px;
      color: var(--text-sub);
      display:flex;
      gap:6px;
      align-items:center;
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 999px;
      padding: 4px 8px;
    }
    select, input{
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.85);
      padding: 6px 8px;
      font-size: 12px;
      outline:none;
    }

    .products{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .product-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border: 1px solid rgba(0,0,0,.06);
      background: rgba(255,255,255,.78);
      border-radius: 14px;
    }
    .product-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
      flex: 1;
    }
    .product-name{
      font-size: 13px;
      font-weight: 600;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .product-price{
      font-size: 12px;
      color: var(--text-sub);
      margin-left: 6px;
      font-weight: 500;
    }
    .qty{
      display:flex;
      align-items:center;
      gap:6px;
      flex: 0 0 auto;
    }
    .qty select{ padding: 6px 8px; border-radius: 10px; }

    .primary{
      margin-top: 10px;
      width:100%;
      border:0;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(225,138,106,.95), rgba(208,100,99,.95));
      color:#fff;
      font-weight: 800;
      padding: 12px 14px;
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,.14);
    }
    .primary:active{ transform: translateY(1px); }
    .primary[disabled]{ opacity:.55; cursor:not-allowed; transform:none; }

    .total{
      margin-top: 8px;
      font-size: 13px;
      color: var(--text-main);
      font-weight: 800;
      text-align:right;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.85);
      font-size: 12px;
      font-weight: 700;
      color: var(--text-sub);
      white-space:nowrap;
    }

    /* ===== modal ===== */
    .modal{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
      background: rgba(0,0,0,.32);
      z-index: 999;
    }
    .modal.show{ display:flex; }
    .modalInner{
      width: min(560px, 100%);
      background: rgba(255,255,255,.88);
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 22px;
      box-shadow: 0 18px 45px rgba(0,0,0,.22);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px 10px;
      border-bottom: 1px dashed var(--line-soft);
    }
    .modalHead h3{ margin:0; font-size: 13px; font-weight: 800; }
    .iconBtn{
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.85);
      border-radius: 999px;
      padding: 4px 8px;
      cursor:pointer;
      font-size: 12px;
      font-weight: 800;
    }
    .modalBody{ padding: 12px; }
    .muted{ color: var(--text-sub); font-size: 11px; }

    .btnRow{
      display:flex;
      gap:8px;
      margin-top: 12px;
    }
    .btn{
      flex:1;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.85);
      padding: 10px 12px;
      font-weight: 800;
      cursor:pointer;
    }
    .btn.primaryBtn{
      border:0;
      background: linear-gradient(135deg, rgba(225,138,106,.95), rgba(208,100,99,.95));
      color:#fff;
    }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }

    /* toast */
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 999px;
      padding: 10px 14px;
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      font-size: 12px;
      font-weight: 800;
      color: var(--text-main);
      display:none;
      z-index: 2000;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .toast.show{ display:block; }

    @media (max-width: 600px){
      body{ padding: 10px; }
      .brand-main{ font-size: 18px; }
    }
      /* ===== POS title edit toggle ===== */
    .titleRow{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .titleIcon{
      width: 28px;
      height: 28px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.80);
      cursor:pointer;
      font-size: 14px;
      font-weight: 900;
      line-height: 1;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .titleIcon:active{ transform: translateY(1px); }

    /* ===== settings edit modal ===== */
    .editGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 6px;
    }
    .field{
      background: rgba(255,255,255,.70);
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 16px;
      padding: 10px;
    }
    .fieldTitle{
      font-size: 12px;
      font-weight: 900;
      margin-bottom: 8px;
    }
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.85);
      font-size: 12px;
      font-weight: 800;
    }
    .chip button{
      border:0;
      background: transparent;
      cursor:pointer;
      font-weight: 900;
      font-size: 14px;
      line-height: 1;
      padding: 0 2px;
      color: var(--text-sub);
    }
    .adder{
      display:flex;
      gap:8px;
      margin-top: 8px;
    }
    .adder input{
      flex:1;
    }
  
/* ===== iOS blue text override ===== */
button, 
button:visited,
button:active,
button:focus,
.titleIcon,
.iconBtn,
.btn,
a,
a:visited,
a:active {
  color: #222 !important;
  -webkit-text-fill-color: #222 !important;
}

button {
  -webkit-appearance: none;
  appearance: none;
}

select {
  color: #222;
}

</style>
</head>

<body>
  <div class="safe">
    <div class="shell">
      <div class="topbar">
        <h1>
          <span class="brand-main">e.nue</span>
          <span class="brand-sub">POS / Firestoreã¸å£²ä¸Šã‚’ä¿å­˜</span>
        </h1>

        <div class="nav">
          <a class="nav-btn" href="index.html" aria-label="æˆ»ã‚‹">â† æˆ»ã‚‹</a>
          <span class="pill" id="statusPill">æœªæ¥ç¶š</span>
          <span class="pill" id="diffPill" style="display:none; cursor:pointer;">updates 0 / adds 0</span>
        </div>
      </div>

      <div class="content">
        <div class="section">
          <div class="sectionHead">
            <div>
              <div class="titleRow"><h3 style="margin:0;">POS</h3></div>
              <div class="sub">è²©å£²æ–¹æ³• / æ±ºæ¸ˆæ–¹æ³• / è³¼å…¥å•†å“ â†’ Firestoreã¸é€ä¿¡</div>
            </div>
            <span class="pill" id="masterPill">å•†å“ãƒã‚¹ã‚¿ï¼šèª­è¾¼ä¸­</span>
            <button class="titleIcon" id="pmToggleBtn" type="button" aria-label="å•†å“ãƒã‚¹ã‚¿ç·¨é›†" title="å•†å“ãƒã‚¹ã‚¿ç·¨é›†">âœ</button>
            <button class="titleIcon" id="mastersToggleBtn" aria-label="ãƒã‚¹ã‚¿ç·¨é›†" title="ãƒã‚¹ã‚¿ç·¨é›†">âš™ï¸</button>
          </div>

          <div class="posBody">
            <div class="row2">
              <span class="label">
                è²©å£²æ–¹æ³•
                <select id="channelSelect"></select>
              </span>

              <span class="label" id="venueWrap" style="display:none;">
                é–‹å‚¬å ´æ‰€
                <select id="venueSelect"></select>
              </span>

              <span class="label">
                æ±ºæ¸ˆæ–¹æ³•
                <select id="paymentSelect"></select>
              </span>
            </div>

            <div class="products" id="products"></div>

            <button class="primary" id="checkoutBtn" type="button" disabled>æ±ºæ¸ˆã¸é€²ã‚€</button>
            <div class="total" id="totalText">åˆè¨ˆï¼šï¿¥0</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Receipt Modal -->
  <div class="modal" id="receiptModal" aria-hidden="true">
    <div class="modalInner">
      <div class="modalHead">
        <h3>ãƒ¬ã‚·ãƒ¼ãƒˆç¢ºèª</h3>
        <button class="iconBtn" id="closeReceiptBtn" type="button">Ã—</button>
      </div>
      <div class="modalBody">
        <div class="muted" id="receiptMeta"></div>
        <div style="margin-top:10px;">
          <span class="label" style="display:inline-flex;">
            å—æ³¨æ—¥
            <input id="orderDateInput" type="date" />
          </span>
        </div>

        <div style="margin-top:10px;">
          <span class="label" style="display:inline-flex; align-items:center; gap:8px;">
            kind
            <select id="kindSelect"></select>
          </span>
        </div>
        <div id="receiptList" style="margin-top:10px;"></div>
        <div style="font-weight:900; margin-top:10px;" id="receiptTotal"></div>

        <div class="btnRow">
          <button class="btn" id="cancelBtn" type="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn primaryBtn" id="confirmBtn" type="button">ç¢ºå®šï¼ˆFirestoreã¸ä¿å­˜ï¼‰</button>
        </div>

        <div class="muted" style="margin-top:10px;">
          â€» createdAt ã¯ serverTimestampï¼ˆã‚µãƒ¼ãƒãƒ¼æ™‚åˆ»ï¼‰ã§ä¿å­˜ã—ã¾ã™ã€‚<br>
          â€» clientCreatedAt ã‚‚ä¸€ç·’ã«ä¿å­˜ã—ã¾ã™ï¼ˆç«¯æœ«æ™‚åˆ» / ä¿é™ºï¼‰ã€‚
        </div>
      </div>
    </div>
  </div>

  <!-- Product Master Edit Modal -->
  <div class="modal" id="pmModal" aria-hidden="true">
    <div class="modalInner">
      <div class="modalHead">
        <h3>å•†å“ãƒã‚¹ã‚¿ï¼ˆè¿½åŠ ãƒ»ä¿®æ­£ï¼‰</h3>
        <button class="iconBtn" id="pmCloseBtn" type="button">â“§</button>
      </div>
      <div class="modalBody">
        <div class="muted">ç·¨é›†å†…å®¹ã¯ <b>Firestore products_patch_updates / products_patch_adds</b> ã«å·®åˆ†ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆbundleã¯ç®¡ç†è€…ãŒå¾Œã§æ›´æ–°ï¼‰ã€‚</div>

        <div class="editGrid">
          <div class="field">
            <div class="fieldTitle">å¯¾è±¡å•†å“</div>
            <select id="pmSelect"></select>
            <div class="muted" style="margin-top:6px;">â€»å•†å“ã‚’é¸ã¶ã¨ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ã•ã‚Œã¾ã™</div>
          </div>

          <div class="field">
            <div class="fieldTitle">ç·¨é›†</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <div>
                <div class="label">ID</div>
                <input id="pmId" disabled />
              </div>
              <div>
                <div class="label">è¡¨ç¤º</div>
                <select id="pmActive">
                  <option value="true">è¡¨ç¤º</option>
                  <option value="false">éè¡¨ç¤º</option>
                </select>
              </div>
            </div>
            <div style="margin-top:10px;">
              <div class="label">å•†å“å</div>
              <input id="pmName" placeholder="ä¾‹ï¼šãƒãƒ–ãƒ¼ã‚·ãƒ¥ã‚«" />
            </div>
            <div style="margin-top:10px;">
              <div class="label">ä¾¡æ ¼</div>
              <input id="pmPrice" inputmode="numeric" placeholder="ä¾‹ï¼š1400" />
            </div>
          </div>

          <div class="field">
            <div class="fieldTitle">æ–°è¦è¿½åŠ </div>
            <div class="muted">ã€Œæ–°è¦è¿½åŠ ã€ã‚’æŠ¼ã™ã¨æ¬¡ã®IDã‚’è‡ªå‹•æ¡ç•ªã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥ã‚Œã¾ã™ã€‚</div>
            <div class="btnRow" style="margin-top:10px;">
              <button class="btn" id="pmNewBtn" type="button">æ–°è¦è¿½åŠ </button>
            </div>
          </div>
        </div>

        <div class="btnRow">
          <button class="btn" id="pmDiscardBtn" type="button">ç ´æ£„ã—ã¦é–‰ã˜ã‚‹</button>
          <button class="btn primaryBtn" id="pmSaveBtn" type="button">ä¿å­˜ã—ã¦é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">ä¿å­˜ã—ã¾ã—ãŸ</div>


  <!-- Masters Modal (simple masters: channels/venues/payments/kinds) -->
  <div class="modal" id="mastersModal" aria-hidden="true">
    <div class="modalInner">
      <div class="modalHead">
        <h3>ãƒã‚¹ã‚¿ç·¨é›†</h3>
        <button class="iconBtn" id="mastersCloseBtn" type="button">â“§</button>
      </div>
      <div class="modalBody">
        <div class="muted" style="margin-bottom:10px;">
          â€» ã“ã“ã§ã®å¤‰æ›´ã¯ã€Œå·®åˆ†ï¼ˆpatchï¼‰ã€ã¨ã—ã¦Firestoreã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚bundle(JSON)ã¯GitHubå´ã€‚
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <span class="label" style="display:inline-flex; align-items:center; gap:8px;">
            å¯¾è±¡
            <select id="masterTypeSelect">
              <option value="channels">è²©å£²æ–¹æ³•ãƒã‚¹ã‚¿</option>
              <option value="venues">é–‹å‚¬å ´æ‰€ãƒã‚¹ã‚¿</option>
              <option value="payments">æ±ºæ¸ˆæ–¹æ³•ãƒã‚¹ã‚¿</option>
              <option value="kinds">kindãƒã‚¹ã‚¿</option>
            </select>
          </span>

          <button class="btn" id="masterAddRowBtn" type="button">ï¼‹è¿½åŠ </button>

          <button class="btn primaryBtn" id="masterSaveBtn" type="button">ä¿å­˜ï¼ˆå·®åˆ†ã¨ã—ã¦ç™»éŒ²ï¼‰</button>
        </div>

        <div id="masterRows" style="margin-top:12px; display:grid; gap:10px;"></div>

        <div class="muted" style="margin-top:10px;">
          ãƒ«ãƒ¼ãƒ«ï¼šbundleã«å­˜åœ¨ã™ã‚‹ID â†’ updatesã€bundleã«ç„¡ã„ID â†’ adds
        </div>
      </div>
    </div>
  </div>

  
  <!-- Admin diff breakdown (header next to status) -->
  <div id="diffPop" style="display:none; position:fixed; right:18px; top:64px; z-index:60;
    background: rgba(255,255,255,.95); border:1px solid rgba(0,0,0,.08); border-radius:14px;
    padding:10px 12px; box-shadow:0 18px 45px rgba(0,0,0,.14); max-width:280px; font-size:13px; line-height:1.35;">
    <div style="font-weight:700; margin-bottom:6px;">å·®åˆ†å†…è¨³</div>
    <div id="diffPopLines"></div>
  </div>

<!-- Admin patch summary -->
  <div id="patchPill" class="pill" style="display:none; position:fixed; right:18px; bottom:18px; z-index:50; cursor:pointer;">
    å·®åˆ†ï¼š0
  </div>
  <div id="patchPop" style="display:none; position:fixed; right:18px; bottom:62px; z-index:51; background:rgba(255,255,255,.95); border:1px solid rgba(0,0,0,.08); border-radius:14px; padding:12px 14px; box-shadow:0 18px 45px rgba(0,0,0,.14); min-width:220px;">
    <div style="font-weight:800; margin-bottom:6px;">å·®åˆ†å†…è¨³</div>
    <div id="patchBreakdown" class="muted"></div>
  </div>
<script type="module">
  console.log("POS COMPLETE build 2025-12-27");
/* =====================================================
   Firebase imports
===================================================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  serverTimestamp,
  doc,
  setDoc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

/* =====================================================
   Firebase configï¼ˆã‚ãªãŸã® devï¼‰
===================================================== */
const firebaseConfig = {
      apiKey: "AIzaSyAhPCgPoJK6S6BWVcBZOruYqMPXVQXQFRk",
      authDomain: "handmade-pos.firebaseapp.com",
      projectId: "handmade-pos",
      storageBucket: "handmade-pos.firebasestorage.app",
      messagingSenderId: "174873514252",
      appId: "1:174873514252:web:c26659bffca850d475f929"
    };

/* =====================================================
   DOM helpers
===================================================== */
const $ = (id) => document.getElementById(id);

const $statusPill   = $("statusPill");
const $channelSelect = $("channelSelect");
const $venueSelect   = $("venueSelect");
const $venueWrap     = $("venueWrap");
const $paymentSelect = $("paymentSelect");

const $products   = $("products");
const $totalText  = $("totalText");
const $checkoutBtn = $("checkoutBtn");

const $receiptModal = $("receiptModal");
const $receiptMeta  = $("receiptMeta");
const $receiptList  = $("receiptList");
const $receiptTotal = $("receiptTotal");
const $orderDateInput = $("orderDateInput");
const $kindSelect = $("kindSelect");
const $mastersToggleBtn = $("mastersToggleBtn");
const $mastersModal = $("mastersModal");
const $mastersCloseBtn = $("mastersCloseBtn");
const $masterTypeSelect = $("masterTypeSelect");
const $masterRows = $("masterRows");
const $masterAddRowBtn = $("masterAddRowBtn");
const $masterSaveBtn = $("masterSaveBtn");
const $patchPill = $("patchPill");
const $patchPop = $("patchPop");
const $patchBreakdown = $("patchBreakdown");
const $diffPill = $("diffPill");
const $diffPop = $("diffPop");
const $diffPopLines = $("diffPopLines");
const $closeReceiptBtn = $("closeReceiptBtn");
const $cancelBtn = $("cancelBtn");
const $confirmBtn = $("confirmBtn");

const $toast = $("toast");

/* =====================================================
   Firebase init
===================================================== */
let db = null;
let firebaseOk = false;
let currentUser = null; // auth user

// ===== Auth state shared vars (declare early to avoid timing issues) =====
const ADMIN_EMAIL = "enue_staff03@management.com";
let currentUserEmail = null;


function setStatus(ok, text){
  firebaseOk = ok;
  $statusPill.textContent = text;
  $checkoutBtn.disabled = !ok;
}

async function bootFirebase(){
  try{
    const app = initializeApp(firebaseConfig);

    // Firestore
    db = getFirestore(app);

    // Auth
    const auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence);

    // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãªã‘ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œã¯ã“ã®POSã¸æˆ»ã™ï¼‰
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      currentUserEmail = user?.email || null;

      if (!user) {
        location.href = 'login.html?redirect=' + encodeURIComponent('pos.html');
        return;
      }

      // ç®¡ç†è€…ã®ã¿ï¼šå·®åˆ†ä»¶æ•°ã®å¯è¦–åŒ–ï¼ˆdiffPill + å¹ãå‡ºã—ï¼‰
      try{ await refreshPatchSummary(); }catch(e){ /* noop */ }
    });

    setStatus(true, "Firestoreæ¥ç¶šOK");
  }catch(e){
    console.error(e);
    setStatus(false, "Firestoreæœªæ¥ç¶š");
    alert("FirebaseåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
}

/* =====================================================
   Settings
===================================================== */
const LS_SETTINGS_KEY = "pos_settings_v2";

const defaultSettings = {
  channels: ["ãƒãƒ«ã‚·ã‚§", "ã‚¤ãƒ³ã‚¹ã‚¿ã‚°ãƒ©ãƒ ", "onlinestore"],
  venues: ["cafe1400"],
  currentChannel: "ãƒãƒ«ã‚·ã‚§",
  currentVenue: "cafe1400",
  paymentMethod: "cash",
  paymentMethods: ["cash","paypay","credit","other"],
};


function migratePaymentMethod(s){
  const map = { "ç¾é‡‘":"cash", "PayPay":"paypay", "ã‚¯ãƒ¬ã‚«":"credit", "ãã®ä»–":"other" };
  if(map[s.paymentMethod]) s.paymentMethod = map[s.paymentMethod];
  return s;
}
function loadSettings(){
  try{
    const raw = localStorage.getItem(LS_SETTINGS_KEY);
    const s = raw ? { ...defaultSettings, ...JSON.parse(raw) } : structuredClone(defaultSettings);
    return migratePaymentMethod(s);
  }catch{
    return structuredClone(defaultSettings);
  }
}
function saveSettings(){
  localStorage.setItem(LS_SETTINGS_KEY, JSON.stringify(settings));
}

let settings = loadSettings();

/* =====================================================
   å•†å“ãƒã‚¹ã‚¿ï¼ˆbundle + updates/adds patchï¼‰
===================================================== */
const BUNDLE_URL = "./products_bundle.json";
let products = [];
let baseIdSet = new Set(); // bundleã«å­˜åœ¨ã™ã‚‹ID

const COL_PATCH_UPDATES = "products_patch_updates";
const COL_PATCH_ADDS    = "products_patch_adds";

async function loadProductsFromBundle(){
  const res = await fetch(BUNDLE_URL, { cache: "no-store" });
  if(!res.ok) throw new Error("bundle fetch failed");
  const json = await res.json();
  return (json.products || []).filter(p => p.active !== false);
}

async function loadProductsWithPatch(){
  const base = await loadProductsFromBundle();
  baseIdSet = new Set(base.map(p => p.id));

  // base map
  const map = new Map(base.map(p => [p.id, { ...p }]));

  let updatesCount = 0;
  let addsCount = 0;

  // 1) updates: æ—¢å­˜IDã¸ä¸Šæ›¸ã
  try{
    const snapU = await getDocs(collection(db, COL_PATCH_UPDATES));
    snapU.forEach(d=>{
      const id = d.id;
      const patch = d.data() || {};
      const cur = map.get(id) || { id };
      map.set(id, { ...cur, ...patch, id });
      updatesCount++;
    });
  }catch(e){
    console.warn("patch_updates read failed", e);
  }

  // 2) adds: æ–°è¦å•†å“ã¨ã—ã¦è¿½åŠ 
  try{
    const snapA = await getDocs(collection(db, COL_PATCH_ADDS));
    snapA.forEach(d=>{
      const id = d.id;
      const patch = d.data() || {};
      const cur = map.get(id) || { id };
      // addsã¯ã€Œæ–°è¦å•†å“ã€æ‰±ã„ãªã®ã§ã€baseã«ãªãã¦ã‚‚è¿½åŠ ã•ã‚Œã‚‹
      map.set(id, { ...cur, ...patch, id });
      addsCount++;
    });
  }catch(e){
    console.warn("patch_adds read failed", e);
  }

  // baseé †ã«ä¸¦ã¹ã€æ®‹ã‚Šï¼ˆaddsç”±æ¥ãªã©ï¼‰ã‚’æœ«å°¾ã¸
  const ordered = [];
  for(const p of base){
    const merged = map.get(p.id);
    if(merged && merged.active !== false) ordered.push(merged);
    map.delete(p.id);
  }
  for(const merged of map.values()){
    if(merged.active !== false) ordered.push(merged);
  }

  return { products: ordered, updatesCount, addsCount };
}

/* =====================================================
   UI render
===================================================== */
function renderSettingsUI(){
  $channelSelect.innerHTML = "";
  settings.channels.forEach(v=>{
    const o = document.createElement("option");
    o.value = v; o.textContent = v;
    if(v === settings.currentChannel) o.selected = true;
    $channelSelect.appendChild(o);
  });

  $venueSelect.innerHTML = "";
  settings.venues.forEach(v=>{
    const o = document.createElement("option");
    o.value = v; o.textContent = v;
    if(v === settings.currentVenue) o.selected = true;
    $venueSelect.appendChild(o);
  });

  $paymentSelect.innerHTML = "";
  const payLabelMap = { cash:"ç¾é‡‘", paypay:"PayPay", credit:"ã‚¯ãƒ¬ã‚«", other:"ãã®ä»–" };
  (settings.paymentMethods || ["cash","paypay","credit","other"]).forEach(v=>{
    const o = document.createElement("option");
    o.value = v;
    o.textContent = payLabelMap[v] || v;
    if(v === settings.paymentMethod) o.selected = true;
    $paymentSelect.appendChild(o);
  });

  $paymentSelect.value = settings.paymentMethod;
  $venueWrap.style.display = (settings.currentChannel === "ãƒãƒ«ã‚·ã‚§") ? "inline-flex" : "none";
}

function renderProducts(){
  $products.innerHTML = "";

  products.forEach(p=>{
    const row = document.createElement("div");
    row.className = "product-row";

    const left = document.createElement("div");
    left.className = "product-left";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.dataset.id = p.id;

    const name = document.createElement("div");
    name.className = "product-name";
    name.textContent = p.name;

    const price = document.createElement("span");
    price.className = "product-price";
    price.textContent = `ï¿¥${p.price}`;

    name.appendChild(price);
    left.appendChild(cb);
    left.appendChild(name);

    const qty = document.createElement("div");
    qty.className = "qty";
    const sel = document.createElement("select");
    sel.disabled = true;
    for(let i=1;i<=10;i++){
      const o=document.createElement("option");
      o.value=o.textContent=i;
      sel.appendChild(o);
    }

    cb.addEventListener("change",()=>{
      sel.disabled = !cb.checked;
      updateTotal();
    });
    sel.addEventListener("change", updateTotal);

    qty.appendChild(sel);
    qty.append(" å€‹");

    row.append(left, qty);
    $products.appendChild(row);
  });

  updateTotal();
}

/* =====================================================
   POS logic
===================================================== */
function getSelected(){
  const items = [];
  let total = 0;

  document.querySelectorAll(".product-row").forEach(row=>{
    const cb = row.querySelector("input[type=checkbox]");
    const sel = row.querySelector("select");
    if(!cb.checked) return;

    const p = products.find(x=>x.id===cb.dataset.id);
    const qty = Number(sel.value);
    const subtotal = p.price * qty;

    items.push({
      id: p.id,
      name: p.name,
      unitPrice: p.price,
      qty,
      subtotal
    });
    total += subtotal;
  });

  return { items, total };
}

function updateTotal(){
  const { total } = getSelected();
  $totalText.textContent = `åˆè¨ˆï¼šï¿¥${total}`;
}

function todayYMD(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

/* =====================================================
   Firestore write
===================================================== */
/* =====================================================
   Simple masters (bundle + patch): channels / venues / payments / kinds
===================================================== */
const MASTER_DEFS = {
  channels: { bundleUrl: "./channels_bundle.json", updates: "channels_patch_updates", adds: "channels_patch_adds" },
  venues:   { bundleUrl: "./venues_bundle.json",   updates: "venues_patch_updates",   adds: "venues_patch_adds" },
  payments: { bundleUrl: "./payments_bundle.json", updates: "payments_patch_updates", adds: "payments_patch_adds" },
  kinds:    { bundleUrl: "./kinds_bundle.json",    updates: "kinds_patch_updates",    adds: "kinds_patch_adds" }
};

const masters = { channels: [], venues: [], payments: [], kinds: [] };
const masterBundleIds = { channels: new Set(), venues: new Set(), payments: new Set(), kinds: new Set() };

async function loadSimpleBundle(key){
  const def = MASTER_DEFS[key];
  const res = await fetch(def.bundleUrl, { cache: "no-store" });
  if(!res.ok) throw new Error(`${def.bundleUrl} not found`);
  const json = await res.json();
  const arr = json[key] || json[ key === "payments" ? "paymentMethods" : key ] || [];
  return arr;
}

async function loadSimplePatch(key){
  const def = MASTER_DEFS[key];
  const updatesSnap = await getDocs(collection(db, def.updates));
  const addsSnap    = await getDocs(collection(db, def.adds));

  const updates = {};
  updatesSnap.forEach(d=> updates[d.id] = d.data());

  const adds = [];
  addsSnap.forEach(d=> adds.push({ id: d.id, ...d.data() }));

  return { updates, adds, updatesCount: updatesSnap.size, addsCount: addsSnap.size };
}

async function initSimpleMaster(key){
  const bundle = await loadSimpleBundle(key);
  masterBundleIds[key] = new Set(bundle.map(x=>x.id));

  const patch = await loadSimplePatch(key);

  const merged = bundle.map(x => patch.updates[x.id] ? ({ ...x, ...patch.updates[x.id] }) : x);
  patch.adds.forEach(a => { if(!merged.find(m=>m.id===a.id)) merged.push(a); });

  masters[key] = merged.filter(x => x.active !== false);
  return patch;
}

function fillSelect(sel, arr, currentValue){
  if(!sel) return;
  sel.innerHTML = "";
  arr.forEach(x=>{
    const opt=document.createElement("option");
    opt.value = x.id;
    opt.textContent = x.label ?? x.name ?? x.id;
    if(currentValue && opt.value === currentValue) opt.selected = true;
    sel.appendChild(opt);
  });
}

function applyKindDefault(){
  if(!$kindSelect) return;
  const hasStock = [...$kindSelect.options].some(o=>o.value==="stock");
  if(hasStock) $kindSelect.value = "stock";
  else if($kindSelect.options.length) $kindSelect.selectedIndex = 0;
}

/* Admin: patch summary */

async function refreshPatchSummary(){
  const isAdmin = (currentUserEmail === ADMIN_EMAIL);

  // éç®¡ç†è€…ã¯éè¡¨ç¤º
  if(!isAdmin) {
    if($diffPill) $diffPill.style.display = "none";
    if($diffPop) $diffPop.style.display = "none";
    // æ—§UIã¯ä½¿ã‚ãªã„
    if($patchPill) $patchPill.style.display = "none";
    if($patchPop) $patchPop.style.display = "none";
    return;
  }

  const targets = [
    { key:"products", label:"å•†å“ãƒã‚¹ã‚¿", updates:"products_patch_updates", adds:"products_patch_adds" },
    { key:"channels", label:"è²©å£²æ–¹æ³•ãƒã‚¹ã‚¿", updates:MASTER_DEFS.channels.updates, adds:MASTER_DEFS.channels.adds },
    { key:"venues", label:"é–‹å‚¬å ´æ‰€ãƒã‚¹ã‚¿", updates:MASTER_DEFS.venues.updates, adds:MASTER_DEFS.venues.adds },
    { key:"payments", label:"æ±ºæ¸ˆæ–¹æ³•ãƒã‚¹ã‚¿", updates:MASTER_DEFS.payments.updates, adds:MASTER_DEFS.payments.adds },
    { key:"kinds", label:"kindãƒã‚¹ã‚¿", updates:MASTER_DEFS.kinds.updates, adds:MASTER_DEFS.kinds.adds }
  ];

  // ã¾ãšã¯ã€Œ0ä»¶ã§ã‚‚å‡ºã™ã€ã‚’ä¿è¨¼ï¼ˆèª­ã‚ãªãã¦ã‚‚è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
  let totalUpdates = 0;
  let totalAdds = 0;
  let hadError = false;
  const lines = [];

  if($diffPill){
    $diffPill.textContent = `updates 0 / adds 0`;
    $diffPill.style.display = "inline-flex";
  }

  for(const t of targets){
    let u = 0, a = 0, err = null;

    try{
      u = (await getDocs(collection(db, t.updates))).size;
    }catch(e){
      hadError = true;
      err = e;
    }

    try{
      a = (await getDocs(collection(db, t.adds))).size;
    }catch(e){
      hadError = true;
      err = err || e;
    }

    totalUpdates += u;
    totalAdds += a;

    lines.push({
      label: t.label,
      updates: u,
      adds: a,
      err: err ? (err.code || "error") : null
    });
  }

  // ãƒ˜ãƒƒãƒ€ãƒ¼æ¨ªã®è¡¨ç¤ºï¼ˆ0ä»¶ã§ã‚‚è¡¨ç¤ºï¼‰
  if($diffPill){
    $diffPill.textContent = hadError
      ? `updates ${totalUpdates} / adds ${totalAdds} âš `
      : `updates ${totalUpdates} / adds ${totalAdds}`;
    $diffPill.style.display = "inline-flex";
    $diffPill.title = hadError ? "ä¸€éƒ¨ãƒã‚¹ã‚¿ã®å·®åˆ†readæ¨©é™/æ¥ç¶šã§ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™" : "";
  }

  // å¹ãå‡ºã—å†…è¨³ï¼ˆã‚¨ãƒ©ãƒ¼ãªã‚‰ code ã‚’è¡¨ç¤ºï¼‰
  if($diffPopLines){
    $diffPopLines.innerHTML = lines
      .map(x => {
        const right = x.err ? `ERR(${x.err})` : `u${x.updates} / a${x.adds}`;
        return `<div style="display:flex; justify-content:space-between; gap:10px; padding:4px 0;">
          <span style="opacity:.85">${x.label}</span>
          <span style="font-variant-numeric: tabular-nums;">${right}</span>
        </div>`;
      })
      .join("");
  }

  // æ—§UIï¼ˆç”»é¢å³ä¸‹ï¼‰ã¯éè¡¨ç¤ºã«çµ±ä¸€
  if($patchPill) $patchPill.style.display = "none";
  if($patchPop) $patchPop.style.display = "none";
  if($patchBreakdown){
    $patchBreakdown.innerHTML = lines.map(x=>`
      <div class="row">
        <span>${x.label}</span>
        <span>${x.err ? `ERR(${x.err})` : `updates ${x.updates} / adds ${x.adds}`}</span>
      </div>
    `).join("");
  }
}

async function writeSale(){
  const { items, total } = getSelected();
  if(!items.length) throw new Error("empty");

  const orderDate = ($orderDateInput?.value || "").trim();
  // orderDate: YYYY-MM-DDï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒ‡å®šã—ãŸå—æ³¨æ—¥ï¼‰
  // â€» createdAt ã¯ serverTimestamp ã®ã¾ã¾ã€‚éå»å…¥åŠ›ã—ãŸã„å ´åˆã¯ orderDate ã‚’å‚ç…§ã€‚
  const orderDateMs = orderDate ? new Date(orderDate + "T00:00:00").getTime() : null;

  const kindId = ($kindSelect?.value || "stock");
  const kindLabel = getSelectedLabel($kindSelect);

  const paymentId = $paymentSelect.value;
  const paymentLabel = getSelectedLabel($paymentSelect);

  await addDoc(collection(db,"sales"),{
    createdAt: serverTimestamp(),
    clientCreatedAt: Date.now(),
    orderDate: orderDate || todayYMD(),
    kindId,
    kindLabel,
    orderDateMs: orderDateMs ?? new Date(todayYMD() + "T00:00:00").getTime(),
    channel: settings.currentChannel,
    venue: settings.currentChannel==="ãƒãƒ«ã‚·ã‚§" ? settings.currentVenue : "",
    paymentId,
    paymentLabel,
    // äº’æ›ç”¨ï¼ˆéå»é›†è¨ˆãŒ paymentMethod ã‚’è¦‹ã¦ã„ã‚‹å ´åˆã®ä¿é™ºï¼‰
    paymentMethod: paymentId,
    total,
    items
  });
}

/* =====================================================
   Events
===================================================== */
$checkoutBtn.onclick = ()=>{
  if(!firebaseOk) return;
  const { items, total } = getSelected();
  if(!items.length) return alert("å•†å“ã‚’é¸æŠã—ã¦ã­");

  if($orderDateInput){
    // åˆæœŸå€¤ã¯æœ¬æ—¥ï¼ˆã‚¿ãƒƒãƒ—ã§å¤‰æ›´OKï¼‰
    $orderDateInput.value = todayYMD();
  }
  setReceiptMetaText();
  $receiptList.innerHTML = items.map(
    i=>`${i.name} Ã—${i.qty}ï¼šï¿¥${i.subtotal}`
  ).join("<br>");
  $receiptTotal.textContent = `åˆè¨ˆï¼šï¿¥${total}`;

  $receiptModal.classList.add("show");
};

$confirmBtn.onclick = async ()=>{
  try{
    await writeSale();
    $receiptModal.classList.remove("show");
    showToast("æ±ºæ¸ˆå®Œäº†ğŸŒŸ");
    document.querySelectorAll("input[type=checkbox]").forEach(c=>c.checked=false);
    document.querySelectorAll("select").forEach(s=>{s.disabled=true;s.value=1});
    updateTotal();
  }catch(e){
    alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
};

$closeReceiptBtn.onclick = $cancelBtn.onclick =
  ()=> $receiptModal.classList.remove("show");

if($orderDateInput){
  $orderDateInput.addEventListener("change", setReceiptMetaText);
  if($kindSelect) $kindSelect.addEventListener("change", ()=>{ settings.kind = $kindSelect.value; saveSettings(); });
}


function getSelectedLabel(selectEl){
  const opt = selectEl?.selectedOptions?.[0];
  return opt ? opt.textContent : (selectEl?.value || "");
}
function showToast(msg){
  $toast.textContent = msg;
  $toast.classList.add("show");
  setTimeout(()=> $toast.classList.remove("show"),1200);
}

function setReceiptMetaText(){
  const d = ($orderDateInput?.value || todayYMD());
  const payLabel = getSelectedLabel($paymentSelect);
  $receiptMeta.textContent = `å—æ³¨æ—¥ï¼š${d} / è²©å£²æ–¹æ³•ï¼š${settings.currentChannel} / æ±ºæ¸ˆï¼š${payLabel}`;
}

/* =====================================================
   INIT
===================================================== */
await bootFirebase();

// load simple masters (bundle + patch)
try{
  await initSimpleMaster("channels");
  await initSimpleMaster("venues");
  await initSimpleMaster("payments");
  await initSimpleMaster("kinds");
}catch(e){
  console.warn("masters init failed", e);
}

renderSettingsUI();

// kinds -> kindSelectï¼ˆUIé…ç·šï¼‰
if($kindSelect && masters.kinds?.length){
  fillSelect($kindSelect, masters.kinds);
  applyKindDefault();
}

// settings change handlers
$channelSelect.addEventListener("change", ()=>{
  settings.currentChannel = $channelSelect.value;
  $venueWrap.style.display = (settings.currentChannel === "ãƒãƒ«ã‚·ã‚§") ? "inline-flex" : "none";
  saveSettings();
});
$venueSelect.addEventListener("change", ()=>{
  settings.currentVenue = $venueSelect.value;
  saveSettings();
});
$paymentSelect.addEventListener("change", ()=>{
  settings.paymentMethod = $paymentSelect.value;
  saveSettings();
});

/* =====================================================
   å•†å“ãƒã‚¹ã‚¿ç·¨é›†ï¼ˆupdates/adds patchã¸å·®åˆ†ä¿å­˜ï¼‰
===================================================== */
const $pmToggleBtn = $("pmToggleBtn");
const $pmModal = $("pmModal");
const $pmCloseBtn = $("pmCloseBtn");
const $pmSaveBtn = $("pmSaveBtn");
const $pmDiscardBtn = $("pmDiscardBtn");
const $pmNewBtn = $("pmNewBtn");
const $pmSelect = $("pmSelect");
const $pmId = $("pmId");
const $pmName = $("pmName");
const $pmPrice = $("pmPrice");
const $pmActive = $("pmActive");

let pmDirty = false;
let pmDraft = null; // {id,name,price,active}
let pmOrigin = null;

function pmMarkDirty(){ pmDirty = true; }

function pmOpen(){
  pmDirty = false;
  pmOrigin = null;
  pmDraft = null;
  pmRenderSelect();
  // default select first (placeholderã‚’é™¤ã„ãŸå…ˆé ­)
  if($pmSelect.options.length > 1){
    $pmSelect.selectedIndex = 1;
    pmLoadFromSelect();
  }else{
    $pmSelect.selectedIndex = 0;
    pmSetForm(null);
  }
  $pmModal.classList.add("show");
  if($pmToggleBtn) $pmToggleBtn.textContent = "â“§";
}

function pmClose(force){
  if(!force && pmDirty){
    const ok = confirm("å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ");
    if(ok){
      pmSave(true);
      return;
    }
    // ç ´æ£„ã—ã¦é–‰ã˜ã‚‹
  }
  $pmModal.classList.remove("show");
  if($pmToggleBtn) $pmToggleBtn.textContent = "âœ";
}

function pmRenderSelect(){
  $pmSelect.innerHTML = "";
  // ã€Œæ–°è¦è¿½åŠ ã€æ™‚ã«å¯¾è±¡å•†å“ã‚’ --- è¡¨ç¤ºã«ã§ãã‚‹ã‚ˆã†ã€å…ˆé ­ã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’å…¥ã‚Œã‚‹
  const ph = document.createElement("option");
  ph.value = "";
  ph.textContent = "---";
  $pmSelect.appendChild(ph);

  const list = [...products].sort((a,b)=> (a.id||"").localeCompare(b.id||""));
  for(const p of list){
    const o = document.createElement("option");
    o.value = p.id;
    o.textContent = `${p.id}ï½œ${p.name}ï¼ˆÂ¥${p.price}ï¼‰`;
    $pmSelect.appendChild(o);
  }
}

function pmSetForm(p){
  pmOrigin = p ? { ...p } : null;
  pmDraft = p ? { id: p.id, name: p.name ?? "", price: p.price ?? "", active: (p.active !== false) } : null;
  $pmId.value = pmDraft?.id || "";
  $pmName.value = pmDraft?.name || "";
  $pmPrice.value = (pmDraft?.price ?? "") + "";
  $pmActive.value = (pmDraft?.active ? "true" : "false");
}

function pmLoadFromSelect(){
  const id = $pmSelect.value;
  if(!id){
    pmSetForm(null);
    return;
  }
  const p = products.find(x => x.id === id);
  pmSetForm(p);
}

function pmNextId(){
  let max = 0;
  for(const p of products){
    const m = String(p.id||"").match(/^p(\d{3})$/);
    if(m) max = Math.max(max, parseInt(m[1],10));
  }
  return "p" + String(max+1).padStart(3,"0");
}

$pmSelect.addEventListener("change", ()=>{
  pmLoadFromSelect();
});

[$pmName,$pmPrice,$pmActive].forEach(el=>{
  el.addEventListener("input", pmMarkDirty);
  el.addEventListener("change", pmMarkDirty);
});

$pmNewBtn.addEventListener("click", ()=>{
  const id = pmNextId();
  pmSetForm({ id, name:"", price:"", active:true });
  // æ–°è¦è¿½åŠ ã¯ã€Œç·¨é›†å¯¾è±¡å•†å“ã€ã‚’é¸ã‚“ã çŠ¶æ…‹ã«ã—ãªã„
  $pmSelect.value = "";
  pmDirty = true;
});

async function pmSave(closeAfter){
  if(!pmDraft) return;

  const id = $pmId.value.trim();
  const name = $pmName.value.trim();
  const price = parseInt(($pmPrice.value||"").toString().replace(/[^0-9]/g,""), 10);
  const active = ($pmActive.value === "true");

  if(!id){
    alert("IDãŒä¸æ­£ã§ã™");
    return;
  }
  if(!name){
    alert("å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }
  if(!Number.isFinite(price)){
    alert("ä¾¡æ ¼ã‚’æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  try{
    // å·®åˆ†ã¨ã—ã¦ä¿å­˜ï¼ˆbundleã¯å¾Œã§ç®¡ç†è€…ãŒæ›´æ–°ï¼‰
    const targetCol = baseIdSet.has(id) ? COL_PATCH_UPDATES : COL_PATCH_ADDS;

    await setDoc(doc(db, targetCol, id), {
      name,
      price,
      active,
      updatedAt: serverTimestamp(),
      updatedBy: currentUser?.email || ""
    }, { merge: true });

    showToast("ä¿å­˜ã—ã¾ã—ãŸ");

    // ãƒ­ãƒ¼ã‚«ãƒ«è¡¨ç¤ºã‚‚æ›´æ–°ï¼ˆæ¬¡å›ãƒ­ãƒ¼ãƒ‰ã§patchãŒåæ˜ ã•ã‚Œã‚‹ãŒã€ä½“æ„Ÿã®ãŸã‚å³åæ˜ ï¼‰
    const idx = products.findIndex(p => p.id === id);
    const merged = { id, name, price, active };
    if(idx >= 0) products[idx] = { ...products[idx], ...merged };
    else products.push(merged);

    renderProducts();
    pmDirty = false;
    if(closeAfter) pmClose(true);
  }catch(e){
    console.error(e);
    alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™ or é€šä¿¡ã‚’ç¢ºèªï¼‰");
  }
}

$pmSaveBtn.addEventListener("click", ()=> pmSave(true));
$pmDiscardBtn.addEventListener("click", ()=> { pmDirty = false; pmClose(true); });
$pmCloseBtn.addEventListener("click", ()=> pmClose(false));
$pmToggleBtn.addEventListener("click", ()=>{
  if($pmModal.classList.contains("show")) pmClose(false);
  else pmOpen();
});

const loaded = await loadProductsWithPatch();
products = loaded.products;

// è¡¨ç¤ºç”¨ï¼ˆå³ä¸Šãƒ”ãƒ«ãŒã‚ã‚Œã°ï¼‰
const $masterPill = document.getElementById('masterPill');
if($masterPill){
  $masterPill.textContent = `å•†å“ãƒã‚¹ã‚¿ï¼š${products.length}ä»¶ï¼ˆupdates ${loaded.updatesCount} / adds ${loaded.addsCount}ï¼‰`;
}

renderProducts();


/* =====================================================
   Override top selects with masters (if loaded)
===================================================== */
function applyMastersToTopSelects(){
  if(masters.channels?.length) fillSelect($channelSelect, masters.channels, settings.currentChannel);
  if(masters.venues?.length)   fillSelect($venueSelect, masters.venues, settings.currentVenue);
  if(masters.payments?.length) fillSelect($paymentSelect, masters.payments, settings.paymentMethod);

  if($venueWrap) $venueWrap.style.display = ($channelSelect.value === "ãƒãƒ«ã‚·ã‚§") ? "inline-flex" : "none";
}
applyMastersToTopSelects();

/* =====================================================
   Masters modal (patch writer)
===================================================== */
function mastersOpen(){
  if(!$mastersModal) return;
  $mastersModal.classList.add("show");
  $mastersModal.setAttribute("aria-hidden","false");
  buildMasterRows();
}
function mastersClose(){
  if(!$mastersModal) return;
  $mastersModal.classList.remove("show");
  $mastersModal.setAttribute("aria-hidden","true");
}

function buildMasterRows(){
  const key = $masterTypeSelect.value;
  const arr = masters[key] || [];
  $masterRows.innerHTML = "";
  arr.forEach(x => addRow(x.id, (x.label ?? x.name ?? ""), x.active !== false));
}

function addRow(id="", label="", active=true){
  const row = document.createElement("div");
  row.className = "card";
  row.style.padding = "12px";
  row.innerHTML = `
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <span class="label" style="display:inline-flex; align-items:center; gap:8px;">
        id <input class="m_id" style="width:180px" value="${escapeHtml(id)}" placeholder="ä¾‹: marche" />
      </span>
      <span class="label" style="display:inline-flex; align-items:center; gap:8px;">
        è¡¨ç¤º <input class="m_label" style="width:220px" value="${escapeHtml(label)}" placeholder="ä¾‹: ãƒãƒ«ã‚·ã‚§" />
      </span>
      <span class="label" style="display:inline-flex; align-items:center; gap:8px;">
        æœ‰åŠ¹ <input class="m_active" type="checkbox" ${active ? "checked":""} />
      </span>
      <button class="btn m_del" type="button">è¡Œã‚’å‰Šé™¤</button>
    </div>
    <div class="muted" style="margin-top:8px;">â€» åŸºæœ¬ã¯active=falseã§éè¡¨ç¤ºé‹ç”¨ãŒãŠã™ã™ã‚</div>
  `;
  row.querySelector(".m_del").onclick = ()=> row.remove();
  $masterRows.appendChild(row);
}

function escapeHtml(str){
  return (str ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

async function saveMasterRows(){
  const key = $masterTypeSelect.value;
  const def = MASTER_DEFS[key];
  const bundleIds = masterBundleIds[key] || new Set();

  const rows = [...$masterRows.querySelectorAll(".card")].map(card=>{
    const id = card.querySelector(".m_id").value.trim();
    const label = card.querySelector(".m_label").value.trim();
    const active = card.querySelector(".m_active").checked;
    return { id, label, active };
  }).filter(r=>r.id);

  for(const r of rows){
    const collName = bundleIds.has(r.id) ? def.updates : def.adds;
    await setDoc(doc(db, collName, r.id), { label: r.label, active: r.active }, { merge:true });
  }

  await initSimpleMaster(key);
  applyMastersToTopSelects();
  await refreshPatchSummary();
  showToast("ãƒã‚¹ã‚¿ä¿å­˜OK");
}

if($mastersToggleBtn) $mastersToggleBtn.addEventListener("click", mastersOpen);
if($mastersCloseBtn)  $mastersCloseBtn.addEventListener("click", mastersClose);
if($masterTypeSelect) $masterTypeSelect.addEventListener("change", buildMasterRows);
if($masterAddRowBtn)  $masterAddRowBtn.addEventListener("click", ()=>addRow());
if($masterSaveBtn)    $masterSaveBtn.addEventListener("click", async ()=>{
  try{ await saveMasterRows(); }
  catch(e){ console.error(e); alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
});


// admin diff popover (next to status)
if($diffPill){
  $diffPill.addEventListener("click", ()=>{
    const show = ($diffPop.style.display === "none" || $diffPop.style.display === "");
    $diffPop.style.display = show ? "block" : "none";
  });
}
document.addEventListener("click", (e)=>{
  if(!$diffPop || !$diffPill) return;
  if(e.target === $diffPill || $diffPill.contains(e.target)) return;
  if($diffPop.contains(e.target)) return;
  $diffPop.style.display = "none";
});

// admin pill popover
if($patchPill){
  $patchPill.addEventListener("click", ()=>{
    const show = $patchPop.style.display === "none";
    $patchPop.style.display = show ? "block" : "none";
  });
}
document.addEventListener("click", (e)=>{
  if(!$patchPop || !$patchPill) return;
  if(e.target === $patchPill || $patchPill.contains(e.target)) return;
  if($patchPop.contains(e.target)) return;
  $patchPop.style.display = "none";
});
</script>
</body>
</html>
