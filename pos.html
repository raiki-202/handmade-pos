<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="format-detection" content="telephone=no,date=no,address=no,email=no">
  <title>e.nue POS</title>

  <style>
    
/* iOS: 青文字(自動リンク)対策 */
a, a:link, a:visited, a:hover, a:active{
  color: inherit;
  text-decoration:none;
}
*{ -webkit-tap-highlight-color: transparent; }

:root{
      --bg1:#e3ddd4;
      --bg2:#d4ccc1;

      /* 透明感UP（背景が透ける方向） */
      --glass-bg: rgba(255,255,255,.62);
      --glass-bg2: rgba(255,255,255,.48);
      --glass-border: rgba(0,0,0,.06);
      --line-soft: rgba(0,0,0,.10);
      --shadow: 0 18px 45px rgba(0,0,0,.14);

      --text-main:#222;
      --text-sub:#555;
      --muted: rgba(34,34,34,.55);

      --accent:#e18a6a;
      --accent2:#d06463;

      --r:20px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding: 12px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }

    .safe{
      max-width: 980px;
      margin: 0 auto;
    }

    /* ====== glass card ====== */
    .shell{
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 26px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      overflow:hidden;
    }

    /* ===== header ===== */
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 14px 14px 10px;
      border-bottom: 1px dashed var(--line-soft);
    }
    h1{
      margin:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand-main{
      font-family: "Georgia", "Times New Roman", serif;
      font-weight: 700;
      letter-spacing:.08em;
      font-size: 20px;
      line-height:1.1;
    }
    .brand-sub{
      font-size: 11px;
      color: var(--text-sub);
      letter-spacing:.02em;
    }

    .nav{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .nav-btn{
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.70);
      color: var(--text-main);
      padding: 6px 12px;
      font-size: 11px;
      cursor:pointer;
      white-space:nowrap;
      transition: transform .12s ease, background .2s ease, border-color .2s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .nav-btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.82); }

    /* 右上：編集トグル（白黒） */
    .icon-nav{
      width: 34px;
      height: 30px;
      padding: 0;
      justify-content:center;
    }
    .icon-nav svg{
      width: 16px;
      height: 16px;
      stroke: #111;
    }

    .content{ padding: 12px; }

    .section{
      background: rgba(255,255,255,.58);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: var(--r);
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
      overflow:hidden;
    }

    .sectionHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px 10px;
      border-bottom: 1px dashed var(--line-soft);
    }
    .sectionHead h3{
      margin:0;
      font-size: 13px;
      font-weight: 700;
    }
    .sectionHead .sub{
      font-size: 11px;
      color: var(--text-sub);
    }

    /* ===== POS ===== */
    .posBody{ padding: 12px; }
    .row2{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .label{
      font-size: 11px;
      color: var(--text-sub);
      display:flex;
      gap:6px;
      align-items:center;
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 999px;
      padding: 6px 10px;
    }
    select, input{
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.85);
      padding: 8px 10px;
      font-size: 13px;
      outline:none;
    }

    .products{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .product-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border: 1px solid rgba(0,0,0,.06);
      background: rgba(255,255,255,.78);
      border-radius: 14px;
    }
    .product-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
      flex: 1;
    }
    .product-name{
      font-size: 13px;
      font-weight: 600;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .product-price{
      font-size: 12px;
      color: var(--text-sub);
      margin-left: 6px;
      font-weight: 500;
    }
    .qty{
      display:flex;
      align-items:center;
      gap:6px;
      flex: 0 0 auto;
    }
    .qty select{ padding: 6px 8px; border-radius: 10px; }

    .primary{
      margin-top: 10px;
      width:100%;
      border:0;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(225,138,106,.95), rgba(208,100,99,.95));
      color:#fff;
      font-weight: 800;
      padding: 12px 14px;
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,.14);
    }
    .primary:active{ transform: translateY(1px); }
    .primary[disabled]{ opacity:.55; cursor:not-allowed; transform:none; }

    .total{
      margin-top: 8px;
      font-size: 13px;
      color: var(--text-main);
      font-weight: 800;
      text-align:right;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.85);
      font-size: 12px;
      font-weight: 700;
      color: var(--text-sub);
      white-space:nowrap;
    }

    /* ===== edit mode ===== */
    .edit-only{ display:none; }
    body.edit-mode .edit-only{ display:inline-flex; }
    body.edit-mode .sale-only{ display:none !important; }

    .editRow{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .miniBtn{
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.85);
      padding: 6px 10px;
      font-size: 11px;
      font-weight: 800;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .miniBtn.primaryMini{
      border:0;
      color:#fff;
      background: linear-gradient(135deg, rgba(34,34,34,.95), rgba(34,34,34,.92));
    }
    .badge{
      font-size:10px;
      font-weight:900;
      padding: 3px 7px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.85);
      color: var(--text-sub);
    }
    .editFields{
      display:flex;
      gap:8px;
      align-items:center;
      min-width:0;
      flex:1;
    }
    .editFields input[type="text"]{ flex:1; min-width:0; }
    .editFields input[type="number"]{ width:110px; }

    .toggle{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size: 11px;
      color: var(--text-sub);
      white-space:nowrap;
      user-select:none;
    }

    /* ===== modal ===== */
    .modal{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
      background: rgba(0,0,0,.32);
      z-index: 999;
    }
    .modal.show{ display:flex; }
    .modalInner{
      width: min(560px, 100%);
      background: rgba(255,255,255,.88);
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 22px;
      box-shadow: 0 18px 45px rgba(0,0,0,.22);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px 10px;
      border-bottom: 1px dashed var(--line-soft);
    }
    .modalHead h3{ margin:0; font-size: 13px; font-weight: 800; }
    .iconBtn{
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.85);
      border-radius: 999px;
      padding: 6px 10px;
      cursor:pointer;
      font-size: 12px;
      font-weight: 800;
    }
    .modalBody{ padding: 12px; }
    .muted{ color: var(--text-sub); font-size: 11px; }

    .btnRow{
      display:flex;
      gap:8px;
      margin-top: 12px;
    }
    .btn{
      flex:1;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.85);
      padding: 10px 12px;
      font-weight: 800;
      cursor:pointer;
    }
    .btn.primaryBtn{
      border:0;
      background: linear-gradient(135deg, rgba(225,138,106,.95), rgba(208,100,99,.95));
      color:#fff;
    }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }

    /* toast */
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 999px;
      padding: 10px 14px;
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      font-size: 12px;
      font-weight: 800;
      color: var(--text-main);
      display:none;
      z-index: 2000;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .toast.show{ display:block; }

    @media (max-width: 600px){
      body{ padding: 10px; }
      .brand-main{ font-size: 18px; }
    }
  </style>
</head>

<body>
  <div class="safe">
    <div class="shell">
      <div class="topbar">
        <h1>
          <span class="brand-main">e.nue</span>
          <span class="brand-sub">POS / Firestoreへ売上を保存</span>
        </h1>

        <div class="nav">
          <a class="nav-btn" href="index.html" aria-label="戻る">← 戻る</a>
          <button class="nav-btn" id="envToggleBtn" type="button" aria-label="環境切替">環境：切替</button>

          <!-- 編集トグル：✏️/×（白黒アイコン） -->
          <button class="nav-btn icon-nav" id="editToggleBtn" type="button" aria-label="編集切替" title="編集">
            <!-- pencil -->
            <svg id="iconPencil" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 20h9"/>
              <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/>
            </svg>
            <!-- x (hidden by default) -->
            <svg id="iconX" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;">
              <path d="M18 6 6 18"/>
              <path d="M6 6l12 12"/>
            </svg>
          </button>

          <button class="nav-btn edit-only" id="saveEditBtn" type="button" aria-label="保存して終了">保存</button>

          <span class="pill" id="statusPill">未接続</span>
        </div>
      </div>

      <div class="content">
        <div class="section">
          <div class="sectionHead">
            <div>
              <h3>POS</h3>
              <div class="sub">販売方法 / 決済方法 / 購入商品 → Firestoreへ送信</div>
            </div>

            <div class="editRow">
              <button class="miniBtn edit-only" id="addProductBtn" type="button" style="display:none;">＋商品追加</button>
              <span class="pill" id="masterPill">商品マスタ：読込中</span>
            </div>
          </div>

          <div class="posBody">
            <div class="row2 sale-only">
              <span class="label">
                販売方法
                <select id="channelSelect"></select>
              </span>

              <span class="label" id="venueWrap" style="display:none;">
                開催場所
                <select id="venueSelect"></select>
              </span>

              <span class="label">
                決済方法
                <select id="paymentSelect">
                  <option value="現金">現金</option>
                  <option value="PayPay">PayPay</option>
                  <option value="クレカ">クレカ</option>
                  <option value="その他">その他</option>
                </select>
              </span>
            </div>

            <div class="products" id="products"></div>

            <button class="primary sale-only" id="checkoutBtn" type="button" disabled>決済へ進む</button>
            <div class="total sale-only" id="totalText">合計：￥0</div>

            <div class="muted edit-only" style="margin-top:10px;">
              ※ 編集モード中は販売UIを停止しています。<br>
              ※ 保存すると <b>products_patch_updates</b> / <b>products_patch_adds</b> に差分が作成されます。
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Receipt Modal -->
  <div class="modal" id="receiptModal" aria-hidden="true">
    <div class="modalInner">
      <div class="modalHead">
        <h3>レシート確認</h3>
        <button class="iconBtn" id="closeReceiptBtn" type="button">×</button>
      </div>
      <div class="modalBody">
        <div class="muted" id="receiptMeta"></div>
        <div id="receiptList" style="margin-top:10px;"></div>
        <div id="receiptOptionLine" style="margin-top:8px; font-weight:900; display:none;"></div>
        <div style="font-weight:900; margin-top:10px;" id="receiptTotal"></div>

        <!-- order / shipping (マルシェ以外のときだけ表示) -->
        <div id="receiptOrderRow" style="display:none; margin-top:12px; padding:12px; border:1px solid rgba(0,0,0,.08); border-radius:16px; background: rgba(255,255,255,.75);">
          <label style="display:flex; gap:10px; align-items:center; font-weight:900;">
            <input id="receiptOrderCheck" type="checkbox" style="width:18px; height:18px;">
            orderとして登録する
          </label>

          <div id="receiptShipOptions" style="display:none; margin-top:10px;">
            <div class="muted" style="margin-bottom:8px;">発送オプション</div>
            <label style="display:flex; gap:10px; align-items:center; font-weight:900; margin-bottom:8px;">
              <input type="radio" name="shipOpt" value="3d" checked>
              3日以内　¥700
            </label>
            <label style="display:flex; gap:10px; align-items:center; font-weight:900; margin-bottom:8px;">
              <input type="radio" name="shipOpt" value="5d">
              5日以内　¥500
            </label>
            <label style="display:flex; gap:10px; align-items:center; font-weight:900;">
              <input type="radio" name="shipOpt" value="none">
              指定なし　¥300
            </label>
          </div>
        </div>


        <div class="btnRow">
          <button class="btn" id="cancelBtn" type="button">キャンセル</button>
          <button class="btn primaryBtn" id="confirmBtn" type="button">確定（Firestoreへ保存）</button>
        </div>

        <div class="muted" style="margin-top:10px;">
          ※ createdAt は serverTimestamp（サーバー時刻）で保存します。<br>
          ※ clientCreatedAt も一緒に保存します（端末時刻 / 保険）。
        </div>
      </div>
    </div>
  </div>

  <!-- Add Product Modal -->
  <div class="modal" id="addModal" aria-hidden="true">
    <div class="modalInner">
      <div class="modalHead">
        <h3>商品追加</h3>
        <button class="iconBtn" id="closeAddBtn" type="button">×</button>
      </div>
      <div class="modalBody">
        <div class="row2" style="gap:10px;">
          <span class="label" style="flex:1;">
            商品名
            <input id="addName" type="text" placeholder="例：バンダナ" />
          </span>
          <span class="label">
            価格
            <input id="addPrice" type="number" inputmode="numeric" placeholder="1500" />
          </span>
        </div>
        <div class="btnRow">
          <button class="btn" id="addCancelBtn" type="button">キャンセル</button>
          <button class="btn primaryBtn" id="addOkBtn" type="button">追加</button>
        </div>
        <div class="muted" style="margin-top:10px;">
          ※ 追加は <b>products_patch_adds</b> に保存されます（管理者が後でbundleに取り込み）。
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">保存しました</div>

<script type="module">
/* =====================================================
   Firebase imports
===================================================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  doc,
  setDoc,
  writeBatch,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

import {
  getAuth,
  onAuthStateChanged,
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

/* =====================================================
   Firebase config（dev / prod 切替）
   - dev（デフォ）：pos.html
   - 本番：        pos.html?env=prod
===================================================== */
const firebaseConfigDev = {
  apiKey: "AIzaSyCINAN5ciYMvKhnrm7thQ8mhK1rL8KQu_o",
  authDomain: "handmade-pos-dev.firebaseapp.com",
  projectId: "handmade-pos-dev",
  storageBucket: "handmade-pos-dev.firebasestorage.app",
  messagingSenderId: "772649201782",
  appId: "1:772649201782:web:ea509be21b4b8c53a66f57",
};

const firebaseConfigProd = {
  apiKey: "AIzaSyAhPCgPoJK6S6BWVcBZOruYqMPXVQXQFRk",
  authDomain: "handmade-pos.firebaseapp.com",
  projectId: "handmade-pos",
  storageBucket: "handmade-pos.firebasestorage.app",
  messagingSenderId: "174873514252",
  appId: "1:174873514252:web:c26659bffca850d475f929",
  measurementId: "G-3F8BYRBXDC"
};

// =====================
// 管理者だけに見せたいUI（環境切替・接続表示）
// =====================
// 本番でログインできる管理者の UID か Email を入れてね（どちらか一致でOK）
const ADMIN_UIDS = [
  "Zs33k2rRFJXEUPxMU09ILRBXOpk1",
];
const ADMIN_EMAILS = [
  "enue_staff03@management.com",
];

function isAdminUser(user){
  if(!user) return false;
  const uidOk = ADMIN_UIDS.includes(user.uid);
  const mail = (user.email || "").toLowerCase();
  const mailOk = mail && ADMIN_EMAILS.map(x=>x.toLowerCase()).includes(mail);
  return uidOk || mailOk;
}

const env = new URLSearchParams(location.search).get("env") === "prod" ? "prod" : "dev";
const firebaseConfig = (env === "prod") ? firebaseConfigProd : firebaseConfigDev;

/* =====================================================
   DOM helpers
===================================================== */
const $ = (id) => document.getElementById(id);

const $statusPill   = $("statusPill");

function applyRoleUI(isAdmin){
  // 非管理者：環境切替と接続表示を隠す（常に本番用として使う）
  if(!isAdmin){
    if($envToggleBtn) $envToggleBtn.style.display = "none";
    if($statusPill) $statusPill.style.display = "none";
  }else{
    if($envToggleBtn) $envToggleBtn.style.display = "";
    if($statusPill) $statusPill.style.display = "";
  }
}

const $masterPill   = $("masterPill");
const $envToggleBtn = $("envToggleBtn");

const $editToggleBtn = $("editToggleBtn");
const $saveEditBtn   = $("saveEditBtn");
const $iconPencil    = $("iconPencil");
const $iconX         = $("iconX");
const $addProductBtn = $("addProductBtn");

const $channelSelect = $("channelSelect");
const $venueSelect   = $("venueSelect");
const $venueWrap     = $("venueWrap");
const $paymentSelect = $("paymentSelect");

const $products   = $("products");
const $totalText  = $("totalText");
const $checkoutBtn = $("checkoutBtn");

const $receiptModal = $("receiptModal");
const $receiptMeta  = $("receiptMeta");
const $receiptList  = $("receiptList");
const $receiptTotal = $("receiptTotal");
const $closeReceiptBtn = $("closeReceiptBtn");
const $cancelBtn = $("cancelBtn");
const $confirmBtn = $("confirmBtn");
const $receiptOrderRow = $("receiptOrderRow");
const $receiptOrderCheck = $("receiptOrderCheck");
const $receiptShipOptions = $("receiptShipOptions");


const $toast = $("toast");

// receipt total calc (base items total + option fee)
let receiptBaseTotal = 0;
let receiptOptionFee = 0;


/* add modal */
const $addModal = $("addModal");
const $closeAddBtn = $("closeAddBtn");
const $addCancelBtn = $("addCancelBtn");
const $addOkBtn = $("addOkBtn");
const $addName = $("addName");
const $addPrice = $("addPrice");

/* =====================================================
   Firebase init
===================================================== */
let db = null;
let auth = null;
let firebaseOk = false;

function setStatus(ok, text){
  firebaseOk = ok;
  const envLabel = (env === "prod") ? "PROD" : "DEV";
  $statusPill.textContent = `${envLabel} / ${text}`;
  $envToggleBtn.textContent = `環境：${envLabel}（切替）`;
  $checkoutBtn.disabled = !ok;
}

function bootFirebase(){
  try{
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);

    // Authは本番で使う想定。DEVは未設定でもOK（uidが取れなければ "no-auth" に落とす）
    try{
      auth = getAuth(app);
    }catch(_){
      auth = null;
    }

    setStatus(true, "Firestore接続OK");
  }catch(e){
    console.error(e);
    setStatus(false, "Firestore未接続");
    alert("Firebase初期化に失敗しました");
  }
}

function getActor(){
  return auth?.currentUser?.uid || "no-auth";
}

/* =====================================================
   Settings
===================================================== */
const LS_SETTINGS_KEY = "pos_settings_v2";

const defaultSettings = {
  channels: ["マルシェ", "インスタグラム", "ストーリー販売", "onlinestore"],
  venues: ["cafe1400"],
  currentChannel: "マルシェ",
  currentVenue: "cafe1400",
  paymentMethod: "現金",
};

function loadSettings(){
  try{
    const raw = localStorage.getItem(LS_SETTINGS_KEY);
    return raw ? { ...defaultSettings, ...JSON.parse(raw) } : structuredClone(defaultSettings);
  }catch{
    return structuredClone(defaultSettings);
  }
}
function saveSettings(){
  localStorage.setItem(LS_SETTINGS_KEY, JSON.stringify(settings));
}

let settings = loadSettings();

// migrate channels (add new channel if not present)
if(!Array.isArray(settings.channels)) settings.channels = ["マルシェ","インスタグラム","ストーリー販売","onlinestore"];
if(!settings.channels.includes("ストーリー販売")) settings.channels.splice(2, 0, "ストーリー販売");
saveSettings();


/* =====================================================
   商品マスタ（bundle + patch）
===================================================== */
const BUNDLE_URL = "./products_bundle.json";

/**
 * 表示に使う“確定後の一覧”（bundle+patch反映済み）
 */
let products = [];

/**
 * 編集モード用ドラフト
 * - draftBase: 既存商品の編集値（id -> {name, price, active}）
 * - draftAdds: 追加商品（[{tempKey,name,price,active}]）
 * - baseSnapshot: 編集前の products を覚えておく（差分計算に使う）
 */
let isEditMode = false;
let baseSnapshot = [];
let draftBase = new Map();
let draftAdds = [];

async function loadProductsFromBundle(){
  const res = await fetch(BUNDLE_URL, { cache: "no-store" });
  if(!res.ok) throw new Error("bundle fetch failed");
  const json = await res.json();
  return (json.products || []);
}

/**
 * patch schema:
 * - updates: products_patch_updates/{productId}
 * - adds:    products_patch_adds/{autoId}
 */
async function loadProductsWithPatch(){
  const base = await loadProductsFromBundle();

  // base map
  const map = new Map(base.map(p => [p.id, { ...p }]));
  let patchUpdateCount = 0;
  let patchAddCount = 0;

  // updates
  try{
    const snap = await getDocs(collection(db, "products_patch_updates"));
    snap.forEach(d=>{
      const id = d.id;
      const patch = d.data() || {};
      const cur = map.get(id) || { id };
      const merged = { ...cur, ...patch, id };
      map.set(id, merged);
      patchUpdateCount++;
    });
  }catch(e){
    console.warn("patch_updates read failed", e);
  }

  // ordered by bundle first
  const ordered = [];
  for(const p of base){
    const merged = map.get(p.id) || p;
    if(merged.active !== false) ordered.push(merged);
    map.delete(p.id);
  }
  // any extra (should be rare)
  for(const merged of map.values()){
    if(merged.active !== false) ordered.push(merged);
  }

  // adds (append)
  try{
    const addSnap = await getDocs(collection(db, "products_patch_adds"));
    addSnap.forEach(d=>{
      const a = d.data() || {};
      if(a.active === false) return;
      ordered.push({
        id: a.tempKey || d.id,     // 表示用id（決済では使わない/編集用）
        name: a.name || "(no name)",
        price: Number(a.price || 0),
        active: a.active !== false,
        _isPatchedAdd: true,
        _addDocId: d.id,
        tempKey: a.tempKey || d.id,
      });
      patchAddCount++;
    });
  }catch(e){
    console.warn("patch_adds read failed", e);
  }

  return { products: ordered, patchUpdateCount, patchAddCount };
}

/* =====================================================
   UI render
===================================================== */
function renderSettingsUI(){
  $channelSelect.innerHTML = "";
  settings.channels.forEach(v=>{
    const o = document.createElement("option");
    o.value = v; o.textContent = v;
    if(v === settings.currentChannel) o.selected = true;
    $channelSelect.appendChild(o);
  });

  $venueSelect.innerHTML = "";
  settings.venues.forEach(v=>{
    const o = document.createElement("option");
    o.value = v; o.textContent = v;
    if(v === settings.currentVenue) o.selected = true;
    $venueSelect.appendChild(o);
  });

  $paymentSelect.value = settings.paymentMethod;
  $venueWrap.style.display = (settings.currentChannel === "マルシェ") ? "inline-flex" : "none";
}

function setEditIcon(){
  if(isEditMode){
    $iconPencil.style.display = "none";
    $iconX.style.display = "block";
    document.body.classList.add("edit-mode");
  }else{
    $iconPencil.style.display = "block";
    $iconX.style.display = "none";
    document.body.classList.remove("edit-mode");
  }
}

function enterEditMode(){
  $addProductBtn.style.display = "inline-flex";
  isEditMode = true;
  baseSnapshot = products.map(p => ({...p})); // shallow copy

  draftBase = new Map();
  for(const p of products){
    // patch_adds は“既存編集”対象外（管理者取り込み待ち扱い）
    if(p._isPatchedAdd) continue;
    draftBase.set(p.id, {
      id: p.id,
      name: p.name,
      price: Number(p.price),
      active: p.active !== false,
    });
  }
  draftAdds = [];

  setEditIcon();
  renderProducts();
}

function exitEditModeWithoutSave(){
  $addProductBtn.style.display = "none";
  isEditMode = false;
  baseSnapshot = [];
  draftBase = new Map();
  draftAdds = [];
  setEditIcon();
  renderProducts();
}

async function exitEditModeWithSave(){
  $addProductBtn.style.display = "none";
  try{
    await savePatchesFromDraft();
    showToast("保存しました");
  }catch(e){
    console.error(e);
    alert("保存に失敗しました（rules/authを確認してね）");
    return; // 失敗時は編集モード継続
  }

  isEditMode = false;
  baseSnapshot = [];
  draftBase = new Map();
  draftAdds = [];
  setEditIcon();

  // patch反映後の表示へ更新
  await reloadProducts();
}

/* =====================================================
   Render products (sale or edit)
===================================================== */
function renderProducts(){
  $products.innerHTML = "";

  if(!isEditMode){
    // sale mode
    products
      .filter(p => p.active !== false)
      .forEach(p=>{
        // patch_adds も売る可能性あるならここで表示OK（今回は“本番”なので表示する）
        const row = document.createElement("div");
        row.className = "product-row";

        const left = document.createElement("div");
        left.className = "product-left";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.dataset.id = p.id;
        cb.disabled = false; // 追加品もそのまま販売OK

        const name = document.createElement("div");
        name.className = "product-name";
        name.textContent = p.name;

        const price = document.createElement("span");
        price.className = "product-price";
        price.textContent = `￥${Number(p.price)}`;

        name.appendChild(price);

        if(p._isPatchedAdd){
          const b = document.createElement("span");
          b.className = "badge";
          b.textContent = "NEW";
          name.appendChild(document.createTextNode(" "));
          name.appendChild(b);
        }

        left.appendChild(cb);
        left.appendChild(name);

        const qty = document.createElement("div");
        qty.className = "qty";
        const sel = document.createElement("select");
        sel.disabled = true;
        for(let i=1;i<=10;i++){
          const o=document.createElement("option");
          o.value=o.textContent=i;
          sel.appendChild(o);
        }

        cb.addEventListener("change",()=>{
          sel.disabled = !cb.checked;
          updateTotal();
        });
        sel.addEventListener("change", updateTotal);

        qty.appendChild(sel);
        qty.append(" 個");

        row.append(left, qty);
        $products.appendChild(row);
      });

    updateTotal();
    return;
  }

  // edit mode (edit-only screen)
  // existing products
  for(const [id, d] of draftBase.entries()){
    const row = document.createElement("div");
    row.className = "product-row";

    const left = document.createElement("div");
    left.className = "product-left";
    left.style.gap = "8px";

    const fields = document.createElement("div");
    fields.className = "editFields";

    const name = document.createElement("input");
    name.type = "text";
    name.value = d.name;
    name.placeholder = "商品名";
    name.addEventListener("input", ()=>{
      d.name = name.value;
    });

    const price = document.createElement("input");
    price.type = "number";
    price.inputMode = "numeric";
    price.value = Number(d.price);
    price.placeholder = "価格";
    price.addEventListener("input", ()=>{
      d.price = Number(price.value);
    });

    fields.appendChild(name);
    fields.appendChild(price);

    const right = document.createElement("div");
    right.className = "qty";

    const label = document.createElement("label");
    label.className = "toggle";
    const active = document.createElement("input");
    active.type = "checkbox";
    active.checked = d.active !== false;
    active.addEventListener("change", ()=>{
      d.active = active.checked;
    });
    label.appendChild(active);
    label.appendChild(document.createTextNode(" 表示"));

    right.appendChild(label);

    left.appendChild(fields);
    row.append(left, right);
    $products.appendChild(row);
  }

  // adds
  for(const a of draftAdds){
    const row = document.createElement("div");
    row.className = "product-row";

    const left = document.createElement("div");
    left.className = "product-left";
    const b = document.createElement("span");
    b.className = "badge";
    b.textContent = "追加";
    left.appendChild(b);

    const fields = document.createElement("div");
    fields.className = "editFields";

    const name = document.createElement("input");
    name.type = "text";
    name.value = a.name;
    name.placeholder = "商品名";
    name.addEventListener("input", ()=> a.name = name.value);

    const price = document.createElement("input");
    price.type = "number";
    price.inputMode = "numeric";
    price.value = Number(a.price);
    price.placeholder = "価格";
    price.addEventListener("input", ()=> a.price = Number(price.value));

    fields.appendChild(name);
    fields.appendChild(price);

    left.appendChild(fields);

    const right = document.createElement("div");
    right.className = "qty";
    const del = document.createElement("button");
    del.type = "button";
    del.className = "miniBtn";
    del.textContent = "削除";
    del.addEventListener("click", ()=>{
      draftAdds = draftAdds.filter(x=>x !== a);
      renderProducts();
    });
    right.appendChild(del);

    row.append(left, right);
    $products.appendChild(row);
  }
}

/* =====================================================
   POS logic
===================================================== */
function getSelected(){
  const items = [];
  let total = 0;

  document.querySelectorAll(".product-row").forEach(row=>{
    const cb = row.querySelector('input[type="checkbox"]');
    const sel = row.querySelector("select");
    if(!cb || !sel) return;
    if(!cb.checked) return;

    const p = products.find(x=>x.id===cb.dataset.id);
    if(!p) return;

    const qty = Number(sel.value);
    const subtotal = Number(p.price) * qty;

    items.push({
      id: p.id,
      name: p.name,
      unitPrice: Number(p.price),
      qty,
      subtotal
    });
    total += subtotal;
  });

  return { items, total };
}

function updateTotal(){
  const { total } = getSelected();
  $totalText.textContent = `合計：￥${total}`;
}

/* =====================================================
   Firestore write (sales)
===================================================== */
async function writeSale(){
  const { items, total } = getSelected();
  if(!items.length) throw new Error("empty");

  // kind（stock/order）は確認画面のチェックで決める（マルシェ以外のみUI表示）
  const isOrder = ($receiptOrderRow && $receiptOrderRow.style.display !== "none" && $receiptOrderCheck)
    ? !!$receiptOrderCheck.checked
    : false;

  let shippingOption = "";
  let shippingFee = 0;
  if(isOrder){
    const opt = document.querySelector('input[name="shipOpt"]:checked');
    shippingOption = opt ? opt.value : "3d";
    shippingFee = (shippingOption==="3d") ? 700
                : (shippingOption==="5d") ? 500
                : 300;
  }

  // 進捗：マルシェ以外は未着手で開始（あとでこのページで進捗管理・集計する）
  const progress = (settings.currentChannel !== "マルシェ")
    ? "未着手"
    : "";

  // オプション料金（orderのみ）を合計に加算
  const optionFee = shippingFee;
  const grandTotal = total + optionFee;

  await addDoc(collection(db,"sales"),{
    createdAt: serverTimestamp(),
    clientCreatedAt: Date.now(),
    channel: settings.currentChannel,
    venue: settings.currentChannel==="マルシェ" ? settings.currentVenue : "",
    paymentMethod: $paymentSelect.value,
    baseTotal: total,
    optionFee,
    total: grandTotal,
    items,

    // 将来の管理用
    // progressの許容値（将来の管理画面側で選択UIに反映）:
    // - order: 未着手 / 作成中 / 完了
    // - stock: 未着手 / 進行中 / 完了

    kind: isOrder ? "order" : "stock",
    progress,                // 未着手 / 進行中 / 完了（初期は未着手）
    shippingOption,          // 3d / 5d / none（orderのみ）
    shippingFee,             // 700 / 500 / 300（orderのみ）
  });
}

/* =====================================================
   Patch write (updates / adds) : schema-fixed
===================================================== */
function diffUpdate(before, after){
  const diff = {};
  if(before.name !== after.name) diff.name = after.name;
  if(Number(before.price) !== Number(after.price)) diff.price = Number(after.price);
  if((before.active !== false) !== (after.active !== false)) diff.active = after.active !== false;
  return diff;
}

async function savePatchesFromDraft(){
  const actor = getActor();
  const batch = writeBatch(db);

  // updates：差分があるものだけ書く
  const beforeMap = new Map(baseSnapshot.filter(p=>!p._isPatchedAdd).map(p=>[p.id, p]));
  for(const [id, d] of draftBase.entries()){
    const before = beforeMap.get(id);
    if(!before) continue;
    const diff = diffUpdate(before, d);
    const keys = Object.keys(diff);
    if(keys.length === 0) continue;

    const ref = doc(db, "products_patch_updates", id);
    batch.set(ref, {
      op: "update",
      ...diff,
      status: "pending",
      createdBy: actor,
      createdAt: serverTimestamp()
    }, { merge: true });
  }

  // adds：必須2項目が揃ってるものだけ
  for(const a of draftAdds){
    const name = (a.name || "").trim();
    const price = Number(a.price);
    if(!name || !Number.isFinite(price) || price <= 0) continue;

    const tempKey = (a.tempKey || `${name}_${Date.now()}`).replace(/\s+/g,"_");
    const ref = doc(collection(db, "products_patch_adds"));
    batch.set(ref, {
      op: "add",
      tempKey,
      name,
      price,
      active: true,
      status: "pending",
      createdBy: actor,
      createdAt: serverTimestamp()
    });
  }

  await batch.commit();
}

/* =====================================================
   Modal helpers
===================================================== */

function calcOptionFee(){
  // order OFF or UI hidden -> 0
  if(!$receiptOrderRow || $receiptOrderRow.style.display === "none") return 0;
  if(!$receiptOrderCheck || !$receiptOrderCheck.checked) return 0;
  const opt = document.querySelector('input[name="shipOpt"]:checked');
  const v = opt ? opt.value : "3d";
  return (v==="3d") ? 700 : (v==="5d") ? 500 : 300;
}

function updateReceiptUI(){
  receiptOptionFee = calcOptionFee();
  const grand = receiptBaseTotal + receiptOptionFee;

  // total text
  if($receiptTotal){
    $receiptTotal.textContent = (receiptOptionFee > 0)
      ? `合計：￥${grand}（商品￥${receiptBaseTotal} + オプション￥${receiptOptionFee}）`
      : `合計：￥${grand}`;
  }

  // listにオプション行も表示（分かりやすく）
  const optLine = document.getElementById("receiptOptionLine");
  if(optLine){
    optLine.style.display = (receiptOptionFee > 0) ? "" : "none";
    if(receiptOptionFee > 0){
      const opt = document.querySelector('input[name="shipOpt"]:checked');
      const v = opt ? opt.value : "3d";
      const label = (v==="3d") ? "3日以内" : (v==="5d") ? "5日以内" : "指定なし";
      optLine.textContent = `オプション：${label}　￥${receiptOptionFee}`;
    }
  }
}


function showToast(msg){
  $toast.textContent = msg;
  $toast.classList.add("show");
  setTimeout(()=> $toast.classList.remove("show"),1200);
}

function openAddModal(){
  $addName.value = "";
  $addPrice.value = "";
  $addModal.classList.add("show");
  $addName.focus();
}
function closeAddModal(){
  $addModal.classList.remove("show");
}

/* =====================================================
   Events
===================================================== */
$checkoutBtn.onclick = ()=>{
  if(!firebaseOk) return;
  if(isEditMode) return;

  const { items, total } = getSelected();
  if(!items.length) return alert("商品を選択してね");

  $receiptMeta.textContent =
    `販売方法：${settings.currentChannel} / 決済：${$paymentSelect.value}`;
  $receiptList.innerHTML = items.map(
    i=>`${i.name} ×${i.qty}：￥${i.subtotal}`
  ).join("<br>");
  receiptBaseTotal = total;
  updateReceiptUI();

  // マルシェ以外 → order チェック表示（デフォルトOFF）
  if($receiptOrderRow && $receiptOrderCheck && $receiptShipOptions){
    const isNonMarche = settings.currentChannel !== "マルシェ";
    $receiptOrderRow.style.display = isNonMarche ? "" : "none";
    $receiptOrderCheck.checked = false;
    $receiptShipOptions.style.display = "none";
    // ラジオはデフォルト 3d
    const radios = $receiptShipOptions.querySelectorAll('input[name="shipOpt"]');
    radios.forEach(r=> r.checked = (r.value==="3d"));
    updateReceiptUI();
  }

  $receiptModal.classList.add("show");
};

$envToggleBtn.onclick = ()=>{
  // 管理者のみ
  if($envToggleBtn.style.display === "none") return;

  const url = new URL(location.href);
  if(env === "prod"){
    url.searchParams.delete("env");
  }else{
    url.searchParams.set("env","prod");
  }
  location.href = url.toString();
};

$confirmBtn.onclick = async ()=>{
  try{
    await writeSale();
    $receiptModal.classList.remove("show");
    showToast("保存しました");
    document.querySelectorAll(".product-row input[type=checkbox]").forEach(c=>c.checked=false);
    document.querySelectorAll(".product-row select").forEach(s=>{s.disabled=true;s.value=1});
    updateTotal();
  }catch(e){
    alert("保存に失敗しました");
  }
};

$closeReceiptBtn.onclick = $cancelBtn.onclick =
  ()=> $receiptModal.classList.remove("show");

// orderチェック → 発送オプション表示
if($receiptOrderCheck && $receiptShipOptions){
  $receiptOrderCheck.onchange = ()=>{
    $receiptShipOptions.style.display = $receiptOrderCheck.checked ? "" : "none";
    updateReceiptUI();
  };
}
// 発送オプション変更 → 合計をリアルタイム反映
document.addEventListener("change", (e) => {
  if(!e.target) return;
  if(e.target.name === "shipOpt"){
    updateReceiptUI();
  }
});


/* edit toggle */
$editToggleBtn.onclick = ()=>{
  if(!firebaseOk) return;
  if(!isEditMode){
    enterEditMode();
  }else{
    exitEditModeWithoutSave();
  }
};

$saveEditBtn.onclick = async ()=>{
  if(!isEditMode) return;
  await exitEditModeWithSave();
};

/* add product */
$addProductBtn.onclick = ()=>{
  if(!isEditMode) return;
  openAddModal();
};
$closeAddBtn.onclick = $addCancelBtn.onclick = closeAddModal;
$addOkBtn.onclick = ()=>{
  const name = ($addName.value || "").trim();
  const price = Number($addPrice.value);
  if(!name){ alert("商品名を入れてね"); return; }
  if(!Number.isFinite(price) || price <= 0){ alert("価格を正しく入れてね"); return; }

  draftAdds.push({
    tempKey: `${name}_${Date.now()}`.replace(/\s+/g,"_"),
    name,
    price,
    active: true
  });

  closeAddModal();
  renderProducts();
};

/* =====================================================
   INIT
===================================================== */
bootFirebase();

// Auth状態で「管理者判定」→ UI制御（非管理者は本番固定）
if(auth){
  onAuthStateChanged(auth, (user)=>{
    const admin = isAdminUser(user);
    applyRoleUI(admin);

    // 非管理者なのに ?env=dev 等で開いていたら、本番へ戻す
    if(!admin){
      const url = new URL(location.href);
      if(url.searchParams.get("env") && url.searchParams.get("env") !== "prod"){
        url.searchParams.delete("env");
        location.replace(url.toString());
        return;
      }
    }
  });
}else{
  // auth が無い場合は「非管理者扱い」= 本番固定（安全側）
  applyRoleUI(false);
  const url = new URL(location.href);
  if(url.searchParams.get("env") && url.searchParams.get("env") !== "prod"){
    url.searchParams.delete("env");
    location.replace(url.toString());
  }
}

renderSettingsUI();

// =====================
// Settings listeners
// =====================
$channelSelect.addEventListener("change", () => {
  settings.currentChannel = $channelSelect.value;
  // マルシェ以外は開催場所を非表示
  $venueWrap.style.display = (settings.currentChannel === "マルシェ") ? "inline-flex" : "none";
  // venueはマルシェ以外なら空でもいいが、値は保持してOK
  saveSettings();
});

$venueSelect.addEventListener("change", () => {
  settings.currentVenue = $venueSelect.value;
  saveSettings();
});

$paymentSelect.addEventListener("change", () => {
  settings.paymentMethod = $paymentSelect.value;
  saveSettings();
});


async function reloadProducts(){
  const loaded = await loadProductsWithPatch();
  products = loaded.products;

  $masterPill.textContent = `商品マスタ：${products.filter(p=>p.active!==false).length}件（upd ${loaded.patchUpdateCount} / add ${loaded.patchAddCount}）`;
  renderProducts();
}
await reloadProducts();

setEditIcon();
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

/* 本番 */
const firebaseConfig = {
  apiKey: "AIzaSyAhPCgPoJK6S6BWVcBZOruYqMPXVQXQFRk",
  authDomain: "handmade-pos.firebaseapp.com",
  projectId: "handmade-pos",
  storageBucket: "handmade-pos.firebasestorage.app",
  messagingSenderId: "174873514252",
  appId: "1:174873514252:web:c26659bffca850d475f929",
  measurementId: "G-3F8BYRBXDC"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

const pad2 = (n)=> String(n).padStart(2,"0");
const ymd = (d)=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

function toMillis(ts){
  if(!ts) return 0;
  if(typeof ts === "number") return ts;
  if(ts instanceof Date) return ts.getTime();
  if(ts instanceof Timestamp) return ts.toMillis();
  if(typeof ts === "string"){
    const t = Date.parse(ts);
    return Number.isFinite(t) ? t : 0;
  }
  return 0;
}
function readCalendarCache(){
  try{
    const raw = localStorage.getItem("enue_calendar_cache_v1");
    if(!raw) return null;
    return JSON.parse(raw);
  }catch{ return null; }
}
function isNowInWindow(ev){
  const s = toMillis(ev.startAt);
  const e = toMillis(ev.endAt);
  const n = Date.now();
  return s && e && n>=s && n<=e;
}

/** POS側デフォルト切替：マルシェ/ストーリー中だけ「マルシェ扱い & 現金」 */
function applyDefaultsByActiveEvent(){
  const cache = readCalendarCache() || {};
  const key = ymd(new Date());
  const arr = cache[key] || [];
  const active = arr.find(ev => (ev.type==="marche" || ev.type==="story") && isNowInWindow(ev));
  if(!active) return;

  // ここは POS の実装に合わせて id/name を後で微調整する必要があるかも。
  // よくある要素名を広めに拾う：
  const methodSel = document.querySelector('select[name="salesMethod"], select#salesMethod, select#method, select[name="method"]');
  const paySel    = document.querySelector('select[name="payMethod"], select#payMethod, select#paymentMethod, select[name="paymentMethod"]');

  if(methodSel){
    // ストーリー販売も「イベント扱い」なので、販売方法は "マルシェ" に寄せたい場合はここで固定
    // ただしユーザー要件：ストーリーは販売場所を選ばない → method自体は任意。今回はPOS側UI次第で無理に固定しない。
    // methodSel.value = "マルシェ";
  }
  if(paySel){
    paySel.value = "現金";
    paySel.dispatchEvent(new Event("change", { bubbles:true }));
  }
}

async function loadVenues(){
  // 1) bundle
  let venues = [];
  try{
    const res = await fetch("./venues_bundle.json", { cache:"no-store" });
    if(res.ok){
      const b = await res.json();
      if(Array.isArray(b.venues)) venues = b.venues.slice();
    }
  }catch{}

  // 2) patch (Firestore: venues)
  try{
    const snap = await getDocs(query(collection(db,"venues"), orderBy("updatedAt","desc"), limit(200)));
    snap.forEach(d=>{
      const v = d.data();
      const name = v.name || v.title || "";
      if(!name) return;
      if(!venues.includes(name)) venues.push(name);
    });
  }catch(err){
    console.warn("venues load failed:", err);
  }

  // 3) 反映（POSの販売場所selectを探してoptionsを更新）
  const venueSel = document.querySelector('select[name="venue"], select#venue, select#salesVenue, select[name="salesVenue"]');
  if(!venueSel) return;

  // 既存を壊さないように、見つからない時だけ追加
  const existing = new Set([...venueSel.options].map(o=>o.value));
  for(const v of venues){
    if(existing.has(v)) continue;
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    venueSel.appendChild(opt);
  }
}

applyDefaultsByActiveEvent();
loadVenues();
</script>

</body>
</html>
