<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>e.nue POS (COMPLETE build 2025-12-27)</title>

  <style>
    :root{
      --bg1:#e3ddd4;
      --bg2:#d4ccc1;

      /* 透明感UP（背景が透ける方向） */
      --glass-bg: rgba(255,255,255,.62);
      --glass-bg2: rgba(255,255,255,.48);
      --glass-border: rgba(0,0,0,.06);
      --line-soft: rgba(0,0,0,.10);
      --shadow: 0 18px 45px rgba(0,0,0,.14);

      --text-main:#222;
      --text-sub:#555;
      --muted: rgba(34,34,34,.55);

      --accent:#e18a6a;
      --accent2:#d06463;

      --r:20px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding: 12px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }

    .safe{
      max-width: 980px;
      margin: 0 auto;
    }

    /* ====== glass card ====== */
    .shell{
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 26px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      overflow:hidden;
    }

    /* ===== header ===== */
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 14px 14px 10px;
      border-bottom: 1px dashed var(--line-soft);
    }
    h1{
      margin:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand-main{
      font-family: "Georgia", "Times New Roman", serif;
      font-weight: 700;
      letter-spacing:.08em;
      font-size: 20px;
      line-height:1.1;
    }
    .brand-sub{
      font-size: 11px;
      color: var(--text-sub);
      letter-spacing:.02em;
    }

    .nav{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .nav-btn{
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.70);
      color: var(--text-main);
      padding: 6px 12px;
      font-size: 11px;
      cursor:pointer;
      white-space:nowrap;
      transition: transform .12s ease, background .2s ease, border-color .2s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .nav-btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.82); }

    .content{ padding: 12px; }

    .section{
      background: rgba(255,255,255,.58);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: var(--r);
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
      overflow:hidden;
    }

    .sectionHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px 10px;
      border-bottom: 1px dashed var(--line-soft);
    }
    .sectionHead h3{
      margin:0;
      font-size: 13px;
      font-weight: 700;
    }
    .sectionHead .sub{
      font-size: 11px;
      color: var(--text-sub);
    }

    /* ===== POS ===== */
    .posBody{ padding: 12px; }
    .row2{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .label{
      font-size: 10px;
      color: var(--text-sub);
      display:flex;
      gap:6px;
      align-items:center;
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 999px;
      padding: 4px 8px;
    }
    select, input{
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.85);
      padding: 6px 8px;
      font-size: 12px;
      outline:none;
    }

    .products{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .product-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border: 1px solid rgba(0,0,0,.06);
      background: rgba(255,255,255,.78);
      border-radius: 14px;
    }
    .product-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
      flex: 1;
    }
    .product-name{
      font-size: 13px;
      font-weight: 600;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .product-price{
      font-size: 12px;
      color: var(--text-sub);
      margin-left: 6px;
      font-weight: 500;
    }
    .qty{
      display:flex;
      align-items:center;
      gap:6px;
      flex: 0 0 auto;
    }
    .qty select{ padding: 6px 8px; border-radius: 10px; }

    .primary{
      margin-top: 10px;
      width:100%;
      border:0;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(225,138,106,.95), rgba(208,100,99,.95));
      color:#fff;
      font-weight: 800;
      padding: 12px 14px;
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,.14);
    }
    .primary:active{ transform: translateY(1px); }
    .primary[disabled]{ opacity:.55; cursor:not-allowed; transform:none; }

    .total{
      margin-top: 8px;
      font-size: 13px;
      color: var(--text-main);
      font-weight: 800;
      text-align:right;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.85);
      font-size: 12px;
      font-weight: 700;
      color: var(--text-sub);
      white-space:nowrap;
    }

    /* ===== modal ===== */
    .modal{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
      background: rgba(0,0,0,.32);
      z-index: 999;
    }
    .modal.show{ display:flex; }
    .modalInner{
      width: min(560px, 100%);
      background: rgba(255,255,255,.88);
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 22px;
      box-shadow: 0 18px 45px rgba(0,0,0,.22);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px 10px;
      border-bottom: 1px dashed var(--line-soft);
    }
    .modalHead h3{ margin:0; font-size: 13px; font-weight: 800; }
    .iconBtn{
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.85);
      border-radius: 999px;
      padding: 4px 8px;
      cursor:pointer;
      font-size: 12px;
      font-weight: 800;
    }
    .modalBody{ padding: 12px; }
    .muted{ color: var(--text-sub); font-size: 11px; }

    .btnRow{
      display:flex;
      gap:8px;
      margin-top: 12px;
    }
    .btn{
      flex:1;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.85);
      padding: 10px 12px;
      font-weight: 800;
      cursor:pointer;
    }
    .btn.primaryBtn{
      border:0;
      background: linear-gradient(135deg, rgba(225,138,106,.95), rgba(208,100,99,.95));
      color:#fff;
    }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }

    /* toast */
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 999px;
      padding: 10px 14px;
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      font-size: 12px;
      font-weight: 800;
      color: var(--text-main);
      display:none;
      z-index: 2000;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .toast.show{ display:block; }

    @media (max-width: 600px){
      body{ padding: 10px; }
      .brand-main{ font-size: 18px; }
    }
      /* ===== POS title edit toggle ===== */
    .titleRow{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .titleIcon{
      width: 28px;
      height: 28px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.80);
      cursor:pointer;
      font-size: 14px;
      font-weight: 900;
      line-height: 1;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .titleIcon:active{ transform: translateY(1px); }

    /* ===== settings edit modal ===== */
    .editGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 6px;
    }
    .field{
      background: rgba(255,255,255,.70);
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 16px;
      padding: 10px;
    }
    .fieldTitle{
      font-size: 12px;
      font-weight: 900;
      margin-bottom: 8px;
    }
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.85);
      font-size: 12px;
      font-weight: 800;
    }
    .chip button{
      border:0;
      background: transparent;
      cursor:pointer;
      font-weight: 900;
      font-size: 14px;
      line-height: 1;
      padding: 0 2px;
      color: var(--text-sub);
    }
    .adder{
      display:flex;
      gap:8px;
      margin-top: 8px;
    }
    .adder input{
      flex:1;
    }
  
/* ===== iOS blue text override ===== */
button, 
button:visited,
button:active,
button:focus,
.titleIcon,
.iconBtn,
.btn,
a,
a:visited,
a:active {
  color: #222 !important;
  -webkit-text-fill-color: #222 !important;
}

button {
  -webkit-appearance: none;
  appearance: none;
}

select {
  color: #222;
}


  /* UI: hide top selector row (kept for JS refs) */
  .row2{display:none !important;}


/* ===== iOS Safari: prevent input focus zoom (keep layout) ===== */
@media (max-width: 600px){
  input, select, textarea{
    font-size:16px !important;
  }
}
/* Date inputs in sheets/modals sometimes have own rules */
@media (max-width: 600px){
  input[type="date"], input[type="month"], input[type="datetime-local"]{
    font-size:16px !important;
  }
}

</style>
</head>

<body>
  <div class="safe">
    <div class="shell">
      <div class="topbar">
        <h1>
          <span class="brand-main">e.nue</span>
          <span class="brand-sub">POS / Firestoreへ売上を保存</span>
        </h1>

        <div class="nav">
          <a class="nav-btn" href="index.html" aria-label="戻る">← 戻る</a>
          <span class="pill" id="statusPill">未接続</span>
          <span class="pill" id="diffPill" style="display:none; cursor:pointer;">updates 0 / adds 0</span>
        </div>
      </div>

      <div class="content">
        <div class="section">
          <div class="sectionHead">
            <div>
              <div class="titleRow"><h3 style="margin:0;">POS</h3></div>
              <div class="sub">販売方法 / 決済方法 / 購入商品 → Firestoreへ送信</div>
            </div>
            <span class="pill" id="masterPill" style="display:none"></span>
            <button class="titleIcon" id="mastersToggleBtn" aria-label="マスタ編集" title="マスタ編集">⚙︎</button>
          </div>

          <div class="posBody">
            <div class="row2">
              <span class="label">
                販売方法
                <select id="channelSelect"></select>
              </span>

              <span class="label" id="venueWrap" style="display:none;">
                開催場所
                <select id="venueSelect"></select>
              </span>

              <span class="label">
                決済方法
                <select id="paymentSelect"></select>
              </span>
            </div>

            <div class="products" id="products"></div>

            <button class="primary" id="checkoutBtn" type="button" disabled>決済へ進む</button>
            <div class="total" id="totalText">合計：￥0</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Receipt Modal -->
  <div class="modal" id="receiptModal" aria-hidden="true">
    <div class="modalInner">
      <div class="modalHead">
        <h3>レシート確認</h3>
        <button class="iconBtn" id="closeReceiptBtn" type="button">×</button>
      </div>
      <div class="modalBody">
        <div class="muted" id="receiptMeta"></div>
        <div style="margin-top:10px;">
          <span class="label" style="display:inline-flex; align-items:center; gap:8px;">
            受注日
            <input id="orderDateInput" type="date" />
          </span>
        </div>

        <div style="margin-top:10px;">
          <div class="label">購入者氏名</div>
          <input id="receiptCustomerName" placeholder="例：山田 太郎" />
        </div>
        <div style="margin-top:8px;">
          <label style="display:flex; align-items:center; gap:8px;">
            <input id="receiptIsCorporate" type="checkbox" />
            <span style="font-size:12px; font-weight:800; color: var(--text-sub);">（企業）</span>
          </label>
        </div>


        <div style="margin-top:10px;">
          <span class="label" style="display:inline-flex; align-items:center; gap:8px;">
            販売方法
            <select id="receiptChannelSelect"></select>
          </span>
        </div>

        <div id="receiptVenueWrap" style="margin-top:10px; display:none;">
          <span class="label" style="display:inline-flex; align-items:center; gap:8px;">
            開催場所
            <select id="receiptVenueSelect"></select>
          </span>
        </div>

        <div style="margin-top:10px;">
          <span class="label" style="display:inline-flex; align-items:center; gap:8px;">
            決済方法
            <select id="receiptPaymentSelect"></select>
          </span>
        </div>

        <div style="margin-top:10px;">
          <span class="label" style="display:inline-flex; align-items:center; gap:8px;">
            kind
            <select id="receiptKindSelect"></select>
          </span>
        </div>

        <div id="urgentWrap" style="margin-top:10px; display:none;">
          <span class="label" style="display:inline-flex; align-items:center; gap:8px;">
            お急ぎOP
            <select id="urgentSelect"></select>
          </span>
          <div class="muted" style="margin-top:6px;">※ kind=order のときだけ表示されます</div>
        </div>

        <div id="statusWrap" style="margin-top:10px; display:none;">
          <span class="label" style="display:inline-flex; align-items:center; gap:8px;">
            ステータス
            <select id="statusSelect"></select>
          </span>
          <div class="muted" style="margin-top:6px;">※ kind と販売方法に応じて選択できます（初期値あり）</div>
        </div>
<div id="receiptList" style="margin-top:10px;"></div>
        <div style="font-weight:900; margin-top:10px;" id="receiptTotal"></div>

        <div class="btnRow">
          <button class="btn" id="cancelBtn" type="button">キャンセル</button>
          <button class="btn primaryBtn" id="confirmBtn" type="button">確定（Firestoreへ保存）</button>
        </div>

        <div class="muted" style="margin-top:10px;">
          ※ createdAt は serverTimestamp（サーバー時刻）で保存します。<br>
          ※ clientCreatedAt も一緒に保存します（端末時刻 / 保険）。
        </div>
      </div>
    </div>
  </div>

  <!-- Product Master Edit Modal -->
  <div class="modal" id="pmModal" aria-hidden="true">
    <div class="modalInner">
      <div class="modalHead">
        <h3>商品マスタ（追加・修正）</h3>
        <button class="iconBtn" id="pmCloseBtn" type="button">ⓧ</button>
      </div>
      <div class="modalBody">
        <div class="muted">編集内容は <b>Firestore products_patch_updates / products_patch_adds</b> に差分として保存されます（bundleは管理者が後で更新）。</div>

        <div class="editGrid">
          <div class="field">
            <div class="fieldTitle">対象商品</div>
            <select id="pmSelect"></select>
            <div class="muted" style="margin-top:6px;">※商品を選ぶと下のフォームに反映されます</div>
          </div>

          <div class="field">
            <div class="fieldTitle">編集</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <div>
                <div class="label">ID</div>
                <input id="pmId" disabled />
              </div>
              <div>
                <div class="label">非表示</div>
                <label style="display:flex; align-items:center; gap:8px; margin-top:4px;">
                  <input id="pmHidden" type="checkbox" />
                  <span style="font-size:12px; font-weight:800; color: var(--text-sub);">この商品を非表示にする</span>
                </label>
              </div>
            </div>
            <div style="margin-top:10px;">
              <div class="label">商品名</div>
              <input id="pmName" placeholder="例：バブーシュカ" />
            </div>
            <div style="margin-top:10px;">
              <div class="label">価格</div>
              <input id="pmPrice" inputmode="numeric" placeholder="例：1400" />
            </div>
          </div>
        </div>

        <div class="btnRow">
          <button class="btn" id="pmDiscardBtn" type="button">破棄して閉じる</button>
          <button class="btn primaryBtn" id="pmSaveBtn" type="button">保存して閉じる</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">保存しました</div>


<!-- Master Menu Modal -->
<div class="modal" id="masterMenuModal" aria-hidden="true">
  <div class="modalInner">
    <div class="modalHead">
      <h3 id="mastersTitle">マスタ編集</h3>
      <button class="iconBtn" id="masterMenuCloseBtn" type="button">ⓧ</button>
    </div>
    <div class="modalBody">
      <div class="btnRow" style="flex-direction:column;">
        <button class="btn" id="menuProductMasterBtn" type="button">商品マスタ編集</button>
        <button class="btn" id="menuChannelsMasterBtn" type="button">販売方法マスタ編集</button>
        <button class="btn" id="menuVenuesMasterBtn" type="button">開催場所マスタ編集</button>
        <button class="btn" id="menuPaymentsMasterBtn" type="button">決済方法マスタ編集</button>
        <button class="btn" id="menuKindsMasterBtn" type="button">kindマスタ編集</button>
        <button class="btn" id="menuUrgentOptionsMasterBtn" type="button">お急ぎOPマスタ編集</button>
      </div>
      <div class="muted" style="margin-top:10px;">※ 変更は差分（patch）としてFirestoreに保存されます。</div>
    </div>
  </div>
</div>

<!-- Mode Select Modal (add / edit) -->
<div class="modal" id="masterModeModal" aria-hidden="true">
  <div class="modalInner">
    <div class="modalHead">
      <h3 id="masterModeTitle">編集モード</h3>
      <button class="iconBtn" id="masterModeCloseBtn" type="button">ⓧ</button>
    </div>
    <div class="modalBody">
      <div class="muted" id="masterModeHelp">追加か修正かを選んでください。</div>
      <div class="btnRow" style="margin-top:12px;">
        <button class="btn" id="masterModeAddBtn" type="button">追加</button>
        <button class="btn primaryBtn" id="masterModeEditBtn" type="button">修正</button>
      </div>
    </div>
  </div>
</div>



  <!-- Masters Modal (simple masters: channels/venues/payments/kinds) -->
  <div class="modal" id="mastersModal" aria-hidden="true">
    <div class="modalInner">
      <div class="modalHead">
        <h3>マスタ編集</h3>
        <button class="iconBtn" id="mastersCloseBtn" type="button">ⓧ</button>
      </div>
      <div class="modalBody">
        <div class="muted" style="margin-bottom:10px;">
          ※ ここでの変更は「差分（patch）」としてFirestoreに保存されます。bundle(JSON)はGitHub側。
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <span class="label" style="display:none; align-items:center; gap:8px;">
            対象
            <select id="masterTypeSelect">
              <option value="channels">販売方法マスタ</option>
              <option value="venues">開催場所マスタ</option>
              <option value="payments">決済方法マスタ</option>
              <option value="kinds">kindマスタ</option>
            </select>
          </span>

          <button class="btn btnDanger" id="masterDeleteRowBtn" type="button">行を削除</button>
          <button class="btn" id="masterAddRowBtn" type="button">＋追加</button>
        </div>

        <div id="masterRows" style="margin-top:12px; display:grid; gap:10px;"></div>

        <div class="muted" style="margin-top:10px;">
          ルール：bundleに存在するID → updates、bundleに無いID → adds
        </div>

        <!-- Save button at bottom -->
        <div style="margin-top:14px; display:flex;">
          <button class="btn primaryBtn" id="masterSaveBtn" type="button" style="width:100%; justify-content:center;">
            保存して閉じる
          </button>
        </div>
      </div>
    </div>
  </div>

  
  <!-- Admin diff breakdown (header next to status) -->
  <div id="diffPop" style="display:none; position:fixed; right:18px; top:64px; z-index:60;
    background: rgba(255,255,255,.95); border:1px solid rgba(0,0,0,.08); border-radius:14px;
    padding:10px 12px; box-shadow:0 18px 45px rgba(0,0,0,.14); max-width:280px; font-size:13px; line-height:1.35;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px;">
      <div style="font-weight:700;">差分内訳</div>
      <button id="exportDiffCsvBtn" class="btn" style="padding:6px 10px; font-size:12px; border-radius:10px;">CSV出力</button>
    </div>
    <div id="diffPopLines"></div>
  </div>

<!-- Admin patch summary -->
  <div id="patchPill" class="pill" style="display:none; position:fixed; right:18px; bottom:18px; z-index:50; cursor:pointer;">
    差分：0
  </div>
  <div id="patchPop" style="display:none; position:fixed; right:18px; bottom:62px; z-index:51; background:rgba(255,255,255,.95); border:1px solid rgba(0,0,0,.08); border-radius:14px; padding:12px 14px; box-shadow:0 18px 45px rgba(0,0,0,.14); min-width:220px;">
    <div style="font-weight:800; margin-bottom:6px;">差分内訳</div>
    <div id="patchBreakdown" class="muted"></div>
  </div>
<script type="module">
  console.log("POS COMPLETE build 2025-12-27");
/* =====================================================
   Firebase imports
===================================================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  serverTimestamp,
  doc,
  setDoc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

/* =====================================================
   Firebase config（あなたの dev）
===================================================== */
const firebaseConfig = {
      apiKey: "AIzaSyAhPCgPoJK6S6BWVcBZOruYqMPXVQXQFRk",
      authDomain: "handmade-pos.firebaseapp.com",
      projectId: "handmade-pos",
      storageBucket: "handmade-pos.firebasestorage.app",
      messagingSenderId: "174873514252",
      appId: "1:174873514252:web:c26659bffca850d475f929"
    };

/* =====================================================
   DOM helpers
===================================================== */
const $ = (id) => document.getElementById(id);

const $statusPill   = $("statusPill");
const $channelSelect = $("channelSelect");
const $venueSelect   = $("venueSelect");
const $venueWrap     = $("venueWrap");
const $paymentSelect = $("paymentSelect");

const $products   = $("products");
const $totalText  = $("totalText");
const $checkoutBtn = $("checkoutBtn");

const $receiptModal = $("receiptModal");
const $receiptMeta  = $("receiptMeta");
const $receiptList  = $("receiptList");
const $receiptTotal = $("receiptTotal");
const $orderDateInput = $("orderDateInput");
const $kindSelect = $("receiptKindSelect");
const $urgentWrap = $("urgentWrap");
const $urgentSelect = $("urgentSelect");
const $statusWrap = $("statusWrap");
const $statusSelect = $("statusSelect");
const $receiptChannelSelect = $("receiptChannelSelect");
const $receiptVenueWrap = $("receiptVenueWrap");
const $receiptVenueSelect = $("receiptVenueSelect");
const $receiptPaymentSelect = $("receiptPaymentSelect");
const $receiptCustomerName  = $("receiptCustomerName");
const $receiptIsCorporate   = $("receiptIsCorporate");

const $mastersToggleBtn = $("mastersToggleBtn");
const $masterMenuModal = $("masterMenuModal");
const $masterMenuCloseBtn = $("masterMenuCloseBtn");
const $menuProductMasterBtn = $("menuProductMasterBtn");
const $menuChannelsMasterBtn = $("menuChannelsMasterBtn");
const $menuVenuesMasterBtn = $("menuVenuesMasterBtn");
const $menuPaymentsMasterBtn = $("menuPaymentsMasterBtn");
const $menuKindsMasterBtn = $("menuKindsMasterBtn");
const $menuUrgentOptionsMasterBtn = $("menuUrgentOptionsMasterBtn");

const $masterModeModal = $("masterModeModal");
const $masterModeTitle = $("masterModeTitle");
const $masterModeHelp  = $("masterModeHelp");
const $masterModeCloseBtn = $("masterModeCloseBtn");
const $masterModeAddBtn  = $("masterModeAddBtn");
const $masterModeEditBtn = $("masterModeEditBtn");

let pendingMasterKey = null; // "products" | "channels" | "venues" | "payments" | "kinds"
let pendingMasterLabel = "";
let pendingMasterEditMode = null; // "add" | "edit"
const $mastersModal = $("mastersModal");
const $mastersCloseBtn = $("mastersCloseBtn");
const $mastersTitle = $("mastersTitle");
const $masterTypeSelect = $("masterTypeSelect");
const $masterRows = $("masterRows");
const $masterAddRowBtn = $("masterAddRowBtn");
const $masterDeleteRowBtn = $("masterDeleteRowBtn");
const $masterSaveBtn = $("masterSaveBtn");
const $patchPill = $("patchPill");
const $patchPop = $("patchPop");
const $patchBreakdown = $("patchBreakdown");
const $diffPill = $("diffPill");
const $diffPop = $("diffPop");
const $diffPopLines = $("diffPopLines");
const $exportDiffCsvBtn = $("exportDiffCsvBtn");

if($exportDiffCsvBtn){
  $exportDiffCsvBtn.addEventListener("click", async (e)=>{
    e.preventDefault();
    e.stopPropagation();
    try{ await exportAllDiffsOneCsv(); }
    catch(err){ console.error(err); alert("CSV出力に失敗しました"); }
  });
}
const $closeReceiptBtn = $("closeReceiptBtn");
const $cancelBtn = $("cancelBtn");
const $confirmBtn = $("confirmBtn");

const $toast = $("toast");

/* =====================================================
   Receipt Modal open / close
===================================================== */
function setReceiptModalOpen(open){
  if(!$receiptModal) return;
  if(open){
    $receiptModal.classList.add("show");
    $receiptModal.setAttribute("aria-hidden","false");
  }else{
    $receiptModal.classList.remove("show");
    $receiptModal.setAttribute("aria-hidden","true");
  }
}

// 背景（オーバーレイ）タップで閉じる
if($receiptModal){
  $receiptModal.addEventListener("click", (e)=>{
    if(e.target === $receiptModal) setReceiptModalOpen(false);
  });
}


/* =====================================================
   Firebase init
===================================================== */
let db = null;
let firebaseOk = false;
let currentUser = null; // auth user

// ===== Auth state shared vars (declare early to avoid timing issues) =====
const ADMIN_EMAIL = "enue_staff03@management.com";
let currentUserEmail = null;


function openMasterMenu(){
  if(!$masterMenuModal) return;
  $masterMenuModal.classList.add("show");
}
function closeMasterMenu(){
  if(!$masterMenuModal) return;
  $masterMenuModal.classList.remove("show");
}

// ⚙ マスタメニューを開く
if($mastersToggleBtn) $mastersToggleBtn.addEventListener("click", openMasterMenu);
function openModeModal(key, label){
  pendingMasterKey = key;
  pendingMasterLabel = label;
  pendingMasterEditMode = null;
  if($masterModeTitle) $masterModeTitle.textContent = `${label}：追加 or 修正`;
  if($masterModeHelp) $masterModeHelp.textContent = "追加か修正かを選んでください。";
  $masterModeModal.classList.add("show");
}
function closeModeModal(){
  $masterModeModal.classList.remove("show");
}

function setStatus(ok, text){
  firebaseOk = ok;
  $statusPill.textContent = text;
  $checkoutBtn.disabled = !ok;
}

async function bootFirebase(){
  try{
    const app = initializeApp(firebaseConfig);

    // Firestore
    db = getFirestore(app);

    // Auth
    const auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence);

    // ログインしてなければログイン画面へ（ログイン後はこのPOSへ戻す）
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      currentUserEmail = user?.email || null;

      if (!user) {
        location.href = 'login.html?redirect=' + encodeURIComponent('pos.html');
        return;
      }

      // 管理者のみ：差分件数の可視化（diffPill + 吹き出し）
      try{ await refreshPatchSummary(); }catch(e){ /* noop */ }
    });

    setStatus(true, "Firestore接続OK");
  }catch(e){
    console.error(e);
    setStatus(false, "Firestore未接続");
    alert("Firebase初期化に失敗しました");
  }
}

/* =====================================================
   Settings
===================================================== */
const LS_SETTINGS_KEY = "pos_settings_v2";

const POS_PREFS_URL = "./bundle/pos_prefs_bundle.json";
let posPrefs = { defaults: { channelId: null, venueId: null, paymentByChannel: {} } };

async function loadPosPrefs(){
  try{
    const res = await fetch(POS_PREFS_URL, { cache: "no-store" });
    if(!res.ok){
      console.warn(`[prefs] missing: ${POS_PREFS_URL} (${res.status}) -> fallback to localStorage/masters`);
      return;
    }
    const json = await res.json();
    const d = json.defaults || json.default || json || {};
    posPrefs = {
      defaults: {
        channelId: d.channelId ?? d.defaultChannelId ?? null,
        venueId: d.venueId ?? d.defaultVenueId ?? null,
        paymentByChannel: d.paymentByChannel ?? d.defaultPaymentByChannel ?? {}
      }
    };
  }catch(e){
    console.warn("[prefs] load failed -> fallback", e);
  }
}

function detectPaymentIdByLabelIncludes(keyword){
  const k = String(keyword || "").toLowerCase();
  const hit = (masters.payments || []).find(x=>{
    const id = String(x.id || "").toLowerCase();
    const label = String(x.label ?? x.name ?? "").toLowerCase();
    return id.includes(k) || label.includes(k);
  });
  return hit?.id || null;
}

function resolveDefaultChannelId(){
  // 1) schedule override (future)
  if(typeof resolveChannelBySchedule === 'function'){
    const s = resolveChannelBySchedule(new Date());
    if(s) return s;
  }

  // 2) prefs (strong default)
  if(posPrefs?.defaults?.channelId) return posPrefs.defaults.channelId;

  // 3) localStorage settings (fallback)
  if(settings.currentChannel) return settings.currentChannel;

  // 3) auto-detect instagram
  if(INSTAGRAM_CHANNEL_ID) return INSTAGRAM_CHANNEL_ID;

  // 4) first master
  return masters.channels?.[0]?.id || "";
}

function resolveDefaultVenueId(){
  if(settings.currentVenue) return settings.currentVenue;
  if(posPrefs?.defaults?.venueId) return posPrefs.defaults.venueId;
  return masters.venues?.[0]?.id || "";
}

function resolveDefaultPaymentId(channelId){
  // 1) user last choice by channel
  if(settings.lastPaymentByChannel && settings.lastPaymentByChannel[channelId]){
    return settings.lastPaymentByChannel[channelId];
  }

  // 2) prefs mapping
  const mapped = posPrefs?.defaults?.paymentByChannel?.[channelId];
  if(mapped) return mapped;

  // 3) heuristic fallback (not hardcode by id, detect by label)
  if(channelId === "marche"){
    return detectPaymentIdByLabelIncludes("cash") || detectPaymentIdByLabelIncludes("現金") || masters.payments?.[0]?.id || "";
  }
  if(channelId === INSTAGRAM_CHANNEL_ID){
    return detectPaymentIdByLabelIncludes("paypay") || detectPaymentIdByLabelIncludes("PayPay") || masters.payments?.[0]?.id || "";
  }
  return masters.payments?.[0]?.id || "";
}


const defaultSettings = {
  currentChannel: "",
  currentVenue: "",
  paymentMethod: "",
  paymentMethods: [],
  kind: "",
  lastPaymentByChannel: {},
};


function migratePaymentMethod(s){
  const map = { "現金":"cash", "PayPay":"paypay", "クレカ":"credit", "その他":"other" };
  if(map[s.paymentMethod]) s.paymentMethod = map[s.paymentMethod];
  return s;
}
function loadSettings(){
  try{
    const raw = localStorage.getItem(LS_SETTINGS_KEY);
    const s = raw ? { ...defaultSettings, ...JSON.parse(raw) } : structuredClone(defaultSettings);
    return migratePaymentMethod(s);
  }catch{
    return structuredClone(defaultSettings);
  }
}
function saveSettings(){
  localStorage.setItem(LS_SETTINGS_KEY, JSON.stringify(settings));
}

let settings = loadSettings();

/* =====================================================
   商品マスタ（bundle + updates/adds patch）
===================================================== */

async function fetchFirstOkJson(urlCandidates, label="json"){
  let lastErr = null;
  for(const url of urlCandidates){
    try{
      const res = await fetch(url, { cache: "no-store" });
      if(res.ok){
        const json = await res.json();
        return { url, json };
      }
      lastErr = new Error(`${label} fetch not ok: ${url} (${res.status})`);
    }catch(e){
      lastErr = e;
    }
  }
  throw lastErr || new Error(`${label} fetch failed`);
}

const PRODUCT_BUNDLE_CANDIDATES = [
  "./bundle/products_bundle.json",
  "bundle/products_bundle.json",
  "./bundle/products_bundle.json",
  "bundle/products_bundle.json"
];
let products = [];
let baseIdSet = new Set(); // bundleに存在するID

const COL_PATCH_UPDATES = "products_patch_updates";
const COL_PATCH_ADDS    = "products_patch_adds";

async function loadProductsFromBundle(){
  const { json } = await fetchFirstOkJson(PRODUCT_BUNDLE_CANDIDATES, "products bundle");
  return (json.products || []).filter(p => p.active !== false);
}

async function loadProductsWithPatch(){
  const base = await loadProductsFromBundle();
  baseIdSet = new Set(base.map(p => p.id));

  // base map
  const map = new Map(base.map(p => [p.id, { ...p }]));

  let updatesCount = 0;
  let addsCount = 0;

  // 1) updates: 既存IDへ上書き
  try{
    const snapU = await getDocs(collection(db, COL_PATCH_UPDATES));
    snapU.forEach(d=>{
      const id = d.id;
      const patch = d.data() || {};
      const cur = map.get(id) || { id };
      map.set(id, { ...cur, ...patch, id });
      updatesCount++;
    });
  }catch(e){
    console.warn("patch_updates read failed", e);
  }

  // 2) adds: 新規商品として追加
  try{
    const snapA = await getDocs(collection(db, COL_PATCH_ADDS));
    snapA.forEach(d=>{
      const id = d.id;
      const patch = d.data() || {};
      const cur = map.get(id) || { id };
      // addsは「新規商品」扱いなので、baseになくても追加される
      map.set(id, { ...cur, ...patch, id });
      addsCount++;
    });
  }catch(e){
    console.warn("patch_adds read failed", e);
  }

  // base順に並べ、残り（adds由来など）を末尾へ
  const ordered = [];
  for(const p of base){
    const merged = map.get(p.id);
    if(merged && merged.active !== false) ordered.push(merged);
    map.delete(p.id);
  }
  for(const merged of map.values()){
    if(merged.active !== false) ordered.push(merged);
  }

  return { products: ordered, updatesCount, addsCount };
}

/* =====================================================
   UI render
===================================================== */
function renderSettingsUI(){
  // チャンネル（販売方法）
  fillSelect($channelSelect, masters.channels, settings.currentChannel);
  if(!$channelSelect.value && $channelSelect.options.length){
    $channelSelect.selectedIndex = 0;
    settings.currentChannel = $channelSelect.value;
  }else{
    settings.currentChannel = $channelSelect.value;
  }

  // 開催場所（マルシェの時だけ表示）
  fillSelect($venueSelect, masters.venues, settings.currentVenue);
  if(!$venueSelect.value && $venueSelect.options.length){
    $venueSelect.selectedIndex = 0;
    settings.currentVenue = $venueSelect.value;
  }else{
    settings.currentVenue = $venueSelect.value;
  }

  // 決済方法
  fillSelect($paymentSelect, masters.payments, settings.paymentMethod);
  if(!$paymentSelect.value && $paymentSelect.options.length){
    $paymentSelect.selectedIndex = 0;
    settings.paymentMethod = $paymentSelect.value;
  }else{
    settings.paymentMethod = $paymentSelect.value;
  }

  $venueWrap.style.display = (settings.currentChannel === "marche") ? "inline-flex" : "none";
}
/* =====================================================
   Channel → Payment default rules
   - 販売方法 初期値：インスタ
   - 販売方法=インスタ → 決済初期値=PayPay
   - 販売方法=マルシェ → 決済初期値=現金
   - マルシェ初期値でも「開催場所」が必ず表示されるようにする（トグル往復不要）
===================================================== */
let INSTAGRAM_CHANNEL_ID = "instagram"; // masters読込後に自動検出で上書きする

function detectInstagramChannelId(){
  const hit = (masters.channels || []).find(x=>{
    const id = (x.id || "").toLowerCase();
    const label = (x.label ?? x.name ?? "").toString();
    return id.includes("insta") || id.includes("instagram") || label.includes("インスタ");
  });
  if(hit?.id) INSTAGRAM_CHANNEL_ID = hit.id;
}

function setPaymentIfExists(paymentId){
  if(!$paymentSelect) return;
  const exists = [...$paymentSelect.options].some(o => o.value === paymentId);
  if(!exists) return;
  $paymentSelect.value = paymentId;
  settings.paymentMethod = paymentId;
}

function applyChannelRules(opts={ forcePayment:false }){
  const ch = settings.currentChannel;

  // venue visibility（マルシェのときだけ）
  if($venueWrap) $venueWrap.style.display = (ch === "marche") ? "inline-flex" : "none";

  // payment default（チャンネルごと：prefs → last choice → fallback）
  if(opts.forcePayment){
    const p = resolveDefaultPaymentId(ch);
    if(p) setPaymentIfExists(p);
  }
}


function renderProducts(){
  $products.innerHTML = "";

  products.forEach(p=>{
    const row = document.createElement("div");
    row.className = "product-row";

    const left = document.createElement("div");
    left.className = "product-left";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.dataset.id = p.id;

    const name = document.createElement("div");
    name.className = "product-name";
    name.textContent = p.name;

    const price = document.createElement("span");
    price.className = "product-price";
    price.textContent = `￥${p.price}`;

    name.appendChild(price);
    left.appendChild(cb);
    left.appendChild(name);

    const qty = document.createElement("div");
    qty.className = "qty";
    const sel = document.createElement("select");
    sel.disabled = true;
    for(let i=1;i<=10;i++){
      const o=document.createElement("option");
      o.value=o.textContent=i;
      sel.appendChild(o);
    }

    cb.addEventListener("change",()=>{
      sel.disabled = !cb.checked;
      updateTotal();
    });
    sel.addEventListener("change", updateTotal);

    qty.appendChild(sel);
    qty.append(" 個");

    row.append(left, qty);
    $products.appendChild(row);
  });

  updateTotal();
}

/* =====================================================
   POS logic
===================================================== */
function getSelected(){
  const items = [];
  let total = 0;

  document.querySelectorAll(".product-row").forEach(row=>{
    const cb = row.querySelector("input[type=checkbox]");
    const sel = row.querySelector("select");
    if(!cb.checked) return;

    const p = products.find(x=>x.id===cb.dataset.id);
    const qty = Number(sel.value);
    const subtotal = p.price * qty;

    items.push({
      id: p.id,
      name: p.name,
      unitPrice: p.price,
      qty,
      subtotal
    });
    total += subtotal;
  });

  return { items, total };
}

function updateTotal(){
  const { total } = getSelected();
  $totalText.textContent = `合計：￥${total}`;
}

function todayYMD(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}


/* =====================================================
   Order fee (お急ぎOP) calc / receipt render
   - kind=order のときだけ「オーダー料」を加算
   - baseTotal / urgentOptionPrice / total を一貫して算出
===================================================== */
function getUrgentOptionById(id, list){
  if(!id) return null;
  const arr = Array.isArray(list) ? list : (masters.urgentOptions || []);
  return arr.find(x => x.id === id) || null;
}

function calcTotalsForReceipt(){
  const { items, total: baseTotal } = getSelected();
  const kindId = ($kindSelect?.value || "stock");
  const isCorp = !!($receiptIsCorporate && $receiptIsCorporate.checked);
  const list = isCorp ? (masters.urgentOptionsCorp || []) : (masters.urgentOptions || []);
  const urgentOptionId = (kindId === "order") ? (($urgentSelect?.value || "").trim()) : "";

  const opt = (kindId === "order") ? getUrgentOptionById(urgentOptionId, list) : null;
  const urgentOptionPrice = (kindId === "order" && opt && Number.isFinite(Number(opt.price))) ? Number(opt.price) : 0;

  return { items, baseTotal, urgentOptionId, urgentOptionLabel: (opt?.label ?? opt?.name ?? ""), urgentOptionPrice, total: baseTotal + urgentOptionPrice };
}

function renderReceiptItemsAndTotal(){
  if(!$receiptList || !$receiptTotal) return;

  const { items, baseTotal, urgentOptionLabel, urgentOptionPrice, total } = calcTotalsForReceipt();

  const lines = items.map(i => `${i.name} ×${i.qty}：￥${i.subtotal}`);

  if(urgentOptionPrice > 0){
    const label = urgentOptionLabel || getSelectedLabel($urgentSelect) || "-";
    lines.push(`オーダー料(${label})：￥${urgentOptionPrice}`);
  }

  $receiptList.innerHTML = lines.join("<br>");
  $receiptTotal.textContent = `合計：￥${total}`;

  // POS側の合計は「商品合計」のまま（kind未選択のため）
  // ただし、レシート内での検算用に baseTotal も表示したい場合はここで追加できる
}


/* =====================================================
   Firestore write
===================================================== */
/* =====================================================
   Simple masters (bundle + patch): channels / venues / payments / kinds
===================================================== */
const MASTER_DEFS = {
  channels: { bundleUrl: "./bundle/channels_bundle.json", updates: "channels_patch_updates", adds: "channels_patch_adds" },
  venues:   { bundleUrl: "./bundle/venues_bundle.json",   updates: "venues_patch_updates",   adds: "venues_patch_adds" },
  payments: { bundleUrl: "./bundle/payments_bundle.json", updates: "payments_patch_updates", adds: "payments_patch_adds" },
  kinds:    { bundleUrl: "./bundle/kinds_bundle.json",    updates: "kinds_patch_updates",    adds: "kinds_patch_adds" },
  urgentOptions: { bundleUrl: "./bundle/urgent_options_bundle.json", updates: "urgent_options_patch_updates", adds: "urgent_options_patch_adds" }
};

const masters = { channels: [], venues: [], payments: [], kinds: [], urgentOptions: [], urgentOptionsCorp: [] };
const masterBundleIds = { channels: new Set(), venues: new Set(), payments: new Set(), kinds: new Set(), urgentOptions: new Set() };

async function loadSimpleBundle(key){
  const def = MASTER_DEFS[key];
  const url = def && def.bundleUrl ? def.bundleUrl : null;
  if(!url) return [];
  try{
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error(`bundle fetch failed: ${key} (${res.status}) ${url}`);
    const json = await res.json();
    const arr =
      json[key]
      || json[ key === "payments" ? "paymentMethods" : key ]
      || [];
    return Array.isArray(arr) ? arr : [];
  }catch(e){
    console.warn(`[masters] bundle load failed: ${key} -> empty bundle used for ${key}`, e);
    return [];
  }
}

async function loadSimplePatch(key){
  // patch read は権限やログインタイミングで失敗することがある。
  // その場合でも bundle は使って UI を壊さないため、ここは必ず「空パッチ」で継続する。
  const def = MASTER_DEFS[key];
  let updatesSnap = null;
  let addsSnap = null;

  try{ updatesSnap = await getDocs(collection(db, def.updates)); }
  catch(e){ console.warn(`[masters] patch updates read failed: ${key}`, e); }

  try{ addsSnap = await getDocs(collection(db, def.adds)); }
  catch(e){ console.warn(`[masters] patch adds read failed: ${key}`, e); }

  const updates = {};
  const adds = [];

  if(updatesSnap){
    updatesSnap.forEach(d=> updates[d.id] = d.data());
  }
  if(addsSnap){
    addsSnap.forEach(d=> adds.push({ id: d.id, ...d.data() }));
  }

  return { 
    updates, 
    adds, 
    updatesCount: updatesSnap ? updatesSnap.size : 0, 
    addsCount: addsSnap ? addsSnap.size : 0
  };
}


/* =====================================================
   Urgent options (企業向け)
   - kind=order かつ 「（企業）」チェックONのとき参照
===================================================== */
const URGENT_CORP_URL = "./bundle/urgent_options_corp_bundle.json";
let urgentCorpLoaded = false;

async function loadUrgentCorpBundle(){
  if(urgentCorpLoaded) return;
  try{
    const res = await fetch(URGENT_CORP_URL, { cache: "no-store" });
    if(!res.ok) throw new Error(`corp urgent bundle missing (${res.status})`);
    const j = await res.json();
    const arr = j.urgentOptions || j.urgentOptionsCorp || j.options || [];
    masters.urgentOptionsCorp = Array.isArray(arr) ? arr.filter(x=>x.active !== false) : [];
    urgentCorpLoaded = true;
  }catch(e){
    console.warn("[urgentCorp] load failed -> fallback to normal urgentOptions", e);
    masters.urgentOptionsCorp = [];
    urgentCorpLoaded = true;
  }
}
async function initSimpleMaster(key){
  const bundle = await loadSimpleBundle(key);
  masterBundleIds[key] = new Set(bundle.map(x=>x.id));

  const patch = await loadSimplePatch(key);

  const merged = bundle.map(x => patch.updates[x.id] ? ({ ...x, ...patch.updates[x.id] }) : x);
  patch.adds.forEach(a => { if(!merged.find(m=>m.id===a.id)) merged.push(a); });

  masters[key] = merged.filter(x => x.active !== false);
  return patch;
}

function fillSelect(sel, arr, currentValue){
  if(!sel) return;
  sel.innerHTML = "";
  arr.forEach(x=>{
    const opt=document.createElement("option");
    opt.value = x.id;
    opt.textContent = x.label ?? x.name ?? x.id;
    if(currentValue && opt.value === currentValue) opt.selected = true;
    sel.appendChild(opt);
  });
}

function fillSelectWithPlaceholder(sel, arr, currentValue, placeholder="---"){
  if(!sel) return;
  sel.innerHTML = "";
  const ph = document.createElement("option");
  ph.value = "";
  ph.textContent = placeholder;
  sel.appendChild(ph);
  arr.forEach(x=>{
    const opt=document.createElement("option");
    opt.value = x.id;
    opt.textContent = x.label ?? x.name ?? x.id;
    if(currentValue && opt.value === currentValue) opt.selected = true;
    sel.appendChild(opt);
  });
}

function applyKindDefault(){
  if(!$kindSelect) return;
  const hasStock = [...$kindSelect.options].some(o=>o.value==="stock");
  if(hasStock) $kindSelect.value = "stock";
  else if($kindSelect.options.length) $kindSelect.selectedIndex = 0;
}


function applyUrgentOptions(list){
  if(!$urgentSelect || !$urgentWrap) return;
  const arr = Array.isArray(list) ? list : (masters.urgentOptions || []);
  // placeholder付き（未選択OK）
  fillSelectWithPlaceholder($urgentSelect, arr, $urgentSelect.value || "", "---");
}


/* =====================================================
   Status (マルシェ以外のとき)
   - channels !== marche のときだけ表示
   - kind=stock / kind=order でリスト切替
===================================================== */
const STATUS_STOCK_URL = "./bundle/status_stock_bundle.json";
const STATUS_ORDER_URL = "./bundle/status_order_bundle.json";
let statusMasters = { stock: [], order: [] };
let statusLoaded = false;

async function loadStatusBundles(){
  if(statusLoaded) return;
  const loadOne = async (url, key)=>{
    try{
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok){
        console.warn(`[status] missing: ${url} (${res.status})`);
        return [];
      }
      const j = await res.json();
      // どちらでも受けられるように key は "statuses" 固定で読む
      const arr = j.statuses || j.status || j[key] || [];
      return Array.isArray(arr) ? arr.filter(x=>x.active !== false) : [];
    }catch(e){
      console.warn(`[status] load failed: ${url}`, e);
      return [];
    }
  };
  statusMasters.stock = await loadOne(STATUS_STOCK_URL, "stock");
  statusMasters.order = await loadOne(STATUS_ORDER_URL, "order");
  statusLoaded = true;
}

function findStatusDefaultId(kindId, channelId){
  const list = (kindId === "order") ? (statusMasters.order || []) : (statusMasters.stock || []);
  const findBy = (kw)=>{
    const k = String(kw||"").toLowerCase();
    return list.find(x=>{
      const id = String(x.id||"").toLowerCase();
      const label = String(x.label ?? x.name ?? "").toLowerCase();
      return id === k || label === k || id.includes(k) || label.includes(k);
    })?.id || "";
  };

  // マルシェのとき：kind=stock → 発送完了 / kind=order → 未着手
  if(channelId === "marche"){
    if(kindId === "stock"){
      return findBy("発送完了") || findBy("shipped") || findBy("ship") || findBy("complete") || findBy("done") || list?.[0]?.id || "";
    }
    return findBy("未着手") || findBy("not_started") || list?.[0]?.id || "";
  }

  // マルシェ以外：初期値は未着手
  return findBy("未着手") || findBy("not_started") || list?.[0]?.id || "";
}

function applyStatusOptions(kindId, channelId){
  if(!$statusSelect) return;
  const list = (kindId === "order") ? (statusMasters.order || []) : (statusMasters.stock || []);
  const prev = ($statusSelect.value || "").trim();

  fillSelectWithPlaceholder($statusSelect, list, prev, "---");

  const defId = findStatusDefaultId(kindId, channelId);
  if(defId) $statusSelect.value = defId;

  if(!$statusSelect.value && $statusSelect.options.length > 1){
    $statusSelect.selectedIndex = 1; // placeholderの次
  }
}

function toggleStatusUI(){
  if(!$statusWrap || !$statusSelect) return;

  const ch = ($receiptChannelSelect?.value || settings.currentChannel || $channelSelect?.value || "");
  const kindId = ($kindSelect?.value || "stock");

  // 表示条件：kind が stock / order のとき（マルシェも含む）
  const show = (kindId === "stock" || kindId === "order");
  $statusWrap.style.display = show ? "" : "none";

  if(show){
    loadStatusBundles().then(()=>{
      applyStatusOptions(kindId, ch);
      setReceiptMetaText();
    });
  }else{
    $statusSelect.value = "";
  }
}

function toggleUrgentUI(){
  const kindId = ($kindSelect?.value || "stock");

  // urgent UI（kind=order のときだけ）
  if($urgentWrap){
    const show = (kindId === "order");
    $urgentWrap.style.display = show ? "" : "none";
    if(show){
      loadUrgentCorpBundle().then(()=>{
        const isCorp = !!($receiptIsCorporate && $receiptIsCorporate.checked);
        const list = isCorp ? (masters.urgentOptionsCorp || []) : (masters.urgentOptions || []);
        applyUrgentOptions(list);
        if(!$urgentSelect.value) $urgentSelect.selectedIndex = 0;
        renderReceiptItemsAndTotal();
        setReceiptMetaText();
      });
    }
  }

  // status UI（マルシェ以外のとき）
  toggleStatusUI();
}

/* =====================================================
   Admin: Export all diffs as ONE CSV (admin only)
===================================================== */
function csvEscape(v){
  const s = (v === null || v === undefined) ? "" : String(v);
  // normalize newlines
  const t = s.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
  // wrap always (safer for commas/quotes)
  return `"${t.replace(/"/g,'""')}"`;
}
function tsToString(v){
  try{
    if(!v) return "";
    if(typeof v === "string") return v;
    if(typeof v?.toDate === "function") return v.toDate().toISOString();
    if(v instanceof Date) return v.toISOString();
    return "";
  }catch{
    return "";
  }
}
function downloadCsv(filename, csvText){
  // Excel向けにBOM付与
  const bom = "\uFEFF";
  const blob = new Blob([bom + csvText], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  link.remove();
}

async function exportAllDiffsOneCsv(){
  const isAdmin = (currentUserEmail === ADMIN_EMAIL);
  if(!isAdmin){
    alert("管理者のみ実行できます");
    return;
  }
  if(!db){
    alert("Firestore未接続です");
    return;
  }

  const targets = [
    { key:"products",  label:"商品マスタ",     updates:"products_patch_updates", adds:"products_patch_adds" },
    { key:"channels",  label:"販売方法マスタ", updates:MASTER_DEFS.channels.updates, adds:MASTER_DEFS.channels.adds },
    { key:"venues",    label:"開催場所マスタ", updates:MASTER_DEFS.venues.updates,   adds:MASTER_DEFS.venues.adds },
    { key:"payments",  label:"決済方法マスタ", updates:MASTER_DEFS.payments.updates, adds:MASTER_DEFS.payments.adds },
    { key:"kinds",     label:"kindマスタ",     updates:MASTER_DEFS.kinds.updates,    adds:MASTER_DEFS.kinds.adds },
    { key:"urgentOptions", label:"お急ぎOPマスタ", updates:MASTER_DEFS.urgentOptions.updates, adds:MASTER_DEFS.urgentOptions.adds }
  ];

  const rows = [];
  for(const t of targets){
    // updates
    try{
      const snapU = await getDocs(collection(db, t.updates));
      snapU.forEach(d=>{
        const id = d.id;
        const data = d.data() || {};
        const updatedAt = tsToString(data.updatedAt);
        const updatedBy = data.updatedBy || "";
        Object.keys(data).forEach(field=>{
          if(field === "updatedAt" || field === "updatedBy") return;
          rows.push({
            masterKey: t.key,
            masterLabel: t.label,
            diffType: "update",
            id,
            field,
            value: (data[field] === undefined ? "" : data[field]),
            updatedAt,
            updatedBy
          });
        });
        // フィールドが1つも無いパッチも行として残す（空パッチ対策）
        const hasFields = Object.keys(data).some(k=>k!=="updatedAt" && k!=="updatedBy");
        if(!hasFields){
          rows.push({ masterKey:t.key, masterLabel:t.label, diffType:"update", id, field:"", value:"", updatedAt, updatedBy });
        }
      });
    }catch(e){
      console.warn("export updates failed", t, e);
      rows.push({ masterKey:t.key, masterLabel:t.label, diffType:"update", id:"", field:"__ERROR__", value:(e?.message||String(e)), updatedAt:"", updatedBy:"" });
    }

    // adds
    try{
      const snapA = await getDocs(collection(db, t.adds));
      snapA.forEach(d=>{
        const id = d.id;
        const data = d.data() || {};
        const updatedAt = tsToString(data.updatedAt);
        const updatedBy = data.updatedBy || "";
        Object.keys(data).forEach(field=>{
          if(field === "updatedAt" || field === "updatedBy") return;
          rows.push({
            masterKey: t.key,
            masterLabel: t.label,
            diffType: "add",
            id,
            field,
            value: (data[field] === undefined ? "" : data[field]),
            updatedAt,
            updatedBy
          });
        });
        const hasFields = Object.keys(data).some(k=>k!=="updatedAt" && k!=="updatedBy");
        if(!hasFields){
          rows.push({ masterKey:t.key, masterLabel:t.label, diffType:"add", id, field:"", value:"", updatedAt, updatedBy });
        }
      });
    }catch(e){
      console.warn("export adds failed", t, e);
      rows.push({ masterKey:t.key, masterLabel:t.label, diffType:"add", id:"", field:"__ERROR__", value:(e?.message||String(e)), updatedAt:"", updatedBy:"" });
    }
  }

  // 並び：マスタ→diff→id→field
  rows.sort((a,b)=>{
    const k1 = (a.masterKey||"").localeCompare(b.masterKey||"");
    if(k1) return k1;
    const k2 = (a.diffType||"").localeCompare(b.diffType||"");
    if(k2) return k2;
    const k3 = (a.id||"").localeCompare(b.id||"");
    if(k3) return k3;
    return (a.field||"").localeCompare(b.field||"");
  });

  const headers = ["masterKey","masterLabel","diffType","id","field","value","updatedAt","updatedBy"];
  const csv = [
    headers.join(","),
    ...rows.map(r => headers.map(h => csvEscape(r[h])).join(","))
  ].join("\n");

  const now = new Date();
  const stamp = now.toISOString().slice(0,19).replace(/[:T]/g,"-");
  downloadCsv(`enue_diff_all_${stamp}.csv`, csv);
}


/* Admin: patch summary */

async function refreshPatchSummary(){
  const isAdmin = (currentUserEmail === ADMIN_EMAIL);

  // 非管理者は非表示
  if(!isAdmin) {
    if($diffPill) $diffPill.style.display = "none";
    if($diffPop) $diffPop.style.display = "none";
    if($exportDiffCsvBtn) $exportDiffCsvBtn.style.display = "none";
    // 旧UIは使わない
    if($patchPill) $patchPill.style.display = "none";
    if($patchPop) $patchPop.style.display = "none";
    return;
  }

  const targets = [
    { key:"products", label:"商品マスタ", updates:"products_patch_updates", adds:"products_patch_adds" },
    { key:"channels", label:"販売方法マスタ", updates:MASTER_DEFS.channels.updates, adds:MASTER_DEFS.channels.adds },
    { key:"venues", label:"開催場所マスタ", updates:MASTER_DEFS.venues.updates, adds:MASTER_DEFS.venues.adds },
    { key:"payments", label:"決済方法マスタ", updates:MASTER_DEFS.payments.updates, adds:MASTER_DEFS.payments.adds },
    { key:"kinds", label:"kindマスタ", updates:MASTER_DEFS.kinds.updates, adds:MASTER_DEFS.kinds.adds },
    { key:"urgentOptions", label:"お急ぎOPマスタ", updates:MASTER_DEFS.urgentOptions.updates, adds:MASTER_DEFS.urgentOptions.adds }
  ];

  // まずは「0件でも出す」を保証（読めなくても表示される）
  let totalUpdates = 0;
  let totalAdds = 0;
  let hadError = false;
  const lines = [];

  if($diffPill){
    $diffPill.textContent = `updates 0 / adds 0`;
    $diffPill.style.display = "inline-flex";
  }
  if($exportDiffCsvBtn) $exportDiffCsvBtn.style.display = "inline-flex";

  for(const t of targets){
    let u = 0, a = 0, err = null;

    try{
      u = (await getDocs(collection(db, t.updates))).size;
    }catch(e){
      hadError = true;
      err = e;
    }

    try{
      a = (await getDocs(collection(db, t.adds))).size;
    }catch(e){
      hadError = true;
      err = err || e;
    }

    totalUpdates += u;
    totalAdds += a;

    lines.push({
      label: t.label,
      updates: u,
      adds: a,
      err: err ? (err.code || "error") : null
    });
  }

  // ヘッダー横の表示（0件でも表示）
  if($diffPill){
    $diffPill.textContent = hadError
      ? `updates ${totalUpdates} / adds ${totalAdds} ⚠`
      : `updates ${totalUpdates} / adds ${totalAdds}`;
    $diffPill.style.display = "inline-flex";
    $diffPill.title = hadError ? "一部マスタの差分read権限/接続でエラーがあります" : "";
  }

  // 吹き出し内訳（エラーなら code を表示）
  if($diffPopLines){
    $diffPopLines.innerHTML = lines
      .map(x => {
        const right = x.err ? `ERR(${x.err})` : `u${x.updates} / a${x.adds}`;
        return `<div style="display:flex; justify-content:space-between; gap:10px; padding:4px 0;">
          <span style="opacity:.85">${x.label}</span>
          <span style="font-variant-numeric: tabular-nums;">${right}</span>
        </div>`;
      })
      .join("");
  }

  // 旧UI（画面右下）は非表示に統一
  if($patchPill) $patchPill.style.display = "none";
  if($patchPop) $patchPop.style.display = "none";
  if($patchBreakdown){
    $patchBreakdown.innerHTML = lines.map(x=>`
      <div class="row">
        <span>${x.label}</span>
        <span>${x.err ? `ERR(${x.err})` : `updates ${x.updates} / adds ${x.adds}`}</span>
      </div>
    `).join("");
  }
}

async function writeSale(){
  const { items, total: baseTotal } = getSelected();
  if(!items.length) throw new Error("empty");

  const orderDate = ($orderDateInput?.value || "").trim();
  const orderDateMs = orderDate ? new Date(orderDate + "T00:00:00").getTime() : null;

  const kindId = ($kindSelect?.value || "stock");
  const kindLabel = getSelectedLabel($kindSelect);

  const channelId = ($receiptChannelSelect?.value || settings.currentChannel || $channelSelect.value);
  const paymentId = ($receiptPaymentSelect?.value || $paymentSelect.value);
  const paymentLabel = getSelectedLabel($receiptPaymentSelect || $paymentSelect);
  const customerName = (($receiptCustomerName?.value || "").trim());

  // 企業チェック
  const isCorporate = !!($receiptIsCorporate && $receiptIsCorporate.checked);

  // venue（マルシェ以外は空）
  const venueId = (channelId === "marche") ? (settings.currentVenue || "") : "";

  const urgentOptionId = (kindId === "order") ? (($urgentSelect?.value || "").trim()) : "";
  const urgentOptionLabel = (kindId === "order") ? getSelectedLabel($urgentSelect) : "";

  // 企業/通常で参照リスト切替
  const list = isCorporate ? (masters.urgentOptionsCorp || []) : (masters.urgentOptions || []);
  const urgentOpt = (kindId === "order") ? getUrgentOptionById(urgentOptionId, list) : null;
  const urgentOptionPrice =
    (kindId === "order" && urgentOpt && Number.isFinite(Number(urgentOpt.price)))
      ? Number(urgentOpt.price)
      : 0;

  const total = baseTotal + urgentOptionPrice;

  const statusId = ((kindId === "stock" || kindId === "order")) ? (($statusSelect?.value || "").trim()) : "";
  const statusLabel = ((kindId === "stock" || kindId === "order")) ? (getSelectedLabel($statusSelect) || "") : "";

  await addDoc(collection(db,"sales"),{
    createdAt: serverTimestamp(),
    clientCreatedAt: Date.now(),
    orderDate: orderDate || todayYMD(),
    orderDateMs: orderDateMs ?? new Date((orderDate || todayYMD()) + "T00:00:00").getTime(),

    kindId,
    kindLabel,

    channel: channelId,
    venue: venueId,

    customerName,
    isCorporate,

    paymentId,
    paymentLabel,
    paymentMethod: paymentId, // 互換用

    urgentOptionId,
    urgentOptionLabel,

    statusId,
    statusLabel,

    baseTotal,
    urgentOptionPrice,
    total,
    items
  });
}

/* =====================================================
   Events
===================================================== */
$checkoutBtn.onclick = ()=>{
  if(!firebaseOk) return;
  const { items, total } = getSelected();
  if(!items.length) return alert("商品を選択してね");

  if($orderDateInput){
    // 初期値は本日（タップで変更OK）
    $orderDateInput.value = todayYMD();
  }

  // レシート側の編集UIへ現在値を反映
  if($receiptChannelSelect) $receiptChannelSelect.value = $channelSelect.value;
  if($receiptPaymentSelect) $receiptPaymentSelect.value = $paymentSelect.value;
  if($receiptVenueSelect) $receiptVenueSelect.value = $venueSelect.value;
  if($receiptCustomerName) $receiptCustomerName.value = "";
  if($receiptIsCorporate) $receiptIsCorporate.checked = false;

  const showVenue = ($channelSelect.value === "marche");
  if($receiptVenueWrap) $receiptVenueWrap.style.display = showVenue ? "block" : "none";

  // kind 初期値：stock（ルール）
  if($kindSelect){
    const hasStock = [...$kindSelect.options].some(o=>o.value==="stock");
    if(!($kindSelect.value||"") && hasStock) $kindSelect.value = "stock";
    else if(hasStock) $kindSelect.value = ($kindSelect.value||"stock");
  }
  toggleUrgentUI();
  setReceiptMetaText();

  renderReceiptItemsAndTotal();

  setReceiptModalOpen(true);
};

$confirmBtn.onclick = async ()=>{
  try{
    await writeSale();
    setReceiptModalOpen(false);
    showToast("決済完了🌟");
    document.querySelectorAll("input[type=checkbox]").forEach(c=>c.checked=false);
    document.querySelectorAll(".product-row select").forEach(s=>{s.disabled=true; s.value=1});
    updateTotal();
  }catch(e){
    alert("保存に失敗しました");
  }
};

$closeReceiptBtn.onclick = $cancelBtn.onclick =
  ()=> setReceiptModalOpen(false);

if($orderDateInput){
  $orderDateInput.addEventListener("change", setReceiptMetaText);
  if($kindSelect) $kindSelect.addEventListener("change", ()=>{
    settings.kind = $kindSelect.value;
    toggleUrgentUI();
    renderReceiptItemsAndTotal();
    setReceiptMetaText();
    saveSettings();
  });
}


function getSelectedLabel(selectEl){
  const opt = selectEl?.selectedOptions?.[0];
  return opt ? opt.textContent : (selectEl?.value || "");
}
function showToast(msg){
  $toast.textContent = msg;
  $toast.classList.add("show");
  setTimeout(()=> $toast.classList.remove("show"),1200);
}

function setReceiptMetaText(){
  const d = ($orderDateInput?.value || todayYMD());
  const chLabel = getSelectedLabel($receiptChannelSelect) || settings.currentChannel || "-";
  const payLabel = getSelectedLabel($receiptPaymentSelect) || getSelectedLabel($paymentSelect) || "-";
  const kindLabel = getSelectedLabel($kindSelect) || ($kindSelect?.value || "-");
  const name = ($receiptCustomerName?.value || "").trim();
  const nameText = name ? ` / 購入者：${name}` : "";
  const corpText = ($receiptIsCorporate && $receiptIsCorporate.checked) ? " / 企業" : "";
  const urgentLabel = ($kindSelect?.value === "order") ? (getSelectedLabel($urgentSelect) || "-") : "";
  const urgentText = ($kindSelect?.value === "order") ? ` / お急ぎOP：${urgentLabel}` : "";
  const statusLabel = ($statusWrap && $statusWrap.style.display !== "none") ? (getSelectedLabel($statusSelect) || "-") : "";
  const statusText = ($statusWrap && $statusWrap.style.display !== "none") ? ` / ステータス：${statusLabel}` : "";
  $receiptMeta.textContent = `受注日：${d}${nameText}${corpText} / 販売方法：${chLabel} / 決済：${payLabel} / kind：${kindLabel}${urgentText}${statusText}`;
}

/* =====================================================
   INIT
===================================================== */
await bootFirebase();

// load simple masters (bundle + patch)
try{
  await initSimpleMaster("channels");
  await initSimpleMaster("venues");
  await initSimpleMaster("payments");
  await initSimpleMaster("kinds");
  await initSimpleMaster("urgentOptions");
  await loadUrgentCorpBundle();
}catch(e){
  console.warn("masters init failed", e);
}


// masters読込後：インスタのIDを自動検出（idが instagram / insta_... などでもOK）
detectInstagramChannelId();

// 1回だけ：初期値（prefs → localStorageへ確定）
// - 販売方法 初期値：インスタ（prefsで変更可）
// - 販売方法=マルシェ → 決済初期値=現金（prefsで変更可）
// - 販売方法=インスタ → 決済初期値=PayPay（prefsで変更可）
const MIG_DEFAULTS_KEY = "pos_migrated_defaults_v5";
await loadPosPrefs();

/**
 * Root fix for defaults:
 * - Channel default should come from prefs (instagram) unless schedule override exists.
 * - Do NOT let old localStorage "marche" stick forever.
 * - Payment default is applied when channel is changed by this resolver or when current payment is invalid.
 */
const resolvedChannel = resolveDefaultChannelId();
const resolvedPayment = resolveDefaultPaymentId(resolvedChannel);

// If user has never saved settings before, or if prefs/schedule says a different channel, adopt it.
if(!settings.currentChannel || settings.currentChannel !== resolvedChannel){
  settings.currentChannel = resolvedChannel;
  // when channel changes, reset payment to channel default
  settings.paymentMethod = resolvedPayment;
}

// Venue: keep user's previous choice; if empty, pick first venue.
if(!settings.currentVenue){
  settings.currentVenue = resolveDefaultVenueId();
}

// If payment is missing/invalid, set it.
{
  const payIds = masters.payments?.map(x=>x.id) || [];
  if(!settings.paymentMethod || !payIds.includes(settings.paymentMethod)){
    settings.paymentMethod = resolvedPayment;
  }
}

// One-time migration flag (kept for future migrations)
if(!localStorage.getItem(MIG_DEFAULTS_KEY)){
  localStorage.setItem(MIG_DEFAULTS_KEY, "1");
}
saveSettings();

// migrate legacy settings (label -> id)
(function migrateLegacySettings(){
  // channel
  const chIds = masters.channels.map(x=>x.id);
  if(settings.currentChannel && !chIds.includes(settings.currentChannel)){
    const hit = masters.channels.find(x => (x.label ?? x.name ?? x.id) === settings.currentChannel);
    if(hit) settings.currentChannel = hit.id;
  }
  // venue
  const vIds = masters.venues.map(x=>x.id);
  if(settings.currentVenue && !vIds.includes(settings.currentVenue)){
    const hitV = masters.venues.find(x => (x.label ?? x.name ?? x.id) === settings.currentVenue);
    if(hitV) settings.currentVenue = hitV.id;
  }
  // payment
  const pIds = masters.payments.map(x=>x.id);
  if(settings.paymentMethod && !pIds.includes(settings.paymentMethod)){
    const hitP = masters.payments.find(x => (x.label ?? x.name ?? x.id) === settings.paymentMethod);
    if(hitP) settings.paymentMethod = hitP.id;
  }
  saveSettings();
})();

renderSettingsUI();
// 初期表示の整合（決済初期値・開催場所表示）
applyChannelRules({ forcePayment:true });

// kinds -> kindSelect（UI配線）
if($kindSelect && masters.kinds?.length){
  fillSelect($kindSelect, masters.kinds);
  applyKindDefault();
}

// urgentOptions -> urgentSelect（UI配線）
if($urgentSelect){
  applyUrgentOptions();
  toggleUrgentUI();
}

// settings change handlers
if($channelSelect){
  $channelSelect.addEventListener("change", ()=>{
    settings.currentChannel = $channelSelect.value;

    // チャンネル変更時：開催場所の表示＆決済初期値
    applyChannelRules({ forcePayment:true });

    // receipt側へ同期
    if($receiptChannelSelect) $receiptChannelSelect.value = $channelSelect.value;
    if($receiptPaymentSelect) $receiptPaymentSelect.value = $paymentSelect?.value || "";
    if($receiptVenueSelect) $receiptVenueSelect.value = $venueSelect?.value || "";

    // venue wrap（receiptも同じ）
    const showVenue = (settings.currentChannel === "marche");
    if($receiptVenueWrap) $receiptVenueWrap.style.display = showVenue ? "block" : "none";

    saveSettings();
    toggleStatusUI();
    setReceiptMetaText();
  });
}

if($venueSelect){
  $venueSelect.addEventListener("change", ()=>{
    settings.currentVenue = $venueSelect.value;
    if($receiptVenueSelect) $receiptVenueSelect.value = $venueSelect.value;
    saveSettings();
    setReceiptMetaText();
  });
}

if($paymentSelect){
  $paymentSelect.addEventListener("change", ()=>{
    settings.paymentMethod = $paymentSelect.value;
    settings.lastPaymentByChannel = settings.lastPaymentByChannel || {};
    if(settings.currentChannel) settings.lastPaymentByChannel[settings.currentChannel] = settings.paymentMethod;

    if($receiptPaymentSelect) $receiptPaymentSelect.value = $paymentSelect.value;
    saveSettings();
    setReceiptMetaText();
  });
}

// receipt modal change handlers（決済確認画面で編集）
if($receiptChannelSelect){
  $receiptChannelSelect.addEventListener("change", ()=>{
    $channelSelect.value = $receiptChannelSelect.value;
    $channelSelect.dispatchEvent(new Event("change"));
  });
}
if($receiptVenueSelect){
  $receiptVenueSelect.addEventListener("change", ()=>{
    $venueSelect.value = $receiptVenueSelect.value;
    $venueSelect.dispatchEvent(new Event("change"));
  });
}
if($receiptPaymentSelect){
  $receiptPaymentSelect.addEventListener("change", ()=>{
    $paymentSelect.value = $receiptPaymentSelect.value;
    $paymentSelect.dispatchEvent(new Event("change"));
  });
}
if($receiptCustomerName){
  $receiptCustomerName.addEventListener("input", ()=>{
    setReceiptMetaText();
  });
}

if($receiptIsCorporate){
  $receiptIsCorporate.addEventListener("change", ()=>{
    if(($kindSelect?.value || "stock") === "order"){
      loadUrgentCorpBundle().then(()=>{
        const isCorp = !!($receiptIsCorporate && $receiptIsCorporate.checked);
        const list = isCorp ? (masters.urgentOptionsCorp || []) : (masters.urgentOptions || []);
        applyUrgentOptions(list);
        if(!$urgentSelect.value) $urgentSelect.selectedIndex = 0;
        renderReceiptItemsAndTotal();
        setReceiptMetaText();
        saveSettings();
      });
    }else{
      setReceiptMetaText();
    }
  });
}

if($statusSelect){
  $statusSelect.addEventListener("change", ()=>{
    setReceiptMetaText();
    saveSettings();
  });
}

if($urgentSelect){
  $urgentSelect.addEventListener("change", ()=>{
    // お急ぎOP変更 → レシート明細＆合計を即更新
    renderReceiptItemsAndTotal();
    setReceiptMetaText();
    saveSettings();
  });
}

/* =====================================================
   商品マスタ編集（updates/adds patchへ差分保存）
===================================================== */
const $pmModal = $("pmModal");
const $pmCloseBtn = $("pmCloseBtn");
const $pmSaveBtn = $("pmSaveBtn");
const $pmDiscardBtn = $("pmDiscardBtn");const $pmSelect = $("pmSelect");
const $pmId = $("pmId");
const $pmName = $("pmName");
const $pmPrice = $("pmPrice");
const $pmHidden = $("pmHidden");

let pmDirty = false;
let pmDraft = null; // {id,name,price,active}
let pmOrigin = null;

function pmMarkDirty(){ pmDirty = true; }

function pmOpen(mode){
  pmDirty = false;
  pmOrigin = null;
  pmDraft = null;
  pmRenderSelect();

  const pmSelectField = $pmSelect?.closest?.(".field");
  const pmHiddenWrap = $pmHidden?.closest?.("div"); // inner wrap
  if(mode === "add"){
    // 追加：商品名・金額のみ（IDは自動採番）
    const id = pmNextId();
    pmSetForm({ id, name:"", price:"", active:true });
    if($pmHidden) $pmHidden.checked = false;
    if($pmSelect) $pmSelect.value = "";
    if(pmSelectField) pmSelectField.style.display = "none";
    if(pmHiddenWrap) pmHiddenWrap.style.display = "none";
  }else{
    // 修正：対象商品を選んで編集（非表示も可）
    if(pmSelectField) pmSelectField.style.display = "";
    if(pmHiddenWrap) pmHiddenWrap.style.display = "";
    if($pmSelect.options.length > 1){
      $pmSelect.selectedIndex = 1;
      pmLoadFromSelect();
    }else{
      $pmSelect.selectedIndex = 0;
      pmSetForm(null);
    }
  }

  // default select first (placeholderを除いた先頭)
  if(mode !== "add" && $pmSelect.options.length > 1){
    $pmSelect.selectedIndex = 1;
    pmLoadFromSelect();
  }else if(mode !== "add"){
    $pmSelect.selectedIndex = 0;
    pmSetForm(null);
  }
  $pmModal.classList.add("show");
}

function pmClose(force){
  if(!force && pmDirty){
    const ok = confirm("変更があります。保存しますか？");
    if(ok){
      pmSave(true);
      return;
    }
    // 破棄して閉じる
  }
  $pmModal.classList.remove("show");
}

function pmRenderSelect(){
  $pmSelect.innerHTML = "";
  // 「新規追加」時に対象商品を --- 表示にできるよう、先頭にプレースホルダを入れる
  const ph = document.createElement("option");
  ph.value = "";
  ph.textContent = "---";
  $pmSelect.appendChild(ph);

  const list = [...products].sort((a,b)=> (a.id||"").localeCompare(b.id||""));
  for(const p of list){
    const o = document.createElement("option");
    o.value = p.id;
    o.textContent = `${p.id}｜${p.name}（¥${p.price}）`;
    $pmSelect.appendChild(o);
  }
}

function pmSetForm(p){
  pmOrigin = p ? { ...p } : null;
  pmDraft = p ? { id: p.id, name: p.name ?? "", price: p.price ?? "", active: (p.active !== false) } : null;
  $pmId.value = pmDraft?.id || "";
  $pmName.value = pmDraft?.name || "";
  $pmPrice.value = (pmDraft?.price ?? "") + "";
  if($pmHidden) $pmHidden.checked = !(pmDraft?.active ?? true);
}

function pmLoadFromSelect(){
  const id = $pmSelect.value;
  if(!id){
    pmSetForm(null);
    return;
  }
  const p = products.find(x => x.id === id);
  pmSetForm(p);
}

function pmNextId(){
  let max = 0;
  for(const p of products){
    const m = String(p.id||"").match(/^p(\d{3})$/);
    if(m) max = Math.max(max, parseInt(m[1],10));
  }
  return "p" + String(max+1).padStart(3,"0");
}

$pmSelect.addEventListener("change", ()=>{
  pmLoadFromSelect();
});

[$pmName,$pmPrice,$pmHidden].forEach(el=>{
  el.addEventListener("input", pmMarkDirty);
  el.addEventListener("change", pmMarkDirty);
});


async function pmSave(closeAfter){
  if(!pmDraft) return;

  const id = $pmId.value.trim();
  const name = $pmName.value.trim();
  const price = parseInt(($pmPrice.value||"").toString().replace(/[^0-9]/g,""), 10);
  const active = $pmHidden ? (!$pmHidden.checked) : true;

  if(!id){
    alert("IDが不正です");
    return;
  }
  if(!name){
    alert("商品名を入力してください");
    return;
  }
  if(!Number.isFinite(price)){
    alert("価格を数値で入力してください");
    return;
  }

  try{
    // 差分として保存（bundleは後で管理者が更新）
    const targetCol = baseIdSet.has(id) ? COL_PATCH_UPDATES : COL_PATCH_ADDS;

    await setDoc(doc(db, targetCol, id), {
      name,
      price,
      active,
      updatedAt: serverTimestamp(),
      updatedBy: currentUser?.email || ""
    }, { merge: true });

    showToast("保存しました");

    // ローカル表示も更新（次回ロードでpatchが反映されるが、体感のため即反映）
    const idx = products.findIndex(p => p.id === id);
    const merged = { id, name, price, active };
    if(idx >= 0) products[idx] = { ...products[idx], ...merged };
    else products.push(merged);

    renderProducts();
    pmDirty = false;
    if(closeAfter) pmClose(true);
  }catch(e){
    console.error(e);
    alert("保存に失敗しました（権限 or 通信を確認）");
  }
}

$pmSaveBtn.addEventListener("click", ()=> pmSave(true));
$pmDiscardBtn.addEventListener("click", ()=> { pmDirty = false; pmClose(true); });
$pmCloseBtn.addEventListener("click", ()=> pmClose(false));

const loaded = await loadProductsWithPatch();
products = loaded.products;

// 表示用（右上ピルがあれば）
const $masterPill = document.getElementById('masterPill');
if($masterPill){
  $masterPill.textContent = `商品マスタ：${products.length}件`;
}

renderProducts();


/* =====================================================
   Override top selects with masters (if loaded)
===================================================== */
function applyMastersToTopSelects(){
  if(masters.channels?.length) fillSelect($channelSelect, masters.channels, settings.currentChannel);
  if(masters.venues?.length)   fillSelect($venueSelect, masters.venues, settings.currentVenue);
  if(masters.payments?.length) fillSelect($paymentSelect, masters.payments, settings.paymentMethod);

  if(masters.channels?.length) fillSelect($receiptChannelSelect, masters.channels, settings.currentChannel);
  if(masters.venues?.length)   fillSelect($receiptVenueSelect, masters.venues, settings.currentVenue);
  if(masters.payments?.length) fillSelect($receiptPaymentSelect, masters.payments, settings.paymentMethod);

  const showVenue = ($channelSelect.value === "marche");
  if($venueWrap) $venueWrap.style.display = showVenue ? "inline-flex" : "none";
  if($receiptVenueWrap) $receiptVenueWrap.style.display = showVenue ? "block" : "none";
}
applyMastersToTopSelects();
// bundle/patch読込後のselect再描画でもルールを維持
settings.currentChannel = $channelSelect.value;
settings.currentVenue = $venueSelect.value;
settings.paymentMethod = $paymentSelect.value;
applyChannelRules({ forcePayment:true });
saveSettings();

/* =====================================================
   Masters modal (patch writer)
===================================================== */
let currentMasterKey = "channels";
let currentMasterMode = "edit"; // "add" | "edit"

function mastersOpen(key, mode){
  if(key) currentMasterKey = key;
  currentMasterMode = mode || "edit";
  if(!$mastersModal) return;

  // title
  if($mastersTitle){
    const labelMap = { channels:"販売方法マスタ編集", venues:"開催場所マスタ編集", payments:"決済方法マスタ編集", kinds:"kindマスタ編集", urgentOptions:"お急ぎOPマスタ編集" };
    $mastersTitle.textContent = labelMap[currentMasterKey] || "マスタ編集";
  }

  // mode UI
  if($masterAddRowBtn) $masterAddRowBtn.style.display = (currentMasterMode === "add") ? "" : "none";
  if($masterDeleteRowBtn) $masterDeleteRowBtn.style.display = (currentMasterMode === "add") ? "" : "none";

  $mastersModal.classList.add("show");
  $mastersModal.setAttribute("aria-hidden","false");

  // rows
  $masterRows.innerHTML = "";
  if(currentMasterMode === "add"){
    addRow("", "", true); // 1行だけ
  }else{
    buildMasterRows();
  }
}

function mastersClose(){
  if(!$mastersModal) return;
  $mastersModal.classList.remove("show");
  $mastersModal.setAttribute("aria-hidden","true");
}

function buildMasterRows(){
  const key = currentMasterKey;
  const arr = masters[key] || [];
  $masterRows.innerHTML = "";
  arr.forEach(x => addRow(x.id, (x.label ?? x.name ?? ""), x.active !== false));
}

function slugifyId(text){
  const base = (text || "")
    .toString()
    .trim()
    .toLowerCase()
    .replace(/[　\s]+/g, "_")
    .replace(/[^a-z0-9_]/g, "")
    .replace(/^_+|_+$/g, "");
  return base || "item";
}

function ensureUniqueId(desired){
  const existing = new Set(
    [...$masterRows.querySelectorAll(".m_id")]
      .map(i => (i.value || "").trim())
      .filter(Boolean)
  );
  let id = desired;
  let n = 2;
  while(existing.has(id)){
    id = `${desired}_${n++}`;
  }
  return id;
}

function addRow(id="", label="", active=true){
  const isAddMode = (currentMasterMode === "add");

  const row = document.createElement("div");
  row.className = "card";
  row.style.padding = "12px";

  // delete button removed (use top "行を削除")
  const delHtml = ``;

row.innerHTML = `
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <span class="label" style="display:inline-flex; align-items:center; gap:8px;">
        id <input class="m_id" style="width:180px" value="${escapeHtml(id)}" placeholder="例: marche" ${isAddMode ? "" : "disabled"} />
      </span>
      <span class="label" style="display:inline-flex; align-items:center; gap:8px;">
        表示 <input class="m_label" style="width:220px" value="${escapeHtml(label)}" placeholder="例: マルシェ" />
      </span>
      <span class="label" style="display:inline-flex; align-items:center; gap:8px;">
        有効 <input class="m_active" type="checkbox" ${active ? "checked":""} />
      </span>
      ${delHtml}
    </div>
    <div class="muted" style="margin-top:8px;">※ 基本はactive=falseで非表示運用がおすすめ</div>
  `;

  const $id = row.querySelector(".m_id");
  const $label = row.querySelector(".m_label");

  // 追加モード：表示名からID自動生成（IDが空のときだけ）
  if(isAddMode){
    const autoFill = ()=>{
      if(!$id) return;
      const cur = ($id.value || "").trim();
      if(cur) return; // 既に入ってるなら触らない
      const base = slugifyId(($label?.value || "").trim());
      $id.value = ensureUniqueId(base);
    };
    if($label){
      $label.addEventListener("blur", autoFill);
      $label.addEventListener("change", autoFill);
    }
  }
$masterRows.appendChild(row);
}

function escapeHtml(str){
  return (str ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

async function saveMasterRows(){
  const key = currentMasterKey;
  const def = MASTER_DEFS[key];
  const bundleIds = masterBundleIds[key] || new Set();

  const rows = [...$masterRows.querySelectorAll(".card")].map(card=>{
    const id = card.querySelector(".m_id").value.trim();
    const label = card.querySelector(".m_label").value.trim();
    const active = card.querySelector(".m_active").checked;
    return { id, label, active };
  }).filter(r=>r.id);

  for(const r of rows){
    // 修正モードは「既存IDのみ」想定。ID変更をdisabledにしてるので基本ここは安全。
    const collName = bundleIds.has(r.id) ? def.updates : def.adds;
    await setDoc(doc(db, collName, r.id), { label: r.label, active: r.active }, { merge:true });
  }

  await initSimpleMaster(key);
  applyMastersToTopSelects();
// bundle/patch読込後のselect再描画でもルールを維持
settings.currentChannel = $channelSelect.value;
settings.currentVenue = $venueSelect.value;
settings.paymentMethod = $paymentSelect.value;
applyChannelRules({ forcePayment:true });
saveSettings();
  await refreshPatchSummary();
  showToast("マスタ保存OK");
}

if($mastersCloseBtn)  $mastersCloseBtn.addEventListener("click", mastersClose);
if($masterAddRowBtn)  $masterAddRowBtn.addEventListener("click", ()=>addRow());
if($masterDeleteRowBtn) $masterDeleteRowBtn.addEventListener("click", ()=>{
  if(currentMasterMode !== "add") return;
  const rows = $masterRows ? Array.from($masterRows.children) : [];
  if(rows.length === 0) return;

  if(rows.length === 1){
    const only = rows[0];
    const idI = only.querySelector(".m_id");
    const labI = only.querySelector(".m_label");
    const actI = only.querySelector(".m_active");
    if(idI) idI.value = "";
    if(labI) labI.value = "";
    if(actI) actI.checked = true;
    return;
  }
  rows[rows.length - 1].remove();
});
if($masterSaveBtn)    $masterSaveBtn.addEventListener("click", async ()=>{
  try{
    await saveMasterRows();
    // 保存後は閉じる（他マスタと同じ挙動）
    closeModeModal();
  }
  catch(e){ console.error(e); alert("保存に失敗しました"); }
});


/* =====================================================
   Master menu (⚙) 5 choices
===================================================== */
if($masterMenuCloseBtn) $masterMenuCloseBtn.addEventListener("click", closeMasterMenu);
if($masterMenuModal){
  $masterMenuModal.addEventListener("click",(e)=>{
    if(e.target === $masterMenuModal) closeMasterMenu();
  });
}

function goMaster(key,label){
  closeMasterMenu();
  openModeModal(key,label);
}

if($menuProductMasterBtn)  $menuProductMasterBtn.onclick  = ()=> goMaster("products","商品マスタ編集");
if($menuChannelsMasterBtn) $menuChannelsMasterBtn.onclick = ()=> goMaster("channels","販売方法マスタ編集");
if($menuVenuesMasterBtn)   $menuVenuesMasterBtn.onclick   = ()=> goMaster("venues","開催場所マスタ編集");
if($menuPaymentsMasterBtn) $menuPaymentsMasterBtn.onclick = ()=> goMaster("payments","決済方法マスタ編集");
if($menuKindsMasterBtn)    $menuKindsMasterBtn.onclick    = ()=> goMaster("kinds","kindマスタ編集");
if($menuUrgentOptionsMasterBtn) $menuUrgentOptionsMasterBtn.onclick = ()=> goMaster("urgentOptions","お急ぎOPマスタ編集");

if($masterModeCloseBtn) $masterModeCloseBtn.onclick = closeModeModal;
if($masterModeModal){
  $masterModeModal.addEventListener("click",(e)=>{
    if(e.target === $masterModeModal) closeModeModal();
  });
}

if($masterModeAddBtn) $masterModeAddBtn.onclick = ()=>{
  pendingMasterEditMode = "add";
  closeModeModal();
  if(pendingMasterKey === "products") pmOpen("add");
  else mastersOpen(pendingMasterKey, "add");
};
if($masterModeEditBtn) $masterModeEditBtn.onclick = ()=>{
  pendingMasterEditMode = "edit";
  closeModeModal();
  if(pendingMasterKey === "products") pmOpen("edit");
  else mastersOpen(pendingMasterKey, "edit");
};

// admin diff popover (next to status)
if($diffPill){
  $diffPill.addEventListener("click", ()=>{
    const show = ($diffPop.style.display === "none" || $diffPop.style.display === "");
    $diffPop.style.display = show ? "block" : "none";
  });
}
document.addEventListener("click", (e)=>{
  if(!$diffPop || !$diffPill) return;
  if(e.target === $diffPill || $diffPill.contains(e.target)) return;
  if($diffPop.contains(e.target)) return;
  $diffPop.style.display = "none";
});

// admin pill popover
if($patchPill){
  $patchPill.addEventListener("click", ()=>{
    const show = $patchPop.style.display === "none";
    $patchPop.style.display = show ? "block" : "none";
  });
}
document.addEventListener("click", (e)=>{
  if(!$patchPop || !$patchPill) return;
  if(e.target === $patchPill || $patchPill.contains(e.target)) return;
  if($patchPop.contains(e.target)) return;
  $patchPop.style.display = "none";
});
</script>
</body>
</html>
