<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>e.nue åæ”¯é›†è¨ˆ</title>

  <style>
    :root{
      --bg1:#e3ddd4;
      --bg2:#d4ccc1;

      --glass-bg: rgba(255,255,255,.86);
      --glass-bg2: rgba(255,255,255,.78);
      --glass-border: rgba(0,0,0,.06);
      --line-soft: rgba(0,0,0,.10);
      --shadow: 0 18px 45px rgba(0,0,0,.14);

      --text-main:#222222;
      --muted: rgba(34,34,34,.58);

      --accent:#e18a6a;
      --accent2:#d06463;

      --r: 20px;
      --max: 980px;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", "Noto Sans JP", sans-serif;
      background:
        radial-gradient(1200px 800px at 18% 8%, rgba(225,138,106,.18), transparent 55%),
        radial-gradient(1200px 800px at 88% 0%, rgba(208,100,99,.14), transparent 52%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      color: var(--text-main);
    }
    a{ color: inherit; text-decoration: none; }

    .wrap{
      min-height: 100%;
      padding: 18px 14px 28px;
      display:flex;
      justify-content:center;
    }
    .app{
      width:100%;
      max-width: var(--max);
    }

    /* header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 6px 2px 14px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand .title{
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .02em;
    }
    .brand .sub{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }
    .navBtns{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      border:1px solid var(--glass-border);
      background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.76));
      box-shadow: 0 10px 25px rgba(0,0,0,.08);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 900;
      font-size: 12px;
      color: rgba(34,34,34,.82);
      cursor:pointer;
      display:inline-flex;
      gap:8px;
      align-items:center;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(225,138,106,.22), rgba(255,255,255,.78));
      border-color: rgba(225,138,106,.25);
    }

    /* cards */
    .card{
      background: linear-gradient(180deg, var(--glass-bg), var(--glass-bg2));
      border: 1px solid var(--glass-border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .cardHead{
      padding: 14px 14px 10px;
      display:flex;
      gap:10px;
      align-items:flex-end;
      justify-content:space-between;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .cardHead .h{
      font-size: 14px;
      font-weight: 1000;
      letter-spacing: .02em;
    }
    .cardHead .meta{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }
    .cardBody{ padding: 12px 14px 14px; }

    .seg{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .seg button{
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.70);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 1000;
      font-size: 12px;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
    }
    .seg button.on{
      background: rgba(17,17,17,.92);
      color:#fff;
      border-color: rgba(17,17,17,.92);
    }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top: 10px;
    }
    .leftControls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .field{
      display:flex;
      gap:8px;
      align-items:center;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.70);
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
    }
    .field label{
      font-size: 12px;
      font-weight: 1000;
      color: rgba(34,34,34,.72);
      white-space:nowrap;
    }
    select, input[type="month"]{
      border:0;
      outline:none;
      background: transparent;
      font-size: 13px;
      font-weight: 900;
      color: rgba(34,34,34,.88);
      min-width: 130px;
    }

    .stats{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:10px;
      margin-top: 12px;
    }
    @media (max-width: 560px){
      .stats{ grid-template-columns: 1fr; }
    }
    .stat{
      background: rgba(255,255,255,.62);
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 16px;
      padding: 12px 12px;
      box-shadow: 0 12px 22px rgba(0,0,0,.05);
    }
    .stat .k{
      font-size: 12px;
      font-weight: 1000;
      color: rgba(34,34,34,.62);
    }
    .stat .v{
      margin-top: 4px;
      font-size: 20px;
      font-weight: 1100;
      letter-spacing: .01em;
    }
    .stat .s{
      margin-top: 2px;
      font-size: 12px;
      font-weight: 900;
      color: rgba(34,34,34,.55);
    }

    .tableWrap{
      margin-top: 12px;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.58);
    }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 680px; /* iPhone æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
      font-size: 12px;
    }
    th,td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(0,0,0,.06);
      white-space:nowrap;
      font-weight: 900;
    }
    th{
      text-align:left;
      color: rgba(34,34,34,.74);
      background: rgba(255,255,255,.60);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    td{ color: rgba(34,34,34,.86); }
    tr:last-child td{ border-bottom: 0; }
    .right{ text-align:right; }
    .neg{ color: rgba(208,100,99,.95); }
    .pos{ color: rgba(30,140,86,.95); }

    .smallNote{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(34,34,34,.58);
      font-weight: 800;
      line-height: 1.55;
    }

    .empty{
      padding: 14px 0 2px;
      color: rgba(34,34,34,.62);
      font-weight: 900;
      font-size: 13px;
    }

    .toast{
      position:fixed;
      left:50%;
      transform: translateX(-50%);
      bottom: 18px;
      background: rgba(25,25,25,.88);
      color:#fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 99;
    }
    .toast.on{ opacity:1; transform: translateX(-50%) translateY(-2px); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="app">

      <div class="topbar">
        <div class="brand">
          <div class="title">åæ”¯é›†è¨ˆ</div>
          <div class="sub">å£²ä¸Šï¼ˆsalesï¼‰âˆ’ æ”¯å‡ºï¼ˆexpense_receiptsï¼‰ã‚’é›†è¨ˆ</div>
        </div>

        <div class="navBtns">
          <button class="btn" id="btnHome">ğŸ  HOME</button>
          <button class="btn" id="btnOther">â¬› OTHER</button>
          <button class="btn primary" id="btnReload">â†» å†èª­è¾¼</button>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div class="h">é›†è¨ˆ</div>
          <div class="meta" id="authState">ç¢ºèªä¸­â€¦</div>
        </div>

        <div class="cardBody">
          <div class="seg">
            <button id="modeYear" class="on" type="button">å¹´åˆ¥</button>
            <button id="modeMonth" type="button">æœˆåˆ¥</button>
          </div>

          <div class="controls">
            <div class="leftControls" id="yearControls">
              <div class="field">
                <label>å¹´</label>
                <select id="yearSel"></select>
              </div>
            </div>

            <div class="leftControls" id="monthControls" style="display:none;">
              <div class="field">
                <label>æœˆ</label>
                <input id="monthInput" type="month" />
              </div>
            </div>

            <div class="leftControls">
              <div class="field">
                <label>è¡¨ç¤º</label>
                <select id="detailSel">
                  <option value="net">ç·è³‡ç”£ã®ã¿</option>
                  <option value="full">å£²ä¸Š/æ”¯å‡ºã‚‚è¡¨ç¤º</option>
                </select>
              </div>
            </div>
          </div>

          <div class="stats" id="stats"></div>

          <div id="detailArea"></div>

          <div class="smallNote">
            ãƒ»å£²ä¸Šã¯ <b>sales.total</b> ã®åˆè¨ˆï¼ˆè¿”é‡‘ã¯ãƒã‚¤ãƒŠã‚¹ sales ã®ãŸã‚è‡ªå‹•ã§æ§é™¤ï¼‰<br>
            ãƒ»æ”¯å‡ºã¯ <b>expenses.amount</b> ã®åˆè¨ˆï¼ˆæ­£ã®å€¤æƒ³å®šï¼‰<br>
            ãƒ»ç¾çŠ¶ç·è³‡ç”£ï¼ï¼ˆå£²ä¸Šåˆè¨ˆ âˆ’ æ”¯å‡ºåˆè¨ˆï¼‰ã¨ã—ã¦è¡¨ç¤ºï¼ˆåˆæœŸè³‡é‡‘ãªã©ãŒå¿…è¦ãªã‚‰å¾Œã§è¶³ã—è¾¼ã¿å¯èƒ½ï¼‰
          </div>
        </div>
      </div>

      <div class="toast" id="toast"></div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import {
    getFirestore, collection, query, where, orderBy, getDocs, limit, Timestamp
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  // âœ… æœ¬ç•ªï¼ˆæ—¢å­˜ãƒšãƒ¼ã‚¸ã¨åŒã˜ï¼‰
  const firebaseConfig = {
    apiKey: "AIzaSyAhPCgPoJK6S6BWVcBZOruYqMPXVQXQFRk",
    authDomain: "handmade-pos.firebaseapp.com",
    projectId: "handmade-pos",
    storageBucket: "handmade-pos.firebasestorage.app",
    messagingSenderId: "174873514252",
    appId: "1:174873514252:web:c26659bffca850d475f929"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM
  const $ = (id)=>document.getElementById(id);
  const authState = $("authState");
  const toastEl = $("toast");

  const btnHome = $("btnHome");
  const btnOther = $("btnOther");
  const btnReload = $("btnReload");

  const modeYearBtn = $("modeYear");
  const modeMonthBtn = $("modeMonth");

  const yearControls = $("yearControls");
  const monthControls = $("monthControls");
  const yearSel = $("yearSel");
  const monthInput = $("monthInput");
  const detailSel = $("detailSel");

  const statsEl = $("stats");
  const detailArea = $("detailArea");

  // routing
  btnHome.addEventListener("click", ()=> location.href = "index.html");
  btnOther.addEventListener("click", ()=> location.href = "otherpage.html");
  btnReload.addEventListener("click", ()=> refresh(true));

  // helpers
  const pad2 = (n)=> String(n).padStart(2,"0");
  const ymKey = (d)=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;

  const fmtJPY = (n)=>{
    const v = Number(n||0);
    return "Â¥" + Math.round(v).toLocaleString("ja-JP");
  };

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("on");
    setTimeout(()=>toastEl.classList.remove("on"), 1400);
  }
  function cls(el, on, c){
    if(on) el.classList.add(c);
    else el.classList.remove(c);
  }
  function toDate(v){
    try{
      if(!v) return null;
      if(typeof v.toDate === "function") return v.toDate();
      if(v instanceof Date) return v;
      if(typeof v === "number") return new Date(v);
      if(typeof v === "string"){ const d=new Date(v); return isNaN(d.getTime())?null:d; }
      return null;
    }catch{ return null; }
  }
  function monthRange(ymStr){
    const [Y,M] = ymStr.split("-").map(Number);
    const start = new Date(Y, M-1, 1, 0,0,0,0);
    const end = new Date(Y, M, 1, 0,0,0,0);
    return { start, end };
  }
  function fillYearOptions(nowY, years){
    const arr = (years?.length ? years : []);
    const set = new Set(arr);
    if(!set.has(nowY)) arr.unshift(nowY);
    const unique = [...new Set(arr)].sort((a,b)=>b-a);

    yearSel.innerHTML = "";
    for(const y of unique){
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = `${y}å¹´`;
      yearSel.appendChild(opt);
    }
    yearSel.value = String(nowY);
  }

  // ---- Data (sales: bundle + firebase) -----------------
  let rawSalesAll = [];  // normalized [{id,date,total,channel,_ym,isBundled}]
  let lastSourceCounts = { json: 0, firebase: 0 };

  function safeStr(v){ return (v==null) ? "" : String(v); }

  function normalizeSale(docLike){
    // docLike: { id, data:()=>{...} } or Firestore docSnap
    const id = safeStr(docLike?.id || "").trim() || ("sale_" + Math.random().toString(36).slice(2,9));
    const d = (typeof docLike?.data === "function") ? (docLike.data()||{}) : (docLike||{});
    const total = Number(d.total ?? d.totalAmount ?? d.grandTotal ?? d.amount ?? 0) || 0;

    const date =
      toDate(d.createdAt) ||
      (Number.isFinite(Number(d.orderDateMs)) ? new Date(Number(d.orderDateMs)) : null) ||
      (Number.isFinite(Number(d.clientCreatedAt)) ? new Date(Number(d.clientCreatedAt)) : null) ||
      (safeStr(d.orderDate) ? new Date(safeStr(d.orderDate)) : null) ||
      new Date(0);

    const channel = safeStr(d.channelLabel ?? d.channel ?? d.channelId ?? "").trim();
    const sale = { id, date, total, channel, isBundled: !!d.isBundled };
    sale._ym = ymKey(date);
    return sale;
  }

  async function loadBundleSales(){
  /*
    âœ… sales bundle loader (éšå±¤å¯¾å¿œãƒ»å°†æ¥æ‹¡å¼µOK)

    1) ã¾ãšã¯ã€Œä¸€è¦§ãƒ•ã‚¡ã‚¤ãƒ«ã€ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†ï¼ˆãŠã™ã™ã‚ï¼‰
       - sales_data/index.json
         ä¾‹: { "bundles": ["sales_data/2025/sales_bundle.json","sales_data/2026/jan/sales_bundle.json"] }

       â€» 2027å¹´, 2028å¹´â€¦ã¨å¢—ãˆã¦ã‚‚ã€"index.json" ã«ãƒ‘ã‚¹ã‚’è¿½è¨˜ã™ã‚‹ã ã‘ã§OKï¼ˆã‚³ãƒ¼ãƒ‰å¤‰æ›´ä¸è¦ï¼‰

    2) ç„¡ã‘ã‚Œã°å¾“æ¥ã®å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«å€™è£œã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå£Šã•ãªã„ï¼‰
  */

  // ---- (A) index/manifestæ–¹å¼ï¼šã“ã“ã ã‘æ›´æ–°ã™ã‚Œã°å¹´ãŒå¢—ãˆã¦ã‚‚è¿½å¾“ã§ãã‚‹ ----
  const indexCandidates = [
    "./sales_data/index.json",
    "sales_data/index.json",
    "./sales_data/manifest.json",
    "sales_data/manifest.json"
  ];

  const indexObj = await (async()=>{
    for(const url of indexCandidates){
      try{
        const res = await fetch(url, { cache: "no-store" });
        if(!res.ok) continue;
        const js = await res.json();
        if(js && (Array.isArray(js.bundles) || Array.isArray(js.files))) return js;
      }catch(e){}
    }
    return null;
  })();

  // bundlesï¼ˆæ¨å¥¨ï¼‰ or filesï¼ˆäº’æ›ï¼‰ã‚’è¨±å®¹
  const bundlePaths = indexObj
    ? (Array.isArray(indexObj.bundles) ? indexObj.bundles
      : Array.isArray(indexObj.files) ? indexObj.files : [])
    : [];

  // 1æœ¬ã§ã‚‚æŒ‡å®šãŒã‚ã‚Œã°ã€ãã“ã‹ã‚‰é›†ç´„ã—ã¦è¿”ã™
  if(bundlePaths.length){
    const list = [];
    let throughMs = 0;

    // ä¸¦åˆ—å–ã‚Šã™ãé˜²æ­¢ï¼ˆGitHub Pagesæƒ³å®šï¼‰
    const CONCURRENCY = 4;
    const queue = [...bundlePaths].filter(Boolean);

    async function worker(){
      while(queue.length){
        const path = queue.shift();
        try{
          const res = await fetch(path, { cache: "no-store" });
          if(!res.ok) continue;
          const json = await res.json();
          const arr = Array.isArray(json) ? json : (Array.isArray(json.sales) ? json.sales : []);
          if(!arr.length) continue;

          for(const d of arr){
            const id = safeStr(d?.id || d?.saleId || "").trim() || `bundle_${list.length}`;
            const data = { ...d, id, isBundled: true, source: "bundle" };
            const s = normalizeSale({ id, data: ()=>data });
            list.push(s);

            const t = Math.max(
              Number(deref(s, "clientCreatedAt")||0),
              Number(deref(s, "orderDateMs")||0),
              Number(s.date?.getTime ? s.date.getTime() : 0)
            );
            if(t > throughMs) throughMs = t;
          }
        }catch(e){
          // ignore and continue
        }
      }
    }

    const workers = [];
    for(let i=0;i<CONCURRENCY;i++) workers.push(worker());
    await Promise.all(workers);

    if(!list.length) return { list: [], throughMs: 0 };
    return { list, throughMs };
  }

  // ---- (B) å¾“æ¥æ–¹å¼ï¼šå˜ä¸€ sales_bundle.json ã‚’èª­ã‚€ï¼ˆå¾Œæ–¹äº’æ›ï¼‰ ----
  const candidates = [
    "./sales_bundle.json",
    "sales_bundle.json",
    "./bundle/sales_bundle.json",
    "bundle/sales_bundle.json"
  ];

  for(const url of candidates){
    try{
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) continue;
      const json = await res.json();
      const arr = Array.isArray(json) ? json : (Array.isArray(json.sales) ? json.sales : []);
      if(!arr.length) return { list: [], throughMs: 0 };

      const list = arr.map((d, idx)=>{
        const id = safeStr(d.id || d.saleId || "").trim() || `bundle_${idx}`;
        const data = { ...d, id, isBundled: true, source: "bundle" };
        return normalizeSale({ id, data: ()=>data });
      });

      let throughMs = 0;
      for(const s of list){
        const t = Math.max(
          Number(deref(s, "clientCreatedAt")||0),
          Number(deref(s, "orderDateMs")||0),
          Number(s.date?.getTime ? s.date.getTime() : 0)
        );
        if(t > throughMs) throughMs = t;
      }
      return { list, throughMs };
    }catch(e){
      // try next
    }
  }
  return { list: [], throughMs: 0 };
}

  function deref(obj, key){
    try{ return obj?.[key]; }catch{ return undefined; }
  }

  async function loadSalesAll(){
    // 1) bundle
    const bundle = await loadBundleSales();
    const bundleList = bundle.list || [];
    const throughMs = Number(bundle.throughMs || 0);

    // 2) firestore delta (createdAt > throughMs)
    let fbList = [];
    try{
      const since = Timestamp.fromMillis(throughMs || 0);
      const qy = query(
        collection(db, "sales"),
        where("createdAt", ">", since),
        orderBy("createdAt", "asc"),
        limit(5000)
      );
      const snap = await getDocs(qy);
      snap.forEach(d=> fbList.push(normalizeSale(d)));
    }catch(e){
      // fallback: æœ€æ–°ã‚’è–„ãèª­ã‚€ï¼ˆãƒšãƒ¼ã‚¸ãŒæ­»ãªãªã„ã‚ˆã†ã«ï¼‰
      try{
        const q2 = query(collection(db,"sales"), orderBy("createdAt","desc"), limit(200));
        const snap2 = await getDocs(q2);
        const tmp = [];
        snap2.forEach(d=> tmp.push(normalizeSale(d)));
        fbList = tmp.filter(s=> (s.date?.getTime?.()||0) > throughMs);
      }catch(_e){
        fbList = [];
      }
    }

    // merge (id unique)
    const map = new Map();
    for(const s of bundleList) map.set(s.id, s);
    for(const s of fbList) map.set(s.id, s);

    rawSalesAll = [...map.values()];
    // source counts
    lastSourceCounts = { json: bundleList.length, firebase: fbList.length };
    return rawSalesAll;
  }

  // ---- expense_receipts loaders -----------------------
  function receiptToRow(docSnap){
    const d = docSnap.data() || {};
    return {
      id: docSnap.id,
      date: safeStr(d.date || ""),     // "YYYY-MM-DD"
      year: Number(d.year || 0) || 0,
      month: Number(d.month || 0) || 0,
      store: safeStr(d.store || "").trim() || "(æœªè¨­å®š)",
      sum: Number(d.sum || 0) || 0,
      memo: safeStr(d.memo || "")
    };
  }

  async function loadExpenseReceiptsByYear(year){
    const qy = query(
      collection(db, "expense_receipts"),
      where("year", "==", Number(year)),
      limit(8000)
    );
    const snap = await getDocs(qy);
    let total = 0;
    const rows = [];
    snap.forEach(docSnap=>{
      const r = receiptToRow(docSnap);
      total += (Number.isFinite(r.sum) ? r.sum : 0);
      rows.push(r);
    });
    return { total, rows };
  }

  async function loadExpenseReceiptsByMonth(year, month){
    const qy = query(
      collection(db, "expense_receipts"),
      where("year", "==", Number(year)),
      where("month", "==", Number(month)),
      limit(8000)
    );
    const snap = await getDocs(qy);
    let total = 0;
    const rows = [];
    snap.forEach(docSnap=>{
      const r = receiptToRow(docSnap);
      total += (Number.isFinite(r.sum) ? r.sum : 0);
      rows.push(r);
    });
    return { total, rows };
  }

  // ---- Aggregations
  function sumByKey(rows, keyFn, valFn){
    const m = new Map();
    for(const r of rows){
      const k = keyFn(r);
      const v = Number(valFn(r)||0);
      m.set(k, (m.get(k)||0) + (Number.isFinite(v)?v:0));
    }
    return m;
  }
  function topN(map, n=5){
    return [...map.entries()]
      .sort((a,b)=> Math.abs(b[1]) - Math.abs(a[1]))
      .slice(0,n);
  }

  // ---- Renderers
  function renderStats({ salesTotal, expensesTotal }){
    const net = Number(salesTotal||0) - Number(expensesTotal||0);
    const detailMode = detailSel.value;

    statsEl.innerHTML = "";

    const mk = (k, v, s, clsName)=>{
      const d = document.createElement("div");
      d.className = "stat";
      d.innerHTML = `<div class="k">${k}</div><div class="v">${v}</div><div class="s">${s||""}</div>`;
      if(clsName) d.querySelector(".v").classList.add(clsName);
      statsEl.appendChild(d);
    };

    mk("å½“æœˆ/å½“å¹´ å·®å¼•", fmtJPY(net), (mode==="year" ? "å¹´åˆè¨ˆ" : "æœˆåˆè¨ˆ"), net<0 ? "neg" : "pos");

    if(detailMode==="full"){
      mk("å£²ä¸Š åˆè¨ˆ", fmtJPY(salesTotal), `sales.total åˆç®—ï¼ˆjson:${lastSourceCounts.json} / firebase:${lastSourceCounts.firebase}ï¼‰`);
      mk("æ”¯å‡º åˆè¨ˆ", fmtJPY(expensesTotal), "expense_receipts.sum åˆç®—");
    }
  }

  function renderYearDetail(year, byMonthSales, byMonthExpenses, salesRows, expRows){
    const detailMode = detailSel.value;

    // æœˆæ¬¡è¡¨
    const rows = [];
    for(let m=1;m<=12;m++){
      const key = `${year}-${pad2(m)}`;
      const s = byMonthSales.get(key) || 0;
      const e = byMonthExpenses.get(key) || 0;
      const net = s - e;
      rows.push({ key, s, e, net });
    }

    const wrap = document.createElement("div");
    wrap.className = "tableWrap";
    const tbl = document.createElement("table");
    tbl.innerHTML = `
      <thead>
        <tr>
          <th>æœˆ</th>
          ${detailMode==="full" ? `<th class="right">å£²ä¸Š</th><th class="right">æ”¯å‡º</th>` : ``}
          <th class="right">å·®å¼•</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;
    const tb = tbl.querySelector("tbody");

    for(const r of rows){
      const tr = document.createElement("tr");
      const mm = Number(r.key.split("-")[1]);
      const netCls = r.net < 0 ? "neg" : "pos";

      tr.innerHTML = `
        <td>${mm}æœˆ</td>
        ${detailMode==="full" ? `<td class="right">${fmtJPY(r.s)}</td><td class="right">${fmtJPY(r.e)}</td>` : ``}
        <td class="right ${netCls}">${fmtJPY(r.net)}</td>
      `;
      tb.appendChild(tr);
    }

    wrap.appendChild(tbl);

    // breakdown
    const salesByChannel = sumByKey(salesRows, r=> (r.channel||"(æœªè¨­å®š)"), r=> r.total);
    const expByStore = sumByKey(expRows, r=> (r.store||"(æœªè¨­å®š)"), r=> r.sum);

    const extra = document.createElement("div");
    extra.style.marginTop = "12px";

    const mkList = (title, items)=>{
      const box = document.createElement("div");
      box.className = "miniCard";
      box.innerHTML = `<div class="miniTitle">${title}</div><div class="miniBody"></div>`;
      const b = box.querySelector(".miniBody");

      if(!items.length){
        b.innerHTML = `<div class="empty">ãƒ‡ãƒ¼ã‚¿ãªã—</div>`;
      }else{
        const ul = document.createElement("div");
        ul.className = "miniList";
        for(const [k,v] of items){
          const row = document.createElement("div");
          row.className = "miniRow";
          row.innerHTML = `<div class="miniK">${escapeHtml(k)}</div><div class="miniV">${fmtJPY(v)}</div>`;
          ul.appendChild(row);
        }
        b.appendChild(ul);
      }
      return box;
    };

    extra.appendChild(mkList("å£²ä¸Š Topï¼ˆchannelï¼‰", topN(salesByChannel, 5)));
    extra.appendChild(mkList("æ”¯å‡º Topï¼ˆstoreï¼‰", topN(expByStore, 5)));

    // output
    detailArea.innerHTML = "";
    detailArea.appendChild(wrap);
    if(detailMode==="full") detailArea.appendChild(extra);
  }

  function renderMonthDetail(ym, salesRows, expRows){
    const detailMode = detailSel.value;

    const wrap = document.createElement("div");
    wrap.className = "tableWrap";

    const sTotal = salesRows.reduce((a,r)=>a+(Number(r.total||0)||0),0);
    const eTotal = expRows.reduce((a,r)=>a+(Number(r.sum||0)||0),0);
    const net = sTotal - eTotal;

    const tbl = document.createElement("table");
    tbl.innerHTML = `
      <thead>
        <tr>
          <th>${ym}</th>
          ${detailMode==="full" ? `<th class="right">å£²ä¸Š</th><th class="right">æ”¯å‡º</th>` : ``}
          <th class="right">å·®å¼•</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>åˆè¨ˆ</td>
          ${detailMode==="full" ? `<td class="right">${fmtJPY(sTotal)}</td><td class="right">${fmtJPY(eTotal)}</td>` : ``}
          <td class="right ${(net<0)?"neg":"pos"}">${fmtJPY(net)}</td>
        </tr>
      </tbody>
    `;
    wrap.appendChild(tbl);

    // breakdown
    const salesByChannel = sumByKey(salesRows, r=> (r.channel||"(æœªè¨­å®š)"), r=> r.total);
    const expByStore = sumByKey(expRows, r=> (r.store||"(æœªè¨­å®š)"), r=> r.sum);

    const extra = document.createElement("div");
    extra.style.marginTop = "12px";

    const mkList = (title, items)=>{
      const box = document.createElement("div");
      box.className = "miniCard";
      box.innerHTML = `<div class="miniTitle">${title}</div><div class="miniBody"></div>`;
      const b = box.querySelector(".miniBody");

      if(!items.length){
        b.innerHTML = `<div class="empty">ãƒ‡ãƒ¼ã‚¿ãªã—</div>`;
      }else{
        const ul = document.createElement("div");
        ul.className = "miniList";
        for(const [k,v] of items){
          const row = document.createElement("div");
          row.className = "miniRow";
          row.innerHTML = `<div class="miniK">${escapeHtml(k)}</div><div class="miniV">${fmtJPY(v)}</div>`;
          ul.appendChild(row);
        }
        b.appendChild(ul);
      }
      return box;
    };

    extra.appendChild(mkList("å£²ä¸Š Topï¼ˆchannelï¼‰", topN(salesByChannel, 5)));
    extra.appendChild(mkList("æ”¯å‡º Topï¼ˆstoreï¼‰", topN(expByStore, 5)));

    detailArea.innerHTML = "";
    detailArea.appendChild(wrap);
    if(detailMode==="full") detailArea.appendChild(extra);
  }

  function escapeHtml(s){
    return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }

  // ---- UI / state ------------------------------------
  let currentUser = null;
  let mode = "year"; // "year" | "month"

  let cacheYear = new Map();   // year -> { salesTotal, expTotal, byMonthSales, byMonthExpenses, salesRows, expRows }
  let cacheMonth = new Map();  // "YYYY-MM" -> { salesTotal, expTotal, salesRows, expRows }

  function setMode(next){
    mode = next;
    cls(modeYearBtn, mode==="year", "primary");
    cls(modeMonthBtn, mode==="month", "primary");

    yearControls.style.display = (mode==="year") ? "" : "none";
    monthControls.style.display = (mode==="month") ? "" : "none";
  }

  modeYearBtn.addEventListener("click", ()=>{ setMode("year"); refresh(false); });
  modeMonthBtn.addEventListener("click", ()=>{ setMode("month"); refresh(false); });

  yearSel.addEventListener("change", ()=> refresh(false));
  monthInput.addEventListener("change", ()=> refresh(false));
  detailSel.addEventListener("change", ()=> refresh(false));

  async function refresh(force){
    if(!currentUser){
      authState.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³";
      return;
    }

    // åˆå›ã ã‘ sales ã‚’èª­ã¿è¾¼ã‚€ï¼ˆbundle + firebase deltaï¼‰
    if(force || rawSalesAll.length===0){
      try{
        authState.textContent = "èª­è¾¼ä¸­â€¦";
        await loadSalesAll();
      }catch(e){
        console.error(e);
        toast("sales èª­è¾¼ã«å¤±æ•—");
      }
    }

    const now = new Date();
    const y = Number(yearSel.value || now.getFullYear());
    const ym = monthInput.value || `${now.getFullYear()}-${pad2(now.getMonth()+1)}`;

    if(mode==="year"){
      if(!force && cacheYear.has(y)){
        const cached = cacheYear.get(y);
        renderStats({ salesTotal: cached.salesTotal, expensesTotal: cached.expTotal });
        renderYearDetail(y, cached.byMonthSales, cached.byMonthExpenses, cached.salesRows, cached.expRows);
        authState.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${currentUser.email || ""}`;
        return;
      }

      // sales: filter in memory
      const salesRows = rawSalesAll.filter(s=> (s.date?.getFullYear?.()===y));
      const salesTotal = salesRows.reduce((a,r)=>a+(Number(r.total||0)||0),0);
      const byMonthSales = sumByKey(salesRows, r=> r._ym, r=> r.total);

      // expenses: query by year
      let expTotal = 0;
      let expRows = [];
      try{
        const ex = await loadExpenseReceiptsByYear(y);
        expTotal = ex.total;
        expRows = ex.rows;
      }catch(e){
        console.error(e);
        toast("æ”¯å‡ºï¼ˆexpense_receiptsï¼‰èª­è¾¼ã«å¤±æ•—");
      }
      const byMonthExpenses = new Map();
      for(const r of expRows){
        const key = `${y}-${pad2(r.month||0)}`;
        byMonthExpenses.set(key, (byMonthExpenses.get(key)||0) + (Number(r.sum||0)||0));
      }

      const cached = { salesTotal, expTotal, byMonthSales, byMonthExpenses, salesRows, expRows };
      cacheYear.set(y, cached);

      renderStats({ salesTotal, expensesTotal: expTotal });
      renderYearDetail(y, byMonthSales, byMonthExpenses, salesRows, expRows);
      authState.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${currentUser.email || ""}`;
      return;
    }

    // month mode
    if(!force && cacheMonth.has(ym)){
      const c = cacheMonth.get(ym);
      renderStats({ salesTotal: c.salesTotal, expensesTotal: c.expTotal });
      renderMonthDetail(ym, c.salesRows, c.expRows);
      authState.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${currentUser.email || ""}`;
      return;
    }

    const [Y,M] = ym.split("-").map(Number);
    const salesRows = rawSalesAll.filter(s=> s._ym === ym);
    const salesTotal = salesRows.reduce((a,r)=>a+(Number(r.total||0)||0),0);

    let expTotal = 0;
    let expRows = [];
    try{
      const ex = await loadExpenseReceiptsByMonth(Y, M);
      expTotal = ex.total;
      expRows = ex.rows;
    }catch(e){
      console.error(e);
      toast("æ”¯å‡ºï¼ˆexpense_receiptsï¼‰èª­è¾¼ã«å¤±æ•—");
    }

    const cached = { salesTotal, expTotal, salesRows, expRows };
    cacheMonth.set(ym, cached);

    renderStats({ salesTotal, expensesTotal: expTotal });
    renderMonthDetail(ym, salesRows, expRows);
    authState.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${currentUser.email || ""}`;
  }

  // ---- boot ------------------------------------------
  onAuthStateChanged(auth, async (user)=>{
    currentUser = user;
    const now = new Date();
    const nowY = now.getFullYear();

    fillYearOptions(nowY, [nowY, nowY-1, nowY-2, nowY-3]);
    monthInput.value = `${nowY}-${pad2(now.getMonth()+1)}`;
    setMode("year");

    if(!user){
      authState.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³";
      statsEl.innerHTML = `<div class="empty">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</div>`;
      detailArea.innerHTML = "";
      return;
    }

    try{
      await loadSalesAll();
    }catch(e){
      console.error(e);
      toast("sales èª­è¾¼ã«å¤±æ•—");
    }

    await refresh(true);
  });
</script>


</body>
</html>
