<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="format-detection" content="telephone=no,date=no,address=no,email=no">
  <title>e.nue Dashboard</title>

<style>

/* ===== iOS: é’æ–‡å­—(è‡ªå‹•ãƒªãƒ³ã‚¯)å¯¾ç­– ===== */
a, a:link, a:visited, a:hover, a:active{
  color: var(--text-main);
  text-decoration:none;
}
*{ -webkit-tap-highlight-color: transparent; }

/* ===== list titleï¼ˆè¦‹åˆ‡ã‚Œå¯¾ç­–ï¼‰ ===== */
.listTitle{
  padding: 12px 14px 8px;
  font-weight: 1000;
  letter-spacing: .04em;
  border-bottom: 1px solid rgba(0,0,0,.06);
  text-align: right;           /* å³å¯„ã›ã§æ å†…ã«åã‚ã‚‹ */
  white-space: nowrap;
  font-size: 13px;
}
@media (max-width: 360px){
  .listTitle{ font-size:12px; }
}

/* ===== calendar viewport fix ===== */
.secCal .calViewport{ overflow:hidden; }
.secCal .calGrid{ width:100%; }

:root{
  --bg1:#e3ddd4;
  --bg2:#d4ccc1;

  --glass-bg: rgba(255,255,255,.86);
  --glass-bg2: rgba(255,255,255,.78);
  --glass-border: rgba(0,0,0,.06);
  --line-soft: rgba(0,0,0,.10);
  --shadow: 0 18px 45px rgba(0,0,0,.14);

  --text-main:#222222;
  --text-sub:#555555;
  --muted: rgba(34,34,34,.55);

  --accent:#e18a6a;
  --accent2:#d06463;

  --ok:#2fbf7a;
  --wait:#f0a33a;
  --done:#6d78d8;
  --todo:#9097a6;

  --r:18px;
  --maxw:980px;

  /* otherpage tiles */
  --safe-pad:14px;
  --gap:10px;
  --tile-r:18px;
  --blur:16px;
  --shadow2: 0 10px 26px rgba(0,0,0,.10);
  --icon: rgba(0,0,0,.72);
  --tile-size: calc((100vw - (var(--safe-pad) * 2) - (var(--gap) * 2)) / 3);

}

*{ box-sizing:border-box; }
html, body{ height:100%; }

body{
  margin:0;
  font-family: system-ui,-apple-system,"Segoe UI","Noto Sans JP",sans-serif;
  color:var(--text-main);
  background:
    radial-gradient(1200px 800px at 18% 8%, rgba(225,138,106,.18), transparent 55%),
    radial-gradient(1200px 800px at 88% 0%, rgba(208,100,99,.14), transparent 52%),
    linear-gradient(135deg,var(--bg1),var(--bg2));
}

.safe{
  padding:max(14px,env(safe-area-inset-top)) 14px max(18px,env(safe-area-inset-bottom));
  max-width:var(--maxw);
  margin:0 auto;
}

/* ===== top bar ===== */
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin:6px 0 14px;
}
.brand{ font-weight:900; letter-spacing:.02em; }

.tabs{
  display:flex; gap:4px; padding:4px;
  border-radius:999px;
  background:rgba(255,255,255,.55);
  border:1px solid var(--glass-border);
  box-shadow:var(--shadow);
  backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);
}
.tab{
  border:0; background:transparent;
  padding:10px 14px; border-radius:999px;
  font-weight:800; cursor:pointer;
  color:rgba(34,34,34,.65);
}
.tab.active{
  background:rgba(255,255,255,.85);
  color:var(--text-main);
  box-shadow:0 8px 18px rgba(0,0,0,.08);
}

/* ===== layout ===== */
.grid{ display:flex; flex-direction:column; gap:14px; }

.card{
  background:linear-gradient(180deg,var(--glass-bg),var(--glass-bg2));
  border:1px solid var(--glass-border);
  border-radius:var(--r);
  box-shadow:var(--shadow);
  overflow:hidden;
  backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);
}

/* =====================================================
   â€œé3Dâ€ flipï¼ˆSafariã§ã‚‚ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å£Šã‚Œãªã„ï¼‰
===================================================== */
.hint{ display:none; }
.cardFlip{ position:relative; cursor:pointer; }
.cardFlipInner{
  position:relative;
  min-height:360px;
}

/* 2é¢ã‚’é‡ã­ã¦ãƒ•ã‚§ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆtransformç„¡ã—ï¼‰ */
.cardFace{
  position:absolute;
  inset:0;
  background: linear-gradient(180deg,var(--glass-bg),var(--glass-bg2));
  opacity:0;
  pointer-events:none;
  transition: opacity .75s ease;
  will-change: opacity, filter;
}
.cardFace.front{ opacity:1; pointer-events:auto; }
.cardFlip.is-flipped .cardFace.front{ opacity:0; pointer-events:none; }
.cardFlip.is-flipped .cardFace.back { opacity:1; pointer-events:auto; }

/* ä¸Šå“ãªåˆ‡æ›¿æ¼”å‡º */
.cardFace::after{
  content:"";
  position:absolute;
  inset:-20%;
  pointer-events:none;
  opacity:0;
  background:
    radial-gradient(800px 520px at 18% 20%, rgba(255,255,255,.55), transparent 60%),
    radial-gradient(900px 560px at 85% 10%, rgba(225,138,106,.20), transparent 62%),
    radial-gradient(900px 640px at 80% 90%, rgba(208,100,99,.14), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,0));
  filter: blur(10px);
  transform: translateY(-6px);
  transition: opacity .75s ease, transform .75s ease, filter .75s ease;
}
.cardFlip.is-animating .cardFace{ filter: blur(2.2px) saturate(1.03); }
.cardFlip.is-animating .cardFace::after{
  opacity:1;
  transform: translateY(0);
  filter: blur(14px);
}

/* ===== card head ===== */
.cardHead{
  display:flex; justify-content:space-between;
  gap:10px;
  padding:14px 14px 10px;
  border-bottom:1px solid rgba(0,0,0,.06);
}
.title .h{ font-weight:900; font-size:14px; letter-spacing:.06em; }
.title .s{ font-size:12px; color:rgba(34,34,34,.6); }

.badgeBig{
  text-align:right;
  min-width: 88px;
  flex: 0 0 auto;
}
.badgeBig .k{
  font-size:11px; font-weight:800; color:rgba(34,34,34,.55);
  white-space:nowrap;
  display:inline-block;
}
.badgeBig .v{ font-size:18px; font-weight:900; }

/* ===== chart ===== */
.chartWrap{
  padding:12px 0;
  overflow:hidden;
  cursor:default;
}
.chartFrame{ position:relative; padding:0 12px 10px; }

.yAxisFixed{
  position:absolute; left:12px; top:0;
  width:42px; height:220px;
  pointer-events:none;
  z-index:2;
}

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸ */
.chartScroller{
  overflow-x:auto;
  overflow-y:hidden;
  -webkit-overflow-scrolling:touch;
  touch-action: pan-x;
}

/* å·¦ä½™ç™½ï¼ˆYè»¸å›ºå®šåˆ†ï¼‰ */
.chartInner{
  padding-left:42px;
  display:inline-block;
}
.chartMount{
  display:inline-block;
}
.chartMount svg{
  display:block;
  pointer-events:none;
  user-select:none;
  -webkit-user-select:none;
}

/* ===== tooltipï¼ˆSVGå†…ï¼‰ ===== */
.chartTooltip{ pointer-events:none; }
.chartTooltip rect{ fill: rgba(34,34,34,.92); rx:8; }
.chartTooltip text{ fill:#fff; font-size:12px; font-weight:900; }

/* ===== section2 (calendar) ===== */
:root{ --cell:52px; } /* fallback */
.secCal .calendar{ padding:12px; }
.secCal .calBox{
  border-radius:14px;
  border:1px solid rgba(0,0,0,.08);
  background:rgba(255,255,255,.60);
  overflow:hidden;
}
.secCal .calTop{
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 10px 8px;
  font-weight:900; gap:10px;
}
.secCal .calTopLeft,.secCal .calTopRight{ display:flex; align-items:center; gap:8px; }
.secCal .navBtn,.secCal .todayBtn,.secCal .modeBtn{
  appearance:none; border:1px solid rgba(0,0,0,.10);
  background:rgba(255,255,255,.75);
  border-radius:999px;
  padding:8px 10px;
  font-weight:900;
  font-size:12px;
  box-shadow: 0 8px 18px rgba(0,0,0,.08);
  cursor:pointer;
}
.secCal .navBtn:active,.secCal .todayBtn:active,.secCal .modeBtn:active{ transform:translateY(1px); }
.secCal .navBtn[disabled]{ opacity:.35; cursor:not-allowed; }
.secCal .monthLabel{ font-weight:1000; letter-spacing:.2px; }
.secCal .calViewport{ position:relative; overflow:hidden; border-top:1px solid rgba(0,0,0,.06); }
.secCal .calGrid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:1px;
  background:rgba(0,0,0,.08);
  will-change: transform, opacity;
}
.secCal .dow,.secCal .day{
  background:rgba(255,255,255,.62);
  padding:6px;
  font-size:12px;
  min-height: var(--cell);
  height: var(--cell);
}
.secCal .dow{
  text-align:center;
  font-weight:1000;
  display:flex; align-items:center; justify-content:center;
  user-select:none;
}
.secCal .day{
  position:relative;
  display:flex;
  flex-direction:column;
  gap:6px;
  border:none;
  width:100%;
  text-align:left;
  cursor:pointer;
  user-select:none;
  touch-action:manipulation;
}
.secCal .day.dim{ opacity:.45; }
.secCal .num{
  font-weight:1000;
  line-height:1;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:26px; height:26px;
  border-radius:999px;
}
.secCal .centerMark{
  margin-top:auto;
  margin-bottom:4px;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height: 22px;
}
.secCal .stamp{
  display:inline-grid;
  grid-template-rows:auto auto;
  place-items:center;
  padding:6px 10px 7px;
  border-radius:999px;
  border:2px solid rgba(0,0,0,.12);
  background: rgba(255,255,255,.78);
  box-shadow:
    0 10px 18px rgba(0,0,0,.10),
    inset 0 0 0 2px rgba(225,138,106,.35);
  transform: rotate(-10deg);
}
.secCal .stamp span{
  font-weight:1000;
  font-size:11px;
  line-height:1.05;
  letter-spacing:.6px;
  color: var(--accent2);
}
.secCal .eventDot{
  width:10px; height:10px;
  border-radius:999px;
  box-shadow:
    0 10px 16px rgba(0,0,0,.10),
    inset 0 0 0 2px rgba(255,255,255,.85);
}
.secCal .eventDot.orange{ background: rgba(225,138,106,.95); }
.secCal .eventDot.blue{ background: rgba(109,120,216,.95); }
.secCal .eventDot.red{ background: rgba(208,100,99,.95); }
.secCal .eventDot.gray{ background: rgba(34,34,34,.28); }
.secCal .day.dim .eventDot,
.secCal .day.dim .stamp{ opacity:.45; transform: rotate(-10deg) scale(.92); }

/* åœŸæ—¥ãƒ»ç¥ */
.secCal .day.sun{ background: linear-gradient(180deg, rgba(255,255,255,.62), rgba(255,255,255,.62)), rgba(208,100,99,.16); }
.secCal .day.sat{ background: linear-gradient(180deg, rgba(255,255,255,.62), rgba(255,255,255,.62)), rgba(109,120,216,.16); }
.secCal .day.holiday{ background: linear-gradient(180deg, rgba(255,255,255,.62), rgba(255,255,255,.62)), rgba(208,100,99,.20); }
.secCal .day.sun .num, .secCal .day.holiday .num{ color: var(--accent2); }
.secCal .day.sat .num{ color: rgba(109,120,216,.95); }

/* ä»Šæ—¥ */
.secCal .day.today .num{
  box-shadow:
    0 0 0 2px rgba(225,138,106,.30),
    0 0 14px rgba(225,138,106,.45);
  background: rgba(255,255,255,.75);
}

/* ã‚¹ãƒ©ã‚¤ãƒ‰ */
.secCal .slideEnterRight{ transform: translateX(14%); opacity:0; }
.secCal .slideEnterLeft { transform: translateX(-14%); opacity:0; }
.secCal .slideActive{ transform: translateX(0%); opacity:1; transition: transform .28s ease, opacity .28s ease; }
.secCal .slideExitLeft{ transform: translateX(-14%); opacity:0; transition: transform .28s ease, opacity .28s ease; position:absolute; inset:0; }
.secCal .slideExitRight{ transform: translateX(14%); opacity:0; transition: transform .28s ease, opacity .28s ease; position:absolute; inset:0; }

/* å¹ãå‡ºã—ï¼ˆclassåã¯ .popover ã«çµ±ä¸€ï¼‰ */
.popover{
  position:fixed;
  z-index:9999;
  max-width:min(320px, calc(100vw - 28px));
  background: rgba(255,255,255,.92);
  border:1px solid rgba(0,0,0,.10);
  border-radius:14px;
  box-shadow: 0 22px 55px rgba(0,0,0,.18);
  padding:10px 12px;
  transform-origin: top left;
  animation: secCalPop .12s ease;
}
@keyframes secCalPop{
  from{ transform: scale(.98); opacity:0; }
  to{ transform: scale(1); opacity:1; }
}
.secCal .popHead{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
.secCal .popTitle{ font-weight:1000; }
.secCal .popSub{ font-size:12px; color:rgba(0,0,0,.55); margin-top:2px; }
.secCal .iconBtn{
  appearance:none;
  border:1px solid rgba(0,0,0,.10);
  background:rgba(255,255,255,.75);
  border-radius:12px;
  padding:6px 8px;
  cursor:pointer;
  box-shadow: 0 8px 18px rgba(0,0,0,.08);
  font-weight:1000;
  font-size:14px;
  line-height:1;
}
.secCal .iconBtn:active{ transform:translateY(1px); }
.secCal .popRow{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
.secCal .badge{
  display:inline-flex; align-items:center; gap:6px;
  font-size:12px; font-weight:900;
  padding:6px 10px;
  border-radius:999px;
  background: rgba(225,138,106,.16);
  border: 1px solid rgba(225,138,106,.28);
}
.secCal .badge.blue{ background: rgba(109,120,216,.14); border-color: rgba(109,120,216,.24); }
.secCal .badge.red{ background: rgba(208,100,99,.14); border-color: rgba(208,100,99,.24); }
.secCal .editBox{
  margin-top:10px;
  padding:10px;
  border-radius:12px;
  border:1px dashed rgba(0,0,0,.18);
  background: rgba(255,255,255,.72);
  display:none;
}
.secCal .editBox.show{ display:block; }
.secCal .editBox label{ display:block; font-size:12px; color:rgba(0,0,0,.55); font-weight:900; margin-bottom:6px; }
.secCal .editRow{ display:flex; gap:8px; align-items:center; }
.secCal .dateInput{
  flex:1; appearance:none;
  border:1px solid rgba(0,0,0,.14);
  border-radius:12px;
  padding:10px 10px;
  background: rgba(255,255,255,.85);
  font-weight:900;
}
.secCal .saveBtn{
  appearance:none; border:none;
  border-radius:12px;
  padding:10px 12px;
  font-weight:1000;
  background: rgba(225,138,106,.95);
  color:#fff;
  box-shadow: 0 10px 18px rgba(0,0,0,.12);
  cursor:pointer;
}
.secCal .saveBtn:active{ transform:translateY(1px); }
.secCal .note{ margin-top:8px; font-size:11px; color:rgba(0,0,0,.55); opacity:.85; }
.secCal .closeHint{ margin-top:10px; font-size:11px; color: rgba(0,0,0,.55); opacity:.75; }

@supports (aspect-ratio: 1 / 1){
  .secCal .day{ aspect-ratio: 1 / 1; height:auto; min-height:auto; }
  .secCal .dow{ height:auto; min-height:34px; }
}
@media (max-width: 380px){
  .secCal .calendar{ padding:10px; }
  .secCal .dow,.secCal .day{ padding:5px; }
  .secCal .num{ width:24px; height:24px; }
}

/* ===== section3/4 (orders tables) ===== */
.secOrders .tableWrap{ overflow:auto; -webkit-overflow-scrolling:touch; }
.secOrders .ordersTable{ width:100%; border-collapse:collapse; min-width:720px; }
.secOrders .ordersTable th,.secOrders .ordersTable td{ padding:10px; font-size:13px; vertical-align:middle; }
.secOrders .ordersTable th{ text-align:left; background:#f3f3f3; position:sticky; top:0; z-index:1; }
.secOrders .ordersTable tr+tr td{ border-top:1px solid rgba(0,0,0,.06); }

.secOrders .tap{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(0,0,0,.10);
  background:rgba(255,255,255,.7);
  cursor:pointer;
  user-select:none;
  max-width:100%;
}
.secOrders .tap:active{ transform: translateY(1px); }

.secOrders .nameBtn{
  border:none; background:transparent; padding:0; margin:0;
  cursor:pointer; text-align:left; font:inherit; color:inherit;
  display:inline-flex; align-items:center; gap:8px;
}
.secOrders .nameBtn .chev{ opacity:.55; font-weight:900; }
.secOrders .duePill{ white-space:nowrap; }

.secOrders .statusPill{
  display:inline-flex; align-items:center; gap:8px;
  padding:6px 10px;
  border-radius:999px;
  border:2px solid rgba(0,0,0,.12);
  font-weight:900;
  background:rgba(255,255,255,.85);
  white-space:nowrap;
}
.secOrders .dot{
  width:8px; height:8px; border-radius:50%;
  background:rgba(0,0,0,.35);
  box-shadow:0 0 0 3px rgba(0,0,0,.06);
  flex:0 0 auto;
}
.secOrders .s-michakushu{ border-color: rgba(139,139,139,.55); }
.secOrders .s-michakushu .dot{ background:rgba(62,62,62,1); box-shadow:0 0 0 3px rgba(139,139,139,.18); }

.secOrders .s-nyuukin{ border-color: rgba(240,163,58,.70); }
.secOrders .s-nyuukin .dot{ background:rgba(185,98,0,1); box-shadow:0 0 0 3px rgba(240,163,58,.22); }

.secOrders .s-shinkochu{ border-color: rgba(47,191,122,.70); }
.secOrders .s-shinkochu .dot{ background:rgba(15,122,69,1); box-shadow:0 0 0 3px rgba(47,191,122,.20); }

/* å®Œäº†ï¼ˆä¿é™ºã€‚è¡¨ç¤ºã¯ã—ãªã„ãƒ•ã‚£ãƒ«ã‚¿ã ã‘ã©ï¼‰ */
.secOrders .s-done{ border-color: rgba(109,120,216,.70); }
.secOrders .s-done .dot{ background:rgba(66,76,175,1); box-shadow:0 0 0 3px rgba(109,120,216,.20); }

.secOrders .chips{ display:flex; flex-wrap:wrap; gap:6px; justify-content:flex-end; }
.secOrders .chip{
  display:inline-flex; align-items:center;
  padding:5px 8px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.14);
  background:rgba(0,0,0,.03);
  font-weight:800;
  white-space:nowrap;
}
.secOrders .chip.muted{ opacity:.55; font-weight:700; }
.emptyOrders{ padding:18px 14px; color:rgba(0,0,0,.55); font-weight:800; }

/* mobile card rows */
@media (max-width: 620px){
  .secOrders .tableWrap{ overflow:visible; }
  .secOrders .ordersTable{ min-width:0; }
  .secOrders .ordersTable thead{ display:none; }
  .secOrders .ordersTable tr{ display:block; padding:10px 12px; border-top:1px solid rgba(0,0,0,.07); }
  .secOrders .ordersTable tr:first-child{ border-top:none; }
  .secOrders .ordersTable tr+tr td{ border-top:none; }
  .secOrders .ordersTable td{ display:flex; justify-content:space-between; align-items:center; padding:8px 0; font-size:13px; }
  .secOrders .ordersTable td::before{
    content: attr(data-label);
    color:rgba(0,0,0,.55);
    font-weight:800;
    margin-right:10px;
    flex:0 0 auto;
  }
}

/* bottom sheet (shared) */
.enueOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.35);
  display:none;
  align-items:flex-end;
  z-index:999;
  padding:10px;
}
.enueOverlay.show{ display:flex; }
.enueSheet{
  width:min(640px,100%);
  margin:0 auto;
  background:#fff;
  border-radius:22px;
  box-shadow:0 30px 80px rgba(0,0,0,.35);
  overflow:hidden;
}
.enueSheetHead{
  padding:12px 14px;
  border-bottom:1px solid rgba(0,0,0,.08);
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  font-weight:900;
}
.enueSheetBody{ padding:12px 14px; }
.enueSheetFoot{
  padding:12px 14px;
  border-top:1px solid rgba(0,0,0,.08);
  display:flex; gap:10px;
}
.enueBtn{
  flex:1;
  border:none;
  border-radius:14px;
  padding:12px 12px;
  font-weight:900;
  cursor:pointer;
}
.enueBtnGhost{ background:rgba(0,0,0,.06); }
.enueBtnPrimary{ background:#111; color:#fff; }

.enueOptList{ display:grid; gap:10px; }
.enueOpt{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 12px;
  border-radius:16px;
  border:1px solid rgba(0,0,0,.12);
  cursor:pointer;
  user-select:none;
}
.enueOpt:active{ transform: translateY(1px); }
.enueOpt .left{ display:flex; align-items:center; gap:10px; font-weight:900; }
.enueOpt .right{ color:rgba(0,0,0,.55); font-weight:800; }
.enueCheck{
  width:18px; height:18px;
  border-radius:6px;
  border:2px solid rgba(0,0,0,.25);
  background:transparent;
  display:inline-flex; align-items:center; justify-content:center;
  font-size:12px; font-weight:900;
}
.enueCheck.on{ background:#111; border-color:#111; color:#fff; }

.enueHiddenDate{
  position:fixed; left:-9999px; top:-9999px;
  opacity:0; pointer-events:none;
}

@media (prefers-reduced-motion: reduce){
  .cardFace{ transition:none; }
  .cardFlip.is-animating .cardFace{ filter:none; }
  .cardFace::after{ transition:none; }
}


/* ===== OTHER page tiles (merged) ===== */
/* OTHER */
.otherCard{ padding:14px; }
.tileGrid{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--gap);
}

.tile{
  position:relative;
  appearance:none;
  -webkit-appearance:none;
  width:100%;
  height: var(--tile-size);  /* â† iPhoneã§ç¢ºå®Ÿã«åã‚ã‚‹ */
  border-radius: var(--tile-r);

  border: 1px solid rgba(255,255,255,.62);
  background: linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,.10));
  box-shadow: var(--shadow2);

  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));

  padding: 11px;
  text-align:left;
  cursor:pointer;
  user-select:none;
  -webkit-tap-highlight-color: transparent;

  display:flex;
  flex-direction:column;
  justify-content:flex-end;
  gap:6px;

  transition: transform .08s ease, background .12s ease, border-color .12s ease;
}
.tile::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius: var(--tile-r);
  pointer-events:none;
  border: 1px solid rgba(0,0,0,.06);
}
.tile:active{ transform: scale(.985); }
.tile:hover{
  background: linear-gradient(180deg, rgba(255,255,255,.30), rgba(255,255,255,.14));
  border-color: rgba(255,255,255,.75);
}

/* ã‚¢ã‚¤ã‚³ãƒ³ */
.tileIcon{
  position:absolute;
  top:10px;
  left:10px;
  width:26px;
  height:26px;
  display:grid;
  place-items:center;
  opacity:.95;
}
.tileIcon svg{
  width:26px;
  height:26px;
  stroke: var(--icon);
  stroke-width: 1.9;
  fill: none;
  stroke-linecap: round;
  stroke-linejoin: round;
}

.tileTitle{ font-weight:900; font-size:13px; line-height:1.2; }
.tileSub{ font-weight:700; font-size:10.5px; color: rgba(34,34,34,.60); line-height:1.2; }

/* ã•ã‚‰ã«å°ã•ã„ç«¯æœ«ï¼ˆSEç´šï¼‰ã§ã‚‚ä½™è£•ã‚’ä½œã‚‹ */
@media (max-width: 360px){
  :root{
    --safe-pad: 12px;
    --gap: 8px;
    --tile-size: calc((100vw - (var(--safe-pad) * 2) - (var(--gap) * 2)) / 3);
  }
  .tile{ padding:10px; }
  .tileIcon{ top:9px; left:9px; width:24px; height:24px; }
  .tileIcon svg{ width:24px; height:24px; }
}

/* iPadä»¥ä¸Šã¯å°‘ã—å¤§ããï¼ˆè¦‹ã‚„ã™ã•ï¼‰ */
@media (min-width: 600px){
  :root{ --tile-size: 160px; --gap: 12px; }
  .tileTitle{ font-size:14px; }
  .tileSub{ font-size:11px; }
}
@media (min-width: 900px){
  :root{ --tile-size: 180px; }
}

</style>
</head>

<body>
  <div class="safe">
    <div class="topbar">
      <div class="brand">e.nue</div>
      <div class="tabs" role="tablist" aria-label="page switch">
        <button class="tab active" data-view="home" type="button">HOME</button>
        <button class="tab" data-view="other" type="button">OTHER</button>
      </div>
    </div>

    <!-- HOME -->
    <main id="view-home" class="grid">

      <!-- 1) ã‚°ãƒ©ãƒ•ï¼ˆåˆ‡æ›¿ï¼‰ -->
      <section class="card cardFlip" id="card-chart">
        <div class="cardFlipInner">

          <!-- FRONTï¼šå—æ³¨ä»¶æ•° -->
          <div class="cardFace front">
            <div class="cardHead">
              <div class="title">
                <div class="h" id="chartTitleA">å—æ³¨ä»¶æ•°ã®æ¨ç§»</div>
                <div class="s">æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼šéå»1å¹´åˆ†ï¼ˆè¡¨ç¤ºä¸­ç¯„å›²ã§ç¸¦è»¸ãŒè‡ªå‹•èª¿æ•´ï¼‰</div>
              </div>
              <div class="badgeBig">
                <div class="k" id="metricLabelA">å—æ³¨ä»¶æ•°</div>
                <div class="v" id="metricValueA">â€”</div>
              </div>
            </div>

            <div class="chartWrap">
              <div class="chartFrame">
                <div class="yAxisFixed" id="yAxisFixedA"></div>
                <div class="chartScroller" id="chartScrollerA">
                  <div class="chartInner">
                    <div class="chartMount" id="chartMountA"></div>
                  </div>
                </div>
              </div>
              <div class="hint">
                <span class="tapHint" id="flipHintA">ğŸ‘† ã‚¿ãƒƒãƒ—ã§ã€Œç·è³‡ç”£ã®æ¨ç§»ã€ã«åˆ‡æ›¿</span>
              </div>
            </div>
          </div>

          <!-- BACKï¼šç·è³‡ç”£ -->
          <div class="cardFace back">
            <div class="cardHead">
              <div class="title">
                <div class="h" id="chartTitleB">ç·è³‡ç”£ã®æ¨ç§»</div>
                <div class="s">æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼šéå»1å¹´åˆ†ï¼ˆè¡¨ç¤ºä¸­ç¯„å›²ã§ç¸¦è»¸ãŒè‡ªå‹•èª¿æ•´ï¼‰</div>
              </div>
              <div class="badgeBig">
                <div class="k" id="metricLabelB">ç·è³‡ç”£</div>
                <div class="v" id="metricValueB">â€”</div>
              </div>
            </div>

            <div class="chartWrap">
              <div class="chartFrame">
                <div class="yAxisFixed" id="yAxisFixedB"></div>
                <div class="chartScroller" id="chartScrollerB">
                  <div class="chartInner">
                    <div class="chartMount" id="chartMountB"></div>
                  </div>
                </div>
              </div>
              <div class="hint">
                <span class="tapHint" id="flipHintB">ğŸ‘† ã‚¿ãƒƒãƒ—ã§ã€Œå—æ³¨ä»¶æ•°ã®æ¨ç§»ã€ã«åˆ‡æ›¿</span>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- 2) ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
      <section class="card">
        <div class="cardHead">
          <div class="title">
            <div class="h">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
            <div class="s">äºˆå®šæ—¥ã®å¹ãå‡ºã—ã«âœï¸ã‚’ä»˜ã‘ã¦æ—¥ä»˜å¤‰æ›´ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰</div>
          </div>
          <div class="badgeBig">
            <div class="k">è¡¨ç¤ºæœˆ</div>
            <div class="v" id="monthLabelMini">â€”</div>
          </div>
        </div>

        <div class="secCal">
          <div class="calendar">
            <div class="calBox" id="calBox">
              <div class="calTop">
                <div class="calTopLeft">
                  <button class="todayBtn" id="todayBtn" type="button">today</button>
                  <button class="navBtn" id="prevBtn" type="button">â‰ª</button>
                  <button class="navBtn" id="nextBtn" type="button">â‰«</button>
                </div>

                <div class="monthLabel" id="monthLabel">----</div>

                <div class="calTopRight">
                  <button class="modeBtn" id="modeBtn" type="button">Sunâ€“Sat</button>
                </div>
              </div>

              <div class="calViewport" id="calViewport"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- 3) å—æ³¨æ®‹ï¼šstock -->
      <section class="card">
        <div class="listTitle">å—æ³¨æ®‹ï¼šstock</div>
        <div class="list secOrders" id="secStock">
          <div class="tableWrap">
            <table class="ordersTable" aria-label="stock orders">
              <thead class="thead">
                <tr>
                  <th style="width:46%;">åå‰</th>
                  <th style="width:22%;">æœŸæ—¥</th>
                  <th style="width:20%;">é€²æ—</th>
                  <th style="width:12%; text-align:right;">æ‹…å½“</th>
                </tr>
              </thead>
              <tbody id="tbodyStock"></tbody>
            </table>
            <div id="emptyStock" class="emptyOrders" style="display:none;">è¡¨ç¤ºã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆãƒãƒ«ã‚·ã‚§ä»¥å¤–ã®è³¼å…¥å±¥æ­´ãŒæœªä½œæˆï¼‰</div>
          </div>
        </div>
      </section>

      <!-- 4) å—æ³¨æ®‹ï¼šorder -->
      <section class="card">
        <div class="listTitle">å—æ³¨æ®‹ï¼šorder</div>
        <div class="list secOrders" id="secOrder">
          <div class="tableWrap">
            <table class="ordersTable" aria-label="made-to-order">
              <thead class="thead">
                <tr>
                  <th style="width:46%;">åå‰</th>
                  <th style="width:22%;">æœŸæ—¥</th>
                  <th style="width:20%;">é€²æ—</th>
                  <th style="width:12%; text-align:right;">æ‹…å½“</th>
                </tr>
              </thead>
              <tbody id="tbodyOrder"></tbody>
            </table>
            <div id="emptyOrder" class="emptyOrders" style="display:none;">è¡¨ç¤ºã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆãƒãƒ«ã‚·ã‚§ä»¥å¤–ã®è³¼å…¥å±¥æ­´ãŒæœªä½œæˆï¼‰</div>
          </div>
        </div>
      </section>

      <!-- Stock/Order å…±é€šï¼šBottom sheet -->
      <div class="enueOverlay" id="overlayOrders" role="dialog" aria-modal="true">
        <div class="enueSheet" onclick="event.stopPropagation()">
          <div class="enueSheetHead">
            <div id="sheetTitle">ç·¨é›†</div>
            <button class="enueBtn enueBtnGhost" style="flex:0 0 auto; padding:10px 12px;" id="closeBtn">é–‰ã˜ã‚‹</button>
          </div>
          <div class="enueSheetBody" id="sheetBody"></div>
          <div class="enueSheetFoot" id="sheetFoot" style="display:none;">
            <button class="enueBtn enueBtnGhost" id="cancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="enueBtn enueBtnPrimary" id="saveBtn">ä¿å­˜</button>
          </div>
        </div>
      </div>

      <input class="enueHiddenDate" id="datePicker" type="date" />
    </main>

    <!-- OTHER -->
    <main id="view-other" class="grid" style="display:none;">
      <section class="card otherCard">
        <div class="tileGrid" id="tileGrid">

          <!-- POSï¼ˆãƒ¬ã‚¸ã‚¢ã‚¤ã‚³ãƒ³ä»˜ãï¼‰ -->
          <button class="tile" type="button" data-href="pos_prod_toggle.html" aria-label="POSã¸">
            <div class="tileIcon" aria-hidden="true">
              <!-- ãƒ¬ã‚¸ï¼ˆé»’ç·šï¼‰SVG -->
              <svg viewBox="0 0 24 24">
                <path d="M5 10h14v8a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-8z"/>
                <path d="M8 10V7a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v3"/>
                <path d="M8 14h2M12 14h2M16 14h2"/>
                <path d="M8 17h2M12 17h2M16 17h2"/>
                <path d="M5 12h14"/>
                <path d="M16 5h2v3"/>
              </svg>
            </div>
            <div class="tileTitle">POS</div>
            <div class="tileSub">pos_prod_toggle.html</div>
          </button>

          <button class="tile" type="button" data-href="categories.html">
            <div class="tileTitle">ã‚«ãƒ†ã‚´ãƒª</div>
            <div class="tileSub">categories.html</div>
          </button>

          <button class="tile" type="button" data-href="stock.html">
            <div class="tileTitle">åœ¨åº«</div>
            <div class="tileSub">stock.html</div>
          </button>

          <button class="tile" type="button" data-href="customers.html">
            <div class="tileTitle">é¡§å®¢ç®¡ç†</div>
            <div class="tileSub">customers.html</div>
          </button>

          <button class="tile" type="button" data-href="order.html">
            <div class="tileTitle">ã‚ªãƒ¼ãƒ€ãƒ¼</div>
            <div class="tileSub">order.html</div>
          </button>

          <button class="tile" type="button" data-href="shipping.html">
            <div class="tileTitle">ç™ºé€</div>
            <div class="tileSub">shipping.html</div>
          </button>

          <button class="tile" type="button" data-href="sales.html">
            <div class="tileTitle">å£²ä¸Š</div>
            <div class="tileSub">sales.html</div>
          </button>

          <button class="tile" type="button" data-href="income.html">
            <div class="tileTitle">å…¥é‡‘</div>
            <div class="tileSub">income.html</div>
          </button>

          <button class="tile" type="button" data-href="analytics.html">
            <div class="tileTitle">åˆ†æ</div>
            <div class="tileSub">analytics.html</div>
          </button>

        </div>
      </section>
    </main>
  </div>


<script type="module">
/**
 * e.nue Dashboard (index)
 * - iPhoneé’æ–‡å­—å¯¾ç­–: meta + CSS
 * - ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼: Firestore(ãƒ‘ãƒƒãƒ) + ä»»æ„bundle(JSON) ã§ã‚¹ã‚¿ãƒ³ãƒ—è¡¨ç¤º/è¿½åŠ 
 * - å—æ³¨ä»¶æ•°: bundle(JSON)ãŒã‚ã‚Œã°å·®åˆ†ã ã‘èª­ã¿ã€ç„¡ã‘ã‚Œã°ç›´è¿‘12ãƒ¶æœˆã‚’é›†è¨ˆ
 * - å—æ³¨æ®‹(stock/order): Firestore sales ã‹ã‚‰å–å¾—ã—ã€é€²æ—/æœŸæ—¥/æ‹…å½“ã‚’ç›´æ¥æ›´æ–°
 * - ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã€Œãƒãƒ«ã‚·ã‚§/ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã€ä¸­ã¯è‡ªå‹•ã§POSã‚’ãƒˆãƒƒãƒ—(=posã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ)
 */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore, collection, doc, getDoc, getDocs, query, where, orderBy, limit,
  updateDoc, setDoc, serverTimestamp, Timestamp
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

/* =========================
   Firebase envåˆ‡æ›¿
   - ?env=prod ã§æœ¬ç•ª
   - ãã‚Œä»¥å¤–ã¯ devï¼ˆã“ã“ã¯å¿…è¦ãªã‚‰å¾Œã§å·®ã—æ›¿ãˆï¼‰
========================= */
const ENV = new URLSearchParams(location.search).get("env") === "prod" ? "prod" : "prod";

/** æœ¬ç•ªï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æä¾›ã®è¨­å®šï¼‰ */
const firebaseConfigProd = {
  apiKey: "AIzaSyAhPCgPoJK6S6BWVcBZOruYqMPXVQXQFRk",
  authDomain: "handmade-pos.firebaseapp.com",
  projectId: "handmade-pos",
  storageBucket: "handmade-pos.firebasestorage.app",
  messagingSenderId: "174873514252",
  appId: "1:174873514252:web:c26659bffca850d475f929",
  measurementId: "G-3F8BYRBXDC"
};

/** devï¼ˆæœªä½¿ç”¨ã€‚å¿…è¦ãªã‚‰å¾Œã§å…¥ã‚Œæ›¿ãˆï¼‰ */
const firebaseConfigDev = firebaseConfigProd;

const firebaseConfig = (ENV === "prod") ? firebaseConfigProd : firebaseConfigDev;
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* =========================
   Small utils
========================= */
const pad2 = (n)=> String(n).padStart(2,"0");
const ymd = (d)=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
const ymdhm = (d)=> `${ymd(d)} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
const escapeHtml = (s)=> String(s ?? "")
  .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
  .replaceAll('"',"&quot;").replaceAll("'","&#39;");

function toMillis(ts){
  if(!ts) return 0;
  if(typeof ts === "number") return ts;
  if(ts instanceof Date) return ts.getTime();
  if(ts instanceof Timestamp) return ts.toMillis();
  if(typeof ts === "string"){
    const t = Date.parse(ts);
    return Number.isFinite(t) ? t : 0;
  }
  return 0;
}
function isoDate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function addDays(d, days){
  const x = new Date(d);
  x.setDate(x.getDate()+days);
  return x;
}
function fmtNoYear(iso){
  if(!iso) return "-";
  const d = new Date(iso + "T00:00:00");
  if(Number.isNaN(d.getTime())) return "-";
  return `${pad2(d.getMonth()+1)}/${pad2(d.getDate())}`;
}

/* =========================
   UI: tab switch
========================= */
const tabs = document.querySelectorAll(".tab");
const viewHome = document.getElementById("view-home");
const viewOther = document.getElementById("view-other");
tabs.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    tabs.forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const v = btn.dataset.view;
    viewHome.style.display = (v==="home") ? "" : "none";
    viewOther.style.display = (v==="other") ? "" : "none";
  });
});

/* OTHER tile nav */
const tileGrid = document.getElementById("tileGrid");
if(tileGrid){
  tileGrid.addEventListener("click", (e)=>{
    const tile = e.target.closest(".tile");
    if(!tile) return;
    const href = tile.dataset.href;
    if(href) location.href = href;
  });
}

/* =========================
   Chart (å—æ³¨ä»¶æ•° / ç·è³‡ç”£)
   - å—æ³¨ä»¶æ•°ã¯ Firestore sales ã‹ã‚‰æœˆåˆ¥é›†è¨ˆ
   - ç·è³‡ç”£ã¯å¾“æ¥ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆï¼ˆå¾Œã§ç½®æ›ï¼‰
========================= */
/* ---- ç·è³‡ç”£ï¼ˆæ—¢å­˜ã®ä»®ãƒ‡ãƒ¼ã‚¿ï¼‰ ---- */
const monthsLabel = ["9æœˆ","10æœˆ","11æœˆ","12æœˆ","1æœˆ","2æœˆ","3æœˆ","4æœˆ","5æœˆ","6æœˆ","7æœˆ","8æœˆ"];
const assetsSeries = [80000,120000,150000,180000,210000,190000,240000,260000,300000,280000,320000,360000];
const formatJPY = n => "Â¥" + Math.round(n).toLocaleString("ja-JP");

/* ---- å—æ³¨ä»¶æ•°ï¼ˆFirestoreé›†è¨ˆçµæœã‚’å·®ã—è¾¼ã¿ï¼‰ ---- */
let ordersSeries = Array(12).fill(0);

/** bundleãŒã‚ã‚‹å ´åˆã¯æ¥µåŠ›ãã‚Œã‚’ä½¿ã„ã€bundleä»¥é™ã ã‘salesã‚’èª­ã‚“ã§å·®åˆ†åŠ ç®— */
async function loadMonthlyOrderCounts(){
  // ç›´è¿‘12ãƒ¶æœˆã‚­ãƒ¼ã‚’ä½œã‚‹ï¼ˆå¤ã„â†’æ–°ã—ã„ï¼‰
  const now = new Date();
  const keys = [];
  for(let i=11;i>=0;i--){
    const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
    keys.push(`${d.getFullYear()}-${pad2(d.getMonth()+1)}`);
  }

  // 1) bundleã‚’èª­ã‚€ï¼ˆç„¡ã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—ï¼‰
  let bundle = null;
  try{
    const res = await fetch("./analytics_bundle.json", { cache:"no-store" });
    if(res.ok) bundle = await res.json();
  }catch{}

  const baseCounts = {};
  let bundleGeneratedAtMs = 0;

  if(bundle && bundle.monthlyOrderCounts && typeof bundle.monthlyOrderCounts === "object"){
    for(const k of keys){
      baseCounts[k] = Number(bundle.monthlyOrderCounts[k] ?? 0);
    }
    bundleGeneratedAtMs = toMillis(bundle.generatedAt);
  }else{
    for(const k of keys) baseCounts[k] = 0;
    bundleGeneratedAtMs = 0;
  }

  // 2) bundleä»¥é™ã® sales ã‚’èª­ã‚“ã§å·®åˆ†ã‚’é›†è¨ˆ
  //    â€» bundleãŒç„¡ã„å ´åˆã¯ã€Œç›´è¿‘12ãƒ¶æœˆã®é–‹å§‹æ—¥ã€ã‹ã‚‰èª­ã‚€ï¼ˆèª­ã¿ã¯å¢—ãˆã‚‹ãŒå‹•ãï¼‰
  const start = bundleGeneratedAtMs
    ? new Date(bundleGeneratedAtMs)
    : new Date(now.getFullYear(), now.getMonth()-11, 1);

  // Firestore query
  const salesRef = collection(db, "sales");
  // createdAt ãŒ Timestamp ã®å‰æã€‚ãªã‘ã‚Œã° clientCreatedAt ã‚’ä½¿ã†ï¼ˆå¾Œæ–¹äº’æ›ï¼‰
  const q1 = query(salesRef, orderBy("createdAt", "asc"), where("createdAt", ">=", Timestamp.fromDate(start)));
  let docs = [];
  try{
    const snap = await getDocs(q1);
    snap.forEach(d=> docs.push({id:d.id, ...d.data()}));
  }catch(err){
    // createdAtãŒç„¡ã„å¤ã„ãƒ‡ãƒ¼ã‚¿ç”¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆcreatedAtã§orderByã§ããªã„å ´åˆï¼‰
    console.warn("createdAt query failed, fallback to limited scan:", err);
    const q2 = query(salesRef, orderBy("clientCreatedAt","desc"), limit(500));
    const snap2 = await getDocs(q2);
    snap2.forEach(d=> docs.push({id:d.id, ...d.data()}));
    // startä»¥é™ã ã‘ã«çµã‚‹
    docs = docs.filter(x=> toMillis(x.clientCreatedAt) >= start.getTime());
  }

  // ã€Œå—æ³¨ä»¶æ•°ã€ã®å®šç¾©ï¼šãƒãƒ«ã‚·ã‚§ä»¥å¤–ï¼ˆï¼å—æ³¨ï¼‰ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
  // kind ãŒ order/stock ã©ã¡ã‚‰ã§ã‚‚ã€Œå—æ³¨ã€æ‰±ã„ï¼ˆå¿…è¦ãªã‚‰å¾Œã§ order ã®ã¿ã«å¤‰æ›´å¯ï¼‰
  for(const s of docs){
    const method = s.method ?? s.salesMethod ?? s.channel ?? s.saleType ?? "";
    if(method === "ãƒãƒ«ã‚·ã‚§") continue;

    const tms = toMillis(s.createdAt ?? s.clientCreatedAt ?? 0);
    if(!tms) continue;
    const d = new Date(tms);
    const key = `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
    if(key in baseCounts) baseCounts[key] += 1;
  }

  // seriesã¸ï¼ˆå¤ã„â†’æ–°ã—ã„ï¼‰
  return keys.map(k=> baseCounts[k] ?? 0);
}

/* ===== chart rendererï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’çŸ­ç¸®ç§»æ¤ï¼šè¦‹ãŸç›®ç¶­æŒï¼‰ ===== */
function down5(v){ return Math.floor(v/5)*5; }
function up5(v){ return Math.ceil(v/5)*5; }
function makeTicks(minS,maxS,isOrders){
  const ticks=[];
  if(isOrders){
    const d=(maxS-minS)/4;
    for(let i=0;i<5;i++) ticks.push(minS + d*i);
    ticks[0]=minS; ticks[4]=maxS;
    return ticks;
  }
  const base=50000;
  const step = base;
  for(let i=0;i<5;i++) ticks.push(minS + step*i);
  return ticks;
}
function labelFor(v,isOrders){
  return isOrders ? `${Math.round(v)}` : `${Math.round(v/10000)}ä¸‡`;
}

function renderChart({mount,yAxis,scroller,metricValue}, mode, series, xLabels){
  const isOrders = (mode==="orders");
  const N=series.length;
  const xStep=96;
  const H=220;
  const padT=14, padB=42, padR=16;
  const innerH=H-padT-padB;
  const W=16 + xStep*(N-1) + padR;

  mount.style.width = `${42 + W}px`;
  metricValue.textContent = isOrders ? `${series[N-1] ?? 0}ä»¶` : formatJPY(series[N-1] ?? 0);

  // scale
  const minV = Math.min(...series);
  const maxV = Math.max(...series);
  const range = (maxV-minV) || 1;
  const pad = range*0.05;
  let minS = minV - pad;
  let maxS = maxV + pad;

  if(isOrders){
    minS = down5(minS);
    maxS = up5(maxS);
    if(maxS - minS < 20) maxS = minS + 20;
  }else{
    const base=50000;
    minS = Math.floor(minS/base)*base;
    maxS = Math.ceil(maxS/base)*base;
    maxS = minS + base*4;
  }

  const ticks = makeTicks(minS,maxS,isOrders);
  const denom = (maxS-minS)||1;
  const yToPx = v => padT + (1 - (v - minS) / denom) * innerH;

  // y axis
  yAxis.innerHTML = `
    <svg width="42" height="${H}">
      ${ticks.map(v=>{
        const y=yToPx(v);
        return `<text x="34" y="${y+4}" text-anchor="end"
          font-size="11" fill="rgba(34,34,34,.55)" font-weight="900">${labelFor(v,isOrders)}</text>`;
      }).join("")}
    </svg>
  `;

  const pts = series.map((v,i)=>({x:42+i*xStep, y:yToPx(v), v}));
  const path = pts.map((p,i)=> i ? `L ${p.x},${p.y}` : `M ${p.x},${p.y}`).join(" ");

  mount.innerHTML = `
    <svg width="${42+W}" height="${H}" viewBox="0 0 ${42+W} ${H}">
      ${ticks.map(v=>{
        const y=yToPx(v);
        return `<line x1="42" y1="${y}" x2="${42+W-padR}" y2="${y}" stroke="rgba(0,0,0,.10)"/>`;
      }).join("")}
      <path d="${path} L ${pts.at(-1).x},${padT+innerH} L ${pts[0].x},${padT+innerH} Z" fill="rgba(225,138,106,.18)"/>
      <path d="${path}" fill="none" stroke="rgba(225,138,106,.95)" stroke-width="3" stroke-linecap="round"/>
      ${pts.map(p=>`<circle cx="${p.x}" cy="${p.y}" r="6" fill="rgba(255,255,255,.95)" stroke="rgba(34,34,34,.28)" stroke-width="2"/>`).join("")}
      ${xLabels.map((m,i)=>`<text x="${42+i*xStep}" y="${H-18}" text-anchor="middle" font-size="12" fill="rgba(34,34,34,.65)" font-weight="900">${m}</text>`).join("")}
    </svg>
  `;

  // rightmost (latest)
  scroller.scrollLeft = scroller.scrollWidth - scroller.clientWidth;
}

const A = {
  mount: document.getElementById("chartMountA"),
  yAxis: document.getElementById("yAxisFixedA"),
  scroller: document.getElementById("chartScrollerA"),
  metricValue: document.getElementById("metricValueA"),
};
const B = {
  mount: document.getElementById("chartMountB"),
  yAxis: document.getElementById("yAxisFixedB"),
  scroller: document.getElementById("chartScrollerB"),
  metricValue: document.getElementById("metricValueB"),
};

const cardChart = document.getElementById("card-chart");
let isFlipped = false;
const ANIM_MS = 650;
function flip(){
  isFlipped = !isFlipped;
  cardChart.classList.add("is-animating");
  cardChart.classList.toggle("is-flipped", isFlipped);
  setTimeout(()=> cardChart.classList.remove("is-animating"), ANIM_MS);
}
cardChart.addEventListener("click", (e)=>{
  if(e.target.closest(".chartScroller")) return;
  flip();
});

/* =========================
   Calendar (stamp only)
   - è¡¨ç¤ºã¯ã‚¹ã‚¿ãƒ³ãƒ—ã®ã¿
   - æƒ…å ±ã¯ã‚¤ãƒ™ãƒ³ãƒˆã«ä¿æŒ:
     { type: "marche"|"story", startAt, endAt, venue(optional) }
   - è¿½åŠ /ç·¨é›†ã¯ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ã‹ã‚‰
   - bundle(JSON)ãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆã—ã€patch(Firestore)ã§å·®åˆ†
========================= */
const HOLIDAY_API = "https://holidays-jp.github.io/api/v1/date.json";
let holidayMap = null;

const calBox = document.getElementById("calBox");
const calViewport = document.getElementById("calViewport");
const monthLabel = document.getElementById("monthLabel");
const monthLabelMini = document.getElementById("monthLabelMini");
const todayBtn = document.getElementById("todayBtn");
const prevBtn  = document.getElementById("prevBtn");
const nextBtn  = document.getElementById("nextBtn");
const modeBtn  = document.getElementById("modeBtn");

const now = new Date();
const baseMonth = new Date(now.getFullYear(), now.getMonth(), 1);
let view = new Date(baseMonth);
const MIN = new Date(baseMonth.getFullYear(), baseMonth.getMonth()-12, 1);
const MAX = new Date(baseMonth.getFullYear(), baseMonth.getMonth()+12, 1);

let dowMode = (localStorage.getItem("enue_dow_mode") === "mon") ? "mon" : "sun";
function getDows(){
  return (dowMode === "mon")
    ? ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"]
    : ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
}
function dayToCol(day){
  if(dowMode === "sun") return day;
  return (day + 6) % 7;
}
function syncModeBtn(){
  if(!modeBtn) return;
  modeBtn.textContent = (dowMode === "sun") ? "Sunâ€“Sat" : "Monâ€“Sun";
}

function updateCellSize(){
  if(!calBox) return;
  const rect = calBox.getBoundingClientRect();
  const innerW = rect.width - 2;
  const cell = Math.floor(innerW / 7);
  const clamped = Math.max(44, Math.min(74, cell));
  document.documentElement.style.setProperty("--cell", clamped + "px");
}
if(calBox && window.ResizeObserver){
  new ResizeObserver(updateCellSize).observe(calBox);
}
updateCellSize();

async function loadHolidays(){
  if(holidayMap) return holidayMap;
  try{
    const res = await fetch(HOLIDAY_API, { cache:"force-cache" });
    holidayMap = await res.json();
  }catch{
    holidayMap = {};
  }
  return holidayMap;
}

/** calendar bundle + patch */
const LS_CAL_CACHE = "enue_calendar_cache_v1";
let CAL_EVENTS = new Map(); // key: ymd -> array of events

function normalizeEvent(e){
  if(!e) return null;
  const type = e.type || e.kind || "";
  const startAt = e.startAt || e.start || e.startISO || e.start_at;
  const endAt   = e.endAt || e.end || e.endISO || e.end_at || startAt;
  if(!type || !startAt) return null;
  return {
    id: e.id || e.eventId || crypto.randomUUID(),
    type, // "marche"|"story"
    startAt, endAt,
    venue: e.venue || ""
  };
}
function packCache(){
  const obj = {};
  for(const [k, arr] of CAL_EVENTS.entries()){
    obj[k] = arr;
  }
  localStorage.setItem(LS_CAL_CACHE, JSON.stringify(obj));
}
function loadCache(){
  try{
    const raw = localStorage.getItem(LS_CAL_CACHE);
    if(!raw) return;
    const parsed = JSON.parse(raw);
    CAL_EVENTS = new Map(Object.entries(parsed));
  }catch{}
}
loadCache();

async function loadCalendarFromBundle(){
  try{
    const res = await fetch("./calendar_bundle.json", { cache:"no-store" });
    if(!res.ok) return;
    const b = await res.json();
    if(!b || !Array.isArray(b.events)) return;
    // rebuild
    const map = new Map();
    for(const evRaw of b.events){
      const ev = normalizeEvent(evRaw);
      if(!ev) continue;
      const d = new Date(toMillis(ev.startAt));
      const key = ymd(d);
      const arr = map.get(key) || [];
      arr.push(ev);
      map.set(key, arr);
    }
    CAL_EVENTS = map;
  }catch{}
}

async function loadCalendarPatchesAround(monthDate){
  // monthDate: first day
  const y = monthDate.getFullYear();
  const m = monthDate.getMonth()+1;
  const start = new Date(y, m-1, 1, 0, 0, 0);
  const end   = new Date(y, m,   1, 0, 0, 0);

  // patches collection: calendar_events
  // fields: type, startAt(Timestamp or ISO), endAt, venue
  const ref = collection(db, "calendar_events");
  let snap;
  try{
    snap = await getDocs(query(ref, orderBy("startAt","asc"), where("startAt", ">=", Timestamp.fromDate(start)), where("startAt","<", Timestamp.fromDate(end))));
  }catch(err){
    // indexç„¡ã—å¯¾ç­–ï¼ˆå°è¦æ¨¡é‹ç”¨æƒ³å®šï¼‰ï¼šå…¨å–å¾—â†’æœˆã§çµã‚‹
    console.warn("calendar index missing? fallback get all (limit 500):", err);
    snap = await getDocs(query(ref, orderBy("startAt","desc"), limit(500)));
  }

  // merge into CAL_EVENTS
  const map = new Map(CAL_EVENTS);
  snap.forEach(d=>{
    const data = d.data();
    const ev = normalizeEvent({ id:d.id, ...data, startAt: data.startAt, endAt: data.endAt });
    if(!ev) return;
    const key = ymd(new Date(toMillis(ev.startAt)));
    const arr = map.get(key) || [];
    // replace by id
    const idx = arr.findIndex(x=>x.id===ev.id);
    if(idx>=0) arr[idx]=ev; else arr.push(ev);
    map.set(key, arr);
  });

  CAL_EVENTS = map;
  packCache();
}

function hasStampOnDay(key){
  const arr = CAL_EVENTS.get(key);
  if(!arr || arr.length===0) return null;
  // å„ªå…ˆ: marche > story
  const m = arr.find(x=>x.type==="marche");
  if(m) return { kind:"marche", ev:m };
  const s = arr.find(x=>x.type==="story");
  if(s) return { kind:"story", ev:s };
  return null;
}

let popEl = null;
function closePopover(){ if(popEl){ popEl.remove(); popEl=null; } }
function openPopover(targetEl, html, onMount){
  closePopover();
  const r = targetEl.getBoundingClientRect();
  popEl = document.createElement("div");
  popEl.className = "popover";
  popEl.innerHTML = html;
  document.body.appendChild(popEl);

  const pr = popEl.getBoundingClientRect();
  let x = r.left + 6;
  let y = r.bottom + 8;
  if(x + pr.width > window.innerWidth - 10) x = window.innerWidth - pr.width - 10;
  if(y + pr.height > window.innerHeight - 10) y = r.top - pr.height - 8;
  if(y < 10) y = 10;
  popEl.style.left = x + "px";
  popEl.style.top  = y + "px";

  if(typeof onMount === "function") onMount(popEl);
}

async function upsertCalendarEvent(dayKey, type, startHHMM="09:00", endHHMM="17:00", venue=""){
  // doc id: `${dayKey}_${type}` (åŒæ—¥åŒtypeã¯1ã¤)
  const id = `${dayKey}_${type}`;
  const startAt = new Date(`${dayKey}T${startHHMM}:00`);
  const endAt   = new Date(`${dayKey}T${endHHMM}:00`);
  await setDoc(doc(db,"calendar_events", id), {
    type,
    startAt: Timestamp.fromDate(startAt),
    endAt: Timestamp.fromDate(endAt),
    venue: venue || "",
    updatedAt: serverTimestamp()
  }, { merge:true });
}

function buildGrid(year, month){
  const grid = document.createElement("div");
  grid.className = "calGrid";

  const dows = getDows();
  for(let i=0;i<7;i++){
    const dow = document.createElement("div");
    dow.className = "dow";
    dow.textContent = dows[i];
    grid.appendChild(dow);
  }

  const firstDow = new Date(year, month-1, 1).getDay();
  const firstCol = dayToCol(firstDow);
  const lastDate = new Date(year, month, 0).getDate();

  const needed = firstCol + lastDate;
  const weeks = Math.ceil(needed / 7);
  const totalCells = weeks * 7;

  const prevLast = new Date(year, month-1, 0).getDate();
  const nextY = (month === 12) ? year+1 : year;
  const nextM = (month === 12) ? 1 : month+1;
  const prevY = (month === 1) ? year-1 : year;
  const prevM = (month === 1) ? 12 : month-1;

  const todayKey = ymd(new Date());

  for(let idx=0; idx<totalCells; idx++){
    let d, cellY=year, cellM=month, outside=false;

    if(idx < firstCol){
      outside = true;
      cellY = prevY; cellM = prevM;
      d = prevLast - (firstCol - 1 - idx);
    }else if(idx >= firstCol + lastDate){
      outside = true;
      cellY = nextY; cellM = nextM;
      d = (idx - (firstCol + lastDate)) + 1;
    }else{
      d = (idx - firstCol) + 1;
    }

    const key = `${cellY}-${pad2(cellM)}-${pad2(d)}`;
    const isToday = key === todayKey;

    const realDay = new Date(cellY, cellM-1, d).getDay();
    const isSun = realDay === 0;
    const isSat = realDay === 6;

    const hName = holidayMap?.[key] || "";
    const isHoliday = !!hName;

    const stampInfo = hasStampOnDay(key);

    const cell = document.createElement("button");
    cell.type = "button";
    cell.className = "day"
      + (outside ? " dim" : "")
      + (isSun ? " sun" : "")
      + (isSat ? " sat" : "")
      + (isHoliday ? " holiday" : "")
      + (isToday ? " today" : "");

    let centerHtml = `<div class="centerMark"></div>`;
    if(stampInfo?.kind==="marche"){
      centerHtml = `<div class="centerMark"><span class="stamp" aria-label="MARCHE"><span>MAR</span><span>CHE</span></span></div>`;
    }else if(stampInfo?.kind==="story"){
      centerHtml = `<div class="centerMark"><span class="eventDot blue" aria-label="STORY"></span></div>`;
    }

    cell.innerHTML = `
      <div class="num">${d}</div>
      ${centerHtml}
    `;

    cell.addEventListener("click", ()=>{
      const ev = stampInfo?.ev || null;

      const pills = [];
      if(stampInfo?.kind==="marche") pills.push(`<span class="badge">ãƒãƒ«ã‚·ã‚§</span>`);
      if(stampInfo?.kind==="story")  pills.push(`<span class="badge blue">ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è²©å£²</span>`);
      if(isHoliday) pills.push(`<span class="badge red">ç¥æ—¥ï¼š${escapeHtml(hName)}</span>`);
      if(isSun && !isHoliday) pills.push(`<span class="badge red">æ—¥æ›œ</span>`);
      if(isSat) pills.push(`<span class="badge blue">åœŸæ›œ</span>`);
      if(!stampInfo && !isHoliday) pills.push(`<span class="badge">äºˆå®šãªã—</span>`);

      const timeLine = ev
        ? `<div class="popSub" style="margin-top:6px;">${escapeHtml(ymdhm(new Date(toMillis(ev.startAt))))}ã€œ${escapeHtml(pad2(new Date(toMillis(ev.endAt))).getHours())}:${escapeHtml(pad2(new Date(toMillis(ev.endAt))).getMinutes()))}${ev.venue ? " / "+escapeHtml(ev.venue):""}</div>`
        : "";

      const html = `
        <div class="popHead">
          <div>
            <div class="popTitle">${key}</div>
            <div class="popSub">${cellY}.${pad2(cellM)}${outside ? "ï¼ˆå‰å¾Œæœˆï¼‰" : ""}</div>
            ${timeLine}
          </div>
          <button class="iconBtn" type="button" id="editBtn" title="è¿½åŠ /ç·¨é›†">âœï¸</button>
        </div>
        <div class="popRow">${pills.join("")}</div>

        <div class="editBox" id="editBox">
          <label>ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ  / ç·¨é›†</label>

          <div class="editRow" style="gap:10px; margin-bottom:10px;">
            <select class="dateInput" id="typeSel" style="flex:1;">
              <option value="marche">ãƒãƒ«ã‚·ã‚§</option>
              <option value="story">ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è²©å£²</option>
            </select>
          </div>

          <div class="editRow" style="gap:10px; margin-bottom:10px;">
            <input class="dateInput" id="startTime" type="time" value="${ev ? pad2(new Date(toMillis(ev.startAt)).getHours())+":"+pad2(new Date(toMillis(ev.startAt)).getMinutes()) : "09:00"}">
            <input class="dateInput" id="endTime" type="time" value="${ev ? pad2(new Date(toMillis(ev.endAt)).getHours())+":"+pad2(new Date(toMillis(ev.endAt)).getMinutes()) : "17:00"}">
          </div>

          <div class="editRow" style="gap:10px;">
            <input class="dateInput" id="venue" type="text" placeholder="è²©å£²å ´æ‰€ï¼ˆãƒãƒ«ã‚·ã‚§ã®ã¿ï¼‰" value="${ev?.venue ? escapeHtml(ev.venue) : ""}">
          </div>

          <div class="note">â€»è¡¨ç¤ºã¯ã‚¹ã‚¿ãƒ³ãƒ—ã®ã¿ã€‚æƒ…å ±ã¯ã‚¹ã‚¿ãƒ³ãƒ—ã«ä¿æŒã—ã¾ã™ã€‚</div>

          <div class="editRow" style="margin-top:10px;">
            <button class="saveBtn" type="button" id="saveStamp">ä¿å­˜</button>
          </div>
        </div>

        <div class="closeHint">å¤–å´ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹</div>
      `;

      openPopover(cell, html, (pop)=>{
        const editBtn = pop.querySelector("#editBtn");
        const editBox = pop.querySelector("#editBox");
        const typeSel = pop.querySelector("#typeSel");
        const startTime = pop.querySelector("#startTime");
        const endTime = pop.querySelector("#endTime");
        const venue = pop.querySelector("#venue");
        const saveStamp = pop.querySelector("#saveStamp");

        if(ev?.type) typeSel.value = ev.type;

        // storyã®æ™‚ã¯ venue ç„¡åŠ¹
        const syncVenueDisable = ()=>{
          const isStory = typeSel.value === "story";
          venue.disabled = isStory;
          if(isStory) venue.value = "";
          venue.placeholder = isStory ? "ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è²©å£²ã¯è²©å£²å ´æ‰€ãªã—" : "è²©å£²å ´æ‰€ï¼ˆãƒãƒ«ã‚·ã‚§ã®ã¿ï¼‰";
        };
        syncVenueDisable();
        typeSel.addEventListener("change", syncVenueDisable);

        editBtn.addEventListener("click", (e)=>{
          e.stopPropagation();
          editBox.classList.toggle("show");
        });

        saveStamp.addEventListener("click", async (e)=>{
          e.stopPropagation();
          try{
            await upsertCalendarEvent(key, typeSel.value, startTime.value || "09:00", endTime.value || "17:00", venue.value || "");
            // å³åæ˜ 
            await loadCalendarPatchesAround(new Date(cellY, cellM-1, 1));
            renderMonth("none");
            closePopover();
          }catch(err){
            alert("ä¿å­˜ã«å¤±æ•—: " + err);
          }
        });
      });
    }, { passive:true });

    grid.appendChild(cell);
  }

  return grid;
}

function setNavDisabled(){
  if(!prevBtn || !nextBtn) return;
  prevBtn.disabled = view <= MIN;
  nextBtn.disabled = view >= MAX;
}
function setHeader(){
  const y = view.getFullYear();
  const m = view.getMonth()+1;
  const label = `${y}.${pad2(m)}`;
  if(monthLabel) monthLabel.textContent = label;
  if(monthLabelMini) monthLabelMini.textContent = label;
  syncModeBtn();
}

function renderMonth(direction){
  closePopover();
  setNavDisabled();
  setHeader();

  const y = view.getFullYear();
  const m = view.getMonth()+1;

  const incoming = buildGrid(y, m);

  if(direction === "none" || !calViewport){
    if(calViewport){
      calViewport.innerHTML = "";
      calViewport.appendChild(incoming);
    }
    incoming.classList.add("slideActive");
    return;
  }

  const current = calViewport.querySelector(".calGrid");
  calViewport.appendChild(incoming);

  if(direction === "left"){
    incoming.classList.add("slideEnterRight");
    requestAnimationFrame(()=>{
      incoming.classList.add("slideActive");
      incoming.classList.remove("slideEnterRight");
      if(current){
        current.classList.add("slideExitLeft");
        setTimeout(()=> current.remove(), 300);
      }
    });
  }else{
    incoming.classList.add("slideEnterLeft");
    requestAnimationFrame(()=>{
      incoming.classList.add("slideActive");
      incoming.classList.remove("slideEnterLeft");
      if(current){
        current.classList.add("slideExitRight");
        setTimeout(()=> current.remove(), 300);
      }
    });
  }
}

prevBtn?.addEventListener("click", async ()=>{
  if(view <= MIN) return;
  view = new Date(view.getFullYear(), view.getMonth()-1, 1);
  await loadCalendarPatchesAround(view);
  renderMonth("right");
});
nextBtn?.addEventListener("click", async ()=>{
  if(view >= MAX) return;
  view = new Date(view.getFullYear(), view.getMonth()+1, 1);
  await loadCalendarPatchesAround(view);
  renderMonth("left");
});
todayBtn?.addEventListener("click", async ()=>{
  view = new Date(baseMonth.getFullYear(), baseMonth.getMonth(), 1);
  await loadCalendarPatchesAround(view);
  renderMonth("none");
});
modeBtn?.addEventListener("click", ()=>{
  dowMode = (dowMode === "sun") ? "mon" : "sun";
  localStorage.setItem("enue_dow_mode", dowMode);
  renderMonth("none");
});

document.addEventListener("click", (e)=>{
  if(!popEl) return;
  const t = e.target;
  if(popEl.contains(t)) return;
  if(t.closest && t.closest(".day")) return;
  closePopover();
}, { passive:true });
window.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closePopover(); });

/* =========================
   Orders list (stock/order)
========================= */
const STATUS = ["æœªç€æ‰‹","å…¥é‡‘å¾…ã¡","é€²è¡Œä¸­","å®Œäº†"];
const ASSIGNEE_OPTIONS = ["è—¤åŸ","å·åŸ"];

const tbodyStock = document.getElementById("tbodyStock");
const emptyStock = document.getElementById("emptyStock");
const tbodyOrder = document.getElementById("tbodyOrder");
const emptyOrder = document.getElementById("emptyOrder");

const overlay = document.getElementById("overlayOrders");
const sheetTitle = document.getElementById("sheetTitle");
const sheetBody  = document.getElementById("sheetBody");
const sheetFoot  = document.getElementById("sheetFoot");
const closeBtn   = document.getElementById("closeBtn");
const cancelBtn  = document.getElementById("cancelBtn");
const saveBtn    = document.getElementById("saveBtn");
const datePicker = document.getElementById("datePicker");

let SALES = []; // raw
let ROWS_STOCK = [];
let ROWS_ORDER = [];

function statusClass(status){
  if(status==="æœªç€æ‰‹") return "s-michakushu";
  if(status==="å…¥é‡‘å¾…ã¡") return "s-nyuukin";
  if(status==="é€²è¡Œä¸­") return "s-shinkochu";
  if(status==="å®Œäº†") return "s-done";
  return "s-michakushu";
}

function openReceiptById(receiptId){
  location.href = `receipt.html?id=${encodeURIComponent(receiptId)}`;
}

async function loadSalesRecent(){
  const salesRef = collection(db,"sales");
  const snap = await getDocs(query(salesRef, orderBy("createdAt","desc"), limit(250)));
  const arr=[];
  snap.forEach(d=> arr.push({ id:d.id, ...d.data() }));
  return arr;
}

function mapSaleToRow(s){
  const receiptId = s.id;
  const method = s.method ?? s.salesMethod ?? s.channel ?? s.saleType ?? "";
  const kind = s.kind ?? ""; // "stock"|"order"
  const progress = s.progress ?? s.status ?? "æœªç€æ‰‹";
  const assignees = Array.isArray(s.assignees) ? s.assignees : [];
  const due = (typeof s.due === "string") ? s.due : (s.due?.toDate ? isoDate(s.due.toDate()) : "");
  const createdAtMs = toMillis(s.createdAt ?? s.clientCreatedAt ?? 0);
  const name = s.title ?? s.name ?? (Array.isArray(s.items) && s.items[0]?.name ? `${s.items[0].name}${s.items.length>1 ? ` ä»–${s.items.length-1}` : ""}` : "ï¼ˆåç§°ãªã—ï¼‰");
  return { receiptId, method, kind, progress, assignees, due, createdAtMs, name };
}

function rebuildRows(){
  const rows = SALES.map(mapSaleToRow)
    .filter(r=> r.method !== "ãƒãƒ«ã‚·ã‚§")
    .filter(r=> r.progress !== "å®Œäº†")
    .filter(r=> r.kind === "stock" || r.kind === "order");

  ROWS_STOCK = rows
    .filter(r=> r.kind === "stock")
    .sort((a,b)=> (b.createdAtMs||0) - (a.createdAtMs||0));

  ROWS_ORDER = rows
    .filter(r=> r.kind === "order")
    .sort((a,b)=>{
      const ad = a.due ? Date.parse(a.due) : 9e15;
      const bd = b.due ? Date.parse(b.due) : 9e15;
      return ad - bd;
    });
}

function td(label, child){
  const cell = document.createElement("td");
  cell.setAttribute("data-label", label);
  cell.appendChild(child);
  return cell;
}
function nameCell(r){
  const btn = document.createElement("button");
  btn.className = "nameBtn";
  btn.type = "button";
  btn.innerHTML = `<span>${escapeHtml(r.name)}</span><span class="chev">â€º</span>`;
  btn.onclick = ()=> openReceiptById(r.receiptId);
  return btn;
}
function dueCell(r){
  const btn = document.createElement("div");
  btn.className = "tap duePill";
  btn.role = "button";
  btn.tabIndex = 0;
  btn.textContent = r.due ? fmtNoYear(r.due) : "-";
  btn.onclick = ()=> editDue(r.receiptId);
  btn.onkeydown = (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); editDue(r.receiptId); } };
  return btn;
}
function statusCell(r){
  const btn = document.createElement("div");
  btn.className = "tap";
  btn.role = "button";
  btn.tabIndex = 0;
  const pill = document.createElement("div");
  pill.className = "statusPill " + statusClass(r.progress);
  pill.innerHTML = `<span class="dot"></span><span>${escapeHtml(r.progress)}</span>`;
  btn.appendChild(pill);
  btn.onclick = ()=> editProgress(r.receiptId);
  btn.onkeydown = (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); editProgress(r.receiptId); } };
  return btn;
}
function assigneeCell(r){
  const btn = document.createElement("div");
  btn.className = "tap";
  btn.role = "button";
  btn.tabIndex = 0;

  const wrap = document.createElement("div");
  wrap.className = "chips";
  if(!r.assignees || r.assignees.length===0){
    const c = document.createElement("span");
    c.className = "chip muted";
    c.textContent = "æœªè¨­å®š";
    wrap.appendChild(c);
  }else{
    r.assignees.forEach(a=>{
      const c = document.createElement("span");
      c.className = "chip";
      c.textContent = a;
      wrap.appendChild(c);
    });
  }
  btn.appendChild(wrap);
  btn.onclick = ()=> editAssignees(r.receiptId);
  btn.onkeydown = (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); editAssignees(r.receiptId); } };
  return btn;
}

function renderTables(){
  // stock
  tbodyStock.innerHTML = "";
  emptyStock.style.display = (ROWS_STOCK.length===0) ? "block" : "none";
  ROWS_STOCK.forEach(r=>{
    const tr = document.createElement("tr");
    tr.appendChild(td("åå‰", nameCell(r)));
    tr.appendChild(td("æœŸæ—¥", dueCell(r)));
    tr.appendChild(td("é€²æ—", statusCell(r)));
    tr.appendChild(td("æ‹…å½“", assigneeCell(r)));
    tbodyStock.appendChild(tr);
  });

  // order
  tbodyOrder.innerHTML = "";
  emptyOrder.style.display = (ROWS_ORDER.length===0) ? "block" : "none";
  ROWS_ORDER.forEach(r=>{
    const tr = document.createElement("tr");
    tr.appendChild(td("åå‰", nameCell(r)));
    tr.appendChild(td("æœŸæ—¥", dueCell(r)));
    tr.appendChild(td("é€²æ—", statusCell(r)));
    tr.appendChild(td("æ‹…å½“", assigneeCell(r)));
    tbodyOrder.appendChild(tr);
  });
}

/* bottom sheet */
overlay?.addEventListener("click", closeSheet);
closeBtn?.addEventListener("click", closeSheet);

function openSheet(title, bodyFactory){
  sheetTitle.textContent = title;
  sheetBody.innerHTML = "";
  sheetFoot.style.display = "none";
  cancelBtn && (cancelBtn.onclick = null);
  saveBtn && (saveBtn.onclick = null);

  const body = bodyFactory();
  sheetBody.appendChild(body);
  overlay.classList.add("show");
}
function showSheetFooter(onCancel, onSave){
  sheetFoot.style.display = "flex";
  if(cancelBtn) cancelBtn.onclick = onCancel;
  if(saveBtn) saveBtn.onclick = onSave;
}
function closeSheet(){
  overlay.classList.remove("show");
  sheetBody.innerHTML = "";
  sheetFoot.style.display = "none";
}

async function patchSale(receiptId, patch){
  await updateDoc(doc(db,"sales", receiptId), patch);
}

function editDue(receiptId){
  const all = [...ROWS_STOCK, ...ROWS_ORDER];
  const r = all.find(x=>x.receiptId===receiptId);
  if(!r || !datePicker) return;

  datePicker.value = r.due || "";
  datePicker.onchange = async ()=>{
    const next = datePicker.value || "";
    try{
      await patchSale(receiptId, { due: next, updatedAt: serverTimestamp() });
      await refreshAll();
    }catch(err){
      alert("æ›´æ–°ã«å¤±æ•—: " + err);
    }
  };
  datePicker.focus();
  datePicker.click();
}

function editProgress(receiptId){
  const all = [...ROWS_STOCK, ...ROWS_ORDER];
  const r = all.find(x=>x.receiptId===receiptId);
  if(!r) return;

  openSheet("é€²æ—ã‚’é¸æŠ", ()=>{
    const body = document.createElement("div");
    body.className = "enueOptList";

    STATUS.forEach(s=>{
      const opt = document.createElement("div");
      opt.className = "enueOpt";
      opt.innerHTML = `
        <div class="left">
          <span class="statusPill ${statusClass(s)}" style="margin:0;">
            <span class="dot"></span><span>${escapeHtml(s)}</span>
          </span>
        </div>
        <div class="right">${r.progress===s ? "é¸æŠä¸­" : ""}</div>
      `;
      opt.onclick = async ()=>{
        try{
          await patchSale(receiptId, { progress: s, updatedAt: serverTimestamp() });
          closeSheet();
          await refreshAll();
        }catch(err){
          alert("æ›´æ–°ã«å¤±æ•—: " + err);
        }
      };
      body.appendChild(opt);
    });

    return body;
  });
}

function editAssignees(receiptId){
  const all = [...ROWS_STOCK, ...ROWS_ORDER];
  const r = all.find(x=>x.receiptId===receiptId);
  if(!r) return;

  const draft = new Set(r.assignees || []);

  openSheet("æ‹…å½“ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰", ()=>{
    const body = document.createElement("div");
    body.className = "enueOptList";

    ASSIGNEE_OPTIONS.forEach(a=>{
      const opt = document.createElement("div");
      opt.className = "enueOpt";

      const check = document.createElement("span");
      check.className = "enueCheck" + (draft.has(a) ? " on" : "");
      check.textContent = draft.has(a) ? "âœ“" : "";

      const left = document.createElement("div");
      left.className = "left";
      left.innerHTML = `<span style="font-weight:900;">${escapeHtml(a)}</span>`;
      left.prepend(check);

      const right = document.createElement("div");
      right.className = "right";
      right.textContent = draft.has(a) ? "é¸æŠä¸­" : "";

      opt.appendChild(left);
      opt.appendChild(right);

      opt.onclick = ()=>{
        if(draft.has(a)) draft.delete(a); else draft.add(a);
        check.className = "enueCheck" + (draft.has(a) ? " on" : "");
        check.textContent = draft.has(a) ? "âœ“" : "";
        right.textContent = draft.has(a) ? "é¸æŠä¸­" : "";
      };

      body.appendChild(opt);
    });

    showSheetFooter(
      ()=> closeSheet(),
      async ()=>{
        try{
          await patchSale(receiptId, { assignees: Array.from(draft), updatedAt: serverTimestamp() });
          closeSheet();
          await refreshAll();
        }catch(err){
          alert("æ›´æ–°ã«å¤±æ•—: " + err);
        }
      }
    );

    return body;
  });
}

async function refreshAll(){
  SALES = await loadSalesRecent();
  rebuildRows();
  renderTables();
}

/* =========================
   POSã‚’ãƒˆãƒƒãƒ—ã«ã™ã‚‹ï¼ˆè‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰
   - ä»Šæ—¥ã®ã‚¤ãƒ™ãƒ³ãƒˆã§ã€Œä»ŠãŒé–‹å‚¬æ™‚é–“å†…ã€ãªã‚‰ pos ã«é£›ã°ã™
========================= */
function isNowInEventWindow(ev){
  const s = toMillis(ev.startAt);
  const e = toMillis(ev.endAt);
  const n = Date.now();
  return s && e && (n >= s) && (n <= e);
}
function shouldRedirectToPos(){
  const key = ymd(new Date());
  const arr = CAL_EVENTS.get(key) || [];
  const active = arr.find(ev => (ev.type==="marche" || ev.type==="story") && isNowInEventWindow(ev));
  return !!active;
}

/* =========================
   Boot
========================= */
(async function boot(){
  await loadHolidays();

  // calendar: bundle -> patch (current view month)
  await loadCalendarFromBundle();
  await loadCalendarPatchesAround(view);

  // redirect check (ã§ãã‚‹ã ã‘æ—©ã)
  if(shouldRedirectToPos()){
    location.replace("pos_prod_toggle.html");
    return;
  }

  renderMonth("none");

  // orders list
  await refreshAll();

  // chart: monthly order counts
  try{
    ordersSeries = await loadMonthlyOrderCounts();
  }catch(err){
    console.warn("monthly counts failed:", err);
    ordersSeries = Array(12).fill(0);
  }

  // x labels: "YYYY-MM" â†’ "Mæœˆ" è¡¨ç¤º
  const now2 = new Date();
  const xLabels = [];
  for(let i=11;i>=0;i--){
    const d = new Date(now2.getFullYear(), now2.getMonth()-i, 1);
    xLabels.push(`${d.getMonth()+1}æœˆ`);
  }

  renderChart(A, "orders", ordersSeries, xLabels);
  renderChart(B, "assets", assetsSeries, monthsLabel);

  // å—æ³¨ä»¶æ•°ã®ç·è¨ˆï¼ˆã‚«ãƒ¼ãƒ‰å³ä¸Šï¼‰
  // metricValueA/B ã¯ renderChart å†…ã§æ›´æ–°æ¸ˆã¿
})();
</script>
</body>
</html>
