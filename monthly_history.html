rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* =========================
       共通
    ========================= */
    function isAllowedUser() {
      return request.auth != null
        && (
          request.auth.uid in [
            "Zs33k2rRFJXEUPxMU09ILRBXOpk1",
            "2e7bfHn6vdOMdLjcCJhhZzEDFMF3",
            "q61dOiRvAwbq2jkeb3wUVLIyhBP2"
          ]
          ||
          (("email" in request.auth.token) && request.auth.token.email in [
            "enue_staff03@management.com",
            "enue_staff01@haruchan.com",
            "enue_staff02@haruna.com"
          ])
        );
    }

    function isAdmin() {
      return request.auth != null
        && (
          request.auth.uid == "Zs33k2rRFJXEUPxMU09ILRBXOpk1"
          || (("email" in request.auth.token) && request.auth.token.email == "enue_staff03@management.com")
        );
    }

    function notBundledDoc() {
      return !(resource.data.isBundled == true);
    }

    function isStr(s, max) { return s is string && s.size() <= max; }
    function isNum(n, min, max) { return n is number && n >= min && n <= max; }
    function isTs(t) { return t is timestamp; }

    // ✅ HTMLが new Date() を送るケースも通す（Firestore側でtimestamp化されるが、評価で落ちるケース対策）
    function isTsOrDate(x) {
      return (x is timestamp) || (x is string && x.size() <= 40) || (x is number);
      // ↑「厳密にtimestampだけ」にしたいなら後で締める（まず通す）
    }

    /* =========================
       sales
    ========================= */
    match /sales/{docId} {
      allow read: if isAllowedUser();
      allow create: if isAllowedUser();

      allow update: if isAdmin()
        && notBundledDoc()
        && request.resource.data
             .diff(resource.data)
             .changedKeys()
             .hasOnly([
               "buyerName",
               "orderDate",
               "channel",
               "paymentMethod",
               "venue",
               "kind",
               "urgentOption",
               "memo",
               "items",
               "total",
               "updatedAt"
             ])

        // 必須
        && isStr(request.resource.data.buyerName, 80)
        && isStr(request.resource.data.orderDate, 20)
        && isStr(request.resource.data.channel, 80)
        && isStr(request.resource.data.paymentMethod, 80)
        && isStr(request.resource.data.venue, 80)
        && isStr(request.resource.data.kind, 80)
        && isStr(request.resource.data.memo, 1000)
        && (request.resource.data.items is list)
        && isNum(request.resource.data.total, -1000000000, 1000000000)

        // ✅ 任意：urgentOption（無い/空でもOK）
        && (
          !("urgentOption" in request.resource.data)
          || isStr(request.resource.data.urgentOption, 80)
        )

        // ✅ updatedAt（無くてもOK／あれば許可）
        && (
          !("updatedAt" in request.resource.data)
          || isTsOrDate(request.resource.data.updatedAt)
        );

      allow delete: if false;
    }

    /* =========================
       修正依頼
    ========================= */
    match /sales_fix_requests/{reqId} {
      allow read: if isAllowedUser();

      allow create: if isAllowedUser()
        && isStr(request.resource.data.saleId, 80)
        && request.resource.data.status == "依頼中"
        && isStr(request.resource.data.createdBy, 120)
        && (
          !("createdAt" in request.resource.data)
          || isTsOrDate(request.resource.data.createdAt)
        );

      allow update: if isAdmin()
        && request.resource.data
             .diff(resource.data)
             .changedKeys()
             .hasOnly(["status","resolvedAt","resolvedBy","adminMemo"])
        && request.resource.data.status in ["依頼中","完了"];

      allow delete: if false;
    }

    /* =========================
       default deny
    ========================= */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
