<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>e.nue Â£≤‰∏äÁÆ°ÁêÜ</title>

  <style>
    :root{
      --bg1:#e3ddd4;
      --bg2:#d4ccc1;

      --glass-bg: rgba(255,255,255,.86);
      --glass-bg2: rgba(255,255,255,.78);
      --glass-border: rgba(0,0,0,.06);
      --line-soft: rgba(0,0,0,.10);
      --shadow: 0 18px 45px rgba(0,0,0,.14);

      --text-main:#222222;
      --text-sub:#555555;
      --muted: rgba(34,34,34,.58);

      --accent:#e18a6a;
      --accent2:#d06463;

      --r: 20px;
      --r2: 16px;
      --pad: 16px;

      --max: 980px;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", "Noto Sans JP", sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color: var(--text-main);
    }

    a{ color: inherit; text-decoration: none; }

    .wrap{
      min-height: 100%;
      padding: 18px 14px 28px;
      display:flex;
      justify-content:center;
    }
    .app{
      width:100%;
      max-width: var(--max);
    }

    /* header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 6px 2px 14px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand .title{
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .02em;
    }
    .brand .sub{
      font-size: 12px;
      color: var(--muted);
    }

    .navBtns{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      border:1px solid var(--glass-border);
      background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.76));
      box-shadow: 0 10px 25px rgba(0,0,0,.08);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 800;
      font-size: 12px;
      color: rgba(34,34,34,.82);
      cursor:pointer;
      display:inline-flex;
      gap:8px;
      align-items:center;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(225,138,106,.22), rgba(255,255,255,.78));
      border-color: rgba(225,138,106,.25);
    }

    /* cards */
    .card{
      background: linear-gradient(180deg, var(--glass-bg), var(--glass-bg2));
      border: 1px solid var(--glass-border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding: 14px 14px 10px;
      display:flex;
      gap:10px;
      align-items:flex-end;
      justify-content:space-between;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .cardHead .h{
      font-size: 14px;
      font-weight: 900;
      letter-spacing: .02em;
    }
    .cardHead .meta{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }
    .cardBody{ padding: 12px 14px 14px; }

    /* controls */
    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .leftControls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .field{
      display:flex;
      gap:8px;
      align-items:center;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.70);
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
    }
    .field label{
      font-size: 12px;
      font-weight: 900;
      color: rgba(34,34,34,.72);
      white-space:nowrap;
    }
    select, input[type="search"]{
      border:0;
      outline:none;
      background: transparent;
      font-size: 13px;
      font-weight: 800;
      color: rgba(34,34,34,.88);
      min-width: 110px;
    }
    input[type="search"]{ min-width: 180px; }

    .statRow{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top: 10px;
      color: rgba(34,34,34,.80);
    }
    .pill{
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.62);
      border: 1px solid rgba(0,0,0,.06);
      font-size: 12px;
      font-weight: 900;
      box-shadow: 0 10px 18px rgba(0,0,0,.05);
    }

    /* list */
    .months{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding: 12px 0 0;
    }

    details.month{
      border: 1px solid rgba(0,0,0,.07);
      background: rgba(255,255,255,.62);
      border-radius: 16px;
      box-shadow: 0 12px 22px rgba(0,0,0,.06);
      overflow:hidden;
    }
    summary{
      list-style:none;
      cursor:pointer;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    summary::-webkit-details-marker{ display:none; }

    .mLeft{
      display:flex; flex-direction:column; gap:3px;
    }
    .mTitle{
      font-weight: 1000;
      letter-spacing: .02em;
      font-size: 14px;
    }
    .mSub{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }
    .mRight{
      text-align:right;
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .mTotal{
      font-size: 14px;
      font-weight: 1000;
    }
    .mCount{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
    }

    .sales{
      padding: 0 10px 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    details.sale{
      border: 1px solid rgba(0,0,0,.07);
      background: rgba(255,255,255,.68);
      border-radius: 14px;
      overflow:hidden;
    }

    .saleCard{
      border: 1px solid rgba(0,0,0,.07);
      background: rgba(255,255,255,.68);
      border-radius: 14px;
      overflow:hidden;
    }
    .saleCard:active{ transform: translateY(1px); }
    .saleSum{
      padding: 10px 10px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .saleLeft{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 0;
      flex: 1;
    }
    .saleTop{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      min-width:0;
    }
    .saleDate{
      font-weight: 1000;
      font-size: 13px;
      white-space:nowrap;
    }
    .badge{
      font-size: 11px;
      font-weight: 1000;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.65);
      color: rgba(34,34,34,.72);
      white-space:nowrap;
    }
    .saleMeta{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space:nowrap;
      max-width: 62vw;
    }
    .saleRight{
      text-align:right;
      display:flex;
      flex-direction:column;
      gap:2px;
      white-space:nowrap;
      align-items:flex-end;
    }
    .saleTotal{
      font-weight: 1000;
      font-size: 13px;
    }
    .saleId{
      font-size: 11px;
      color: rgba(34,34,34,.48);
      font-weight: 800;
    }

    .editBtn{
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.72);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      font-weight: 1000;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
      flex: 0 0 auto;
    }
    .editBtn:active{ transform: translateY(1px); }

    .items{
      padding: 0 10px 10px;
    }
    table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
      overflow:hidden;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.08);
    }
    th,td{
      padding: 8px 8px;
      border-bottom: 1px solid rgba(0,0,0,.06);
      vertical-align: top;
    }
    th{
      text-align:left;
      font-weight: 1000;
      background: rgba(255,255,255,.58);
      color: rgba(34,34,34,.78);
    }
    td{
      font-weight: 800;
      color: rgba(34,34,34,.84);
    }
    tr:last-child td{ border-bottom:0; }

    .right{ text-align:right; }
    .muted{ color: var(--muted); font-weight: 800; }

    .empty{
      padding: 14px 0 2px;
      color: rgba(34,34,34,.62);
      font-weight: 900;
      font-size: 13px;
    }

    .toast{
      position:fixed;
      left:50%;
      transform: translateX(-50%);
      bottom: 18px;
      background: rgba(25,25,25,.88);
      color:#fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 20000;
    }
    .toast.on{ opacity:1; transform: translateX(-50%) translateY(-2px); }

    .smallNote{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(34,34,34,.58);
      font-weight: 800;
      line-height: 1.5;
    }

    /* modal */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding: 18px 14px;
      z-index: 200;
    }
    .modalCard{
      width: 100%;
      max-width: 560px;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.80));
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 18px;
      box-shadow: 0 22px 55px rgba(0,0,0,.18);
      padding: 14px;
      overflow:hidden;
    }
    .modalTitle{
      font-size: 14px;
      font-weight: 1000;
      letter-spacing: .02em;
      margin-bottom: 10px;
    }
    .modalSub{
      font-size: 12px;
      color: rgba(34,34,34,.62);
      font-weight: 900;
      margin-top: -6px;
      margin-bottom: 10px;
      line-height: 1.4;
    }
    .modalBtns{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .modalBtn{
      width: 100%;
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 14px;
      padding: 12px 12px;
      background: rgba(255,255,255,.72);
      font-weight: 1000;
      font-size: 13px;
      cursor:pointer;
      text-align:left;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalBtn.primary{
      border-color: rgba(225,138,106,.30);
      background: linear-gradient(180deg, rgba(225,138,106,.20), rgba(255,255,255,.78));
    }
    .modalBtn.danger{
      border-color: rgba(208,100,99,.35);
      background: linear-gradient(180deg, rgba(208,100,99,.16), rgba(255,255,255,.78));
    }
    .modalBtn:active{ transform: translateY(1px); }
    .modalBtn .hint{
      font-size: 12px;
      font-weight: 900;
      color: rgba(34,34,34,.55);
      white-space:nowrap;
    }

    .form{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 10px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-start;
    }
    .input{
      flex: 1 1 160px;
      display:flex;
      flex-direction:column;
      gap:6px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.70);
      box-shadow: 0 10px 18px rgba(0,0,0,.05);
    }
    .input .lab{
      font-size: 12px;
      font-weight: 1000;
      color: rgba(34,34,34,.72);
    }
    .input input, .input textarea, .input select{
      width:100%;
      border:0;
      outline:none;
      background: transparent;
      font-size: 13px;
      font-weight: 900;
      color: rgba(34,34,34,.88);
    }
    .input textarea{
      min-height: 70px;
      resize: vertical;
      line-height: 1.45;
      font-weight: 800;
    }

    .miniTable{
      width:100%;
      border-collapse: collapse;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.62);
    }
    .miniTable th,.miniTable td{ padding: 8px; border-bottom: 1px solid rgba(0,0,0,.06); }
    .miniTable th{ font-size: 12px; font-weight: 1000; color: rgba(34,34,34,.72); background: rgba(255,255,255,.58); }
    .miniTable td input{
      width:100%;
      border:0;
      outline:none;
      background: transparent;
      font-size: 12px;
      font-weight: 900;
      color: rgba(34,34,34,.88);
    }
    .miniActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 8px;
    }
    .miniActions .sbtn{
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.72);
      border-radius: 999px;
      padding: 9px 12px;
      font-size: 12px;
      font-weight: 1000;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(0,0,0,.05);
    }
    .miniActions .sbtn:active{ transform: translateY(1px); }
    .miniActions .sbtn.primary{
      border-color: rgba(225,138,106,.30);
      background: linear-gradient(180deg, rgba(225,138,106,.18), rgba(255,255,255,.78));
    }
    .miniActions .sbtn.danger{
      border-color: rgba(208,100,99,.35);
      background: linear-gradient(180deg, rgba(208,100,99,.14), rgba(255,255,255,.78));
    }

    /* claim card */
    .claimCard{
      margin-top: 8px;
      border: 1px dashed rgba(0,0,0,.16);
      background: rgba(255,255,255,.60);
      border-radius: 14px;
      padding: 10px;
    }
    .claimHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 6px;
    }
    .claimTitle{
      font-size: 12px;
      font-weight: 1000;
      color: rgba(34,34,34,.78);
    }
    .claimAmt{
      font-size: 12px;
      font-weight: 1000;
      color: rgba(208,100,99,.92);
      white-space:nowrap;
    }
    .claimReason{
      font-size: 12px;
      font-weight: 800;
      color: rgba(34,34,34,.74);
      line-height: 1.45;
      white-space: pre-wrap;
    }
    .claimMeta{
      font-size: 11px;
      font-weight: 900;
      color: rgba(34,34,34,.50);
      margin-top: 6px;
    }

    @media (min-width: 720px){
      .modal{ align-items:center; }
    }
  
    /* =========================
       Bottom Drawer (Sale Detail)
       ========================= */
    .drawerBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
      z-index: 9998;
    }
    .drawer{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      max-height: 86vh;
      background: rgba(255,255,255,.92);
      border-top-left-radius: 22px;
      border-top-right-radius: 22px;
      box-shadow: 0 -18px 45px rgba(0,0,0,.18);
      transform: translateY(105%);
      transition: transform .22s ease;
      z-index: 9999;
      overflow: hidden;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .drawer.open{ transform: translateY(0); }
    .drawerBackdrop.open{
      opacity: 1;
      pointer-events: auto;
    }
    .drawerHeader{
      padding: 14px 14px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid rgba(0,0,0,.08);
    }
    .drawerTitle{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 0;
    }
    .drawerTitle .big{
      font-size: 18px;
      font-weight: 1000;
      line-height: 1.1;
    }
    .drawerTitle .sub{
      font-size: 12px;
      color: rgba(34,34,34,.70);
    }
    .drawerClose{
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.85);
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 800;
    }
    .drawerBody{
      padding: 12px 14px 18px;
      overflow:auto;
      max-height: calc(86vh - 62px);
    }
    .kv{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:8px 10px;
      padding: 10px 0;
      border-bottom: 1px dashed rgba(0,0,0,.10);
    }
    .k{ font-size: 12px; color: rgba(34,34,34,.70); }
    .v{ font-size: 13px; word-break: break-word; }
    .sectionTitle{
      margin: 12px 0 6px;
      font-weight: 1000;
    }
    .drawerTable{
      width: 100%;
      border-collapse: collapse;
      background: rgba(255,255,255,.6);
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 12px;
      overflow:hidden;
    }
    .drawerTable th, .drawerTable td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(0,0,0,.06);
      font-size: 13px;
    }
    .drawerTable th{
      font-size: 12px;
      color: rgba(34,34,34,.70);
      text-align:left;
      background: rgba(255,255,255,.75);
    }
    .drawerTable .right{ text-align:right; }


    
    /* edit drawer kv */
    .drawerLike{ max-width: 760px; padding:0; }
    .drawerLike .drawerBody{ padding: 12px 14px 18px; }
    .editKv{ border-bottom: none; padding: 6px 0; }
    .editKv .v{ position: relative; }
    .editWrap{
      position: relative;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.65);
      box-shadow: 0 10px 18px rgba(0,0,0,.04);
      cursor: pointer;
    }
    .editWrap.alwaysOn{ cursor: default; }
    .editWrap:active{ transform: translateY(1px); }
    .editWrap .disp{
      display:block;
      font-weight: 900;
      color: rgba(34,34,34,.90);
      white-space: pre-wrap;
      word-break: break-word;
      min-height: 18px;
    }
    .editInput{
      display:none;
      width:100%;
      border:1px solid rgba(0,0,0,.12);
      outline:none;
      background: rgba(255,255,255,.92);
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 900;
      color: rgba(34,34,34,.88);
    }
    .editWrap.editing .disp{ display:none; }
    .editWrap.editing .editInput{ display:block; }
    .editInput.always{ display:block; }
    .readonlyLine{
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px dashed rgba(0,0,0,.10);
      background: rgba(255,255,255,.45);
      font-size: 13px;
      font-weight: 900;
      color: rgba(34,34,34,.78);
    }
    .diffLine{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(34,34,34,.70);
      font-weight: 900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 12px;
      padding: 8px 10px;
    }
    .approveC{
      font-size: 12px;
      font-weight: 1000;
      display:inline-flex;
      gap:6px;
      align-items:center;
      white-space:nowrap;
    }
    .itemsBox{ margin-top: 6px; }
    .footKv{ padding-top: 10px; border-top: 1px dashed rgba(0,0,0,.10); }

/* approve (admin) */
    .approveBox{
      margin: 10px 0 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.62);
      box-shadow: 0 10px 18px rgba(0,0,0,.05);
    }
    .approveHead{
      font-weight: 900;
      font-size: 13px;
      margin-bottom: 6px;
    }
    .approveNote{
      font-size: 12px;
      color: rgba(34,34,34,.72);
      font-weight: 800;
      margin-bottom: 8px;
      line-height: 1.35;
    }
    .approveRow{
      display:grid;
      grid-template-columns: 120px 1fr 80px;
      gap:10px;
      align-items:center;
      padding: 8px 0;
      border-top: 1px dashed rgba(0,0,0,.10);
      font-size: 12px;
    }
    .approveRow:first-child{ border-top:0; }
    .approveL{ font-weight: 900; color: rgba(34,34,34,.82); }
    .approveR{ color: rgba(34,34,34,.76); font-weight: 800; word-break: break-word; }
    .approveC{ justify-self:end; font-weight: 900; color: rgba(34,34,34,.82); display:flex; gap:6px; align-items:center; }
    .approveEmpty{ font-size: 12px; font-weight: 800; color: rgba(34,34,34,.72); padding: 6px 0; }
    .fromTo{font-size:11px;font-weight:900;color:rgba(34,34,34,.55);margin-left:8px;}
    .okChk{
      margin-left: 10px;
      font-size: 11px;
      font-weight: 900;
      color: rgba(34,34,34,.76);
      display:inline-flex;
      gap:6px;
      align-items:center;
      user-select:none;
    }
    .okChk input{ transform: translateY(1px); }


    /* fix summary bar (outside card) */
    .fixSummaryBar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
      padding: 0 2px 12px;
      margin-top: -6px;
    }
    .fixSummaryBar .pill{
      cursor: default;
    }
    .fixSummaryBar .pill strong{
      font-weight: 1000;
    }

  

/* ===== iOS Safari: prevent input focus zoom (keep layout) ===== */
@media (max-width: 600px){
  input, select, textarea{
    font-size:16px !important;
  }
}
/* Date inputs in sheets/modals sometimes have own rules */
@media (max-width: 600px){
  input[type="date"], input[type="month"], input[type="datetime-local"]{
    font-size:16px !important;
  }
}

</style>
</head>

<body>
  <div class="wrap">
    <div class="app">

      <div class="topbar">
        <div class="brand">
          <div class="title">Â£≤‰∏äÁÆ°ÁêÜ</div>
          <div class="sub">sales „ÇíÊúàÂçò‰Ωç„ÅßÈõÜË®à„Åó„Å¶‰∏ÄË¶ßË°®Á§∫</div>
        </div>

        <div class="navBtns">
          <button class="btn" id="btnHome">üè† HOME</button>
          <button class="btn" id="btnOther">‚¨õ OTHER</button>
          <button class="btn primary" id="btnReload">‚Üª ÂÜçË™≠Ëæº</button>
          <button class="btn" id="btnCsv">üìÑ CSV</button>
        </div>
      </div>

      <!-- ‰øÆÊ≠£‰æùÈ†º„Çµ„Éû„É™„ÉºÔºàÊû†Â§ñË°®Á§∫Ôºâ -->
      <div class="fixSummaryBar" id="fixSummaryBar" style="display:none;">
        <div class="pill" id="fixSumPending">‰øÆÊ≠£‰æùÈ†ºÔºö‰æùÈ†º‰∏≠ - ‰ª∂</div>
        <div class="pill" id="fixSumDone">ÂÆå‰∫Ü - ‰ª∂</div>
        <div class="pill" id="sourceSum" style="display:none;">salesÔºöjson - ‰ª∂ / firebase - ‰ª∂</div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div class="h">„Éï„Ç£„É´„Çø</div>
          <div class="meta" id="authState">Á¢∫Ë™ç‰∏≠‚Ä¶</div>
        </div>

        <div class="cardBody">
          <div class="controls">
            <div class="leftControls">
              <div class="field">
                <label>Âπ¥</label>
                <select id="yearSel"></select>
              </div>
              <div class="field">
                <label>Êúà</label>
                <select id="monthSel">
                  <option value="all">„Åô„Åπ„Å¶</option>
                  <option value="1">1Êúà</option><option value="2">2Êúà</option><option value="3">3Êúà</option><option value="4">4Êúà</option>
                  <option value="5">5Êúà</option><option value="6">6Êúà</option><option value="7">7Êúà</option><option value="8">8Êúà</option>
                  <option value="9">9Êúà</option><option value="10">10Êúà</option><option value="11">11Êúà</option><option value="12">12Êúà</option>
                </select>
              </div>
              <div class="field">
                <label>Ê§úÁ¥¢</label>
                <input id="q" type="search" placeholder="Ë≥ºÂÖ•ËÄÖÂêç / „ÉÅ„É£„É≥„Éç„É´ / „É°„É¢„Å™„Å©" />
              </div>
            </div>
          </div>

          <div class="statRow" id="stats"></div>

          <div class="months" id="months"></div>

          <div class="smallNote" id="note">
            „Éªsale„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®ÊòéÁ¥∞„ÇíÈñã„Åç„Åæ„Åô„ÄÇÊòéÁ¥∞ÂÜÖ„ÅÆ„Äå‚úéÊâì„Å°ÈñìÈÅï„ÅÑ‰øÆÊ≠£„Äç„Åã„Çâ‰øÆÊ≠£„Åß„Åç„Åæ„Åô„ÄÇ<br>
            „Éª„Äå„ÇØ„É¨„Éº„É†ËøîÈáë„Äç„ÅØ„Äå„Éû„Ç§„Éä„Çπ„ÅÆ sales„Äç„ÇíÊñ∞Ë¶è‰ΩúÊàê„Åó„Åæ„ÅôÔºàÂÖÉ„ÅÆ sales „ÅØ‰øùÊåÅÔºâ„ÄÇ„ÄåÊâì„Å°ÈñìÈÅï„ÅÑ‰øÆÊ≠£„Äç„ÅØÁÆ°ÁêÜËÄÖ„Å∏‰øÆÊ≠£‰æùÈ†º„ÇíÈÄÅ„Çä„Åæ„ÅôÔºàsales„ÅØÂ§âÊõ¥„Åó„Åæ„Åõ„ÇìÔºâ„ÄÇ<br>
            „Éª„Éê„É≥„Éâ„É´Áî±Êù•„Éá„Éº„Çø„ÇÇÂê´„ÇÅ„ÄÅÊâì„Å°ÈñìÈÅï„ÅÑ‰øÆÊ≠£„ÅØ„Äå‰øÆÊ≠£‰æùÈ†º„Äç„ÇíÈÄÅ„Çä„Åæ„ÅôÔºàsales„ÅØÂ§âÊõ¥„Åó„Åæ„Åõ„ÇìÔºâ„ÄÇÊú¨‰øÆÊ≠£„ÅØÁÆ°ÁêÜËÄÖ„ÅÆ„Åø„Åß„Åô„ÄÇ
          </div>
        </div>
      </div>

      <div class="toast" id="toast"></div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import {
    getFirestore,
    collection, doc,
    query, where, orderBy, limit,
    getDocs, getDoc,
    addDoc, setDoc, updateDoc, deleteDoc,
    serverTimestamp, Timestamp
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  // ‚úÖ Êú¨Áï™ÔºàÊó¢Â≠ò„Éï„Ç°„Ç§„É´„Å®Âêå„ÅòÔºâ
  const firebaseConfig = {
    apiKey: "AIzaSyAhPCgPoJK6S6BWVcBZOruYqMPXVQXQFRk",
    authDomain: "handmade-pos.firebaseapp.com",
    projectId: "handmade-pos",
    storageBucket: "handmade-pos.firebasestorage.app",
    messagingSenderId: "174873514252",
    appId: "1:174873514252:web:c26659bffca850d475f929"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ---- UI refs
  const el = (id)=>document.getElementById(id);
  const monthsEl = el("months");
  const statsEl  = el("stats");
  const authStateEl = el("authState");
  const toastEl = el("toast");

  const fixSummaryBar = el("fixSummaryBar");
  const fixSumPendingEl = el("fixSumPending");
  const fixSumDoneEl = el("fixSumDone");

  const yearSel = el("yearSel");
  const monthSel = el("monthSel");
  const qEl = el("q");

  const btnHome = el("btnHome");
  const btnOther = el("btnOther");
  const btnReload = el("btnReload");
  const btnCsv = el("btnCsv");

  // ---- helpers
  const pad2 = (n)=> String(n).padStart(2,"0");
  const fmtYMDHM = (d)=> `${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  const fmtYMD = (d)=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const fmtMoney = (n)=> {
    const v = Number(n||0);
    return "¬•" + v.toLocaleString("ja-JP");
  };
  const yen = (n)=> fmtMoney(n);

  const ymKey = (d)=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("on");
    setTimeout(()=>toastEl.classList.remove("on"), 1400);
  }

  function safeStr(v){
    if(v===null || v===undefined) return "";
    return String(v);
  }

  function normalizeText(s){
    return safeStr(s).toLowerCase().replace(/\\s+/g," ").trim();
  }

  function saleToSearchText(sale){
    const parts = [];
    parts.push(sale.id);
    parts.push(sale.buyerName);
    parts.push(sale.channel);
    parts.push(sale.paymentMethod);
    parts.push(sale.memo);
    parts.push(sale.shippingOption);
    parts.push(sale.kind);
    parts.push(sale.parentSaleId);
    parts.push(sale.isRefund ? "refund" : "");
    if(Array.isArray(sale.items)){
      for(const it of sale.items){
        parts.push(it.name, it.productName, it.sku, it.code);
      }
    }
    return normalizeText(parts.filter(Boolean).join(" "));
  }

  function escapeHtml(str){
    return safeStr(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // --- Fix request helpers (staff workflow)
  const FIX_FIELD_ORDER = ["buyerName","orderDate","channel","paymentMethod","venue","kind","urgentOption","memo","items","total"];

  function jsonEq(a,b){
    try{ return JSON.stringify(a ?? null) === JSON.stringify(b ?? null); }catch(e){ return String(a)===String(b); }
  }
  function computeDiffKeys(snapshot, proposed){
    const diff = [];
    for(const k of FIX_FIELD_ORDER){
      if(!jsonEq(snapshot?.[k], proposed?.[k])) diff.push(k);
    }
    return diff;
  }
  function normalizeDone(diffKeys, doneKeys){
    const set = new Set(doneKeys || []);
    return diffKeys.filter(k => set.has(k));
  }
  function statusFrom(diffKeys, doneKeys){
    const done = new Set(doneKeys || []);
    return diffKeys.length > 0 && diffKeys.every(k => done.has(k)) ? "‰øÆÊ≠£Ê∏à„Åø" : "‰øÆÊ≠£‰∏≠";
  }
  function fieldLabel(key){
    const map = {
      buyerName:"Ë≥ºÂÖ•ËÄÖ", orderDate:"Ë≥ºÂÖ•Êó•‰ªò", channel:"Ë≤©Â£≤ÊñπÊ≥ï", paymentMethod:"Ê±∫Ê∏àÊñπÊ≥ï", venue:"ÈñãÂÇ¨Â†¥ÊâÄ",
      kind:"Ë≤©Â£≤Á®ÆÂà•", urgentOption:"„ÅäÊÄ•„Åé", memo:"„É°„É¢", items:"ÂïÜÂìÅÊòéÁ¥∞", total:"ÂêàË®à"
    };
    return map[key] || key;
  }

  function renderDiffRow(key, oldVal, newVal, checked){
    const oldTxt = escapeHtml(key==="items" ? (oldVal||[]).map(it=>`${it?.productName||it?.name||it?.product||"-"}√ó${it?.qty||it?.quantity||1} @${it?.price||it?.unitPrice||0}`).join(" / ") : String(oldVal??""));
    const newTxt = escapeHtml(key==="items" ? (newVal||[]).map(it=>`${it?.productName||it?.name||it?.product||"-"}√ó${it?.qty||it?.quantity||1} @${it?.price||it?.unitPrice||0}`).join(" / ") : String(newVal??""));
    return `
      <div class="diffrow" data-key="${escapeAttr(key)}" style="display:grid; grid-template-columns: 140px 1fr 110px; gap:10px; align-items:center; padding:10px 0; border-top:1px dashed rgba(0,0,0,.12);">
        <div style="font-weight:700;">${escapeHtml(fieldLabel(key))}</div>
        <div style="font-size:13px; line-height:1.35;">
          <div style="opacity:.75;">ÊóßÔºö${oldTxt}</div>
          <div style="margin-top:4px;">Êñ∞Ôºö${newTxt}</div>
        </div>
        <label style="display:flex; gap:8px; align-items:center; justify-content:flex-end; font-weight:700;">
          <input type="checkbox" class="doneChk" ${checked ? "checked":""} />
          <span>ÂÆå‰∫Ü</span>
        </label>
      </div>
    `;
  }


  // --- select helper (robust: string[] „Åß„ÇÇ {id,label}[] „Åß„ÇÇOK)
  function normalizeOptions(options){
    const out = [];
    for(const o of (options||[])){
      if(o == null) continue;
      if(typeof o === "string" || typeof o === "number"){
        const s = String(o);
        out.push({ id: s, label: s });
      }else if(typeof o === "object"){
        const id = String(o.id ?? o.value ?? o.key ?? o.label ?? o.name ?? "").trim();
        const label = String(o.label ?? o.name ?? o.id ?? "").trim();
        if(!id && !label) continue;
        out.push({ id: id || label, label: label || id });
      }
    }
    // id„Åß„É¶„Éã„Éº„ÇØÂåñ
    const map = {};
    out.forEach(x=>{ map[x.id] = x; });
    return Object.values(map);
  }

  function norm(s){ return String(s??"").trim().toLowerCase(); }

  function resolveId(options, current){
    const opts = normalizeOptions(options);
    const c = String(current??"").trim();
    if(!c) return "";
    if(opts.some(o=>o.id === c)) return c;
    const n = norm(c);
    const hit = opts.find(o=> norm(o.label) === n) || opts.find(o=> norm(o.id) === n);
    return hit ? hit.id : c;
  }

  // ‰∏äÊõ∏„ÅçÂÆöÁæ©ÔºöÂè§„ÅÑ sel „ÅåÊÆã„Å£„Å¶„ÅÑ„Å¶„ÇÇ„Åì„Çå„ÅåÊúÄÁµÇÁöÑ„Å´‰Ωø„Çè„Çå„Çã
  const sel = (id, options, current)=>{
    const opts = normalizeOptions(options);
    const curId = resolveId(opts, current);
    const htmlOpts = opts.map(o=>{
      const v = escapeAttr(o.id);
      const t = escapeHtml(o.label);
      const s = (o.id === curId) ? " selected" : "";
      return `<option value="${v}"${s}>${t}</option>`;
    }).join("");
    return `<select class="in sel" id="${id}">${htmlOpts}</select>`;
  };


  // ---- data cache
  let rawSales = [];                 // normalized
  let lastBuilt = null;              // { list, groups }
  let currentUser = null;

  function getUserEmail(){
    try{ return String(currentUser?.email || auth?.currentUser?.email || ""); }catch(e){ return ""; }
  }
  function getUserUid(){
    try{ return String(currentUser?.uid || auth?.currentUser?.uid || ""); }catch(e){ return ""; }
  }
  function isAdminClient(){
    const email = getUserEmail();
    const uid = getUserUid();
    return (email === "enue_staff03@management.com" || uid === "Zs33k2rRFJXEUPxMU09ILRBXOpk1");
  }


  // ---- admin
  const ADMIN_EMAILS = ["enue_staff03@management.com"]; // ÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÔºàÂøÖË¶Å„Å™„ÇâËøΩÂä†Ôºâ
  function isAdminEmail(email){
    const e = safeStr(email).toLowerCase();
    return ADMIN_EMAILS.map(x=>x.toLowerCase()).includes(e);
  }
  let isAdminUser = false;

  // ---- source counts
  let lastSourceCounts = { json: 0, firebase: 0 };

  // ---- ‰øÆÊ≠£‰æùÈ†ºÔºàsales_subÔºâ„Ç≠„É£„ÉÉ„Ç∑„É•
  // key: saleId, value: {status, diffKeys, doneKeys, snapshot, proposed, createdAt, updatedAt, createdByEmail}
  let fixReqBySaleId = new Map();
  let fixReqSummary = { pending: 0, done: 0 };

  // ---- option lists (JSON bundle „Åã„ÇâË™≠„ÇÄ)
  let optPaymentMethods = [];   // payments_bundle.json (label)
  let optChannels = [];         // channels_bundle.json (label)
  let optKinds = [];            // kinds_bundle.json (label)
  let optVenues = [];           // venues_bundle.json (label)
  let optUrgentOptions = [];    // urgent_options_bundle.json (label)

  let optShippingOptions = [];  // sales „Åã„ÇâËá™ÂãïÂèéÈõÜÔºàbundleÁÑ°„ÅóÔºâ
  let optProductNames = [];     // products_bundle.json (name)
  let productPriceByName = {};
  function __dup_norm(s){ return String(s??"").trim().toLowerCase(); }

  function activeEntries(arr){
    const out = [];
    for(const x of (arr||[])){
      if(!x || x.active === false) continue;
      const id = (x.id ?? x.value ?? x.key ?? x.label ?? x.name ?? "").toString().trim();
      const label = (x.label ?? x.name ?? x.id ?? "").toString().trim();
      if(!id && !label) continue;
      out.push({ id, label: label || id });
    }
    const map = {};
    out.forEach(o=>{ map[o.id] = o; });
    return Object.values(map).sort((a,b)=> a.label.localeCompare(b.label, "ja"));
  }

  function __dup_resolveId(options, current){
    const c = String(current??"").trim();
    if(!c) return "";
    if((options||[]).some(o=>o.id === c)) return c;
    const n = norm(c);
    const hit = (options||[]).find(o=> norm(o.label) == n) || (options||[]).find(o=> norm(o.id) == n);
    return hit ? hit.id : c;
  }



  function uniqSorted(arr){
    const set = new Set(arr.map(v=>safeStr(v).trim()).filter(Boolean));
    return [...set].sort((a,b)=>a.localeCompare(b,'ja'));
  }
  function buildOptionsHTML(list, current){
    const cur = safeStr(current).trim();
    const opts = [];
    // current „ÅåÂÄôË£ú„Å´ÁÑ°„ÅÑÂ†¥Âêà„ÇÇÂÖàÈ†≠„Å´Âá∫„Åô
    if(cur && !list.includes(cur)){
      opts.push(`<option value="${escapeHtml(cur)}" selected>${escapeHtml(cur)}</option>`);
    }
    for(const v of list){
      const __dup_sel = (v===cur) ? " selected" : "";
      opts.push(`<option value="${escapeHtml(v)}"${__dup_sel}>${escapeHtml(v)}</option>`);
    }
    // Ëá™Áî±ÂÖ•Âäõ
    opts.push(`<option value="__custom__">ÔºàËá™Áî±ÂÖ•ÂäõÔºâ</option>`);
    return opts.join("");
  }

  
  // ---- fix editor helpers (self-contained)
  function escapeAttr(s){ return escapeHtml(s); }
  function toLocalDateTimeInputValue(d){
    try{
      const dt = (d instanceof Date) ? d : new Date(d);
      if(isNaN(dt.getTime())) return "";
      return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}T${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`;
    }catch(e){ return ""; }
  }

  function fmtDateTime(ms){
    const d = new Date(Number(ms||0));
    if(isNaN(d.getTime())) return "-";
    return `${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }

  function fmtYMDDate(ms){
    const d = new Date(Number(ms||0));
    if(isNaN(d.getTime())) return "-";
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  function msAtLocalMidnight(ymd){
    // ymd: "YYYY-MM-DD"
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(ymd||""));
    if(!m) return 0;
    const d = new Date(Number(m[1]), Number(m[2])-1, Number(m[3]), 0,0,0,0);
    return d.getTime();
  }

  function wireTapEdit(root){
    // tap/click disp -> show input; blur/Enter -> back to disp
    const wraps = root.querySelectorAll?.(".editWrap") || [];
    wraps.forEach(w=>{
      const disp = w.querySelector(".disp");
      const input = w.querySelector(".editInput");
      if(!disp || !input) return;

      const syncDisp = ()=>{
        let val = "";
        if(input.tagName === "SELECT"){
          val = input.value === "__custom__" ? (w.querySelector(".customInput")?.value || "") : input.value;
        }else{
          val = input.value;
        }
        disp.textContent = (val && String(val).trim().length) ? String(val) : "-";
      };

      // init
      input.style.display = "none";
      const custom = w.querySelector(".customInput");
      if(custom) custom.style.display = "none";
      syncDisp();

      disp.style.cursor = "pointer";
      disp.addEventListener("click", ()=>{
        // show editor without clearing current value
        disp.style.display = "none";
        input.style.display = "";
        // if input is empty, carry over disp text (except "-")
        if((input.value == null || String(input.value).length === 0) && disp.textContent && disp.textContent !== "-"){
          input.value = disp.textContent;
        }
        if(input.tagName === "SELECT"){
          selectOrCustom(w, input);
          setTimeout(()=>input.focus(), 0);
        }else{
          input.focus();
          if(input.select) input.select();
        }
      });
const close = ()=>{
        input.style.display = "none";
        if(custom) custom.style.display = "none";
        disp.style.display = "";
        syncDisp();
      };

      input.addEventListener("change", ()=>{
        if(input.tagName === "SELECT") selectOrCustom(w, input);
        syncDisp();
        if(input.tagName === "SELECT") close();
      });
      // NOTE: SELECT„ÅØblur„ÅßÂç≥Èñâ„Åò„Çã„Å®ÈÅ∏Êäû„Åß„Åç„Å™„ÅÑÁ´ØÊú´„Åå„ÅÇ„Çã„Åü„ÇÅ„ÄÅblur„Åß„ÅØÈñâ„Åò„Å™„ÅÑ
      if(input.tagName !== "SELECT") input.addEventListener("blur", close);
      input.addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){ e.preventDefault(); close(); }
        if(e.key === "Escape"){ e.preventDefault(); close(); }
      });

      if(custom){
        custom.addEventListener("input", syncDisp);
        custom.addEventListener("blur", close);
        custom.addEventListener("keydown", (e)=>{
          if(e.key === "Enter"){ e.preventDefault(); close(); }
          if(e.key === "Escape"){ e.preventDefault(); close(); }
        });
      }
    });
  }

  function selectOrCustom(wrap, sel){
    const custom = wrap.querySelector(".customInput");
    if(!custom) return;
    if(sel.value === "__custom__"){
      custom.style.display = "";
      custom.focus();
    }else{
      custom.style.display = "none";
      custom.value = "";
    }
  }

  function getSelOrCustom(sel, custom){
    if(sel && sel.value === "__custom__"){
      return (custom?.value || "").trim();
    }
    return (sel?.value || "").trim();
  }

// ---- routing
  btnHome.addEventListener("click", ()=> location.href = "index.html");
  btnOther.addEventListener("click", ()=> location.href = "otherpage.html");
  btnReload.addEventListener("click", ()=> loadAll(true));
  btnCsv.addEventListener("click", ()=> exportCsv());

  yearSel.addEventListener("change", ()=> render());
  monthSel.addEventListener("change", ()=> render());
  qEl.addEventListener("input", ()=> render());

  function fillYearOptions(sales){
    const years = new Set(sales.map(s=> s.date.getFullYear()));
    const arr = [...years].sort((a,b)=>b-a);

    // fallback: ‰ªäÂπ¥„ÄúÈÅéÂéª3Âπ¥
    const nowY = new Date().getFullYear();
    if(arr.length===0){
      for(let y=nowY; y>=nowY-3; y--) arr.push(y);
    }else{
      if(!years.has(nowY)) arr.unshift(nowY);
    }

    yearSel.innerHTML = "";
    for(const y of arr){
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = `${y}Âπ¥`;
      yearSel.appendChild(opt);
    }
  }

  function normalizeSale(docSnap){
    const data = docSnap.data ? docSnap.data() : docSnap;

    const createdAt = data.createdAt;

    // --- Êó•‰ªòÊ±∫ÂÆöÔºàÂèóÊ≥®Êó•„Éô„Éº„ÇπÔºâ
// ÂÑ™ÂÖàÔºöorderDateMs ‚Üí orderDate ‚Üí createdAt
let date = null;

// ‚ë† orderDateMsÔºàÊúÄÂÑ™ÂÖàÔºâ
if (data.orderDateMs) {
  date = new Date(Number(data.orderDateMs));
}
// ‚ë° orderDateÔºàYYYY-MM-DDÔºâ
else if (data.orderDate) {
  date = new Date(data.orderDate);
}
// ‚ë¢ createdAtÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
else {

  try{
    if(createdAt?.toDate) date = createdAt.toDate();
    else if(typeof createdAt === "number") date = new Date(createdAt);
    else if(typeof createdAt === "string") date = new Date(createdAt);
  }catch(e){}
}

if(!date || isNaN(date.getTime())){
  date = new Date(0);
}

const items = Array.isArray(data.items) ? data.items.map(it=>({
      id: it.id ?? it.productId ?? it.sku ?? "",
      name: it.name ?? it.productName ?? "",
      qty: Number(it.qty ?? it.quantity ?? 0),
      unitPrice: Number(it.unitPrice ?? it.price ?? it.unit ?? 0),
      // ‰∫íÊèõÁî®ÔºàÂè§„ÅÑ„Ç≥„Éº„Éâ„Åå price „ÇíÂèÇÁÖß„Åó„Å¶„ÇÇÂãï„Åè„Çà„ÅÜÊÆã„ÅôÔºâ
      price: Number(it.unitPrice ?? it.price ?? it.unit ?? 0),
      subtotal: Number(
        it.subtotal ??
        (Number(it.unitPrice ?? it.price ?? it.unit ?? 0) * Number(it.qty ?? it.quantity ?? 0)) ??
        0
      ),
      raw: it
    })) : [];

    const total =
      Number(data.total ?? data.totalAmount ?? data.grandTotal ?? data.amount ?? 0) ||
      items.reduce((a,b)=> a + (Number(b.subtotal)||0), 0);

    // „Éê„É≥„Éâ„É´Áî±Êù•Âà§ÂÆöÔºàÂ≠òÂú®„Åô„Çã„Å™„ÇâÂ∞äÈáç„ÄÅÁÑ°„ÅÑÂ†¥Âêà„ÅØ kind/source „Åß„ÇÇÂà§ÂÆöÔºâ
    const isBundled = Boolean(
      data.isBundled ?? data.bundled ?? (safeStr(data.source).toLowerCase()==="bundle") ?? false
    ) || (safeStr(data.kind).toLowerCase()==="bundle");
    const parentSaleId = data.parentSaleId ?? data.originalSaleId ?? data.parentId ?? "";

    const isRefund = Boolean(data.isRefund ?? false) || (safeStr(data.channel).toLowerCase()==="refund") || (Number(data.total ?? data.totalAmount ?? data.grandTotal ?? data.amount ?? 0) < 0 && parentSaleId);

    const sale = {
      id: docSnap.id ?? data.id ?? "",
      date,
      total,
      items,

      // Ë°®Á§∫Áî®
      buyerName: data.buyerName ?? data.customerName ?? data.purchaserName ?? "",
      orderDate: data.orderDate ?? "",
      orderDateMs: Number(data.orderDateMs ?? 0) || 0,
      createdAtText: createdAt?.toDate ? createdAt.toDate().toLocaleString('ja-JP') : (typeof createdAt==='number' ? new Date(createdAt).toLocaleString('ja-JP') : (createdAt?.seconds ? new Date(createdAt.seconds*1000).toLocaleString('ja-JP') : "")),
      clientCreatedAt: Number(data.clientCreatedAt ?? 0) || 0,
      channel: data.channel ?? data.channelId ?? "",
      channelLabel: data.channelLabel ?? "",
      paymentId: data.paymentId ?? "",
      paymentLabel: data.paymentLabel ?? "",
      paymentMethod: data.paymentMethod ?? data.payment ?? data.paymentId ?? "",
      venue: data.venue ?? data.venueId ?? "",
      venueLabel: data.venueLabel ?? "",
      kindId: data.kindId ?? "",
      kindLabel: data.kindLabel ?? "",
      urgentOptionId: data.urgentOptionId ?? "",
      urgentOptionLabel: data.urgentOptionLabel ?? "",
      memo: data.memo ?? data.note ?? "",
      shippingOption: data.shippingOption ?? "",
      kind: data.kind ?? "",

      parentSaleId,
      isRefund,

      isBundled
    };
    sale._search = saleToSearchText(sale);
    sale._ym = ymKey(date);
    return sale;
  }

  
async function loadBundleSales(){
  /*
    ‚úÖ sales bundle loader (ÈöéÂ±§ÂØæÂøú„ÉªÂ∞ÜÊù•Êã°ÂºµOK)

    1) „Åæ„Åö„ÅØ„Äå‰∏ÄË¶ß„Éï„Ç°„Ç§„É´„Äç„Åå„ÅÇ„Çå„Å∞„Åù„Çå„Çí‰Ωø„ÅÜÔºà„Åä„Åô„Åô„ÇÅÔºâ
       - sales_data/index.json
         ‰æã: { "bundles": ["sales_data/2025/sales_bundle.json","sales_data/2026/jan/sales_bundle.json"] }

       ‚Äª 2027Âπ¥, 2028Âπ¥‚Ä¶„Å®Â¢ó„Åà„Å¶„ÇÇ„ÄÅ"index.json" „Å´„Éë„Çπ„ÇíËøΩË®ò„Åô„Çã„Å†„Åë„ÅßOKÔºà„Ç≥„Éº„ÉâÂ§âÊõ¥‰∏çË¶ÅÔºâ

    2) ÁÑ°„Åë„Çå„Å∞ÂæìÊù•„ÅÆÂçò‰∏Ä„Éï„Ç°„Ç§„É´ÂÄôË£ú„Å∏„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºàÂ£ä„Åï„Å™„ÅÑÔºâ
  */

  // ---- (A) index/manifestÊñπÂºèÔºö„Åì„Åì„Å†„ÅëÊõ¥Êñ∞„Åô„Çå„Å∞Âπ¥„ÅåÂ¢ó„Åà„Å¶„ÇÇËøΩÂæì„Åß„Åç„Çã ----
  const indexCandidates = [
    "./sales_data/index.json",
    "sales_data/index.json",
    "./sales_data/manifest.json",
    "sales_data/manifest.json"
  ];

  const indexObj = await (async()=>{
    for(const url of indexCandidates){
      try{
        const res = await fetch(url, { cache: "no-store" });
        if(!res.ok) continue;
        const js = await res.json();
        if(js && (Array.isArray(js.bundles) || Array.isArray(js.files))) return js;
      }catch(e){}
    }
    return null;
  })();

  // bundlesÔºàÊé®Â•®Ôºâ or filesÔºà‰∫íÊèõÔºâ„ÇíË®±ÂÆπ
  const bundlePaths = indexObj
    ? (Array.isArray(indexObj.bundles) ? indexObj.bundles
      : Array.isArray(indexObj.files) ? indexObj.files : [])
    : [];

  // 1Êú¨„Åß„ÇÇÊåáÂÆö„Åå„ÅÇ„Çå„Å∞„ÄÅ„Åù„Åì„Åã„ÇâÈõÜÁ¥Ñ„Åó„Å¶Ëøî„Åô
  if(bundlePaths.length){
    const list = [];
    let throughMs = 0;

    // ‰∏¶ÂàóÂèñ„Çä„Åô„ÅéÈò≤Ê≠¢ÔºàGitHub PagesÊÉ≥ÂÆöÔºâ
    const CONCURRENCY = 4;
    const queue = [...bundlePaths].filter(Boolean);

    async function worker(){
      while(queue.length){
        const path = queue.shift();
        try{
          const res = await fetch(path, { cache: "no-store" });
          if(!res.ok) continue;
          const json = await res.json();
          const arr = Array.isArray(json) ? json : (Array.isArray(json.sales) ? json.sales : []);
          if(!arr.length) continue;

          for(const d of arr){
            const id = safeStr(d?.id || d?.saleId || "").trim() || `bundle_${list.length}`;
            const data = { ...d, id, isBundled: true, source: "bundle" };
            const s = normalizeSale({ id, data: ()=>data });
            list.push(s);

            const t = Math.max(
              Number(deref(s, "clientCreatedAt")||0),
              Number(deref(s, "orderDateMs")||0),
              Number(s.date?.getTime ? s.date.getTime() : 0)
            );
            if(t > throughMs) throughMs = t;
          }
        }catch(e){
          // ignore and continue
        }
      }
    }

    const workers = [];
    for(let i=0;i<CONCURRENCY;i++) workers.push(worker());
    await Promise.all(workers);

    if(!list.length) return { list: [], throughMs: 0 };
    return { list, throughMs };
  }

  // ---- (B) ÂæìÊù•ÊñπÂºèÔºöÂçò‰∏Ä sales_bundle.json „ÇíË™≠„ÇÄÔºàÂæåÊñπ‰∫íÊèõÔºâ ----
  const candidates = [
    "./sales_bundle.json",
    "sales_bundle.json",
    "./bundle/sales_bundle.json",
    "bundle/sales_bundle.json"
  ];

  for(const url of candidates){
    try{
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) continue;
      const json = await res.json();
      const arr = Array.isArray(json) ? json : (Array.isArray(json.sales) ? json.sales : []);
      if(!arr.length) return { list: [], throughMs: 0 };

      const list = arr.map((d, idx)=>{
        const id = safeStr(d.id || d.saleId || "").trim() || `bundle_${idx}`;
        const data = { ...d, id, isBundled: true, source: "bundle" };
        return normalizeSale({ id, data: ()=>data });
      });

      let throughMs = 0;
      for(const s of list){
        const t = Math.max(
          Number(deref(s, "clientCreatedAt")||0),
          Number(deref(s, "orderDateMs")||0),
          Number(s.date?.getTime ? s.date.getTime() : 0)
        );
        if(t > throughMs) throughMs = t;
      }
      return { list, throughMs };
    }catch(e){
      // try next
    }
  }
  return { list: [], throughMs: 0 };
}

function deref(obj, key){
  try{ return obj?.[key]; }catch{ return undefined; }
}



async function loadProductsBundle(){
  // ‚úÖ ÂïÜÂìÅ„Éû„Çπ„ÇøÔºà„Éê„É≥„Éâ„É´Ôºâ„ÇíË™≠„ÇÄÔºöÊâì„Å°ÈñìÈÅï„ÅÑ‰øÆÊ≠£„ÅÆ„ÄåÂïÜÂìÅÂêç„Éà„Ç∞„É´„Äç„Å´‰ΩøÁî®
  const candidates = ["./bundle/products_bundle.json"];
  for(const url of candidates){
    try{
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) continue;
      const js = await res.json();
      const arr = Array.isArray(js?.products) ? js.products : [];
      const names = [];
      const map = {};
      for(const p of arr){
        if(p && p.active === false) continue;
        const name = safeStr(p?.name).trim();
        if(!name) continue;
        names.push(name);
        const price = Number(p?.price ?? 0);
        if(!isNaN(price)) map[name] = price;
      }
      optProductNames = uniqSorted(names);
      productPriceByName = map;
      return;
    }catch(e){
      // try next candidate
    }
  }
  // fallbackÔºàË™≠„ÇÅ„Å™„Åë„Çå„Å∞Á©∫„ÄÇsales items „Åã„ÇâÂæå„ÅßË£úÂÆå„Åó„Å¶„ÇÇOKÔºâ
  optProductNames = optProductNames && optProductNames.length ? optProductNames : [];
  productPriceByName = productPriceByName && Object.keys(productPriceByName).length ? productPriceByName : {};
}


async function loadSimpleBundle(candidates, pickFn){
  for(const url of candidates){
    try{
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) continue;
      const js = await res.json();
      const out = pickFn(js);
      if(Array.isArray(out)) return out;
    }catch(e){}
  }
  return [];
}

function __dup_activeEntries(arr, labelKey="label"){
  return uniqSorted((arr||[])
    .filter(x=> x && x.active !== false)
    .map(x=> safeStr(x[labelKey] ?? x.label ?? x.name ?? x.id).trim())
    .filter(Boolean)
  );
}

async function loadMastersBundles(){
  // channels
  const channels = await loadSimpleBundle(
    ["./bundle/channels_bundle.json"],
    (js)=> js?.channels
  );
  optChannels = activeEntries(channels);

  // payments
  const payments = await loadSimpleBundle(
    ["./bundle/payments_bundle.json"],
    (js)=> js?.payments
  );
  optPaymentMethods = activeEntries(payments);

  // kinds
  const kinds = await loadSimpleBundle(
    ["./bundle/kinds_bundle.json"],
    (js)=> js?.kinds
  );
  optKinds = activeEntries(kinds);

  // venues
  const venues = await loadSimpleBundle(
    ["./bundle/venues_bundle.json"],
    (js)=> js?.venues
  );
  optVenues = activeEntries(venues);

  // urgent options
  const urgent = await loadSimpleBundle(
    ["./bundle/urgent_options_bundle.json"],
    (js)=> js?.urgentOptions
  );
  optUrgentOptions = activeEntries(urgent);
}


async function loadSales(){
  // 1) „Éê„É≥„Éâ„É´(JSON)„ÇíÂÖà„Å´Ë™≠„ÇÄÔºàreadÁØÄÁ¥Ñ„ÅÆ‰∏ªÂΩπÔºâ
  const bundle = await loadBundleSales();
  const bundleList = bundle.list || [];
  const bundleThroughMs = Number(bundle.throughMs || 0);

  // 2) Firestore„ÅØ„Äå„Éê„É≥„Éâ„É´„Å´ÂÖ•„Å£„Å¶„ÅÑ„Å™„ÅÑÊñ∞Ë¶èÂàÜ„Å†„Åë„ÄçË™≠„ÇÄ
  //    createdAt „Åå Timestamp „Åß„ÇÇÊØîËºÉ„Åß„Åç„Çã„Çà„ÅÜ Timestamp.fromMillis „Çí‰Ωø„ÅÜ
  let fbList = [];
  try{
    const since = Timestamp.fromMillis(bundleThroughMs || 0);
    const q = query(
      collection(db, "sales"),
      where("createdAt", ">", since),
      orderBy("createdAt", "asc"),
      limit(5000)
    );
    const snap = await getDocs(q);
    snap.forEach(d=> fbList.push(normalizeSale(d)));
  }catch(e){
    // createdAt „ÅÆÂûã/„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÈÉΩÂêà„ÅßÂ§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØ„ÄÅ
    // „ÄåÊúÄÊñ∞„Å†„ÅëËñÑ„ÅèË™≠„ÇÄ„Äç„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºà„Éö„Éº„Ç∏„ÅåÊ≠ª„Å™„Å™„ÅÑ„Çà„ÅÜ„Å´Ôºâ
    try{
      const q2 = query(
        collection(db, "sales"),
        orderBy("createdAt", "desc"),
        limit(200)
      );
      const snap2 = await getDocs(q2);
      const tmp = [];
      snap2.forEach(d=> tmp.push(normalizeSale(d)));
      // bundle„Çà„ÇäÊñ∞„Åó„Åù„ÅÜ„Å™„ÇÇ„ÅÆ„Å†„ÅëÊÆã„ÅôÔºàÊØîËºÉ„ÅØdate„ÅßÔºâ
      fbList = tmp.filter(s=> (s.date?.getTime?.()||0) > bundleThroughMs);
    }catch(_e){
      fbList = [];
    }
  }

  // 3) „Éû„Éº„Ç∏ÔºàÂêå„Åò id „ÅØ Firestore „ÇíÂÑ™ÂÖàÔºâ
  const map = new Map();
  for(const s of bundleList){
    s._source = "json";
    map.set(s.id, s);
  }

  let firebaseOnlyCount = 0;
  for(const s of fbList){
    s._source = "firebase";
    if(!map.has(s.id)) firebaseOnlyCount += 1;
    map.set(s.id, s);
  }

  rawSales = [...map.values()];

  // 4) ‰ª∂Êï∞ÔºàÁÆ°ÁêÜËÄÖË°®Á§∫Áî®Ôºâ
  lastSourceCounts = { json: bundleList.length, firebase: firebaseOnlyCount };
  // option listsÔºöpayments/channels/kinds/venues/urgent „ÅØ bundle „Åã„ÇâË™≠„ÇÄÔºàsales „Åã„Çâ‰∏äÊõ∏„Åç„Åó„Å™„ÅÑÔºâ
fillYearOptions(rawSales);
  const latest = rawSales.reduce((a,b)=> (a && a.date>b.date) ? a : b, null);
  if(latest && latest.date?.getTime?.()>0){
    yearSel.value = String(latest.date.getFullYear());
  }

  renderSourceSummary();
}

function renderSourceSummary(){
  const sumEl = document.getElementById("sourceSum");
  if(!sumEl) return;

  if(!isAdminUser){
    sumEl.style.display = "none";
    return;
  }
  sumEl.style.display = "";
  sumEl.textContent = `salesÔºöjson ${lastSourceCounts.json.toLocaleString("ja-JP")} ‰ª∂ / firebase ${lastSourceCounts.firebase.toLocaleString("ja-JP")} ‰ª∂`;
}


async function loadFixRequests(){
  // sales_fix_patches „ÇíË™≠„ÅøËæº„Åø„ÄÅ(1) „Çµ„Éû„É™„ÉºË°®Á§∫ (2) saleId->patch„ÅÆMap „ÇíÊõ¥Êñ∞
  // status: "Áî≥Ë´ã‰∏≠" | "ÂÆå‰∫Ü"
  fixReqBySaleId = new Map();
  fixReqSummary = { pending: 0, done: 0 };

  try{
    const q = query(
      collection(db, "sales_fix_patches"),
      orderBy("updatedAt", "desc"),
      limit(2000)
    );
    const snap = await getDocs(q);

    snap.forEach(d=>{
      const data = d.data() || {};
      const saleId = String(data.saleId || d.id || "").trim();
      if(!saleId) return;

      const status = safeStr(data.status || "Áî≥Ë´ã‰∏≠").trim() || "Áî≥Ë´ã‰∏≠";
      if(status === "ÂÆå‰∫Ü") fixReqSummary.done += 1;
      else fixReqSummary.pending += 1;

      fixReqBySaleId.set(saleId, { id: d.id, ...data, saleId, status });
    });

    fixSumPendingEl.textContent = `‰øÆÊ≠£Áî≥Ë´ãÔºöÁî≥Ë´ã‰∏≠ ${fixReqSummary.pending.toLocaleString("ja-JP")} ‰ª∂`;
    fixSumDoneEl.textContent    = `ÂÆå‰∫Ü ${fixReqSummary.done.toLocaleString("ja-JP")} ‰ª∂`;
    fixSummaryBar.style.display = "flex";
  }catch(e){
    console.warn("loadFixRequests failed", e);
    fixSummaryBar.style.display = "none";
  }
}

  async function loadAll(force=false){

    authStateEl.textContent = "Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶";
    monthsEl.innerHTML = "";
    statsEl.innerHTML = "";

    try{
      await loadProductsBundle();
      await loadMastersBundles();
      await loadSales();
      await loadFixRequests();

      authStateEl.textContent = `OKÔºàsales: ${rawSales.length} ‰ª∂Ôºâ`;
      render();
    }catch(err){
      console.error(err);
      authStateEl.textContent = "Ë™≠„ÅøËæº„ÅøÂ§±Êïó";
      monthsEl.innerHTML = `<div class="empty">Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ<br><span class="muted">Firestore „É´„Éº„É´ / „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ / createdAt „ÅÆÂûã„ÇíÁ¢∫Ë™ç„Åó„Å¶„Å≠„ÄÇ</span></div>`;
      toast("Ë™≠„ÅøËæº„ÅøÂ§±Êïó");
    }
  }

  function buildGroups(filtered){
    const map = new Map();
    for(const s of filtered){
      const key = s._ym;
      if(!map.has(key)){
        map.set(key, { monthKey:key, total:0, count:0, sales:[] });
      }
      const g = map.get(key);
      g.total += Number(s.total||0);
      g.count += 1;
      g.sales.push(s);
    }
    for(const g of map.values()){
      g.sales.sort((a,b)=> b.date - a.date);
    }
    const arr = [...map.values()].sort((a,b)=> b.monthKey.localeCompare(a.monthKey));
    return arr;
  }

  function applyFilters(){
    const y = Number(yearSel.value);
    const m = monthSel.value === "all" ? null : Number(monthSel.value);
    const q = normalizeText(qEl.value);

    return rawSales.filter(s=>{
      if(s.date.getTime()<=0) return false;
      if(s.date.getFullYear() !== y) return false;
      if(m && (s.date.getMonth()+1)!==m) return false;
      if(q && !s._search.includes(q)) return false;
      return true;
    });
  }

  function renderStats(list){
    const total = list.reduce((a,b)=> a + Number(b.total||0), 0);
    const cnt = list.length;

    statsEl.innerHTML = "";
    const p1 = document.createElement("div");
    p1.className = "pill";
    p1.textContent = `ÂêàË®àÔºö${fmtMoney(total)}`;
    statsEl.appendChild(p1);

    const p2 = document.createElement("div");
    p2.className = "pill";
    p2.textContent = `‰ª∂Êï∞Ôºö${cnt.toLocaleString("ja-JP")} ‰ª∂`;
    statsEl.appendChild(p2);
  }

  function render(){
    if(!rawSales.length){
      monthsEl.innerHTML = `<div class="empty">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>`;
      return;
    }

    const list = applyFilters();
    renderStats(list);

    const groups = buildGroups(list);
    lastBuilt = { list, groups };

    monthsEl.innerHTML = "";
    if(groups.length===0){
      monthsEl.innerHTML = `<div class="empty">Ë©≤ÂΩì„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>`;
      return;
    }

    for(const g of groups){
      const [yy,mm] = g.monthKey.split("-");
      const monthLabel = `${yy}Âπ¥${Number(mm)}Êúà`;

      const det = document.createElement("details");
      det.className = "month";

      const sum = document.createElement("summary");

      const left = document.createElement("div");
      left.className = "mLeft";
      left.innerHTML = `<div class="mTitle">${monthLabel}</div><div class="mSub">„Çø„ÉÉ„Éó„ÅßÊòéÁ¥∞</div>`;

      const right = document.createElement("div");
      right.className = "mRight";
      right.innerHTML = `<div class="mTotal">${fmtMoney(g.total)}</div><div class="mCount">${g.count} ‰ª∂</div>`;

      sum.appendChild(left);
      sum.appendChild(right);
      det.appendChild(sum);

      const salesWrap = document.createElement("div");
      salesWrap.className = "sales";

      for(const s of g.sales){
        const card = document.createElement("div");
        card.className = "saleCard";
        card.addEventListener("click", ()=>{
          openSaleDrawer(s);
        });

        const sRow = document.createElement("div");
        sRow.className = "saleSum";

        const sLeft = document.createElement("div");
        sLeft.className = "saleLeft";

        const top = document.createElement("div");
        top.className = "saleTop";

        const d = document.createElement("div");
        d.className = "saleDate";
        d.textContent = (s.orderDate ? s.orderDate : fmtYMDHM(s.date));

        top.appendChild(d);

        // Ë≤©Â£≤ÊñπÊ≥ïÔºàchannelÔºâ
        if(s.channelLabel || s.channel){
          const b = document.createElement("span");
          b.className = "badge";
          b.textContent = (s.channelLabel || s.channel);
          top.appendChild(b);
        }

        if(s.isRefund){
          const b = document.createElement("span");
          b.className = "badge";
          b.textContent = "ËøîÈáë";
          top.appendChild(b);
        }

        // „Éê„É≥„Éâ„É´‰øÆÊ≠£ÂæÖ„Å°Ôºà„Éê„É≥„Éâ„É´Áî±Êù• „Åã„Å§ ‰øÆÊ≠£‰æùÈ†º„Åå„ÄåÁî≥Ë´ã‰∏≠„Äç„ÅÆ„ÇÇ„ÅÆ„Å†„ÅëË°®Á§∫Ôºâ
        const frBundle = fixReqBySaleId.get(s.id);
        if(s.isBundled && frBundle && safeStr(frBundle.status || "Áî≥Ë´ã‰∏≠") !== "ÂÆå‰∫Ü"){
          const b = document.createElement("span");
          b.className = "badge";
          b.textContent = "„Éê„É≥„Éâ„É´‰øÆÊ≠£ÂæÖ„Å°";
          top.appendChild(b);
        }

        // ‰øÆÊ≠£‰æùÈ†º„Çπ„ÉÜ„Éº„Çø„ÇπÔºàsales_subÔºâ
        const fr = fixReqBySaleId.get(s.id);
        if(fr){
          const b = document.createElement("span");
          b.className = "badge";
          b.textContent = (fr.status === "‰øÆÊ≠£Ê∏à„Åø") ? "‰øÆÊ≠£Ê∏à„Åø" : "‰øÆÊ≠£‰æùÈ†º";
          top.appendChild(b);
        }

        const bottom = document.createElement("div");
        bottom.className = "saleBottom";

        const bn = document.createElement("div");
        bn.className = "saleBuyer";
        bn.textContent = (s.buyerName ?? "");

        const t = document.createElement("div");
        t.className = "saleTotal";
        t.textContent = fmtMoney(s.total);

        bottom.appendChild(bn);
        bottom.appendChild(t);

        sLeft.appendChild(top);
        sLeft.appendChild(bottom);

        const sRight = document.createElement("div");
        sRight.className = "saleRight";

        const editBtn = document.createElement("button");
        editBtn.className = "editBtn";
        editBtn.type = "button";
        editBtn.textContent = "‚úé";
        editBtn.title = "Á∑®ÈõÜ";
        editBtn.addEventListener("click", (e)=>{
          e.preventDefault();
          e.stopPropagation();
          openFixEditor(s);
        });

        sRow.appendChild(sLeft);
        sRow.appendChild(sRight);
        card.appendChild(sRow);

        salesWrap.appendChild(card);
      }

      det.appendChild(salesWrap);
      monthsEl.appendChild(det);
    }
  }

  function exportCsv(){
    if(!lastBuilt || !lastBuilt.list){
      toast("„Éá„Éº„Çø„Å™„Åó");
      return;
    }

    const list = lastBuilt.list.slice().sort((a,b)=> b.date - a.date);

    const header = ["id","date","total","buyerName","channel","paymentMethod","kind","parentSaleId","isRefund","memo","itemName","qty","price","subtotal"];
    const lines = [header.join(",")];

    for(const s of list){
      const base = [
        csvCell(s.id),
        csvCell(fmtYMDHM(s.date)),
        csvCell(s.total),
        csvCell(s.buyerName),
        csvCell(s.channel),
        csvCell(s.paymentMethod),
        csvCell(s.kind),
        csvCell(s.parentSaleId),
        csvCell(s.isRefund ? "true" : ""),
        csvCell(s.memo)
      ];

      if(s.items?.length){
        for(const it of s.items){
          const row = base.concat([
            csvCell(it.name),
            csvCell(it.qty),
            csvCell(it.price),
            csvCell(it.subtotal)
          ]);
          lines.push(row.join(","));
        }
      }else{
        const row = base.concat([csvCell(""),csvCell(""),csvCell(""),csvCell("")]);
        lines.push(row.join(","));
      }
    }

    const blob = new Blob(["\\ufeff" + lines.join("\\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;

    const y = yearSel.value || "year";
    const m = monthSel.value === "all" ? "all" : pad2(monthSel.value);
    a.download = `monthly_sales_${y}_${m}.csv`;

    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    toast("CSVÂá∫„Åó„Åæ„Åó„Åü");
  }

  function csvCell(v){
    const s = safeStr(v);
    if(/[",\\n]/.test(s)){
      return '"' + s.replaceAll('"','""') + '"';
    }
    return s;
  }

  // ======================
  //  Á∑®ÈõÜ„Éï„É≠„Éº
  // ======================
  function closeModal(modal){
    if(modal && modal.remove) modal.remove();
  }

  // =========================
  // Bottom Drawer : Sale Detail
  // =========================
  let drawerEl = null;
  let drawerBackdropEl = null;
  let currentDrawerSale = null;

  function ensureDrawer(){
    if(drawerEl && drawerBackdropEl) return;

    drawerBackdropEl = document.createElement("div");
    drawerBackdropEl.className = "drawerBackdrop";
    drawerBackdropEl.addEventListener("click", ()=> closeSaleDrawer());

    drawerEl = document.createElement("div");
    drawerEl.className = "drawer";

    // delegated actions (fix/claim) - prevents lost listeners on re-render
    drawerEl.addEventListener("click", (e)=>{
      const fix = e.target.closest("#drawerFixBtn");
      if(fix){
        e.preventDefault(); e.stopPropagation();
        console.log("[ui] fix button clicked");
        try{ openFixEditor(currentDrawerSale); }catch(err){ console.error(err); toast("‰øÆÊ≠£ÁîªÈù¢„ÅÆË°®Á§∫„Å´Â§±Êïó"); }
        return;
      }
      const claim = e.target.closest("#drawerClaimBtn");
      if(claim){
        e.preventDefault(); e.stopPropagation();
        try{ openClaimRefund(currentDrawerSale); }catch(err){ console.error(err); toast("ËøîÈáëÁîªÈù¢„ÅÆË°®Á§∫„Å´Â§±Êïó"); }
        return;
      }
    });
    drawerEl.innerHTML = `
      <div class="drawerHeader">
        <div class="drawerTitle">
          <div class="big" id="drawerBig">ÊòéÁ¥∞</div>
          <div class="sub" id="drawerSub"></div>
</div>
        <button class="drawerClose" id="drawerCloseBtn" type="button">Èñâ„Åò„Çã</button>
      </div>
      <div class="drawerBody" id="drawerBody"></div>
    `;
    drawerEl.querySelector("#drawerCloseBtn").addEventListener("click", ()=> closeSaleDrawer());

    document.body.appendChild(drawerBackdropEl);
    document.body.appendChild(drawerEl);
  }

  function closeSaleDrawer(){
    if(!drawerEl) return;
    drawerEl.classList.remove("open");
    drawerBackdropEl.classList.remove("open");
    // iOS ËÉåÊôØ„Çπ„ÇØ„É≠„Éº„É´Âæ©Â∏∞
    document.documentElement.style.overflow = "";
    document.body.style.overflow = "";
  }

  function openSaleDrawer(sale){
    ensureDrawer();
    currentDrawerSale = sale;

    // ËÉåÊôØ„Çπ„ÇØ„É≠„Éº„É´ÊäëÊ≠¢
    document.documentElement.style.overflow = "hidden";
    document.body.style.overflow = "hidden";

    const dateText = sale.orderDate ? sale.orderDate : fmtYMDHM(sale.date);
    const big = `${fmtMoney(sale.total)}`;
    const sub = `${dateText}${(sale.buyerName? " / " + sale.buyerName : "")}`;

    drawerEl.querySelector("#drawerBig").textContent = big;
    drawerEl.querySelector("#drawerSub").textContent = sub;

    const body = drawerEl.querySelector("#drawerBody");

    const kv = (k,v)=>`<div class="k">${escapeHtml(k)}</div><div class="v">${escapeHtml(v ?? "")}</div>`;

    const channel = sale.channelLabel || sale.channel || "";
    const payment = sale.paymentLabel || sale.paymentMethod || sale.paymentId || "";
    const kind = sale.kindLabel || sale.kindId || "";
    const venue = sale.venueLabel || sale.venue || "";
    const urgent = sale.urgentOptionLabel || sale.urgentOptionId || "";
    const memo = sale.memo || "";

    let html = `
      <div class="kv">
        ${kv("Ë≥ºÂÖ•ËÄÖ", sale.buyerName ?? "")}
        ${kv("Ë≥ºÂÖ•Êó•‰ªò", dateText)}
                ${kv("Ë≤©Â£≤ÊñπÊ≥ï", channel)}
        ${kv("Ê±∫Ê∏àÊñπÊ≥ï", payment)}
        ${kv("ÈñãÂÇ¨Â†¥ÊâÄ", venue)}
        ${kv("Ë≤©Â£≤Á®ÆÂà•", kind)}
        ${urgent ? kv("Á∑äÊÄ•„Ç™„Éó„Ç∑„Éß„É≥", urgent) : ""}
        ${memo ? kv("„É°„É¢", memo) : ""}
                ${sale.parentSaleId ? kv("Ë¶™Sale", sale.parentSaleId) : ""}
        ${sale.isRefund ? kv("ËøîÈáë", "„ÅØ„ÅÑ") : ""}
        ${sale.isBundled ? kv("„Éê„É≥„Éâ„É´", "„ÅØ„ÅÑ") : ""}
      </div>
    `;

    // items
    const rows = Array.isArray(sale.items) ? sale.items : [];
    html += `<div class="sectionTitle">ÂïÜÂìÅÊòéÁ¥∞</div>`;
    if(!rows.length){
      html += `<div class="empty">ÊòéÁ¥∞ÔºàitemsÔºâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>`;
    }else{
      html += `
        <table class="drawerTable">
          <thead>
            <tr>
              <th>ÂïÜÂìÅ</th>
              <th class="right">Êï∞Èáè</th>
              <th class="right">Âçò‰æ°</th>
              <th class="right">Â∞èË®à</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(it=>`
              <tr>
                <td>${escapeHtml(it.name || it.id || "")}</td>
                <td class="right">${escapeHtml(String(it.qty ?? ""))}</td>
                <td class="right">${escapeHtml(fmtMoney((it.unitPrice ?? it.price ?? 0)))}</td>
                <td class="right">${escapeHtml(fmtMoney(it.subtotal ?? 0))}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    // system fields (Êäò„Çä„Åü„Åü„ÅøÊ∞óÂë≥)
    const createdAt = sale.createdAtText || "";

    if(createdAt){
      html += `<div class="sectionTitle">„Ç∑„Çπ„ÉÜ„É†</div>
        <div class="kv">
          ${createdAt ? kv("createdAt", createdAt) : ""}
        </div>
      `;
    }


    // fix request status
    const fr = fixReqBySaleId.get(sale.id);
    if(fr){
      const st = safeStr(fr.status || "‰æùÈ†º‰∏≠");
      html += `
        <div class="sectionTitle" style="margin-top:14px;">‰øÆÊ≠£‰æùÈ†º</div>
        <div class="claimCard">
          <div class="claimHead">
            <div class="claimTitle">„Çπ„ÉÜ„Éº„Çø„ÇπÔºö${escapeHtml(st)}</div>
            <div class="claimMeta">${escapeHtml(String(fr.createdByEmail||fr.createdBy||""))}</div>
          </div>
          <div class="claimReason">‚Äª„Åì„ÅÆÊòéÁ¥∞„ÅØ„Äå‰øÆÊ≠£‰æùÈ†º„Äç„ÅåÂá∫„Å¶„ÅÑ„Åæ„Åô„ÄÇÁÆ°ÁêÜËÄÖ„ÅØFirebaseÂÅ¥„Åßsales„Çí‰øÆÊ≠£Âæå„ÄÅÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÖ•„Çå„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>
        </div>
      `;
    }

    // actions (Ë©≥Á¥∞„Åã„ÇâÁõ¥Êé• ‰øÆÊ≠£/ËøîÈáë)
    if(sale && sale.id){
      html += `
        <div class="sectionTitle" style="margin-top:14px;">Êìç‰Ωú</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="modalBtn primary" id="drawerFixBtn" type="button"><span>‚úé Êâì„Å°ÈñìÈÅï„ÅÑ‰øÆÊ≠£</span></button>
          <button class="modalBtn danger" id="drawerClaimBtn" type="button"><span>„ÇØ„É¨„Éº„É†ËøîÈáëÂá¶ÁêÜ</span></button>
        </div>
      `;
    }

    body.innerHTML = html;

    // wire actions
    const fixBtn = drawerEl.querySelector('#drawerFixBtn');
    if (fixBtn) fixBtn.onclick = ()=> openEditChoiceModal(sale);
    const claimBtn = drawerEl.querySelector('#drawerClaimBtn');
    if (claimBtn) claimBtn.onclick = ()=> openClaimEditor(sale);

    drawerBackdropEl.classList.add('open');
    drawerEl.classList.add('open');
  }


  function openEditChoiceModal(sale){
    const modal = document.createElement("div");
    modal.className = "modal";
    modal.innerHTML = `
      <div class="modalCard" role="dialog" aria-modal="true">
        <div class="modalTitle">Á∑®ÈõÜÂÜÖÂÆπ„ÇíÈÅ∏Êäû</div>
        <div class="modalSub">„ÇØ„É¨„Éº„É†ËøîÈáëÔºö„Éû„Ç§„Éä„Çπ„ÅÆ sales „ÇíÊñ∞Ë¶è‰ΩúÊàê / Êâì„Å°ÈñìÈÅï„ÅÑ‰øÆÊ≠£ÔºöÁÆ°ÁêÜËÄÖ„Å∏‰øÆÊ≠£‰æùÈ†º„ÇíÈÄÅ‰ø°Ôºàsales„ÅØÂ§âÊõ¥„Åó„Åæ„Åõ„ÇìÔºâ</div>
        <div class="modalBtns">
          <button class="modalBtn danger" id="btnClaim">
            <span>„ÇØ„É¨„Éº„É†ËøîÈáëÂá¶ÁêÜ</span><span class="hint">ËøΩË®ò</span>
          </button>
          <button class="modalBtn primary" id="btnFix">
            <span>Êâì„Å°ÈñìÈÅï„ÅÑ‰øÆÊ≠£</span><span class="hint">‰æùÈ†º</span>
          </button>
          <button class="modalBtn" id="btnCancel">
            <span>„Ç≠„É£„É≥„Çª„É´</span><span class="hint">Èñâ„Åò„Çã</span>
          </button>
        </div>
      </div>
    `;
    modal.addEventListener("click", (e)=>{
      if(e.target === modal) closeModal(modal);
    });
    document.body.appendChild(modal);

    modal.querySelector("#btnCancel").onclick = ()=> closeModal(modal);

    // refund „ÅÆ sales „Å´„ÅØËøîÈáëÂá¶ÁêÜ„ÇíÈáç„Å≠„Å™„ÅÑÔºàÂøÖË¶Å„Å™„ÇâÊâì„Å°ÈñìÈÅï„ÅÑ‰øÆÊ≠£„ÅßÁ∑®ÈõÜÔºâ
    if(sale.isRefund){
      const bc = modal.querySelector("#btnClaim");
      bc.disabled = true;
      bc.style.opacity = "0.45";
      bc.style.pointerEvents = "none";
      bc.querySelector(".hint").textContent = "‰∏çÂèØ";
    }

    // „Éê„É≥„Éâ„É´Áî±Êù•Ôºö‰øÆÊ≠£‰æùÈ†º„Åå„ÄåÁî≥Ë´ã‰∏≠„Äç„ÅÆ„ÇÇ„ÅÆ„Å†„Åë„Äå„Éê„É≥„Éâ„É´‰øÆÊ≠£ÂæÖ„Å°„Äç„ÇíË°®Á§∫
    {
      const bf = modal.querySelector("#btnFix");
      const frBundle = fixReqBySaleId.get(sale.id);
      if(sale.isBundled && frBundle && safeStr(frBundle.status || "Áî≥Ë´ã‰∏≠") !== "ÂÆå‰∫Ü"){
        bf.querySelector(".hint").textContent = "„Éê„É≥„Éâ„É´‰øÆÊ≠£ÂæÖ„Å°";
      }else{
        bf.querySelector(".hint").textContent = "";
      }
    }

    modal.querySelector("#btnClaim").onclick = ()=>{
      closeModal(modal);
      openClaimEditor(sale);
    };

    modal.querySelector("#btnFix").onclick = ()=>{
      closeModal(modal);
      openFixEditor(sale);
    };
  }



async function openFixEditor(sale){
  // ÂΩπÂâ≤
  const admin = isAdminEmail(currentUser?.email);
  ensureDrawer();

  const saleId = String(sale?.id || "").trim();
  if(!saleId){ toast("saleId„Åå„ÅÇ„Çä„Åæ„Åõ„Çì"); return; }

  // bundleÁî±Êù•„Åã„Å©„ÅÜ„Åã
  const isBundled = Boolean(sale?.isBundled);

  // patch doc (docId = saleId)
  const patchRef = doc(db, "sales_fix_patches", saleId);
  let patchSnap = null;
  try{ patchSnap = await getDoc(patchRef); }catch(e){}
  const patch = (patchSnap && patchSnap.exists()) ? (patchSnap.data()||{}) : null;

  // ---- master maps
  const channelLabelById = Object.fromEntries((optChannels||[]).map(o=>[o.id,o.label]));
  const paymentLabelById = Object.fromEntries((optPaymentMethods||[]).map(o=>[o.id,o.label]));
  const kindLabelById    = Object.fromEntries((optKinds||[]).map(o=>[o.id,o.label]));
  const venueLabelById   = Object.fromEntries((optVenues||[]).map(o=>[o.id,o.label]));

  // products: name -> id
  let productIdByName = {};
  try{
    // products_bundle.json „ÅåË™≠„ÇÅ„Å¶„ÅÑ„Çå„Å∞ optProductNames „Å´ÂÖ•„Å£„Å¶„Çã„Åå„ÄÅid„ÅØÂà•ÈÄî‰Ωú„Çã
    // ÔºàbundleË™≠„ÅøËæº„ÅøÊôÇ„Å´ map „Åæ„Åß„ÅØÊåÅ„Å£„Å¶„ÅÑ„Å™„ÅÑ„ÅÆ„Åß„ÄÅ„Åì„Åì„Åß fetch „Åõ„Åö„Å´Á∞°ÊòìÊé®ÂÆöÔºâ
  }catch(e){}

  // ---- snapshotÔºàÊóßÔºâ
  const snapshot = {
    buyerName: sale?.buyerName ?? "",
    orderDate: sale?.orderDate ?? (sale?.date ? fmtYMD(sale.date) : ""),
    channelId: sale?.channelId ?? resolveId(optChannels, (sale?.channelLabel || sale?.channel || "")),
    paymentId: sale?.paymentId ?? resolveId(optPaymentMethods, (sale?.paymentLabel || sale?.paymentMethod || "")),
    venueId: sale?.venueId ?? resolveId(optVenues, (sale?.venueLabel || sale?.venue || "")),
    kindId: sale?.kindId ?? resolveId(optKinds, (sale?.kindLabel || sale?.kind || "")),
    items: Array.isArray(sale?.items) ? sale.items.map(it=>({
      name: it?.name ?? "",
      qty: Number(it?.qty ?? 0),
      unitPrice: Number(it?.unitPrice ?? it?.price ?? 0),
      subtotal: Number(it?.subtotal ?? (Number(it?.qty??0)*Number(it?.unitPrice ?? it?.price ?? 0))) || 0
    })) : []
  };

  // ---- proposedÔºàÊñ∞Ôºâ
  const proposed0 = patch?.proposed ? patch.proposed : snapshot;

  // ---- drawer header
  drawerEl.querySelector("#drawerBig").textContent = "Êâì„Å°ÈñìÈÅï„ÅÑ‰øÆÊ≠£";
  drawerEl.querySelector("#drawerSub").textContent = `${snapshot.orderDate}${snapshot.buyerName ? " / "+snapshot.buyerName : ""}`;

  const body = drawerEl.querySelector("#drawerBody");

  const kvRow = (label, html)=>`
    <div class="kv editKv">
      <div class="k">${escapeHtml(label)}</div>
      <div class="v">${html}</div>
    </div>
  `;

  const inp = (id, v, ph="")=>`<input class="editInput always" id="${id}" value="${escapeAttr(v??"")}" placeholder="${escapeAttr(ph)}" />`;

  const dateInp = (id, v)=>`<input class="editInput always" id="${id}" type="date" value="${escapeAttr(/^\d{4}-\d{2}-\d{2}$/.test(String(v||"")) ? v : "")}" />`;

  const selId = (id, options, currentId, placeholder="")=>{
    const opts = normalizeOptions(options);
    const cur = resolveId(opts, currentId);
    const htmlOpts = [
      `<option value="">${escapeHtml(placeholder||"ÈÅ∏Êäû")}</option>`,
      ...opts.map(o=>{
        const s = (o.id === cur) ? " selected" : "";
        return `<option value="${escapeAttr(o.id)}"${s}>${escapeHtml(o.label)}</option>`;
      })
    ].join("");
    return `<select class="in sel" id="${id}">${htmlOpts}</select>`;
  };

  // itemsÔºàÁ∑®ÈõÜÁî®Ôºâ
  let items = Array.isArray(proposed0?.items) ? proposed0.items.map(it=>({
    name: it?.name ?? "",
    qty: Number(it?.qty ?? 0),
    unitPrice: Number(it?.unitPrice ?? it?.price ?? 0),
    subtotal: Number(it?.subtotal ?? (Number(it?.qty??0)*Number(it?.unitPrice ?? it?.price ?? 0))) || 0
  })) : [];

  function recalc(){
    items.forEach(it=>{
      it.qty = Number(it.qty||0);
      it.unitPrice = Number(it.unitPrice||0);
      it.subtotal = Math.round(it.qty * it.unitPrice);
    });
    const total = items.reduce((a,it)=>a+Number(it.subtotal||0),0);
    const t = body.querySelector("#fx_total");
    if(t) t.textContent = fmtMoney(total);
    return total;
  }

  function renderItemsEditable(){
    const wrap = body.querySelector("#fx_items");
    if(!wrap) return;

    const list = (optProductNames && optProductNames.length) ? optProductNames : [];
    const buildOpts = (cur)=>{
      const c = safeStr(cur).trim();
      const opts = [];
      if(c && !list.includes(c)) opts.push(`<option value="${escapeAttr(c)}" selected>${escapeHtml(c)}</option>`);
      for(const n of list){
        opts.push(`<option value="${escapeAttr(n)}"${n===c?" selected":""}>${escapeHtml(n)}</option>`);
      }
      return opts.join("");
    };

    wrap.innerHTML = `
      <table class="drawerTable">
        <thead>
          <tr><th>ÂïÜÂìÅ</th><th class="right">Êï∞Èáè</th><th class="right">Âçò‰æ°</th><th class="right">Â∞èË®à</th></tr>
        </thead>
        <tbody>
          ${items.map((it,i)=>`
            <tr>
              <td><select class="cellSel" data-i="${i}">${buildOpts(it.name)}</select></td>
              <td class="right"><input class="cellIn right" data-i="${i}" data-f="qty" type="number" inputmode="numeric" value="${escapeAttr(it.qty)}" /></td>
              <td class="right"><input class="cellIn right" data-i="${i}" data-f="unitPrice" type="number" inputmode="numeric" value="${escapeAttr(it.unitPrice)}" /></td>
              <td class="right">${escapeHtml(fmtMoney(it.subtotal))}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
      <div class="miniActions">
        <button class="sbtn" id="fx_addItem" type="button">Ôºã Ë°å„ÇíËøΩÂä†</button>
        <button class="sbtn danger" id="fx_delItem" type="button">Ôºç ÊúÄÁµÇË°å„ÇíÂâäÈô§</button>
      </div>
    `;

    wrap.querySelectorAll(".cellIn").forEach(el2=>{
      el2.addEventListener("input", ()=>{
        const i = Number(el2.getAttribute("data-i"));
        const f = el2.getAttribute("data-f");
        if(!items[i]) return;
        items[i][f] = Number(el2.value||0);
        recalc();
        renderItemsEditable();
      });
    });
    wrap.querySelectorAll(".cellSel").forEach(sel2=>{
      sel2.addEventListener("change", ()=>{
        const i = Number(sel2.getAttribute("data-i"));
        if(!items[i]) return;
        const name = sel2.value;
        items[i].name = name;
        const mp = Number(productPriceByName?.[name] ?? 0);
        if((!items[i].unitPrice || items[i].unitPrice===0) && mp>0) items[i].unitPrice = mp;
        recalc();
        renderItemsEditable();
      });
    });

    const addBtn = wrap.querySelector("#fx_addItem");
    const delBtn = wrap.querySelector("#fx_delItem");
    addBtn.onclick = ()=>{
      items.push({ name: (optProductNames?.[0]||""), qty: 1, unitPrice: 0, subtotal: 0 });
      recalc();
      renderItemsEditable();
    };
    delBtn.onclick = ()=>{
      if(items.length<=0) return;
      items.pop();
      recalc();
      renderItemsEditable();
    };

    recalc();
  }

  function renderItemsReadonly(rows){
    const wrap = body.querySelector("#fx_items");
    if(!wrap) return;
    const arr = Array.isArray(rows) ? rows : [];
    if(!arr.length){
      wrap.innerHTML = `<div class="empty">ÊòéÁ¥∞ÔºàitemsÔºâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>`;
      return;
    }
    wrap.innerHTML = `
      <table class="drawerTable">
        <thead>
          <tr><th>ÂïÜÂìÅ</th><th class="right">Êï∞Èáè</th><th class="right">Âçò‰æ°</th><th class="right">Â∞èË®à</th></tr>
        </thead>
        <tbody>
          ${arr.map(it=>`
            <tr>
              <td>${escapeHtml(it?.name || "")}</td>
              <td class="right">${escapeHtml(String(it?.qty ?? ""))}</td>
              <td class="right">${escapeHtml(String(it?.unitPrice ?? it?.price ?? ""))}</td>
              <td class="right">${escapeHtml(fmtMoney(it?.subtotal ?? (Number(it?.qty||0)*Number(it?.unitPrice ?? it?.price ?? 0))))}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  function diffLine(label, oldV, newV, statusText){
    const o = escapeHtml(String(oldV ?? ""));
    const n = escapeHtml(String(newV ?? ""));
    const st = escapeHtml(statusText || "");
    return `
      <div class="diffLine">
        <div>${escapeHtml(label)}<span class="fromTo"> ${o} ‚Üí ${n}</span></div>
        <div style="font-weight:1000;">${st}</div>
      </div>
    `;
  }

  function buildDiffHtml(snap, prop){
    const chOld = channelLabelById[snap.channelId] || snap.channelId || "";
    const chNew = channelLabelById[prop.channelId] || prop.channelId || "";
    const pmOld = paymentLabelById[snap.paymentId] || snap.paymentId || "";
    const pmNew = paymentLabelById[prop.paymentId] || prop.paymentId || "";
    const vnOld = venueLabelById[snap.venueId] || snap.venueId || "";
    const vnNew = venueLabelById[prop.venueId] || prop.venueId || "";
    const kdOld = kindLabelById[snap.kindId] || snap.kindId || "";
    const kdNew = kindLabelById[prop.kindId] || prop.kindId || "";

    const lines = [];
    if(!jsonEq(snap.buyerName, prop.buyerName)) lines.push(diffLine("Ë≥ºÂÖ•ËÄÖ", snap.buyerName, prop.buyerName, admin ? "‚òëÂÆå‰∫Ü" : "Áî≥Ë´ã‰∏≠"));
    if(!jsonEq(snap.orderDate, prop.orderDate)) lines.push(diffLine("Ë≥ºÂÖ•Êó•‰ªò", snap.orderDate, prop.orderDate, admin ? "‚òëÂÆå‰∫Ü" : "Áî≥Ë´ã‰∏≠"));
    if(!jsonEq(snap.channelId, prop.channelId)) lines.push(diffLine("Ë≤©Â£≤ÊñπÊ≥ï", chOld, chNew, admin ? "‚òëÂÆå‰∫Ü" : "Áî≥Ë´ã‰∏≠"));
    if(!jsonEq(snap.paymentId, prop.paymentId)) lines.push(diffLine("Ê±∫Ê∏àÊñπÊ≥ï", pmOld, pmNew, admin ? "‚òëÂÆå‰∫Ü" : "Áî≥Ë´ã‰∏≠"));
    if(!jsonEq(snap.venueId, prop.venueId)) lines.push(diffLine("ÈñãÂÇ¨Â†¥ÊâÄ", vnOld, vnNew, admin ? "‚òëÂÆå‰∫Ü" : "Áî≥Ë´ã‰∏≠"));
    if(!jsonEq(snap.kindId, prop.kindId)) lines.push(diffLine("Ë≤©Â£≤Á®ÆÂà•", kdOld, kdNew, admin ? "‚òëÂÆå‰∫Ü" : "Áî≥Ë´ã‰∏≠"));
    // items / total „ÅØ„Åæ„Å®„ÇÅ„Å¶1Ë°å
    if(!jsonEq(snap.items, prop.items)){
      lines.push(diffLine("ÂïÜÂìÅÊòéÁ¥∞", "ÔºàÊóßÔºâ", "ÔºàÊñ∞Ôºâ", admin ? "‚òëÂÆå‰∫Ü" : "Áî≥Ë´ã‰∏≠"));
    }
    return lines.length ? lines.join("") : `<div class="empty">Â∑ÆÂàÜ„Å™„Åó</div>`;
  }

  // =========================
  // staff view
  // =========================
  if(!admin){
    const status = safeStr(patch?.status || "Áî≥Ë´ã‰∏≠");
    const hasPatch = !!patch;

    body.innerHTML = `
      <div class="sectionTitle">Êâì„Å°ÈñìÈÅï„ÅÑ‰øÆÊ≠£Ôºà„Çπ„Çø„ÉÉ„ÉïÔºâ</div>
      <div class="muted" style="margin-bottom:10px;">
        ‰øùÂ≠ò„Åô„Çã„Å® <b>Â∑ÆÂàÜsalesÔºàpatchÔºâ</b> „Çí‰ΩúÊàê„Åó„Åæ„Åô„ÄÇË°®Á§∫„ÅØ„ÄåÊóß‚ÜíÊñ∞„ÄÄÁî≥Ë´ã‰∏≠„Äç„Å´„Å™„Çä„Åæ„Åô„ÄÇ
      </div>

      ${kvRow("Ë≥ºÂÖ•ËÄÖ", inp("fx_buyer", proposed0?.buyerName ?? snapshot.buyerName, "‰æãÔºöÂ±±Áî∞ Â§™ÈÉé"))}
      ${kvRow("Ë≥ºÂÖ•Êó•‰ªò", dateInp("fx_date", proposed0?.orderDate ?? snapshot.orderDate))}
      ${kvRow("Ë≤©Â£≤ÊñπÊ≥ï", selId("fx_channel", optChannels, proposed0?.channelId ?? snapshot.channelId, "ÈÅ∏Êäû"))}
      ${kvRow("Ê±∫Ê∏àÊñπÊ≥ï", selId("fx_payment", optPaymentMethods, proposed0?.paymentId ?? snapshot.paymentId, "ÈÅ∏Êäû"))}
      ${kvRow("ÈñãÂÇ¨Â†¥ÊâÄÔºà„Éû„É´„Ç∑„Çß„ÅÆ„ÅøÔºâ", selId("fx_venue", optVenues, proposed0?.venueId ?? snapshot.venueId, "ÈÅ∏Êäû"))}
      ${kvRow("Ë≤©Â£≤Á®ÆÂà•", selId("fx_kind", optKinds, proposed0?.kindId ?? snapshot.kindId, "ÈÅ∏Êäû"))}

      <div class="sectionTitle" style="margin-top:14px;">ÂïÜÂìÅÊòéÁ¥∞</div>
      <div id="fx_items"></div>

      <div class="sectionTitle" style="margin-top:14px;">ÂêàË®à</div>
      <div class="kv"><div class="k">ÂêàË®à</div><div class="v"><b id="fx_total">${fmtMoney(0)}</b></div></div>

      <div class="sectionTitle" style="margin-top:14px;">Â∑ÆÂàÜ</div>
      <div id="fx_diff">${hasPatch ? buildDiffHtml(snapshot, proposed0) : `<div class="empty">‰øùÂ≠ò„Åô„Çã„Å®Â∑ÆÂàÜ„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</div>`}</div>

      <div style="display:flex; gap:10px; margin-top:14px;">
        <button class="modalBtn" id="fx_back" type="button"><span>Êàª„Çã</span></button>
        <button class="modalBtn primary" id="fx_save" type="button"><span>‰øùÂ≠òÔºà‰øÆÊ≠£Áî≥Ë´ãÔºâ</span></button>
      </div>

      <div class="smallNote">‚ÄªÁÆ°ÁêÜËÄÖ„Åå Firebase „Åß sales „ÇíÁõ¥Êé•‰øÆÊ≠£„Åó„Åæ„Åô„ÄÇÁÆ°ÁêÜËÄÖ„Åå„ÄåÂÆå‰∫Ü„Äç„Åß‰øùÂ≠ò„Åô„Çã„Å®ÂèçÊò†„Åï„Çå„Åæ„Åô„ÄÇ</div>
    `;

    // venue enable only if channel is marche
    const chSel = body.querySelector("#fx_channel");
    const vnSel = body.querySelector("#fx_venue");
    function applyVenueEnable(){
      const ch = chSel?.value || "";
      const enable = (ch === "marche"); // channels_bundle.json „ÅÆ id
      if(!vnSel) return;
      vnSel.disabled = !enable;
      vnSel.style.opacity = enable ? "1" : "0.45";
      if(!enable) vnSel.value = "";
    }
    if(chSel) chSel.addEventListener("change", ()=>{
      applyVenueEnable();
      // diff redraw
      const diffEl = body.querySelector("#fx_diff");
      if(diffEl) diffEl.innerHTML = buildDiffHtml(snapshot, collectProposedFromUI());
    });

    ["fx_buyer","fx_date","fx_payment","fx_kind","fx_venue"].forEach(id=>{
      const node = body.querySelector("#"+id);
      if(node) node.addEventListener("change", ()=>{
        const diffEl = body.querySelector("#fx_diff");
        if(diffEl) diffEl.innerHTML = buildDiffHtml(snapshot, collectProposedFromUI());
      });
      if(node && node.tagName==="INPUT") node.addEventListener("input", ()=>{
        const diffEl = body.querySelector("#fx_diff");
        if(diffEl) diffEl.innerHTML = buildDiffHtml(snapshot, collectProposedFromUI());
      });
    });

    function collectProposedFromUI(){
      const buyerName = body.querySelector("#fx_buyer")?.value?.trim() || "";
      const orderDate = body.querySelector("#fx_date")?.value?.trim() || "";
      const channelId = body.querySelector("#fx_channel")?.value || "";
      const paymentId = body.querySelector("#fx_payment")?.value || "";
      const venueId   = body.querySelector("#fx_venue")?.value || "";
      const kindId    = body.querySelector("#fx_kind")?.value || "";
      return { buyerName, orderDate, channelId, paymentId, venueId, kindId, items };
    }

    body.querySelector("#fx_back").onclick = ()=> openSaleDrawer(sale);

    // render items
    renderItemsEditable();
    // initial calc + venue enable + diff
    recalc();
    applyVenueEnable();
    const diffEl0 = body.querySelector("#fx_diff");
    if(diffEl0 && hasPatch) diffEl0.innerHTML = buildDiffHtml(snapshot, proposed0);

    body.querySelector("#fx_save").onclick = async ()=>{
      const proposed = collectProposedFromUI();
      const diffKeys = [];
      if(!jsonEq(snapshot.buyerName, proposed.buyerName)) diffKeys.push("buyerName");
      if(!jsonEq(snapshot.orderDate, proposed.orderDate)) diffKeys.push("orderDate");
      if(!jsonEq(snapshot.channelId, proposed.channelId)) diffKeys.push("channelId");
      if(!jsonEq(snapshot.paymentId, proposed.paymentId)) diffKeys.push("paymentId");
      if(!jsonEq(snapshot.venueId, proposed.venueId)) diffKeys.push("venueId");
      if(!jsonEq(snapshot.kindId, proposed.kindId)) diffKeys.push("kindId");
      if(!jsonEq(snapshot.items, proposed.items)) diffKeys.push("items");

      if(diffKeys.length === 0){
        toast("Â§âÊõ¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì");
        return;
      }

      const payload = {
        saleId,
        status: "Áî≥Ë´ã‰∏≠",
        diffKeys,
        snapshot,
        proposed: {
          ...proposed,
          total: recalc()
        },
        createdAt: (patch?.createdAt || serverTimestamp()),
        updatedAt: serverTimestamp(),
        createdByUid: (auth?.currentUser?.uid || ""),
        createdByEmail: (auth?.currentUser?.email || "")
      };

      try{
        await setDoc(patchRef, payload, { merge: true });
        toast("‰øÆÊ≠£Áî≥Ë´ã„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü");
        await loadFixRequests();
        // diffÂèçÊò†
        const diffEl = body.querySelector("#fx_diff");
        if(diffEl) diffEl.innerHTML = buildDiffHtml(snapshot, payload.proposed);
      }catch(err){
        console.error(err);
        toast(`‰øùÂ≠òÂ§±ÊïóÔºà${err?.code||"error"}Ôºâ`);
      }
    };

    return;
  }

  // =========================
  // admin view
  // =========================
  if(!patch){
    body.innerHTML = `
      <div class="sectionTitle">Êâì„Å°ÈñìÈÅï„ÅÑ‰øÆÊ≠£ÔºàÁÆ°ÁêÜËÄÖÔºâ</div>
      <div class="empty">„Åì„ÅÆÊòéÁ¥∞„Å´„ÅØ‰øÆÊ≠£Áî≥Ë´ã„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>
      <div style="display:flex; gap:10px; margin-top:14px;">
        <button class="modalBtn" id="fx_back" type="button"><span>Êàª„Çã</span></button>
      </div>
    `;
    body.querySelector("#fx_back").onclick = ()=> openSaleDrawer(sale);
    return;
  }

  const status = safeStr(patch.status || "Áî≥Ë´ã‰∏≠");

  body.innerHTML = `
    <div class="sectionTitle">Êâì„Å°ÈñìÈÅï„ÅÑ‰øÆÊ≠£ÔºàÁÆ°ÁêÜËÄÖÔºâ</div>
    <div class="muted" style="margin-bottom:10px;">
      ‚òëÂÆå‰∫Ü„Åß‰øùÂ≠ò„Åô„Çã„Å®„ÄÅ<b>ÂÖÉ„ÅÆsales„ÇíÊñ∞„Åß‰∏äÊõ∏„Åç</b>„Åó„Åæ„Åô„ÄÇ
      ${isBundled ? `<br><b style="color:rgba(208,100,99,.92);">‚Äª„Éê„É≥„Éâ„É´Áî±Êù•„Åß„Åô„ÄÇÁõ¥Êé•‰øÆÊ≠£„Åè„Å†„Åï„ÅÑ</b>` : ""}
    </div>

    <div class="approveBox">
      <div class="approveHead">Êóß ‚Üí Êñ∞„ÄÄ‚òëÂÆå‰∫Ü</div>
      <div id="fx_diff">${buildDiffHtml(snapshot, patch.proposed || proposed0)}</div>
      <div style="margin-top:10px; display:flex; justify-content:flex-end;">
        <label class="okChk"><input type="checkbox" id="fx_done" /> ÂÆå‰∫Ü</label>
      </div>
      <div style="padding-top:10px; text-align:right; font-weight:900;">„Çπ„ÉÜ„Éº„Çø„ÇπÔºö<span id="fx_status">${escapeHtml(status)}</span></div>
    </div>

    <div class="sectionTitle" style="margin-top:14px;">ÂïÜÂìÅÊòéÁ¥∞ÔºàÊñ∞Ôºâ</div>
    <div id="fx_items"></div>

    <div class="sectionTitle" style="margin-top:14px;">ÂêàË®àÔºàÊñ∞Ôºâ</div>
    <div class="kv"><div class="k">ÂêàË®à</div><div class="v"><b id="fx_total">${fmtMoney(patch?.proposed?.total ?? 0)}</b></div></div>

    <div style="display:flex; gap:10px; margin-top:14px;">
      <button class="modalBtn" id="fx_back" type="button"><span>Êàª„Çã</span></button>
      <button class="modalBtn primary" id="fx_apply" type="button" disabled style="opacity:.45;"><span>‰øùÂ≠òÔºà‰∏äÊõ∏„ÅçÔºâ</span></button>
    </div>
  `;

  // render items readonly (proposed)
  renderItemsReadonly(patch?.proposed?.items || proposed0?.items || []);
  // total
  const tEl = body.querySelector("#fx_total");
  if(tEl) tEl.textContent = fmtMoney(patch?.proposed?.total ?? recalc());

  body.querySelector("#fx_back").onclick = ()=> openSaleDrawer(sale);

  const doneChk = body.querySelector("#fx_done");
  const applyBtn = body.querySelector("#fx_apply");
  doneChk.addEventListener("change", ()=>{
    const ok = doneChk.checked;
    applyBtn.disabled = !ok;
    applyBtn.style.opacity = ok ? "1" : "0.45";
  });

  applyBtn.onclick = async ()=>{
    if(isBundled){
      toast("„Éê„É≥„Éâ„É´Áî±Êù•„Åß„Åô„ÄÇÁõ¥Êé•‰øÆÊ≠£„Åè„Å†„Åï„ÅÑ");
      return;
    }
    if(!doneChk.checked){
      toast("ÂÆå‰∫Ü„Å´„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
      return;
    }

    const prop = patch.proposed || proposed0;
    const channelId = String(prop.channelId||"").trim();
    const paymentId = String(prop.paymentId||"").trim();
    const venueId   = String(prop.venueId||"").trim();
    const kindId    = String(prop.kindId||"").trim();

    const channelLabel = channelLabelById[channelId] || "";
    const paymentLabel = paymentLabelById[paymentId] || "";
    const venueLabel   = venueLabelById[venueId] || "";
    const kindLabel    = kindLabelById[kindId] || "";

    // sales„ÅÆ‰∏äÊõ∏„ÅçÔºàÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøË®±ÂèØ„Åï„Çå„ÇãÊÉ≥ÂÆöÔºâ
    const salesRef = doc(db, "sales", saleId);

    const itemsOut = (Array.isArray(prop.items) ? prop.items : []).map(it=>{
      const qty = Number(it.qty||0);
      const unitPrice = Number(it.unitPrice ?? it.price ?? 0);
      return {
        name: String(it.name||"").trim(),
        qty,
        unitPrice,
        price: unitPrice, // ‰∫íÊèõ
        subtotal: Math.round(qty * unitPrice)
      };
    });
    const totalOut = itemsOut.reduce((a,it)=>a+Number(it.subtotal||0),0);

    const patchUpdate = {
      buyerName: String(prop.buyerName||"").trim(),
      orderDate: String(prop.orderDate||"").trim(),
      orderDateMs: msAtLocalMidnight(String(prop.orderDate||"").trim()),
      channelId, channelLabel,
      channel: channelLabel || channelId, // ‰∫íÊèõ
      paymentId, paymentLabel,
      paymentMethod: paymentLabel || paymentId, // ‰∫íÊèõ
      venueId, venueLabel,
      venue: venueLabel || venueId, // ‰∫íÊèõ
      kindId, kindLabel,
      kind: kindId || kindLabel || "", // ‰∫íÊèõ
      items: itemsOut,
      total: totalOut,
      updatedAt: serverTimestamp()
    };

    try{
      await updateDoc(salesRef, patchUpdate);
      await updateDoc(patchRef, { status: "ÂÆå‰∫Ü", updatedAt: serverTimestamp(), resolvedAt: serverTimestamp(), resolvedByEmail: (auth?.currentUser?.email||"") });
      toast("‰∏äÊõ∏„Åç‰øùÂ≠ò„Åó„Åæ„Åó„Åü");
      await loadAll(true);
      // ÊòéÁ¥∞„Å∏Êàª„ÇãÔºàÊúÄÊñ∞Ë°®Á§∫Ôºâ
      openSaleDrawer({ ...sale, ...patchUpdate, items: itemsOut, total: totalOut, isBundled:false });
    }catch(err){
      console.error(err);
      toast(`‰øùÂ≠òÂ§±ÊïóÔºà${err?.code||"error"}Ôºâ`);
    }
  };
}


// ---- „ÇØ„É¨„Éº„É†ËøîÈáëÂá¶ÁêÜ
// ‰ªïÊßòÔºö„Éû„Ç§„Éä„Çπ„ÅÆ sales „ÇíÊñ∞Ë¶è‰ΩúÊàêÔºàÂÖÉ„ÅÆ sales „ÅØ‰øùÊåÅÔºâ
async function openClaimEditor(sale){
  ensureDrawer();

  const saleId = String(sale?.id || "").trim();
  if(!saleId){ toast("saleId„Åå„ÅÇ„Çä„Åæ„Åõ„Çì"); return; }

  // ËøîÈáëÈ°ç„Éá„Éï„Ç©„É´„ÉàÔºàÂêàË®àÔºâ
  const saleTotal = Number(sale?.total ?? 0) || 0;

  // ---- master maps
  const channelLabelById = Object.fromEntries((optChannels||[]).map(o=>[o.id,o.label]));
  const paymentLabelById = Object.fromEntries((optPaymentMethods||[]).map(o=>[o.id,o.label]));
  const venueLabelById   = Object.fromEntries((optVenues||[]).map(o=>[o.id,o.label]));
  const kindLabelById    = Object.fromEntries((optKinds||[]).map(o=>[o.id,o.label]));

  // ---- snapshotÔºàÂÖÉÔºâ
  const snapshot = {
    buyerName: sale?.buyerName ?? "",
    orderDate: sale?.orderDate ?? (sale?.date ? fmtYMD(sale.date) : ""),
    channelId: sale?.channelId ?? resolveId(optChannels, (sale?.channelLabel || sale?.channel || "")),
    paymentId: sale?.paymentId ?? resolveId(optPaymentMethods, (sale?.paymentLabel || sale?.paymentMethod || "")),
    venueId: sale?.venueId ?? resolveId(optVenues, (sale?.venueLabel || sale?.venue || "")),
    kindId: sale?.kindId ?? resolveId(optKinds, (sale?.kindLabel || sale?.kind || "")),
  };

  // ---- UI
  drawerEl.querySelector("#drawerBig").textContent = "„ÇØ„É¨„Éº„É†ËøîÈáë";
  drawerEl.querySelector("#drawerSub").textContent = `${snapshot.orderDate}${snapshot.buyerName ? " / "+snapshot.buyerName : ""}`;

  const body = drawerEl.querySelector("#drawerBody");

  const today = fmtYMD(new Date());
  const html = `
    <div class="muted" style="margin-bottom:10px;">
      ËøîÈáë„ÅØ <b>„Éû„Ç§„Éä„Çπ„ÅÆÂ£≤‰∏ä</b> „ÇíÊñ∞Ë¶è‰ΩúÊàê„Åó„Åæ„ÅôÔºàÂÖÉ„ÅÆ sales „ÅØ‰øùÊåÅÔºâ„ÄÇ
    </div>

    <div class="panel" style="padding:14px;">
      <div class="kv editKv">
        <div class="k">ËøîÈáëÊó•</div>
        <div class="v"><input id="claimDate" class="inp" type="date" value="${escapeHtml(today)}"></div>
      </div>

      <div class="kv editKv">
        <div class="k">ËøîÈáëÈ°ç</div>
        <div class="v">
          <input id="claimAmount" class="inp" type="number" inputmode="numeric" min="0" step="1" value="${escapeHtml(String(Math.abs(saleTotal)||0))}">
          <div class="muted" style="margin-top:6px;">‚Äª ÂêàË®à ${fmtMoney(saleTotal)} „ÇíÂàùÊúüÂÄ§„Å´„Åó„Å¶„ÅÑ„Åæ„ÅôÔºàÂøÖË¶Å„Å™„ÇâÂ§âÊõ¥Ôºâ</div>
        </div>
      </div>

      <div class="kv editKv">
        <div class="k">Ê±∫Ê∏àÊñπÊ≥ï</div>
        <div class="v">
          <select id="claimPayment" class="sel">
            ${(optPaymentMethods||[]).filter(o=>o?.active!==false).map(o=>{
              const sel = (String(o.id)===String(snapshot.paymentId)) ? "selected" : "";
              return `<option value="${escapeHtml(o.id)}" ${sel}>${escapeHtml(o.label)}</option>`;
            }).join("")}
          </select>
        </div>
      </div>

      <div class="kv editKv">
        <div class="k">„É°„É¢</div>
        <div class="v"><textarea id="claimMemo" class="txt" rows="3" placeholder="‰æãÔºöÁ†¥Êêç„ÅÆ„Åü„ÇÅËøîÈáë / „ÇØ„É¨„Éº„É†ÂØæÂøú „Å™„Å©"></textarea></div>
      </div>
    </div>

    <div class="panel" style="padding:14px; margin-top:12px;">
      <div class="muted" style="margin-bottom:6px;">‰ΩúÊàê„Åï„Çå„ÇãÂ£≤‰∏äÔºàËøîÈáëÔºâ</div>
      <div class="kv"><div class="k">ÂÖÉsaleId</div><div class="v">${escapeHtml(saleId)}</div></div>
      <div class="kv"><div class="k">Ë≥ºÂÖ•ËÄÖ</div><div class="v">${escapeHtml(snapshot.buyerName || "-")}</div></div>
      <div class="kv"><div class="k">Ë≤©Â£≤ÊñπÊ≥ï</div><div class="v">${escapeHtml(channelLabelById[snapshot.channelId] || snapshot.channelId || "-")}</div></div>
      <div class="kv"><div class="k">ÈñãÂÇ¨Â†¥ÊâÄ</div><div class="v">${escapeHtml(venueLabelById[snapshot.venueId] || snapshot.venueId || "-")}</div></div>
      <div class="kv"><div class="k">Ë≤©Â£≤Á®ÆÂà•</div><div class="v">${escapeHtml(kindLabelById[snapshot.kindId] || snapshot.kindId || "-")}</div></div>
    </div>

    <div class="btnRow" style="margin-top:14px;">
      <button class="btn ghost" id="claimCancel">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="btn danger" id="claimSave">ËøîÈáë„Çí‰ΩúÊàê</button>
    </div>
  `;

  body.innerHTML = html;

  const cancelBtn = body.querySelector("#claimCancel");
  const saveBtn   = body.querySelector("#claimSave");
  if(cancelBtn) cancelBtn.onclick = ()=> openSaleDrawer(sale);

  if(saveBtn) saveBtn.onclick = async ()=>{
    const dateStr = String(body.querySelector("#claimDate")?.value || "").trim() || today;
    const amt = Number(body.querySelector("#claimAmount")?.value || 0);
    if(!Number.isFinite(amt) || amt <= 0){
      toast("ËøîÈáëÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
      return;
    }
    const paymentId = String(body.querySelector("#claimPayment")?.value || "").trim();
    const paymentLabel = paymentLabelById[paymentId] || paymentId || "";
    const memo = String(body.querySelector("#claimMemo")?.value || "").trim();

    // ËøîÈáë„ÅØ„ÄåË≤†„ÅÆÂ£≤‰∏ä„Äç„Å®„Åó„Å¶ÁôªÈå≤
    const total = -Math.round(amt);

    // ËøîÈáëÁî®„ÅÆitemsÔºàÂçò‰∏ÄÊòéÁ¥∞Ôºâ
    const itemsOut = [{
      name: "ËøîÈáë",
      qty: 1,
      unitPrice: total,   // unitPrice „ÇíË≤†Êï∞„Å´„Åó„Å¶ subtotal=total
      price: total,       // ‰∫íÊèõ
      subtotal: total
    }];

    const docOut = {
      // link
      parentSaleId: saleId,
      originalSaleId: saleId,
      isRefund: true,

      // main
      buyerName: String(snapshot.buyerName||"").trim(),
      orderDate: dateStr,
      orderDateMs: msAtLocalMidnight(dateStr),

      channelId: snapshot.channelId || "",
      channelLabel: channelLabelById[snapshot.channelId] || "",
      channel: (channelLabelById[snapshot.channelId] || snapshot.channelId || ""), // ‰∫íÊèõ

      paymentId,
      paymentLabel,
      paymentMethod: paymentLabel || paymentId, // ‰∫íÊèõ

      venueId: snapshot.venueId || "",
      venueLabel: venueLabelById[snapshot.venueId] || "",
      venue: (venueLabelById[snapshot.venueId] || snapshot.venueId || ""), // ‰∫íÊèõ

      kindId: snapshot.kindId || "",
      kindLabel: kindLabelById[snapshot.kindId] || "",
      kind: (snapshot.kindId || kindLabelById[snapshot.kindId] || ""), // ‰∫íÊèõ

      items: itemsOut,
      total,

      memo: memo || "",
      createdAt: serverTimestamp(),
      clientCreatedAt: Date.now(),
      isBundled: false
    };

    try{
      await addDoc(collection(db, "sales"), docOut);
      toast("ËøîÈáë„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü");
      await loadAll(true);
      // ÂÖÉsale„Å∏Êàª„Åô
      openSaleDrawer(sale);
    }catch(err){
      console.error(err);
      toast(`‰ΩúÊàêÂ§±ÊïóÔºà${err?.code||"error"}Ôºâ`);
    }
  };
}

// ---- auth gate („É≠„Ç∞„Ç§„É≥„Åó„Å¶„Å™„Åë„Çå„Å∞ login.html „Å∏)
// („É≠„Ç∞„Ç§„É≥„Åó„Å¶„Å™„Åë„Çå„Å∞ login.html „Å∏)
  onAuthStateChanged(auth, (user)=>{
    if(!user){
      authStateEl.textContent = "Êú™„É≠„Ç∞„Ç§„É≥ ‚Üí login.html „Å∏";
      setTimeout(()=> location.href = "login.html", 250);
      return;
    }
    currentUser = user;
    isAdminUser = isAdminEmail(user.email);
    authStateEl.textContent = `„É≠„Ç∞„Ç§„É≥‰∏≠Ôºö${user.email || "user"}${isAdminUser ? "ÔºàÁÆ°ÁêÜËÄÖÔºâ" : ""}`;
    loadAll();
  });
</script>

</body>
</html>