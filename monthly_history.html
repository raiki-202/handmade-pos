<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>e.nue æœˆåˆ¥è³¼å…¥å±¥æ­´</title>

  <style>
    :root{
      --bg1:#e3ddd4;
      --bg2:#d4ccc1;

      --glass-bg: rgba(255,255,255,.86);
      --glass-bg2: rgba(255,255,255,.78);
      --glass-border: rgba(0,0,0,.06);
      --line-soft: rgba(0,0,0,.10);
      --shadow: 0 18px 45px rgba(0,0,0,.14);

      --text-main:#222222;
      --text-sub:#555555;
      --muted: rgba(34,34,34,.58);

      --accent:#e18a6a;
      --accent2:#d06463;

      --r: 20px;
      --r2: 16px;
      --pad: 16px;

      --max: 980px;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", "Noto Sans JP", sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color: var(--text-main);
    }

    a{ color: inherit; text-decoration: none; }

    .wrap{
      min-height: 100%;
      padding: 18px 14px 28px;
      display:flex;
      justify-content:center;
    }
    .app{
      width:100%;
      max-width: var(--max);
    }

    /* header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 6px 2px 14px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand .title{
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .02em;
    }
    .brand .sub{
      font-size: 12px;
      color: var(--muted);
    }

    .navBtns{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      border:1px solid var(--glass-border);
      background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.76));
      box-shadow: 0 10px 25px rgba(0,0,0,.08);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 800;
      font-size: 12px;
      color: rgba(34,34,34,.82);
      cursor:pointer;
      display:inline-flex;
      gap:8px;
      align-items:center;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(225,138,106,.22), rgba(255,255,255,.78));
      border-color: rgba(225,138,106,.25);
    }

    /* cards */
    .card{
      background: linear-gradient(180deg, var(--glass-bg), var(--glass-bg2));
      border: 1px solid var(--glass-border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding: 14px 14px 10px;
      display:flex;
      gap:10px;
      align-items:flex-end;
      justify-content:space-between;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .cardHead .h{
      font-size: 14px;
      font-weight: 900;
      letter-spacing: .02em;
    }
    .cardHead .meta{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }
    .cardBody{ padding: 12px 14px 14px; }

    /* controls */
    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .leftControls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .field{
      display:flex;
      gap:8px;
      align-items:center;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.70);
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
    }
    .field label{
      font-size: 12px;
      font-weight: 900;
      color: rgba(34,34,34,.72);
      white-space:nowrap;
    }
    select, input[type="search"]{
      border:0;
      outline:none;
      background: transparent;
      font-size: 13px;
      font-weight: 800;
      color: rgba(34,34,34,.88);
      min-width: 110px;
    }
    input[type="search"]{ min-width: 180px; }

    .statRow{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top: 10px;
      color: rgba(34,34,34,.80);
    }
    .pill{
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.62);
      border: 1px solid rgba(0,0,0,.06);
      font-size: 12px;
      font-weight: 900;
      box-shadow: 0 10px 18px rgba(0,0,0,.05);
    }

    /* list */
    .months{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding: 12px 0 0;
    }

    details.month{
      border: 1px solid rgba(0,0,0,.07);
      background: rgba(255,255,255,.62);
      border-radius: 16px;
      box-shadow: 0 12px 22px rgba(0,0,0,.06);
      overflow:hidden;
    }
    summary{
      list-style:none;
      cursor:pointer;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    summary::-webkit-details-marker{ display:none; }

    .mLeft{
      display:flex; flex-direction:column; gap:3px;
    }
    .mTitle{
      font-weight: 1000;
      letter-spacing: .02em;
      font-size: 14px;
    }
    .mSub{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }
    .mRight{
      text-align:right;
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .mTotal{
      font-size: 14px;
      font-weight: 1000;
    }
    .mCount{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
    }

    .sales{
      padding: 0 10px 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    details.sale{
      border: 1px solid rgba(0,0,0,.07);
      background: rgba(255,255,255,.68);
      border-radius: 14px;
      overflow:hidden;
    }
    .saleSum{
      padding: 10px 10px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .saleLeft{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 0;
    }
    .saleTop{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      min-width:0;
    }
    .saleDate{
      font-weight: 1000;
      font-size: 13px;
      white-space:nowrap;
    }
    .badge{
      font-size: 11px;
      font-weight: 1000;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.65);
      color: rgba(34,34,34,.72);
      white-space:nowrap;
    }
    .saleMeta{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space:nowrap;
      max-width: 62vw;
    }
    .saleRight{
      text-align:right;
      display:flex;
      flex-direction:column;
      gap:2px;
      white-space:nowrap;
    }
    .saleTotal{
      font-weight: 1000;
      font-size: 13px;
    }
    .saleId{
      font-size: 11px;
      color: rgba(34,34,34,.48);
      font-weight: 800;
    }

    .items{
      padding: 0 10px 10px;
    }
    table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
      overflow:hidden;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.08);
    }
    th,td{
      padding: 8px 8px;
      border-bottom: 1px solid rgba(0,0,0,.06);
      vertical-align: top;
    }
    th{
      text-align:left;
      font-weight: 1000;
      background: rgba(255,255,255,.58);
      color: rgba(34,34,34,.78);
    }
    td{
      font-weight: 800;
      color: rgba(34,34,34,.84);
    }
    tr:last-child td{ border-bottom:0; }

    .right{ text-align:right; }
    .muted{ color: var(--muted); font-weight: 800; }

    .empty{
      padding: 14px 0 2px;
      color: rgba(34,34,34,.62);
      font-weight: 900;
      font-size: 13px;
    }

    .toast{
      position:fixed;
      left:50%;
      transform: translateX(-50%);
      bottom: 18px;
      background: rgba(25,25,25,.88);
      color:#fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 99;
    }
    .toast.on{ opacity:1; transform: translateX(-50%) translateY(-2px); }

    .smallNote{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(34,34,34,.58);
      font-weight: 800;
      line-height: 1.5;
    }
  
    /* --- adjustments (refund / correction) --- */
    .btn.small{
      padding: 7px 10px;
      font-size: 11px;
      font-weight: 1000;
      gap:6px;
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(208,100,99,.22), rgba(255,255,255,.78));
      border-color: rgba(208,100,99,.28);
    }
    .amountStrike{
      text-decoration: line-through;
      opacity: .55;
      margin-right: 6px;
      font-weight: 900;
      font-size: 12px;
    }
    .adjBadge{
      background: rgba(208,100,99,.12);
      border-color: rgba(208,100,99,.25);
      color: rgba(34,34,34,.78);
    }
    .adjBox{
      margin-top: 8px;
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 12px;
      background: rgba(255,255,255,.62);
      padding: 10px;
      box-shadow: 0 10px 18px rgba(0,0,0,.04);
    }
    .adjHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .adjTitle{
      font-weight: 1000;
      font-size: 12px;
      color: rgba(34,34,34,.78);
    }
    .adjList{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .adjRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 8px 8px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,.06);
      background: rgba(255,255,255,.60);
    }
    .adjL{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .adjType{
      font-weight: 1000;
      font-size: 12px;
    }
    .adjMeta{
      font-size: 11px;
      color: var(--muted);
      font-weight: 800;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space:nowrap;
      max-width: 62vw;
    }
    .adjR{
      text-align:right;
      white-space:nowrap;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .adjAmt{
      font-weight: 1000;
      font-size: 12px;
    }
    .adjWho{
      font-size: 11px;
      color: rgba(34,34,34,.48);
      font-weight: 800;
    }

    .modalBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px 14px;
      z-index: 120;
    }
    .modalBack.on{ display:flex; }
    .modal{
      width: min(520px, 100%);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.25);
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.80));
      box-shadow: 0 22px 60px rgba(0,0,0,.22);
      overflow:hidden;
    }
    .modalHead{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(0,0,0,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalHead .t{
      font-weight: 1000;
      font-size: 14px;
      letter-spacing: .02em;
    }
    .modalBody{
      padding: 12px 14px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .row .field{
      flex: 1 1 180px;
      min-width: 180px;
    }
    textarea{
      width:100%;
      border:0;
      outline:none;
      background: transparent;
      font-size: 13px;
      font-weight: 800;
      color: rgba(34,34,34,.88);
      resize: vertical;
      min-height: 70px;
      padding: 2px 0;
    }
    .help{
      font-size: 12px;
      color: rgba(34,34,34,.58);
      font-weight: 800;
      line-height: 1.5;
    }
    .modalFoot{
      padding: 12px 14px 14px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      border-top: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.55);
    }

  </style>
</head>

<body>
  <div class="wrap">
    <div class="app">

      <div class="topbar">
        <div class="brand">
          <div class="title">æœˆåˆ¥è³¼å…¥å±¥æ­´</div>
          <div class="sub">sales ã‚’æœˆå˜ä½ã§é›†è¨ˆã—ã¦ä¸€è¦§è¡¨ç¤º</div>
        </div>

        <div class="navBtns">
          <button class="btn" id="btnHome">ğŸ  HOME</button>
          <button class="btn" id="btnOther">â¬› OTHER</button>
          <button class="btn primary" id="btnReload">â†» å†èª­è¾¼</button>
          <button class="btn" id="btnCsv">ğŸ“„ CSV</button>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div class="h">ãƒ•ã‚£ãƒ«ã‚¿</div>
          <div class="meta" id="authState">ç¢ºèªä¸­â€¦</div>
        </div>

        <div class="cardBody">
          <div class="controls">
            <div class="leftControls">
              <div class="field">
                <label>å¹´</label>
                <select id="yearSel"></select>
              </div>
              <div class="field">
                <label>æœˆ</label>
                <select id="monthSel">
                  <option value="all">ã™ã¹ã¦</option>
                  <option value="1">1æœˆ</option><option value="2">2æœˆ</option><option value="3">3æœˆ</option><option value="4">4æœˆ</option>
                  <option value="5">5æœˆ</option><option value="6">6æœˆ</option><option value="7">7æœˆ</option><option value="8">8æœˆ</option>
                  <option value="9">9æœˆ</option><option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
                </select>
              </div>
              <div class="field">
                <label>æ¤œç´¢</label>
                <input id="q" type="search" placeholder="è³¼å…¥è€…å / ãƒãƒ£ãƒ³ãƒãƒ« / ãƒ¡ãƒ¢ãªã©" />
              </div>
            </div>
</div>

          <div class="statRow" id="stats"></div>

          <div class="months" id="months"></div>

          <div class="smallNote" id="note">
            ãƒ»saleã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æ˜ç´°ã‚’é–‹ãã¾ã™ã€‚<br>
            ãƒ»ãƒ‡ãƒ¼ã‚¿é‡ãŒå¤šã„å ´åˆã¯ã€Œå¹´ã€ã€Œæœˆã€ã§çµã‚Šè¾¼ã‚€ã®ãŒé€Ÿã„ã§ã™ã€‚
          </div>
        </div>
      </div>

      
      <!-- refund / correction modal -->
      <div class="modalBack" id="adjModalBack" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="adjModalTitle">
          <div class="modalHead">
            <div class="t" id="adjModalTitle">è¿”é‡‘ãƒ»ä¿®æ­£</div>
            <button class="btn small" id="btnAdjClose">âœ• é–‰ã˜ã‚‹</button>
          </div>

          <div class="modalBody">
            <div class="help" id="adjTargetInfo">å¯¾è±¡ï¼šâ€”</div>

            <div class="row">
              <div class="field">
                <label>ç¨®åˆ¥</label>
                <select id="adjType">
                  <option value="refund">ã‚¯ãƒ¬ãƒ¼ãƒ è¿”é‡‘</option>
                  <option value="typo">æ‰“ã¡é–“é•ã„ä¿®æ­£</option>
                </select>
              </div>

              <div class="field">
                <label>é‡‘é¡ï¼ˆå·®åˆ†ï¼‰</label>
                <input id="adjAmount" inputmode="numeric" placeholder="-500 ãªã©ï¼ˆè¿”é‡‘ã¯ãƒã‚¤ãƒŠã‚¹ï¼‰" />
              </div>
            </div>

            <div class="field">
              <label>ç†ç”± / ãƒ¡ãƒ¢</label>
              <textarea id="adjReason" placeholder="ä¾‹ï¼šã‚¯ãƒ¬ãƒ¼ãƒ å¯¾å¿œã®ãŸã‚ä¸€éƒ¨è¿”é‡‘ / å˜ä¾¡æ‰“ã¡é–“é•ã„ã‚’ä¿®æ­£ ãªã©"></textarea>
            </div>

            <div class="row">
              <div class="field">
                <label>è³¼å…¥è€…åï¼ˆä¸Šæ›¸ã ä»»æ„ï¼‰</label>
                <input id="adjBuyerName" placeholder="ç©ºãªã‚‰å¤‰æ›´ãªã—" />
              </div>
</div>

            <div class="help">
              ãƒ»å£²ä¸Šï¼ˆsalesï¼‰è‡ªä½“ã¯è§¦ã‚‰ãšã€<b>å·®åˆ†ï¼ˆadjustmentï¼‰</b>ã¨ã—ã¦è¨˜éŒ²ã—ã¾ã™ã€‚<br>
              ãƒ»è¿”é‡‘ã¯é‡‘é¡ãŒãƒã‚¤ãƒŠã‚¹ã«ãªã‚Šã¾ã™ï¼ˆãƒ—ãƒ©ã‚¹ã§å…¥ã‚ŒãŸã‚‰è‡ªå‹•ã§ãƒã‚¤ãƒŠã‚¹ã«è£œæ­£ã—ã¾ã™ï¼‰ã€‚
            </div>
          </div>

          <div class="modalFoot">
            <button class="btn" id="btnAdjCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn primary" id="btnAdjSave">ä¿å­˜</button>
          </div>
        </div>
      </div>

      <div class="toast" id="toast"></div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import {
    getFirestore, collection, query, orderBy, limit, getDocs, addDoc
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  // âœ… æœ¬ç•ªï¼ˆæ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã¨åŒã˜ï¼‰
  const firebaseConfig = {
    apiKey: "AIzaSyAhPCgPoJK6S6BWVcBZOruYqMPXVQXQFRk",
    authDomain: "handmade-pos.firebaseapp.com",
    projectId: "handmade-pos",
    storageBucket: "handmade-pos.firebasestorage.app",
    messagingSenderId: "174873514252",
    appId: "1:174873514252:web:c26659bffca850d475f929"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ---- UI refs
  const el = (id)=>document.getElementById(id);
  const monthsEl = el("months");
  const statsEl  = el("stats");
  const authStateEl = el("authState");
  const toastEl = el("toast");

  const yearSel = el("yearSel");
  const monthSel = el("monthSel");
  const qEl = el("q");

  const btnHome = el("btnHome");
  const btnOther = el("btnOther");
  const btnReload = el("btnReload");
  const btnCsv = el("btnCsv");

  // ---- adjustment modal refs
  const adjModalBack = el("adjModalBack");
  const btnAdjClose = el("btnAdjClose");
  const btnAdjCancel = el("btnAdjCancel");
  const btnAdjSave = el("btnAdjSave");
  const adjTargetInfo = el("adjTargetInfo");
  const adjTypeEl = el("adjType");
  const adjAmountEl = el("adjAmount");
  const adjReasonEl = el("adjReason");
  const adjBuyerNameEl = el("adjBuyerName");
  let currentAdjSale = null;

  function openAdjModal(sale){
    currentAdjSale = sale;
    adjTargetInfo.textContent = `å¯¾è±¡ï¼š${fmtYMD(sale.date)} / ${sale.id || ""}`;
    adjTypeEl.value = "refund";
    adjAmountEl.value = "";
    adjReasonEl.value = "";
    adjBuyerNameEl.value = "";
adjModalBack.classList.add("on");
    adjModalBack.setAttribute("aria-hidden","false");
    setTimeout(()=> adjAmountEl.focus(), 0);
  }
  function closeAdjModal(){
    adjModalBack.classList.remove("on");
    adjModalBack.setAttribute("aria-hidden","true");
    currentAdjSale = null;
  }

  btnAdjClose?.addEventListener("click", closeAdjModal);
  btnAdjCancel?.addEventListener("click", closeAdjModal);
  adjModalBack?.addEventListener("click", (e)=>{
    if(e.target === adjModalBack) closeAdjModal();
  });

  function parseAmountInput(v){
    const s = safeStr(v).replace(/[Â¥,\s]/g,"").trim();
    if(!s) return null;
    const n = Number(s);
    if(Number.isFinite(n)) return n;
    return null;
  }

  btnAdjSave?.addEventListener("click", async ()=>{
    if(!currentAdjSale){
      closeAdjModal();
      return;
    }
    const type = adjTypeEl.value;
    let amt = parseAmountInput(adjAmountEl.value);
    if(amt===null){
      toast("é‡‘é¡ãŒç©ºã§ã™");
      return;
    }
    if(type==="refund" && amt>0) amt = -Math.abs(amt);

    const payload = {
      saleId: currentAdjSale.id,
      createdAt: Date.now(),
      type,
      amount: amt,
      reason: safeStr(adjReasonEl.value).trim(),
      buyerNameNew: safeStr(adjBuyerNameEl.value).trim(),
byEmail: (auth.currentUser?.email || "")
    };

    try{
      await addDoc(collection(db, "sales_adjustments"), payload);
      toast("ä¿å­˜ã—ã¾ã—ãŸ");
      closeAdjModal();
      await loadAdjustments();
      // apply again
      rawSales.forEach(applyAdjustmentsToSale);
      render();
    }catch(err){
      console.error(err);
      toast("ä¿å­˜å¤±æ•—ï¼ˆãƒ«ãƒ¼ãƒ«ç¢ºèªï¼‰");
      try{
        await navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
        toast("å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
      }catch(e){}
    }
  });


  // ---- helpers
  const pad2 = (n)=> String(n).padStart(2,"0");
  const fmtYMD = (d)=> `${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  const fmtMoney = (n)=> {
    const v = Number(n||0);
    return "Â¥" + v.toLocaleString("ja-JP");
  };
  const ymKey = (d)=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("on");
    setTimeout(()=>toastEl.classList.remove("on"), 1300);
  }

  function safeStr(v){
    if(v===null || v===undefined) return "";
    return String(v);
  }

  function normalizeText(s){
    return safeStr(s).toLowerCase().replace(/\s+/g," ").trim();
  }

  function saleToSearchText(sale){
    const parts = [];
    parts.push(sale.id);
    parts.push(sale.buyerName);
    parts.push(sale.channel);
    parts.push(sale.paymentMethod);
    parts.push(sale.memo);
    parts.push(sale.shippingOption);
    parts.push(sale.kind);
    if(Array.isArray(sale.items)){
      for(const it of sale.items){
        parts.push(it.name, it.productName, it.sku, it.code);
      }
    }
    return normalizeText(parts.filter(Boolean).join(" "));
  }

  // ---- data cache

  // ---- adjustments cache (refund / correction)
  // model: { saleId, createdAt(ms), type, amount, reason, buyerNameNew?, byEmail? }
  let adjustments = [];                // raw
  let adjBySaleId = new Map();         // saleId -> adjustments[]

  let rawSales = [];    // normalized
  let grouped = null;   // Map monthKey -> {monthKey, total, count, sales[]}
  let lastBuilt = null;

  // ---- routing
  btnHome.addEventListener("click", ()=> location.href = "index.html");
  btnOther.addEventListener("click", ()=> location.href = "otherpage.html");
  btnReload.addEventListener("click", ()=> loadSales(true));
  btnCsv.addEventListener("click", ()=> exportCsv());

  yearSel.addEventListener("change", ()=> render());
  monthSel.addEventListener("change", ()=> render());
  qEl.addEventListener("input", ()=> render());

  function fillYearOptions(sales){
    const years = new Set(sales.map(s=> s.date.getFullYear()));
    const arr = [...years].sort((a,b)=>b-a);

    // fallback: ä»Šå¹´ã€œéå»3å¹´
    const nowY = new Date().getFullYear();
    if(arr.length===0){
      for(let y=nowY; y>=nowY-3; y--) arr.push(y);
    }else{
      // ã‚‚ã—æœ€æ–°ãŒä»Šå¹´ã‚ˆã‚Šå°ã•ã„ç­‰ã§ã‚‚ã€ä»Šå¹´ã‚’è¿½åŠ ã—ã¦ãŠã
      if(!years.has(nowY)) arr.unshift(nowY);
    }

    yearSel.innerHTML = "";
    for(const y of arr){
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = `${y}å¹´`;
      yearSel.appendChild(opt);
    }
  }

  function normalizeSale(doc){
    // æœŸå¾…ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¾‹ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯ç©ºæ‰±ã„ï¼‰
    // createdAt: Timestamp / number / string
    // total: number
    // items: [{name, qty, price, subtotal}] etc
    const data = doc.data ? doc.data() : doc;

    let createdAt = data.createdAt;
    let date = null;
    try{
      if(createdAt?.toDate) date = createdAt.toDate();
      else if(typeof createdAt === "number") date = new Date(createdAt);
      else if(typeof createdAt === "string") date = new Date(createdAt);
    }catch(e){}
    if(!date || isNaN(date.getTime())){
      // createdAtãŒç„¡ã„/å£Šã‚Œã¦ã‚‹å ´åˆã¯documentIdã‚„æ›´æ–°æ—¥ãŒç„¡ã„ã®ã§ã€ã¨ã‚Šã‚ãˆãšä»Š
      date = new Date(0);
    }

    const items = Array.isArray(data.items) ? data.items.map(it=>({
      name: it.name ?? it.productName ?? "",
      qty: Number(it.qty ?? it.quantity ?? 0),
      price: Number(it.price ?? it.unitPrice ?? 0),
      subtotal: Number(it.subtotal ?? (Number(it.price ?? 0) * Number(it.qty ?? 0)) ?? 0),
      raw: it
    })) : [];

    const total =
      Number(data.total ?? data.totalAmount ?? data.grandTotal ?? data.amount ?? 0) ||
      items.reduce((a,b)=> a + (Number(b.subtotal)||0), 0);

    const sale = {
      id: doc.id ?? data.id ?? "",
      date,
      total,
      items,

      // optional
      buyerName: data.buyerName ?? data.customerName ?? data.purchaserName ?? "",
      channel: data.channel ?? "",
      paymentMethod: data.paymentMethod ?? data.payment ?? "",
      memo: data.memo ?? data.note ?? "",
      shippingOption: data.shippingOption ?? "",
      kind: data.kind ?? ""
    };
    sale._search = saleToSearchText(sale);
    sale._ym = ymKey(date);
    return sale;
  }


  async function loadAdjustments(){
    try{
      const qAdj = query(
        collection(db, "sales_adjustments"),
        orderBy("createdAt", "desc"),
        limit(5000)
      );
      const snap = await getDocs(qAdj);
      const list = [];
      snap.forEach(d=>{
        const data = d.data();
        list.push({
          id: d.id,
          saleId: data.saleId || "",
          createdAt: Number(data.createdAt || 0),
          type: data.type || "",
          amount: Number(data.amount || 0),
          reason: data.reason || "",
          buyerNameNew: data.buyerNameNew || "",
byEmail: data.byEmail || ""
        });
      });
      adjustments = list;

      const map = new Map();
      for(const a of adjustments){
        if(!a.saleId) continue;
        if(!map.has(a.saleId)) map.set(a.saleId, []);
        map.get(a.saleId).push(a);
      }
      for(const arr of map.values()){
        arr.sort((x,y)=> (y.createdAt||0) - (x.createdAt||0));
      }
      adjBySaleId = map;
    }catch(err){
      console.warn("adjustments load skipped:", err?.message || err);
      adjustments = [];
      adjBySaleId = new Map();
    }
  }

  function applyAdjustmentsToSale(sale){
    const arr = adjBySaleId.get(sale.id) || [];
    const delta = arr.reduce((a,b)=> a + Number(b.amount||0), 0);

    // overrides: newest winsï¼ˆè³¼å…¥è€…åã®ã¿ï¼‰
    let buyerName = sale.buyerName;
    for(const a of arr){
      if(a.buyerNameNew) buyerName = a.buyerNameNew;
    }

    sale._adj = { list: arr, delta, has: arr.length>0, buyerName };
    sale._adjTotal = Number(sale.total||0) + delta;

    // æ¤œç´¢ç”¨ãƒ†ã‚­ã‚¹ãƒˆã¯å…ƒã® memo ã‚’ä½¿ã†ï¼ˆä¸Šæ›¸ãã¯ã—ãªã„ï¼‰
    sale._search = saleToSearchText({ ...sale, buyerName });
    return sale;
  }

  async function loadSales(force=false){

    authStateEl.textContent = "èª­ã¿è¾¼ã¿ä¸­â€¦";
    monthsEl.innerHTML = "";
    statsEl.innerHTML = "";

    try{
      // sales ãŒå¢—ãˆã¦ã„ãå‰æï¼šã¾ãšã¯æœ€æ–°2000ä»¶ã¾ã§ï¼ˆå¿…è¦ãªã‚‰å¢—ã‚„ã—ã¦OKï¼‰
      // â€»ä»¶æ•°ãŒå¤šã„ãªã‚‰å¹´/æœˆã§ãƒ•ã‚£ãƒ«ã‚¿ã—ã¦å–å¾—ã™ã‚‹ä½œã‚Šã«ã‚‚ã§ãã‚‹ï¼ˆå¾Œã§ã‚„ã‚‹ãªã‚‰è¨€ã£ã¦ï¼‰
      const q = query(
        collection(db, "sales"),
        orderBy("createdAt", "desc"),
        limit(2000)
      );
      const snap = await getDocs(q);

      const list = [];
      snap.forEach(d=> list.push(normalizeSale(d)));

      rawSales = list;
      grouped = null;
      lastBuilt = null;

      fillYearOptions(rawSales);

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šæœ€æ–°å¹´ã‚’é¸æŠ
      const latest = rawSales.find(s=> s.date.getTime()>0);
      if(latest){
        yearSel.value = String(latest.date.getFullYear());
      }

      authStateEl.textContent = `OKï¼ˆsales: ${rawSales.length} ä»¶ï¼‰`;
      render();
    }catch(err){
      console.error(err);
      authStateEl.textContent = "èª­ã¿è¾¼ã¿å¤±æ•—";
      monthsEl.innerHTML = `<div class="empty">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br><span class="muted">Firestore ãƒ«ãƒ¼ãƒ« / ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ / createdAt ã®å‹ã‚’ç¢ºèªã—ã¦ã­ã€‚</span></div>`;
      toast("èª­ã¿è¾¼ã¿å¤±æ•—");
    }
  }

  function buildGroups(filtered){
    const map = new Map();
    for(const s of filtered){
      const key = s._ym;
      if(!map.has(key)){
        map.set(key, { monthKey:key, total:0, count:0, sales:[] });
      }
      const g = map.get(key);
      g.total += Number(s.total||0);
      g.count += 1;
      g.sales.push(s);
    }
    // sort sales inside month by date desc
    for(const g of map.values()){
      g.sales.sort((a,b)=> b.date - a.date);
    }
    // sort months desc
    const arr = [...map.values()].sort((a,b)=> b.monthKey.localeCompare(a.monthKey));
    return arr;
  }

  function applyFilters(){
    const y = Number(yearSel.value);
    const m = monthSel.value === "all" ? null : Number(monthSel.value);
    const q = normalizeText(qEl.value);

    let list = rawSales.filter(s=>{
      if(s.date.getTime()<=0) return false;
      if(s.date.getFullYear() !== y) return false;
      if(m && (s.date.getMonth()+1)!==m) return false;
      if(q && !s._search.includes(q)) return false;
      return true;
    });

    return list;
  }

  function renderStats(list){
    const totalRaw = list.reduce((a,b)=> a + Number(b.total||0), 0);
    const totalAdj = list.reduce((a,b)=> a + Number((b._adjTotal ?? b.total) ||0), 0);
    const totalDelta = totalAdj - totalRaw;
    const cnt = list.length;

    statsEl.innerHTML = "";
    const p1 = document.createElement("div");
    p1.className = "pill";
    p1.textContent = `åˆè¨ˆï¼š${fmtMoney(totalAdj)}`;
    statsEl.appendChild(p1);

    const p2 = document.createElement("div");
    p2.className = "pill";
    p2.textContent = `ä»¶æ•°ï¼š${cnt.toLocaleString("ja-JP")} ä»¶`;
    statsEl.appendChild(p2);

    if(Math.abs(totalDelta) > 0.0001){
      const p3 = document.createElement("div");
      p3.className = "pill";
      p3.textContent = `ä¿®æ­£å·®åˆ†ï¼š${fmtMoney(totalDelta)}`;
      statsEl.appendChild(p3);

      const p4 = document.createElement("div");
      p4.className = "pill";
      p4.textContent = `å…ƒåˆè¨ˆï¼š${fmtMoney(totalRaw)}`;
      statsEl.appendChild(p4);
    }
  }

  function render(){
    if(!rawSales.length){
      monthsEl.innerHTML = `<div class="empty">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
      return;
    }

    const list = applyFilters();
    renderStats(list);

    const groups = buildGroups(list);
    lastBuilt = { list, groups };

    monthsEl.innerHTML = "";
    if(groups.length===0){
      monthsEl.innerHTML = `<div class="empty">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
      return;
    }

    for(const g of groups){
      const [yy,mm] = g.monthKey.split("-");
      const monthLabel = `${yy}å¹´${Number(mm)}æœˆ`;

      const det = document.createElement("details");
      det.className = "month";

      const sum = document.createElement("summary");

      const left = document.createElement("div");
      left.className = "mLeft";
      left.innerHTML = `<div class="mTitle">${monthLabel}</div><div class="mSub">ã‚¿ãƒƒãƒ—ã§æ˜ç´°</div>`;

      const right = document.createElement("div");
      right.className = "mRight";
      right.innerHTML = `<div class="mTotal">${fmtMoney(g.total)}</div><div class="mCount">${g.count} ä»¶</div>`;

      sum.appendChild(left);
      sum.appendChild(right);
      det.appendChild(sum);

      const salesWrap = document.createElement("div");
      salesWrap.className = "sales";

      for(const s of g.sales){
        const sDet = document.createElement("details");
        sDet.className = "sale";

        const sSum = document.createElement("summary");
        sSum.className = "saleSum";

        const sLeft = document.createElement("div");
        sLeft.className = "saleLeft";

        const top = document.createElement("div");
        top.className = "saleTop";

        const d = document.createElement("div");
        d.className = "saleDate";
        d.textContent = fmtYMD(s.date);

        top.appendChild(d);

        if(s.channel){
          const b = document.createElement("span");
          b.className = "badge";
          b.textContent = s.channel;
          top.appendChild(b);
        }
        if(s.paymentMethod){
          const b = document.createElement("span");
          b.className = "badge";
          b.textContent = s.paymentMethod;
          top.appendChild(b);
        }

        const meta = document.createElement("div");
        meta.className = "saleMeta";
        meta.textContent = (s._adj?.buyerName ?? s.buyerName) || "â€”";

        sLeft.appendChild(top);
        sLeft.appendChild(meta);

        const sRight = document.createElement("div");
        sRight.className = "saleRight";
        {
          const raw = Number(s.total||0);
          const adj = Number((s._adjTotal ?? raw) || 0);
          const hasAdj = (s._adj?.has);
          const rawHtml = hasAdj ? `<span class="amountStrike">${fmtMoney(raw)}</span>` : "";
          sRight.innerHTML = `<div class="saleTotal">${rawHtml}${fmtMoney(adj)}</div><div class="saleId">${s.id || ""}</div>`;
        }

        sSum.appendChild(sLeft);

        // actions
        const act = document.createElement("div");
        act.style.display = "flex";
        act.style.gap = "8px";
        act.style.alignItems = "center";
        act.style.marginLeft = "8px";

        if(s._adj?.has){
          const b = document.createElement("span");
          b.className = "badge adjBadge";
          b.textContent = "ä¿®æ­£ã‚ã‚Š";
          act.appendChild(b);
        }

        const btnAdj = document.createElement("button");
        btnAdj.className = "btn small";
        btnAdj.textContent = "âœ è¿”é‡‘/ä¿®æ­£";
        btnAdj.addEventListener("click", (e)=>{
          e.preventDefault();
          e.stopPropagation();
          openAdjModal(s);
        });
        act.appendChild(btnAdj);

        sSum.appendChild(act);
        sSum.appendChild(sRight);
        sDet.appendChild(sSum);

        const items = document.createElement("div");
        items.className = "items";

        const rows = (s.items?.length ? s.items : []);
        if(rows.length===0){
          items.innerHTML = `<div class="empty">æ˜ç´°ï¼ˆitemsï¼‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
        }else{
          const table = document.createElement("table");
          table.innerHTML = `
            <thead>
              <tr>
                <th>å•†å“</th>
                <th class="right">æ•°é‡</th>
                <th class="right">å˜ä¾¡</th>
                <th class="right">å°è¨ˆ</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;
          const tb = table.querySelector("tbody");
          for(const it of rows){
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${escapeHtml(it.name || "â€”")}</td>
              <td class="right">${Number(it.qty||0).toLocaleString("ja-JP")}</td>
              <td class="right">${fmtMoney(it.price||0)}</td>
              <td class="right">${fmtMoney(it.subtotal||0)}</td>
            `;
            tb.appendChild(tr);
          }
          items.appendChild(table);
        }

        sDet.appendChild(items);

        // adjustments display
        const adjArr = s._adj?.list || [];
        if(adjArr.length){
          const box = document.createElement("div");
          box.className = "adjBox";

          const head = document.createElement("div");
          head.className = "adjHead";

          const title = document.createElement("div");
          title.className = "adjTitle";
          title.textContent = "è¿”é‡‘ãƒ»ä¿®æ­£å±¥æ­´";

          const headBtn = document.createElement("button");
          headBtn.className = "btn small";
          headBtn.textContent = "ï¼‹ è¿½åŠ ";
          headBtn.addEventListener("click", (e)=>{
            e.preventDefault();
            e.stopPropagation();
            openAdjModal(s);
          });

          head.appendChild(title);
          head.appendChild(headBtn);
          box.appendChild(head);

          const list = document.createElement("div");
          list.className = "adjList";

          for(const a of adjArr){
            const row = document.createElement("div");
            row.className = "adjRow";

            const left = document.createElement("div");
            left.className = "adjL";

            const type = document.createElement("div");
            type.className = "adjType";
            type.textContent = a.type === "refund" ? "ã‚¯ãƒ¬ãƒ¼ãƒ è¿”é‡‘" : "æ‰“ã¡é–“é•ã„ä¿®æ­£";

            const meta = document.createElement("div");
            meta.className = "adjMeta";
            const d = a.createdAt ? fmtYMD(new Date(a.createdAt)) : "";
            meta.textContent = [d, a.reason].filter(Boolean).join(" / ") || "â€”";

            left.appendChild(type);
            left.appendChild(meta);

            const right = document.createElement("div");
            right.className = "adjR";

            const amt = document.createElement("div");
            amt.className = "adjAmt";
            amt.textContent = fmtMoney(a.amount || 0);

            const who = document.createElement("div");
            who.className = "adjWho";
            who.textContent = a.byEmail || "";

            right.appendChild(amt);
            right.appendChild(who);

            row.appendChild(left);
            row.appendChild(right);

            list.appendChild(row);
          }

          box.appendChild(list);
          sDet.appendChild(box);
        }

        salesWrap.appendChild(sDet);
      }

      det.appendChild(salesWrap);
      monthsEl.appendChild(det);
    }
  }

  function escapeHtml(str){
    return safeStr(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function exportCsv(){
    if(!lastBuilt || !lastBuilt.list){
      toast("ãƒ‡ãƒ¼ã‚¿ãªã—");
      return;
    }

    const list = lastBuilt.list.slice().sort((a,b)=> b.date - a.date);

    const header = ["id","date","total","adjustedTotal","buyerName","channel","paymentMethod","memo","itemName","qty","price","subtotal"];
    const lines = [header.join(",")];

    for(const s of list){
      const base = [
        csvCell(s.id),
        csvCell(fmtYMD(s.date)),
        csvCell(s.total),
        csvCell((s._adjTotal ?? s.total) || 0),
        csvCell(s.buyerName),
        csvCell(s.channel),
        csvCell(s.paymentMethod),
        csvCell(s.memo)
      ];

      if(s.items?.length){
        for(const it of s.items){
          const row = base.concat([
            csvCell(it.name),
            csvCell(it.qty),
            csvCell(it.price),
            csvCell(it.subtotal)
          ]);
          lines.push(row.join(","));
        }
      }else{
        const row = base.concat([csvCell(""),csvCell(""),csvCell(""),csvCell("")]);
        lines.push(row.join(","));
      }
    }

    const blob = new Blob(["\ufeff" + lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;

    const y = yearSel.value || "year";
    const m = monthSel.value === "all" ? "all" : pad2(monthSel.value);
    a.download = `monthly_sales_${y}_${m}.csv`;

    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    toast("CSVå‡ºã—ã¾ã—ãŸ");
  }

  function csvCell(v){
    const s = safeStr(v);
    if(/[",\n]/.test(s)){
      return '"' + s.replaceAll('"','""') + '"';
    }
    return s;
  }

  // ---- auth gate (ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãªã‘ã‚Œã° login.html ã¸)
  onAuthStateChanged(auth, (user)=>{
    if(!user){
      authStateEl.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³ â†’ login.html ã¸";
      setTimeout(()=> location.href = "login.html", 250);
      return;
    }
    authStateEl.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${user.email || "user"}`;
    loadSales();
  });
</script>

</body>
</html>
