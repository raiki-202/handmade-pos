<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>e.nue å£²ä¸Šç®¡ç†</title>

  <style>
    :root{
      --bg1:#e3ddd4;
      --bg2:#d4ccc1;

      --glass-bg: rgba(255,255,255,.86);
      --glass-bg2: rgba(255,255,255,.78);
      --glass-border: rgba(0,0,0,.06);
      --line-soft: rgba(0,0,0,.10);
      --shadow: 0 18px 45px rgba(0,0,0,.14);

      --text-main:#222222;
      --text-sub:#555555;
      --muted: rgba(34,34,34,.58);

      --accent:#e18a6a;
      --accent2:#d06463;

      --r: 20px;
      --r2: 16px;
      --pad: 16px;

      --max: 980px;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", "Noto Sans JP", sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color: var(--text-main);
    }

    a{ color: inherit; text-decoration: none; }

    .wrap{
      min-height: 100%;
      padding: 18px 14px 28px;
      display:flex;
      justify-content:center;
    }
    .app{
      width:100%;
      max-width: var(--max);
    }

    /* header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 6px 2px 14px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand .title{
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .02em;
    }
    .brand .sub{
      font-size: 12px;
      color: var(--muted);
    }

    .navBtns{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      border:1px solid var(--glass-border);
      background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.76));
      box-shadow: 0 10px 25px rgba(0,0,0,.08);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 800;
      font-size: 12px;
      color: rgba(34,34,34,.82);
      cursor:pointer;
      display:inline-flex;
      gap:8px;
      align-items:center;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(225,138,106,.22), rgba(255,255,255,.78));
      border-color: rgba(225,138,106,.25);
    }

    /* cards */
    .card{
      background: linear-gradient(180deg, var(--glass-bg), var(--glass-bg2));
      border: 1px solid var(--glass-border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding: 14px 14px 10px;
      display:flex;
      gap:10px;
      align-items:flex-end;
      justify-content:space-between;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .cardHead .h{
      font-size: 14px;
      font-weight: 900;
      letter-spacing: .02em;
    }
    .cardHead .meta{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }
    .cardBody{ padding: 12px 14px 14px; }

    /* controls */
    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .leftControls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .field{
      display:flex;
      gap:8px;
      align-items:center;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.70);
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
    }
    .field label{
      font-size: 12px;
      font-weight: 900;
      color: rgba(34,34,34,.72);
      white-space:nowrap;
    }
    select, input[type="search"]{
      border:0;
      outline:none;
      background: transparent;
      font-size: 13px;
      font-weight: 800;
      color: rgba(34,34,34,.88);
      min-width: 110px;
    }
    input[type="search"]{ min-width: 180px; }

    .statRow{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top: 10px;
      color: rgba(34,34,34,.80);
    }
    .pill{
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.62);
      border: 1px solid rgba(0,0,0,.06);
      font-size: 12px;
      font-weight: 900;
      box-shadow: 0 10px 18px rgba(0,0,0,.05);
    }

    /* list */
    .months{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding: 12px 0 0;
    }

    details.month{
      border: 1px solid rgba(0,0,0,.07);
      background: rgba(255,255,255,.62);
      border-radius: 16px;
      box-shadow: 0 12px 22px rgba(0,0,0,.06);
      overflow:hidden;
    }
    summary{
      list-style:none;
      cursor:pointer;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    summary::-webkit-details-marker{ display:none; }

    .mLeft{
      display:flex; flex-direction:column; gap:3px;
    }
    .mTitle{
      font-weight: 1000;
      letter-spacing: .02em;
      font-size: 14px;
    }
    .mSub{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }
    .mRight{
      text-align:right;
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .mTotal{
      font-size: 14px;
      font-weight: 1000;
    }
    .mCount{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
    }

    .sales{
      padding: 0 10px 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    details.sale{
      border: 1px solid rgba(0,0,0,.07);
      background: rgba(255,255,255,.68);
      border-radius: 14px;
      overflow:hidden;
    }

    .saleCard{
      border: 1px solid rgba(0,0,0,.07);
      background: rgba(255,255,255,.68);
      border-radius: 14px;
      overflow:hidden;
    }
    .saleCard:active{ transform: translateY(1px); }
    .saleSum{
      padding: 10px 10px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .saleLeft{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 0;
      flex: 1;
    }
    .saleTop{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      min-width:0;
    }
    .saleDate{
      font-weight: 1000;
      font-size: 13px;
      white-space:nowrap;
    }
    .badge{
      font-size: 11px;
      font-weight: 1000;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.65);
      color: rgba(34,34,34,.72);
      white-space:nowrap;
    }
    .saleMeta{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space:nowrap;
      max-width: 62vw;
    }
    .saleRight{
      text-align:right;
      display:flex;
      flex-direction:column;
      gap:2px;
      white-space:nowrap;
      align-items:flex-end;
    }
    .saleTotal{
      font-weight: 1000;
      font-size: 13px;
    }
    .saleId{
      font-size: 11px;
      color: rgba(34,34,34,.48);
      font-weight: 800;
    }

    .editBtn{
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.72);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      font-weight: 1000;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
      flex: 0 0 auto;
    }
    .editBtn:active{ transform: translateY(1px); }

    .items{
      padding: 0 10px 10px;
    }
    table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
      overflow:hidden;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.08);
    }
    th,td{
      padding: 8px 8px;
      border-bottom: 1px solid rgba(0,0,0,.06);
      vertical-align: top;
    }
    th{
      text-align:left;
      font-weight: 1000;
      background: rgba(255,255,255,.58);
      color: rgba(34,34,34,.78);
    }
    td{
      font-weight: 800;
      color: rgba(34,34,34,.84);
    }
    tr:last-child td{ border-bottom:0; }

    .right{ text-align:right; }
    .muted{ color: var(--muted); font-weight: 800; }

    .empty{
      padding: 14px 0 2px;
      color: rgba(34,34,34,.62);
      font-weight: 900;
      font-size: 13px;
    }

    .toast{
      position:fixed;
      left:50%;
      transform: translateX(-50%);
      bottom: 18px;
      background: rgba(25,25,25,.88);
      color:#fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 99;
    }
    .toast.on{ opacity:1; transform: translateX(-50%) translateY(-2px); }

    .smallNote{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(34,34,34,.58);
      font-weight: 800;
      line-height: 1.5;
    }

    /* modal */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding: 18px 14px;
      z-index: 200;
    }
    .modalCard{
      width: 100%;
      max-width: 560px;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.80));
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 18px;
      box-shadow: 0 22px 55px rgba(0,0,0,.18);
      padding: 14px;
      overflow:hidden;
    }
    .modalTitle{
      font-size: 14px;
      font-weight: 1000;
      letter-spacing: .02em;
      margin-bottom: 10px;
    }
    .modalSub{
      font-size: 12px;
      color: rgba(34,34,34,.62);
      font-weight: 900;
      margin-top: -6px;
      margin-bottom: 10px;
      line-height: 1.4;
    }
    .modalBtns{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .modalBtn{
      width: 100%;
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 14px;
      padding: 12px 12px;
      background: rgba(255,255,255,.72);
      font-weight: 1000;
      font-size: 13px;
      cursor:pointer;
      text-align:left;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalBtn.primary{
      border-color: rgba(225,138,106,.30);
      background: linear-gradient(180deg, rgba(225,138,106,.20), rgba(255,255,255,.78));
    }
    .modalBtn.danger{
      border-color: rgba(208,100,99,.35);
      background: linear-gradient(180deg, rgba(208,100,99,.16), rgba(255,255,255,.78));
    }
    .modalBtn:active{ transform: translateY(1px); }
    .modalBtn .hint{
      font-size: 12px;
      font-weight: 900;
      color: rgba(34,34,34,.55);
      white-space:nowrap;
    }

    .form{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 10px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-start;
    }
    .input{
      flex: 1 1 160px;
      display:flex;
      flex-direction:column;
      gap:6px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.70);
      box-shadow: 0 10px 18px rgba(0,0,0,.05);
    }
    .input .lab{
      font-size: 12px;
      font-weight: 1000;
      color: rgba(34,34,34,.72);
    }
    .input input, .input textarea, .input select{
      width:100%;
      border:0;
      outline:none;
      background: transparent;
      font-size: 13px;
      font-weight: 900;
      color: rgba(34,34,34,.88);
    }
    .input textarea{
      min-height: 70px;
      resize: vertical;
      line-height: 1.45;
      font-weight: 800;
    }

    .miniTable{
      width:100%;
      border-collapse: collapse;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.62);
    }
    .miniTable th,.miniTable td{ padding: 8px; border-bottom: 1px solid rgba(0,0,0,.06); }
    .miniTable th{ font-size: 12px; font-weight: 1000; color: rgba(34,34,34,.72); background: rgba(255,255,255,.58); }
    .miniTable td input{
      width:100%;
      border:0;
      outline:none;
      background: transparent;
      font-size: 12px;
      font-weight: 900;
      color: rgba(34,34,34,.88);
    }
    .miniActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 8px;
    }
    .miniActions .sbtn{
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.72);
      border-radius: 999px;
      padding: 9px 12px;
      font-size: 12px;
      font-weight: 1000;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(0,0,0,.05);
    }
    .miniActions .sbtn:active{ transform: translateY(1px); }
    .miniActions .sbtn.primary{
      border-color: rgba(225,138,106,.30);
      background: linear-gradient(180deg, rgba(225,138,106,.18), rgba(255,255,255,.78));
    }
    .miniActions .sbtn.danger{
      border-color: rgba(208,100,99,.35);
      background: linear-gradient(180deg, rgba(208,100,99,.14), rgba(255,255,255,.78));
    }

    /* claim card */
    .claimCard{
      margin-top: 8px;
      border: 1px dashed rgba(0,0,0,.16);
      background: rgba(255,255,255,.60);
      border-radius: 14px;
      padding: 10px;
    }
    .claimHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 6px;
    }
    .claimTitle{
      font-size: 12px;
      font-weight: 1000;
      color: rgba(34,34,34,.78);
    }
    .claimAmt{
      font-size: 12px;
      font-weight: 1000;
      color: rgba(208,100,99,.92);
      white-space:nowrap;
    }
    .claimReason{
      font-size: 12px;
      font-weight: 800;
      color: rgba(34,34,34,.74);
      line-height: 1.45;
      white-space: pre-wrap;
    }
    .claimMeta{
      font-size: 11px;
      font-weight: 900;
      color: rgba(34,34,34,.50);
      margin-top: 6px;
    }

    @media (min-width: 720px){
      .modal{ align-items:center; }
    }
  
    /* =========================
       Bottom Drawer (Sale Detail)
       ========================= */
    .drawerBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
      z-index: 9998;
    }
    .drawer{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      max-height: 86vh;
      background: rgba(255,255,255,.92);
      border-top-left-radius: 22px;
      border-top-right-radius: 22px;
      box-shadow: 0 -18px 45px rgba(0,0,0,.18);
      transform: translateY(105%);
      transition: transform .22s ease;
      z-index: 9999;
      overflow: hidden;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .drawer.open{ transform: translateY(0); }
    .drawerBackdrop.open{
      opacity: 1;
      pointer-events: auto;
    }
    .drawerHeader{
      padding: 14px 14px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid rgba(0,0,0,.08);
    }
    .drawerTitle{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 0;
    }
    .drawerTitle .big{
      font-size: 18px;
      font-weight: 1000;
      line-height: 1.1;
    }
    .drawerTitle .sub{
      font-size: 12px;
      color: rgba(34,34,34,.70);
    }
    .drawerClose{
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.85);
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 800;
    }
    .drawerBody{
      padding: 12px 14px 18px;
      overflow:auto;
      max-height: calc(86vh - 62px);
    }
    .kv{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:8px 10px;
      padding: 10px 0;
      border-bottom: 1px dashed rgba(0,0,0,.10);
    }
    .k{ font-size: 12px; color: rgba(34,34,34,.70); }
    .v{ font-size: 13px; word-break: break-word; }
    .sectionTitle{
      margin: 12px 0 6px;
      font-weight: 1000;
    }
    .drawerTable{
      width: 100%;
      border-collapse: collapse;
      background: rgba(255,255,255,.6);
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 12px;
      overflow:hidden;
    }
    .drawerTable th, .drawerTable td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(0,0,0,.06);
      font-size: 13px;
    }
    .drawerTable th{
      font-size: 12px;
      color: rgba(34,34,34,.70);
      text-align:left;
      background: rgba(255,255,255,.75);
    }
    .drawerTable .right{ text-align:right; }


    
    /* edit drawer kv */
    .drawerLike{ max-width: 760px; padding:0; }
    .drawerLike .drawerBody{ padding: 12px 14px 18px; }
    .editKv{ border-bottom: none; padding: 6px 0; }
    .editKv .v{ position: relative; }
    .editWrap{
      position: relative;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.65);
      box-shadow: 0 10px 18px rgba(0,0,0,.04);
      cursor: pointer;
    }
    .editWrap.alwaysOn{ cursor: default; }
    .editWrap:active{ transform: translateY(1px); }
    .editWrap .disp{
      display:block;
      font-weight: 900;
      color: rgba(34,34,34,.90);
      white-space: pre-wrap;
      word-break: break-word;
      min-height: 18px;
    }
    .editInput{
      display:none;
      width:100%;
      border:0;
      outline:none;
      background: transparent;
      font-size: 13px;
      font-weight: 900;
      color: rgba(34,34,34,.88);
    }
    .editWrap.editing .disp{ display:none; }
    .editWrap.editing .editInput{ display:block; }
    .editInput.always{ display:block; }
    .readonlyLine{
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px dashed rgba(0,0,0,.10);
      background: rgba(255,255,255,.45);
      font-size: 13px;
      font-weight: 900;
      color: rgba(34,34,34,.78);
    }
    .diffLine{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(34,34,34,.70);
      font-weight: 900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 12px;
      padding: 8px 10px;
    }
    .approveC{
      font-size: 12px;
      font-weight: 1000;
      display:inline-flex;
      gap:6px;
      align-items:center;
      white-space:nowrap;
    }
    .itemsBox{ margin-top: 6px; }
    .footKv{ padding-top: 10px; border-top: 1px dashed rgba(0,0,0,.10); }

/* approve (admin) */
    .approveBox{
      margin: 10px 0 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.62);
      box-shadow: 0 10px 18px rgba(0,0,0,.05);
    }
    .approveHead{
      font-weight: 900;
      font-size: 13px;
      margin-bottom: 6px;
    }
    .approveNote{
      font-size: 12px;
      color: rgba(34,34,34,.72);
      font-weight: 800;
      margin-bottom: 8px;
      line-height: 1.35;
    }
    .approveRow{
      display:grid;
      grid-template-columns: 120px 1fr 80px;
      gap:10px;
      align-items:center;
      padding: 8px 0;
      border-top: 1px dashed rgba(0,0,0,.10);
      font-size: 12px;
    }
    .approveRow:first-child{ border-top:0; }
    .approveL{ font-weight: 900; color: rgba(34,34,34,.82); }
    .approveR{ color: rgba(34,34,34,.76); font-weight: 800; word-break: break-word; }
    .approveC{ justify-self:end; font-weight: 900; color: rgba(34,34,34,.82); display:flex; gap:6px; align-items:center; }
    .approveEmpty{ font-size: 12px; font-weight: 800; color: rgba(34,34,34,.72); padding: 6px 0; }
    .fromTo{font-size:11px;font-weight:900;color:rgba(34,34,34,.55);margin-left:8px;}
    .okChk{
      margin-left: 10px;
      font-size: 11px;
      font-weight: 900;
      color: rgba(34,34,34,.76);
      display:inline-flex;
      gap:6px;
      align-items:center;
      user-select:none;
    }
    .okChk input{ transform: translateY(1px); }


    /* fix summary bar (outside card) */
    .fixSummaryBar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
      padding: 0 2px 12px;
      margin-top: -6px;
    }
    .fixSummaryBar .pill{
      cursor: default;
    }
    .fixSummaryBar .pill strong{
      font-weight: 1000;
    }

  </style>
</head>

<body>
  <div class="wrap">
    <div class="app">

      <div class="topbar">
        <div class="brand">
          <div class="title">å£²ä¸Šç®¡ç†</div>
          <div class="sub">sales ã‚’æœˆå˜ä½ã§é›†è¨ˆã—ã¦ä¸€è¦§è¡¨ç¤º</div>
        </div>

        <div class="navBtns">
          <button class="btn" id="btnHome">ğŸ  HOME</button>
          <button class="btn" id="btnOther">â¬› OTHER</button>
          <button class="btn primary" id="btnReload">â†» å†èª­è¾¼</button>
          <button class="btn" id="btnCsv">ğŸ“„ CSV</button>
        </div>
      </div>

      <!-- ä¿®æ­£ä¾é ¼ã‚µãƒãƒªãƒ¼ï¼ˆæ å¤–è¡¨ç¤ºï¼‰ -->
      <div class="fixSummaryBar" id="fixSummaryBar" style="display:none;">
        <div class="pill" id="fixSumPending">ä¿®æ­£ä¾é ¼ï¼šä¾é ¼ä¸­ - ä»¶</div>
        <div class="pill" id="fixSumDone">å®Œäº† - ä»¶</div>
        <div class="pill" id="sourceSum" style="display:none;">salesï¼šjson - ä»¶ / firebase - ä»¶</div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div class="h">ãƒ•ã‚£ãƒ«ã‚¿</div>
          <div class="meta" id="authState">ç¢ºèªä¸­â€¦</div>
        </div>

        <div class="cardBody">
          <div class="controls">
            <div class="leftControls">
              <div class="field">
                <label>å¹´</label>
                <select id="yearSel"></select>
              </div>
              <div class="field">
                <label>æœˆ</label>
                <select id="monthSel">
                  <option value="all">ã™ã¹ã¦</option>
                  <option value="1">1æœˆ</option><option value="2">2æœˆ</option><option value="3">3æœˆ</option><option value="4">4æœˆ</option>
                  <option value="5">5æœˆ</option><option value="6">6æœˆ</option><option value="7">7æœˆ</option><option value="8">8æœˆ</option>
                  <option value="9">9æœˆ</option><option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
                </select>
              </div>
              <div class="field">
                <label>æ¤œç´¢</label>
                <input id="q" type="search" placeholder="è³¼å…¥è€…å / ãƒãƒ£ãƒ³ãƒãƒ« / ãƒ¡ãƒ¢ãªã©" />
              </div>
            </div>
          </div>

          <div class="statRow" id="stats"></div>

          <div class="months" id="months"></div>

          <div class="smallNote" id="note">
            ãƒ»saleã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æ˜ç´°ã‚’é–‹ãã¾ã™ã€‚å³ç«¯ã®ã€Œâœã€ã§ç·¨é›†ã§ãã¾ã™ã€‚<br>
            ãƒ»ã€Œã‚¯ãƒ¬ãƒ¼ãƒ è¿”é‡‘ã€ã¯ã€Œãƒã‚¤ãƒŠã‚¹ã® salesã€ã‚’æ–°è¦ä½œæˆã—ã¾ã™ï¼ˆå…ƒã® sales ã¯ä¿æŒï¼‰ã€‚ã€Œæ‰“ã¡é–“é•ã„ä¿®æ­£ã€ã¯ç®¡ç†è€…ã¸ä¿®æ­£ä¾é ¼ã‚’é€ã‚Šã¾ã™ï¼ˆsalesã¯å¤‰æ›´ã—ã¾ã›ã‚“ï¼‰ã€‚<br>
            ãƒ»ãƒãƒ³ãƒ‰ãƒ«ç”±æ¥ãƒ‡ãƒ¼ã‚¿ã‚‚å«ã‚ã€æ‰“ã¡é–“é•ã„ä¿®æ­£ã¯ã€Œä¿®æ­£ä¾é ¼ã€ã‚’é€ã‚Šã¾ã™ï¼ˆsalesã¯å¤‰æ›´ã—ã¾ã›ã‚“ï¼‰ã€‚æœ¬ä¿®æ­£ã¯ç®¡ç†è€…ã®ã¿ã§ã™ã€‚
          </div>
        </div>
      </div>

      <div class="toast" id="toast"></div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import {
    getFirestore,
    collection, doc, query, where, orderBy, limit, getDocs, addDoc, updateDoc, serverTimestamp, Timestamp
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  // âœ… æœ¬ç•ªï¼ˆæ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã¨åŒã˜ï¼‰
  const firebaseConfig = {
    apiKey: "AIzaSyAhPCgPoJK6S6BWVcBZOruYqMPXVQXQFRk",
    authDomain: "handmade-pos.firebaseapp.com",
    projectId: "handmade-pos",
    storageBucket: "handmade-pos.firebasestorage.app",
    messagingSenderId: "174873514252",
    appId: "1:174873514252:web:c26659bffca850d475f929"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ---- UI refs
  const el = (id)=>document.getElementById(id);
  const monthsEl = el("months");
  const statsEl  = el("stats");
  const authStateEl = el("authState");
  const toastEl = el("toast");

  const fixSummaryBar = el("fixSummaryBar");
  const fixSumPendingEl = el("fixSumPending");
  const fixSumDoneEl = el("fixSumDone");

  const yearSel = el("yearSel");
  const monthSel = el("monthSel");
  const qEl = el("q");

  const btnHome = el("btnHome");
  const btnOther = el("btnOther");
  const btnReload = el("btnReload");
  const btnCsv = el("btnCsv");

  // ---- helpers
  const pad2 = (n)=> String(n).padStart(2,"0");
  const fmtYMDHM = (d)=> `${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  const fmtMoney = (n)=> {
    const v = Number(n||0);
    return "Â¥" + v.toLocaleString("ja-JP");
  };
  const yen = (n)=> fmtMoney(n);

  const ymKey = (d)=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("on");
    setTimeout(()=>toastEl.classList.remove("on"), 1400);
  }

  function safeStr(v){
    if(v===null || v===undefined) return "";
    return String(v);
  }

  function normalizeText(s){
    return safeStr(s).toLowerCase().replace(/\\s+/g," ").trim();
  }

  function saleToSearchText(sale){
    const parts = [];
    parts.push(sale.id);
    parts.push(sale.buyerName);
    parts.push(sale.channel);
    parts.push(sale.paymentMethod);
    parts.push(sale.memo);
    parts.push(sale.shippingOption);
    parts.push(sale.kind);
    parts.push(sale.parentSaleId);
    parts.push(sale.isRefund ? "refund" : "");
    if(Array.isArray(sale.items)){
      for(const it of sale.items){
        parts.push(it.name, it.productName, it.sku, it.code);
      }
    }
    return normalizeText(parts.filter(Boolean).join(" "));
  }

  function escapeHtml(str){
    return safeStr(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ---- data cache
  let rawSales = [];                 // normalized
  let lastBuilt = null;              // { list, groups }
  let currentUser = null;

  // ---- admin
  const ADMIN_EMAILS = ["enue_staff03@management.com"]; // ç®¡ç†è€…ã®ã¿ï¼ˆå¿…è¦ãªã‚‰è¿½åŠ ï¼‰
  function isAdminEmail(email){
    const e = safeStr(email).toLowerCase();
    return ADMIN_EMAILS.map(x=>x.toLowerCase()).includes(e);
  }
  let isAdminUser = false;

  // ---- source counts
  let lastSourceCounts = { json: 0, firebase: 0 };

  // ---- option lists (è‡ªå‹•åé›†)
  let optPaymentMethods = [];
  let optChannels = [];

  function uniqSorted(arr){
    const set = new Set(arr.map(v=>safeStr(v).trim()).filter(Boolean));
    return [...set].sort((a,b)=>a.localeCompare(b,'ja'));
  }
  function buildOptionsHTML(list, current){
    const cur = safeStr(current).trim();
    const opts = [];
    // current ãŒå€™è£œã«ç„¡ã„å ´åˆã‚‚å…ˆé ­ã«å‡ºã™
    if(cur && !list.includes(cur)){
      opts.push(`<option value="${escapeHtml(cur)}" selected>${escapeHtml(cur)}</option>`);
    }
    for(const v of list){
      const sel = (v===cur) ? " selected" : "";
      opts.push(`<option value="${escapeHtml(v)}"${sel}>${escapeHtml(v)}</option>`);
    }
    // è‡ªç”±å…¥åŠ›
    opts.push(`<option value="__custom__">ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰</option>`);
    return opts.join("");
  }

  // ---- routing
  btnHome.addEventListener("click", ()=> location.href = "index.html");
  btnOther.addEventListener("click", ()=> location.href = "otherpage.html");
  btnReload.addEventListener("click", ()=> loadAll(true));
  btnCsv.addEventListener("click", ()=> exportCsv());

  yearSel.addEventListener("change", ()=> render());
  monthSel.addEventListener("change", ()=> render());
  qEl.addEventListener("input", ()=> render());

  function fillYearOptions(sales){
    const years = new Set(sales.map(s=> s.date.getFullYear()));
    const arr = [...years].sort((a,b)=>b-a);

    // fallback: ä»Šå¹´ã€œéå»3å¹´
    const nowY = new Date().getFullYear();
    if(arr.length===0){
      for(let y=nowY; y>=nowY-3; y--) arr.push(y);
    }else{
      if(!years.has(nowY)) arr.unshift(nowY);
    }

    yearSel.innerHTML = "";
    for(const y of arr){
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = `${y}å¹´`;
      yearSel.appendChild(opt);
    }
  }

  function normalizeSale(docSnap){
    const data = docSnap.data ? docSnap.data() : docSnap;

    let createdAt = data.createdAt;
    let date = null;
    try{
      if(createdAt?.toDate) date = createdAt.toDate();
      else if(typeof createdAt === "number") date = new Date(createdAt);
      else if(typeof createdAt === "string") date = new Date(createdAt);
    }catch(e){}
    if(!date || isNaN(date.getTime())){
      date = new Date(0);
    }

    const items = Array.isArray(data.items) ? data.items.map(it=>({
      id: it.id ?? it.productId ?? it.sku ?? "",
      name: it.name ?? it.productName ?? "",
      qty: Number(it.qty ?? it.quantity ?? 0),
      unitPrice: Number(it.unitPrice ?? it.price ?? it.unit ?? 0),
      // äº’æ›ç”¨ï¼ˆå¤ã„ã‚³ãƒ¼ãƒ‰ãŒ price ã‚’å‚ç…§ã—ã¦ã‚‚å‹•ãã‚ˆã†æ®‹ã™ï¼‰
      price: Number(it.unitPrice ?? it.price ?? it.unit ?? 0),
      subtotal: Number(
        it.subtotal ??
        (Number(it.unitPrice ?? it.price ?? it.unit ?? 0) * Number(it.qty ?? it.quantity ?? 0)) ??
        0
      ),
      raw: it
    })) : [];

    const total =
      Number(data.total ?? data.totalAmount ?? data.grandTotal ?? data.amount ?? 0) ||
      items.reduce((a,b)=> a + (Number(b.subtotal)||0), 0);

    // ãƒãƒ³ãƒ‰ãƒ«ç”±æ¥åˆ¤å®šï¼ˆå­˜åœ¨ã™ã‚‹ãªã‚‰å°Šé‡ã€ç„¡ã„å ´åˆã¯ kind/source ã§ã‚‚åˆ¤å®šï¼‰
    const isBundled = Boolean(
      data.isBundled ?? data.bundled ?? (safeStr(data.source).toLowerCase()==="bundle") ?? false
    ) || (safeStr(data.kind).toLowerCase()==="bundle");
    const parentSaleId = data.parentSaleId ?? data.parentId ?? "";

    const isRefund = Boolean(data.isRefund ?? false) || (safeStr(data.channel).toLowerCase()==="refund") || (Number(data.total ?? data.totalAmount ?? data.grandTotal ?? data.amount ?? 0) < 0 && parentSaleId);

    const sale = {
      id: docSnap.id ?? data.id ?? "",
      date,
      total,
      items,

      // è¡¨ç¤ºç”¨
      buyerName: data.buyerName ?? data.customerName ?? data.purchaserName ?? "",
      orderDate: data.orderDate ?? "",
      orderDateMs: Number(data.orderDateMs ?? 0) || 0,
      createdAtText: createdAt?.toDate ? createdAt.toDate().toLocaleString('ja-JP') : (typeof createdAt==='number' ? new Date(createdAt).toLocaleString('ja-JP') : (createdAt?.seconds ? new Date(createdAt.seconds*1000).toLocaleString('ja-JP') : "")),
      clientCreatedAt: Number(data.clientCreatedAt ?? 0) || 0,
      channel: data.channel ?? data.channelId ?? "",
      channelLabel: data.channelLabel ?? "",
      paymentId: data.paymentId ?? "",
      paymentLabel: data.paymentLabel ?? "",
      paymentMethod: data.paymentMethod ?? data.payment ?? data.paymentId ?? "",
      venue: data.venue ?? data.venueId ?? "",
      venueLabel: data.venueLabel ?? "",
      kindId: data.kindId ?? "",
      kindLabel: data.kindLabel ?? "",
      urgentOptionId: data.urgentOptionId ?? "",
      urgentOptionLabel: data.urgentOptionLabel ?? "",
      memo: data.memo ?? data.note ?? "",
      shippingOption: data.shippingOption ?? "",
      kind: data.kind ?? "",

      parentSaleId,
      isRefund,

      isBundled
    };
    sale._search = saleToSearchText(sale);
    sale._ym = ymKey(date);
    return sale;
  }

  async function loadBundleSales(){
  // ãƒãƒ³ãƒ‰ãƒ«ï¼ˆjsonï¼‰ã‚’å„ªå…ˆèª­ã¿è¾¼ã¿ã€‚å­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ã€‚
  const candidates = ["bundle/sales_bundle.json","sales_bundle.json"];
  for(const url of candidates){
    try{
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) continue;
      const json = await res.json();
      const arr = Array.isArray(json) ? json : (Array.isArray(json.sales) ? json.sales : []);
      if(!arr.length) return [];
      return arr.map((d, idx)=>{
        // id ãŒç„¡ã„å ´åˆã¯é€£ç•ªï¼ˆé‡è¤‡å›é¿ï¼‰
        const id = safeStr(d.id || d.saleId || "").trim() || `bundle_${idx}`;
        const data = { ...d, id, isBundled: true, source: "bundle" };
        return normalizeSale({ id, data: ()=>data });
      });
    }catch(e){
      // ignore and try next
    }
  }
  return [];
}

async function loadSales(){
  // 1) ãƒãƒ³ãƒ‰ãƒ«ã‚’å…ˆã«èª­ã‚€
  const bundleList = await loadBundleSales();

  // 2) Firestoreï¼ˆå·®åˆ†/æœ€æ–°ï¼‰ã‚’èª­ã‚€
  // åŸºæœ¬ã¯ãƒãƒ³ãƒ‰ãƒ«ï¼ˆjsonï¼‰ã‚’æ­£ã¨ã—ã€Firestore ã¯ã€Œå·®åˆ†ã€ã‚’èª­ã‚€æƒ³å®šã€‚
  // ã¾ãš isBundled==false ã‚’å·®åˆ†ã¨ã—ã¦èª­ã¿ã€å¤±æ•—ã—ãŸã‚‰å…¨ä»¶èª­ã¿ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€‚
  let fbList = [];
  try{
    const qDiff = query(
      collection(db, "sales"),
      where("isBundled", "==", false),
      orderBy("createdAt", "desc"),
      limit(2000)
    );
    const snap = await getDocs(qDiff);
    snap.forEach(d=> fbList.push(normalizeSale(d)));
  }catch(e){
    // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœªä½œæˆç­‰ã§è½ã¡ãŸã‚‰ã€å¾“æ¥ã©ãŠã‚Šå…¨ä»¶èª­ã¿ï¼ˆâ€»æœ€çµ‚æ‰‹æ®µï¼‰
    const qAll = query(
      collection(db, "sales"),
      orderBy("createdAt", "desc"),
      limit(2000)
    );
    const snap2 = await getDocs(qAll);
    snap2.forEach(d=> fbList.push(normalizeSale(d)));
  }

  // 3) ãƒãƒ¼ã‚¸ï¼ˆåŒã˜ id ã¯ Firestore ã‚’å„ªå…ˆï¼‰
  const map = new Map();
  for(const s of bundleList){
    s._source = "json";
    map.set(s.id, s);
  }
  for(const s of fbList){
    s._source = "firebase";
    map.set(s.id, s);
  }

  rawSales = [...map.values()];

  // 4) ä»¶æ•°ä¿æŒï¼ˆèª­ã¿å–ã‚Šä»¶æ•°ï¼šmergeå‰ï¼‰
  lastSourceCounts = { json: bundleList.length, firebase: fbList.length };

  // option lists ã‚’ sales ã‹ã‚‰è‡ªå‹•åé›†
  optPaymentMethods = uniqSorted(rawSales.map(x=>x.paymentMethod));
  optChannels       = uniqSorted(rawSales.map(x=>x.channel));

  fillYearOptions(rawSales);
  const latest = rawSales.find(s=> s.date.getTime()>0);
  if(latest){
    yearSel.value = String(latest.date.getFullYear());
  }

  renderSourceSummary();
}

function renderSourceSummary(){
  const el = document.getElementById("sourceSum");
  if(!el) return;
  if(!isAdminUser){
    el.style.display = "none";
    return;
  }
}

async function renderFixSummary(){
  // sales_fix_requests ã®å…¨ä½“ä»¶æ•°ï¼ˆä¾é ¼ä¸­/å®Œäº†ï¼‰ã‚’ä¸Šéƒ¨ã«è¡¨ç¤º
  try{
    const q = query(
      collection(db, "sales_fix_requests"),
      orderBy("createdAt", "desc"),
      limit(2000)
    );
    const snap = await getDocs(q);
    let pending = 0, done = 0;
    snap.forEach(d=>{
      const st = safeStr(d.data()?.status || "").trim();
      if(st === "ä¾é ¼ä¸­") pending += 1;
      else if(st === "å®Œäº†") done += 1;
    });

    fixSumPendingEl.textContent = `ä¿®æ­£ä¾é ¼ï¼šä¾é ¼ä¸­ ${pending.toLocaleString("ja-JP")} ä»¶`;
    fixSumDoneEl.textContent    = `å®Œäº† ${done.toLocaleString("ja-JP")} ä»¶`;

    // 0ä»¶ã§ã‚‚â€œæ å¤–â€ã«ç½®ã„ã¦ãŠããŸã„ã®ã§å¸¸ã«è¡¨ç¤ºï¼ˆä¸è¦ãªã‚‰ã“ã“ã‚’ pending+done>0 ã«ï¼‰
    fixSummaryBar.style.display = "flex";
  }catch(e){
    // å¤±æ•—ã—ã¦ã‚‚ãƒšãƒ¼ã‚¸è‡ªä½“ã¯å‹•ã‹ã™
    fixSummaryBar.style.display = "none";
  }
}
  el.style.display = "";
  el.textContent = `salesï¼šjson ${lastSourceCounts.json.toLocaleString("ja-JP")} ä»¶ / firebase ${lastSourceCounts.firebase.toLocaleString("ja-JP")} ä»¶`;
}

  async function loadAll(force=false){
    authStateEl.textContent = "èª­ã¿è¾¼ã¿ä¸­â€¦";
    monthsEl.innerHTML = "";
    statsEl.innerHTML = "";

    try{
      await loadSales();
      await renderFixSummary();

      authStateEl.textContent = `OKï¼ˆsales: ${rawSales.length} ä»¶ï¼‰`;
      render();
    }catch(err){
      console.error(err);
      authStateEl.textContent = "èª­ã¿è¾¼ã¿å¤±æ•—";
      monthsEl.innerHTML = `<div class="empty">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br><span class="muted">Firestore ãƒ«ãƒ¼ãƒ« / ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ / createdAt ã®å‹ã‚’ç¢ºèªã—ã¦ã­ã€‚</span></div>`;
      toast("èª­ã¿è¾¼ã¿å¤±æ•—");
    }
  }

  function buildGroups(filtered){
    const map = new Map();
    for(const s of filtered){
      const key = s._ym;
      if(!map.has(key)){
        map.set(key, { monthKey:key, total:0, count:0, sales:[] });
      }
      const g = map.get(key);
      g.total += Number(s.total||0);
      g.count += 1;
      g.sales.push(s);
    }
    for(const g of map.values()){
      g.sales.sort((a,b)=> b.date - a.date);
    }
    const arr = [...map.values()].sort((a,b)=> b.monthKey.localeCompare(a.monthKey));
    return arr;
  }

  function applyFilters(){
    const y = Number(yearSel.value);
    const m = monthSel.value === "all" ? null : Number(monthSel.value);
    const q = normalizeText(qEl.value);

    return rawSales.filter(s=>{
      if(s.date.getTime()<=0) return false;
      if(s.date.getFullYear() !== y) return false;
      if(m && (s.date.getMonth()+1)!==m) return false;
      if(q && !s._search.includes(q)) return false;
      return true;
    });
  }

  function renderStats(list){
    const total = list.reduce((a,b)=> a + Number(b.total||0), 0);
    const cnt = list.length;

    statsEl.innerHTML = "";
    const p1 = document.createElement("div");
    p1.className = "pill";
    p1.textContent = `åˆè¨ˆï¼š${fmtMoney(total)}`;
    statsEl.appendChild(p1);

    const p2 = document.createElement("div");
    p2.className = "pill";
    p2.textContent = `ä»¶æ•°ï¼š${cnt.toLocaleString("ja-JP")} ä»¶`;
    statsEl.appendChild(p2);
  }

  function render(){
    if(!rawSales.length){
      monthsEl.innerHTML = `<div class="empty">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
      return;
    }

    const list = applyFilters();
    renderStats(list);

    const groups = buildGroups(list);
    lastBuilt = { list, groups };

    monthsEl.innerHTML = "";
    if(groups.length===0){
      monthsEl.innerHTML = `<div class="empty">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
      return;
    }

    for(const g of groups){
      const [yy,mm] = g.monthKey.split("-");
      const monthLabel = `${yy}å¹´${Number(mm)}æœˆ`;

      const det = document.createElement("details");
      det.className = "month";

      const sum = document.createElement("summary");

      const left = document.createElement("div");
      left.className = "mLeft";
      left.innerHTML = `<div class="mTitle">${monthLabel}</div><div class="mSub">ã‚¿ãƒƒãƒ—ã§æ˜ç´°</div>`;

      const right = document.createElement("div");
      right.className = "mRight";
      right.innerHTML = `<div class="mTotal">${fmtMoney(g.total)}</div><div class="mCount">${g.count} ä»¶</div>`;

      sum.appendChild(left);
      sum.appendChild(right);
      det.appendChild(sum);

      const salesWrap = document.createElement("div");
      salesWrap.className = "sales";

      for(const s of g.sales){
        const card = document.createElement("div");
        card.className = "saleCard";
        card.addEventListener("click", ()=>{
          openSaleDrawer(s);
        });

        const sRow = document.createElement("div");
        sRow.className = "saleSum";

        const sLeft = document.createElement("div");
        sLeft.className = "saleLeft";

        const top = document.createElement("div");
        top.className = "saleTop";

        const d = document.createElement("div");
        d.className = "saleDate";
        d.textContent = (s.orderDate ? s.orderDate : fmtYMDHM(s.date));

        top.appendChild(d);

        // è²©å£²æ–¹æ³•ï¼ˆchannelï¼‰
        if(s.channelLabel || s.channel){
          const b = document.createElement("span");
          b.className = "badge";
          b.textContent = (s.channelLabel || s.channel);
          top.appendChild(b);
        }

        if(s.isRefund){
          const b = document.createElement("span");
          b.className = "badge";
          b.textContent = "è¿”é‡‘";
          top.appendChild(b);
        }

        if(s.isBundled){
          const b = document.createElement("span");
          b.className = "badge";
          b.textContent = "ãƒãƒ³ãƒ‰ãƒ«ä¿®æ­£å¾…ã¡";
          top.appendChild(b);
        }

        const bottom = document.createElement("div");
        bottom.className = "saleBottom";

        const bn = document.createElement("div");
        bn.className = "saleBuyer";
        bn.textContent = (s.buyerName ?? "");

        const t = document.createElement("div");
        t.className = "saleTotal";
        t.textContent = fmtMoney(s.total);

        bottom.appendChild(bn);
        bottom.appendChild(t);

        sLeft.appendChild(top);
        sLeft.appendChild(bottom);

        const sRight = document.createElement("div");
        sRight.className = "saleRight";

        const editBtn = document.createElement("button");
        editBtn.className = "editBtn";
        editBtn.type = "button";
        editBtn.textContent = "âœ";
        editBtn.title = "ç·¨é›†";
        editBtn.addEventListener("click", (e)=>{
          e.preventDefault();
          e.stopPropagation();
          openEditChoiceModal(s);
        });

        sRow.appendChild(sLeft);
        sRow.appendChild(sRight);
        sRow.appendChild(editBtn);
        card.appendChild(sRow);

        salesWrap.appendChild(card);
      }

      det.appendChild(salesWrap);
      monthsEl.appendChild(det);
    }
  }

  function exportCsv(){
    if(!lastBuilt || !lastBuilt.list){
      toast("ãƒ‡ãƒ¼ã‚¿ãªã—");
      return;
    }

    const list = lastBuilt.list.slice().sort((a,b)=> b.date - a.date);

    const header = ["id","date","total","buyerName","channel","paymentMethod","kind","parentSaleId","isRefund","memo","itemName","qty","price","subtotal"];
    const lines = [header.join(",")];

    for(const s of list){
      const base = [
        csvCell(s.id),
        csvCell(fmtYMDHM(s.date)),
        csvCell(s.total),
        csvCell(s.buyerName),
        csvCell(s.channel),
        csvCell(s.paymentMethod),
        csvCell(s.kind),
        csvCell(s.parentSaleId),
        csvCell(s.isRefund ? "true" : ""),
        csvCell(s.memo)
      ];

      if(s.items?.length){
        for(const it of s.items){
          const row = base.concat([
            csvCell(it.name),
            csvCell(it.qty),
            csvCell(it.price),
            csvCell(it.subtotal)
          ]);
          lines.push(row.join(","));
        }
      }else{
        const row = base.concat([csvCell(""),csvCell(""),csvCell(""),csvCell("")]);
        lines.push(row.join(","));
      }
    }

    const blob = new Blob(["\\ufeff" + lines.join("\\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;

    const y = yearSel.value || "year";
    const m = monthSel.value === "all" ? "all" : pad2(monthSel.value);
    a.download = `monthly_sales_${y}_${m}.csv`;

    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    toast("CSVå‡ºã—ã¾ã—ãŸ");
  }

  function csvCell(v){
    const s = safeStr(v);
    if(/[",\\n]/.test(s)){
      return '"' + s.replaceAll('"','""') + '"';
    }
    return s;
  }

  // ======================
  //  ç·¨é›†ãƒ•ãƒ­ãƒ¼
  // ======================
  function closeModal(modal){
    if(modal && modal.remove) modal.remove();
  }

  // =========================
  // Bottom Drawer : Sale Detail
  // =========================
  let drawerEl = null;
  let drawerBackdropEl = null;

  function ensureDrawer(){
    if(drawerEl && drawerBackdropEl) return;

    drawerBackdropEl = document.createElement("div");
    drawerBackdropEl.className = "drawerBackdrop";
    drawerBackdropEl.addEventListener("click", ()=> closeSaleDrawer());

    drawerEl = document.createElement("div");
    drawerEl.className = "drawer";
    drawerEl.innerHTML = `
      <div class="drawerHeader">
        <div class="drawerTitle">
          <div class="big" id="drawerBig">æ˜ç´°</div>
          <div class="sub" id="drawerSub"></div>
</div>
        <button class="drawerClose" id="drawerCloseBtn" type="button">é–‰ã˜ã‚‹</button>
      </div>
      <div class="drawerBody" id="drawerBody"></div>
    `;
    drawerEl.querySelector("#drawerCloseBtn").addEventListener("click", ()=> closeSaleDrawer());

    document.body.appendChild(drawerBackdropEl);
    document.body.appendChild(drawerEl);
  }

  function closeSaleDrawer(){
    if(!drawerEl) return;
    drawerEl.classList.remove("open");
    drawerBackdropEl.classList.remove("open");
    // iOS èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¾©å¸°
    document.documentElement.style.overflow = "";
    document.body.style.overflow = "";
  }

  function openSaleDrawer(sale){
    ensureDrawer();

    // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æŠ‘æ­¢
    document.documentElement.style.overflow = "hidden";
    document.body.style.overflow = "hidden";

    const dateText = sale.orderDate ? sale.orderDate : fmtYMDHM(sale.date);
    const big = `${fmtMoney(sale.total)}`;
    const sub = `${dateText}${(sale.buyerName? " / " + sale.buyerName : "")}`;

    drawerEl.querySelector("#drawerBig").textContent = big;
    drawerEl.querySelector("#drawerSub").textContent = sub;

    const body = drawerEl.querySelector("#drawerBody");

    const kv = (k,v)=>`<div class="k">${escapeHtml(k)}</div><div class="v">${escapeHtml(v ?? "")}</div>`;

    const channel = sale.channelLabel || sale.channel || "";
    const payment = sale.paymentLabel || sale.paymentMethod || sale.paymentId || "";
    const kind = sale.kindLabel || sale.kindId || "";
    const venue = sale.venueLabel || sale.venue || "";
    const urgent = sale.urgentOptionLabel || sale.urgentOptionId || "";
    const memo = sale.memo || "";

    let html = `
      <div class="kv">
        ${kv("è³¼å…¥è€…", sale.buyerName ?? "")}
        ${kv("è³¼å…¥æ—¥ä»˜", dateText)}
                ${kv("è²©å£²æ–¹æ³•", channel)}
        ${kv("æ±ºæ¸ˆæ–¹æ³•", payment)}
        ${kv("é–‹å‚¬å ´æ‰€", venue)}
        ${kv("è²©å£²ç¨®åˆ¥", kind)}
        ${urgent ? kv("ç·Šæ€¥ã‚ªãƒ—ã‚·ãƒ§ãƒ³", urgent) : ""}
        ${memo ? kv("ãƒ¡ãƒ¢", memo) : ""}
                ${sale.parentSaleId ? kv("è¦ªSale", sale.parentSaleId) : ""}
        ${sale.isRefund ? kv("è¿”é‡‘", "ã¯ã„") : ""}
        ${sale.isBundled ? kv("ãƒãƒ³ãƒ‰ãƒ«ä¿®æ­£å¾…ã¡", "ã¯ã„ï¼ˆãƒãƒ³ãƒ‰ãƒ«æ›´æ–°ã§åæ˜ ï¼‰") : ""}
      </div>
    `;

    // items
    const rows = Array.isArray(sale.items) ? sale.items : [];
    html += `<div class="sectionTitle">å•†å“æ˜ç´°</div>`;
    if(!rows.length){
      html += `<div class="empty">æ˜ç´°ï¼ˆitemsï¼‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
    }else{
      html += `
        <table class="drawerTable">
          <thead>
            <tr>
              <th>å•†å“</th>
              <th class="right">æ•°é‡</th>
              <th class="right">å˜ä¾¡</th>
              <th class="right">å°è¨ˆ</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(it=>`
              <tr>
                <td>${escapeHtml(it.name || it.id || "")}</td>
                <td class="right">${escapeHtml(String(it.qty ?? ""))}</td>
                <td class="right">${escapeHtml(fmtMoney((it.unitPrice ?? it.price ?? 0)))}</td>
                <td class="right">${escapeHtml(fmtMoney(it.subtotal ?? 0))}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    // system fields (æŠ˜ã‚ŠãŸãŸã¿æ°—å‘³)
    const createdAt = sale.createdAtText || "";

    if(createdAt){
      html += `<div class="sectionTitle">ã‚·ã‚¹ãƒ†ãƒ </div>
        <div class="kv">
          ${createdAt ? kv("createdAt", createdAt) : ""}
        </div>
      `;
    }

    body.innerHTML = html;

    // ä¿®æ­£å±¥æ­´ä»¶æ•°
    if(sale.id){
}

    drawerBackdropEl.classList.add("open");
    drawerEl.classList.add("open");
  }


  function openEditChoiceModal(sale){
    const modal = document.createElement("div");
    modal.className = "modal";
    modal.innerHTML = `
      <div class="modalCard" role="dialog" aria-modal="true">
        <div class="modalTitle">ç·¨é›†å†…å®¹ã‚’é¸æŠ</div>
        <div class="modalSub">ã‚¯ãƒ¬ãƒ¼ãƒ è¿”é‡‘ï¼šãƒã‚¤ãƒŠã‚¹ã® sales ã‚’æ–°è¦ä½œæˆ / æ‰“ã¡é–“é•ã„ä¿®æ­£ï¼šç®¡ç†è€…ã¸ä¿®æ­£ä¾é ¼ã‚’é€ä¿¡ï¼ˆsalesã¯å¤‰æ›´ã—ã¾ã›ã‚“ï¼‰</div>
        <div class="modalBtns">
          <button class="modalBtn danger" id="btnClaim">
            <span>ã‚¯ãƒ¬ãƒ¼ãƒ è¿”é‡‘å‡¦ç†</span><span class="hint">è¿½è¨˜</span>
          </button>
          <button class="modalBtn primary" id="btnFix">
            <span>æ‰“ã¡é–“é•ã„ä¿®æ­£</span><span class="hint">ä¾é ¼</span>
          </button>
          <button class="modalBtn" id="btnCancel">
            <span>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span><span class="hint">é–‰ã˜ã‚‹</span>
          </button>
        </div>
      </div>
    `;
    modal.addEventListener("click", (e)=>{
      if(e.target === modal) closeModal(modal);
    });
    document.body.appendChild(modal);

    modal.querySelector("#btnCancel").onclick = ()=> closeModal(modal);

    // refund ã® sales ã«ã¯è¿”é‡‘å‡¦ç†ã‚’é‡ã­ãªã„ï¼ˆå¿…è¦ãªã‚‰æ‰“ã¡é–“é•ã„ä¿®æ­£ã§ç·¨é›†ï¼‰
    if(sale.isRefund){
      const bc = modal.querySelector("#btnClaim");
      bc.disabled = true;
      bc.style.opacity = "0.45";
      bc.style.pointerEvents = "none";
      bc.querySelector(".hint").textContent = "ä¸å¯";
    }

    // ãƒãƒ³ãƒ‰ãƒ«ç”±æ¥ã¯æ‰“ã¡é–“é•ã„ä¿®æ­£ï¼ˆFirestoreä¸Šæ›¸ãï¼‰ä¸å¯ï¼šãƒãƒ³ãƒ‰ãƒ«æ›´æ–°å¾…ã¡
    if(sale.isBundled){
      const bf = modal.querySelector("#btnFix");
      bf.disabled = true;
      bf.style.opacity = "0.55";
      bf.style.pointerEvents = "none";
      bf.querySelector(".hint").textContent = "ãƒãƒ³ãƒ‰ãƒ«ä¿®æ­£å¾…ã¡";
    }

    modal.querySelector("#btnClaim").onclick = ()=>{
      closeModal(modal);
      openClaimEditor(sale);
    };

    modal.querySelector("#btnFix").onclick = ()=>{
      closeModal(modal);
      openFullEditEditor(sale);
    };
  }
function openClaimEditor(sale){
  const modal = document.createElement("div");
  modal.className = "modal";

  modal.innerHTML = `
    <div class="modalCard" role="dialog" aria-modal="true">
      <div class="modalTitle">ã‚¯ãƒ¬ãƒ¼ãƒ è¿”é‡‘å‡¦ç†ï¼ˆãƒã‚¤ãƒŠã‚¹ sales ä½œæˆï¼‰</div>
      <div class="modalSub">å…ƒã® sales ã¯å¤‰æ›´ã—ã¾ã›ã‚“ã€‚ç´ã¥ãã€Œè¿”é‡‘ç”¨ã® salesï¼ˆãƒã‚¤ãƒŠã‚¹ï¼‰ã€ã‚’æ–°è¦ä½œæˆã—ã¾ã™ã€‚</div>

      <div class="editKvWrap">
  <div class="kv editKv">
    <div class="k">è³¼å…¥è€…</div>
    <div class="v">
      <div class="editWrap" data-edit="buyerName">
        <span class="disp" id="buyerNameDisp"></span>
        <input class="editInput" id="buyerName" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ" />
      </div>
      ${admin && pending && ftBuyer ? `<div class="diffLine">${escapeHtml(ftBuyer)} <label class="approveC"><input type="checkbox" data-appr="buyerName" checked>è¨±å¯</label></div>` : ``}
    </div>

    <div class="k">è³¼å…¥æ—¥ä»˜</div>
    <div class="v">
      <div class="editWrap" data-edit="date">
        <span class="disp" id="createdAtDisp"></span>
        <input class="editInput" id="createdAt" type="datetime-local" />
      </div>
      ${admin && pending ? `<div class="diffLine"><label class="approveC"><input type="checkbox" data-appr="date" checked>è¨±å¯</label></div>` : ``}
    </div>

    <div class="k">è²©å£²æ–¹æ³•</div>
    <div class="v">
      <div class="editWrap" data-edit="channel">
        <span class="disp" id="channelDisp"></span>
        <select class="editInput" id="channelSel">
          ${buildOptionsHTML(optChannels, initChannel)}
        </select>
        <input class="editInput" id="channelCustom" style="display:none;margin-top:6px;" value="" placeholder="è‡ªç”±å…¥åŠ›ï¼ˆä¾‹ï¼šãƒãƒ«ã‚·ã‚§ / ã‚¤ãƒ³ã‚¹ã‚¿ï¼‰" />
      </div>
      ${admin && pending && ftChan ? `<div class="diffLine">${escapeHtml(ftChan)} <label class="approveC"><input type="checkbox" data-appr="channel" checked>è¨±å¯</label></div>` : (admin && pending ? `<div class="diffLine"><label class="approveC"><input type="checkbox" data-appr="channel" checked>è¨±å¯</label></div>` : ``)}
    </div>

    <div class="k">æ±ºæ¸ˆæ–¹æ³•</div>
    <div class="v">
      <div class="editWrap" data-edit="paymentMethod">
        <span class="disp" id="paymentMethodDisp"></span>
        <select class="editInput" id="paymentMethodSel">
          ${buildOptionsHTML(optPaymentMethods, initPayment)}
        </select>
        <input class="editInput" id="paymentMethodCustom" style="display:none;margin-top:6px;" value="" placeholder="è‡ªç”±å…¥åŠ›ï¼ˆä¾‹ï¼šç¾é‡‘ / PayPayï¼‰" />
      </div>
      ${admin && pending && ftPay ? `<div class="diffLine">${escapeHtml(ftPay)} <label class="approveC"><input type="checkbox" data-appr="paymentMethod" checked>è¨±å¯</label></div>` : (admin && pending ? `<div class="diffLine"><label class="approveC"><input type="checkbox" data-appr="paymentMethod" checked>è¨±å¯</label></div>` : ``)}
    </div>

    <div class="k">é–‹å‚¬å ´æ‰€</div>
    <div class="v">
      <div class="readonlyLine">${escapeHtml(sale.venueLabel || sale.venue || "")}</div>
    </div>

    <div class="k">è²©å£²ç¨®åˆ¥</div>
    <div class="v">
      <div class="editWrap" data-edit="kind">
        <span class="disp" id="kindDisp"></span>
        <select class="editInput" id="kindSel">
          <option value="">-</option>
          <option value="stock">stock</option>
          <option value="order">order</option>
        </select>
      </div>
      ${admin && pending ? `<div class="diffLine"><label class="approveC"><input type="checkbox" data-appr="kind" checked>è¨±å¯</label></div>` : ``}
    </div>

    <div class="k">é…é€</div>
    <div class="v">
      <div class="editWrap" data-edit="shippingOption">
        <span class="disp" id="shippingOptionDisp"></span>
        <input class="editInput" id="shippingOption" placeholder="ä¾‹ï¼šæŒã¡å¸°ã‚Š" />
      </div>
      ${admin && pending && ftShip ? `<div class="diffLine">${escapeHtml(ftShip)} <label class="approveC"><input type="checkbox" data-appr="shippingOption" checked>è¨±å¯</label></div>` : (admin && pending ? `<div class="diffLine"><label class="approveC"><input type="checkbox" data-appr="shippingOption" checked>è¨±å¯</label></div>` : ``)}
    </div>

    <div class="k">ãƒ¡ãƒ¢</div>
    <div class="v">
      <div class="editWrap" data-edit="memo">
        <span class="disp" id="memoDisp"></span>
        <textarea class="editInput" id="memo" placeholder="ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰"></textarea>
      </div>
      ${admin && pending && ftMemo ? `<div class="diffLine">${escapeHtml(ftMemo)} <label class="approveC"><input type="checkbox" data-appr="memo" checked>è¨±å¯</label></div>` : (admin && pending ? `<div class="diffLine"><label class="approveC"><input type="checkbox" data-appr="memo" checked>è¨±å¯</label></div>` : ``)}
    </div>

    ${admin && pending ? `` : `
    <div class="k">ä¾é ¼ã‚³ãƒ¡ãƒ³ãƒˆ</div>
    <div class="v">
      <div class="editWrap alwaysOn">
        <textarea class="editInput always" id="requestText" placeholder="ä¾‹ï¼šæ±ºæ¸ˆæ–¹æ³•ã‚’ç¾é‡‘â†’PayPayã«ã€æ—¥ä»˜ã‚’12/28â†’12/27ã«ä¿®æ­£ã—ã¦ãã ã•ã„"></textarea>
      </div>
    </div>
    `}

  </div>

  <div class="sectionTitle">å•†å“æ˜ç´°</div>
  <div class="itemsBox">
    <table class="drawerTable" id="itemsTbl">
      <thead>
        <tr>
          <th>å•†å“</th>
          <th class="right">æ•°é‡</th>
          <th class="right">å˜ä¾¡</th>
          <th class="right">å°è¨ˆ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="miniActions">
      <button class="sbtn" id="addItem">ï¼‹ è¡Œè¿½åŠ </button>
      <button class="sbtn danger" id="delItem">ï¼ æœ€çµ‚è¡Œå‰Šé™¤</button>
      ${admin && pending ? `<label class="approveC" style="margin-left:auto;"><input type="checkbox" data-appr="items" checked>è¨±å¯</label>` : ``}
    </div>
  </div>

  <div class="kv editKv footKv" style="margin-top:10px;">
    <div class="k">åˆè¨ˆ</div>
    <div class="v">
      <div class="editWrap" data-edit="total">
        <span class="disp" id="totalDisp"></span>
        <input class="editInput" id="total" type="number" step="1" />
      </div>
      ${admin && pending && ftTotal ? `<div class="diffLine">${escapeHtml(ftTotal)} <label class="approveC"><input type="checkbox" data-appr="total" checked>è¨±å¯</label></div>` : (admin && pending ? `<div class="diffLine"><label class="approveC"><input type="checkbox" data-appr="total" checked>è¨±å¯</label></div>` : ``)}
    </div>

    <div class="k">ID</div>
    <div class="v"><div class="readonlyLine">${escapeHtml(safeStr(sale.id))}</div></div>
  </div>

  <div class="miniActions" style="margin-top:14px;">
    <button class="sbtn primary" id="save">${admin && pending ? "ä¿å­˜ã—ã¦åæ˜ ï¼ˆå®Œäº†ï¼‰" : "ä¿å­˜ï¼ˆä¾é ¼é€ä¿¡ï¼‰"}</button>
    <button class="sbtn" id="cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>
      </div>
    </div>
    `;

    modal.addEventListener("click", (e)=>{
      if(e.target === modal) closeModal(modal);
    });
    document.body.appendChild(modal);

    // kind åˆæœŸå€¤
    const kindSel = modal.querySelector("#kindSel");
    kindSel.value = initKind || "";

    const tbody = modal.querySelector("#itemsTbl tbody");

    const paySel = modal.querySelector("#paymentMethodSel");
    const payCus = modal.querySelector("#paymentMethodCustom");
    const chSel = modal.querySelector("#channelSel");
    const chCus = modal.querySelector("#channelCustom");

    const syncCustomVisibility = ()=>{
      payCus.style.display = (paySel.value==="__custom__") ? "block" : "none";
      chCus.style.display = (chSel.value==="__custom__") ? "block" : "none";
    };
    syncCustomVisibility();
    paySel.onchange = syncCustomVisibility;
    chSel.onchange = syncCustomVisibility;

    // ---- æ˜ç´°è©³ç´°ã¨åŒã˜è¦‹ãŸç›®ï¼šè¡¨ç¤ºï¼ˆdispï¼‰â†”ç·¨é›†ï¼ˆinput/select/textareaï¼‰åˆ‡ã‚Šæ›¿ãˆ
    const setDisp = (id, val)=>{
      const el = modal.querySelector(id);
      if(el) el.textContent = (val==null || String(val).trim()==="") ? "-" : String(val);
    };

    // åˆæœŸå€¤ã‚’æµã—è¾¼ã¿
    modal.querySelector("#buyerName").value = initBuyer;
    modal.querySelector("#createdAt").value = initDateVal;
    modal.querySelector("#shippingOption").value = initShip;
    modal.querySelector("#memo").value = initMemo;
    modal.querySelector("#total").value = String(Math.round(initTotal));

    // selectåˆæœŸ
    paySel.value = initPayment || "";
    chSel.value = initChannel || "";
    kindSel.value = initKind || "";
    syncCustomVisibility();

    const refreshDisp = ()=>{
      const buyerName = safeStr(modal.querySelector("#buyerName").value||"").trim();
      const createdAtStr = safeStr(modal.querySelector("#createdAt").value||"");
      const pm = (paySel.value==="__custom__" ? safeStr(payCus.value||"").trim() : safeStr(paySel.value||"").trim());
      const ch = (chSel.value==="__custom__" ? safeStr(chCus.value||"").trim() : safeStr(chSel.value||"").trim());
      const kind = safeStr(kindSel.value||"").trim() || "-";
      const ship = safeStr(modal.querySelector("#shippingOption").value||"").trim();
      const memo = safeStr(modal.querySelector("#memo").value||"").trim();
      const total = Number(modal.querySelector("#total").value||0);

      setDisp("#buyerNameDisp", buyerName);
      setDisp("#createdAtDisp", createdAtStr ? createdAtStr.replace("T"," ") : "-");
      setDisp("#paymentMethodDisp", pm || "-");
      setDisp("#channelDisp", ch || "-");
      setDisp("#kindDisp", kind);
      setDisp("#shippingOptionDisp", ship);
      setDisp("#memoDisp", memo);
      setDisp("#totalDisp", fmtMoney(Math.round(total||0)));
    };

    // ã‚¿ãƒƒãƒ—ã§ç·¨é›†ã«åˆ‡æ›¿ï¼ˆblurã§æˆ»ã™ï¼‰
    Array.from(modal.querySelectorAll(".editWrap")).forEach(w=>{
      if(w.classList.contains("alwaysOn")) return;
      w.addEventListener("click", ()=>{
        w.classList.add("editing");
        const focusable = w.querySelector("input,select,textarea");
        if(focusable) setTimeout(()=> focusable.focus(), 0);
      });
      w.addEventListener("focusout", (e)=>{
        // å¤–ã«å‡ºãŸã‚‰é–‰ã˜ã‚‹ï¼ˆã‚»ãƒ¬ã‚¯ãƒˆã®ã‚¯ãƒªãƒƒã‚¯ã‚‚è€ƒæ…®ã—ã¦å°‘ã—é…å»¶ï¼‰
        setTimeout(()=>{
          if(!w.contains(document.activeElement)){
            w.classList.remove("editing");
            refreshDisp();
          }
        }, 80);
      });
    });

    paySel.addEventListener("change", ()=>{ refreshDisp(); });
    chSel.addEventListener("change", ()=>{ refreshDisp(); });
    kindSel.addEventListener("change", ()=>{ refreshDisp(); });
    modal.querySelector("#buyerName").addEventListener("input", refreshDisp);
    modal.querySelector("#createdAt").addEventListener("input", refreshDisp);
    modal.querySelector("#shippingOption").addEventListener("input", refreshDisp);
    modal.querySelector("#memo").addEventListener("input", refreshDisp);
    modal.querySelector("#total").addEventListener("input", refreshDisp);

    refreshDisp();

    function renderItems(){
      items = recalcItems(items);
      tbody.innerHTML = items.map((it, idx)=>`
        <tr>
          <td><input data-i="${idx}" data-k="name" value="${escapeHtml(it.name||"")}" placeholder="å•†å“å" /></td>
          <td><input data-i="${idx}" data-k="qty" type="number" inputmode="numeric" min="0" step="1" value="${escapeHtml(String(it.qty||0))}" /></td>
          <td><input data-i="${idx}" data-k="price" type="number" inputmode="numeric" step="1" value="${escapeHtml(String(it.price||0))}" /></td>
          <td class="right">${yen(it.subtotal||0)}</td>
        </tr>
      `).join("");

      // total ã¯ items ã‹ã‚‰å†è¨ˆç®—ã—ã¦è‡ªå‹•ã§å…¥ã‚Œã‚‹ï¼ˆæ‰‹å…¥åŠ›ã—ãŸã„ãªã‚‰å¾Œã§ã‚¹ã‚¤ãƒƒãƒè¶³ã™ï¼‰
      const t = items.reduce((a,b)=>a+Number(b.subtotal||0),0);
      modal.querySelector("#total").value = String(Math.round(t));
    }

    tbody.addEventListener("input", (e)=>{
      const inp = e.target;
      if(!(inp instanceof HTMLInputElement)) return;
      const i = Number(inp.dataset.i);
      const k = inp.dataset.k;
      if(!Number.isFinite(i) || !k) return;

      if(k==="name"){
        items[i].name = inp.value;
      }else if(k==="qty"){
        items[i].qty = Number(inp.value||0);
      }else if(k==="price"){
        items[i].price = Number(inp.value||0);
      }
      renderItems();
    });

    modal.querySelector("#addItem").onclick = ()=>{
      items.push({ name:"", qty:1, price:0, subtotal:0 });
      renderItems();
    };
    modal.querySelector("#delItem").onclick = ()=>{
      if(items.length<=1){
        toast("ã“ã‚Œä»¥ä¸Šæ¸›ã‚‰ã›ãªã„");
        return;
      }
      items.pop();
      renderItems();
    };

    const cancelTop = modal.querySelector("#cancelTop");
    if(cancelTop) cancelTop.onclick = ()=> closeModal(modal);

    modal.querySelector("#cancel").onclick = ()=> closeModal(modal);

    modal.querySelector("#save").onclick = async ()=>{
      try{
        const buyerName = safeStr(modal.querySelector("#buyerName").value || "").trim();
        const createdAtStr = safeStr(modal.querySelector("#createdAt").value || "");
        const paymentMethod = (paySel.value === "__custom__"
          ? safeStr(payCus.value || "").trim()
          : safeStr(paySel.value || "").trim());
        const channel = (chSel.value === "__custom__"
          ? safeStr(chCus.value || "").trim()
          : safeStr(chSel.value || "").trim());
        const memo = safeStr(modal.querySelector("#memo").value || "").trim();
        const shippingOption = safeStr(modal.querySelector("#shippingOption").value || "").trim();
        const kind = safeStr(kindSel.value || "").trim();

        const createdAtDate = parseLocalInputValue(createdAtStr);
        if(!createdAtStr || isNaN(createdAtDate.getTime())){
          toast("æ—¥ä»˜ãŒä¸æ­£");
          return;
        }

        // items æ­£è¦åŒ–
        items = recalcItems(items).map(it=>({
          name: safeStr(it.name||"").trim(),
          qty: Number(it.qty||0),
          price: Number(it.price||0),
          subtotal: Number(it.subtotal||0)
        })).filter(it=> it.name || it.qty || it.price);

        const total = Number(modal.querySelector("#total").value || 0);

        if(!items.length){
          toast("æ˜ç´°ãŒç©ºã§ã™");
          return;
        }
        if(!(total>=0)){
          toast("åˆè¨ˆãŒä¸æ­£");
          return;
        }

        if(admin && pending){
          // ---- ç®¡ç†è€…ï¼šè¨±å¯ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸã‚‚ã®ã ã‘ sales ã«åæ˜ 
          const allowed = new Set(
            Array.from(modal.querySelectorAll('input[type="checkbox"][data-appr]'))
              .filter(ch=>ch.checked)
              .map(ch=>ch.getAttribute("data-appr"))
          );

          const updateData = {};
          if(allowed.has("buyerName")) updateData.buyerName = buyerName;
          if(allowed.has("paymentMethod")) updateData.paymentMethod = paymentMethod;
          if(allowed.has("channel")) updateData.channel = channel;
          if(allowed.has("memo")) updateData.memo = memo;
          if(allowed.has("shippingOption")) updateData.shippingOption = shippingOption;
          if(allowed.has("kind")) updateData.kind = kind;

          if(allowed.has("date")){
            updateData.orderDate = fmtYMDDate(createdAtDate);
            updateData.orderDateMs = msAtLocalMidnight(createdAtDate);
            updateData.clientCreatedAt = createdAtDate.getTime();
          }

          if(allowed.has("items")){
            updateData.items = items;
          }
          if(allowed.has("total")){
            updateData.total = Math.round(total);
          }else{
            // total ã®è¨±å¯ãŒå¤–ã‚Œã¦ã‚‹ã®ã« items ã ã‘åæ˜ ã€ã¿ãŸã„ãªæ™‚ã«ã‚ºãƒ¬ãŒå‡ºã‚‹ã®ã‚’é¿ã‘ã‚‹
            if(allowed.has("items")){
              updateData.total = Math.round(items.reduce((a,b)=>a+Number(b.subtotal||0),0));
            }
          }

          // ä½•ã‚‚è¨±å¯ã—ãªã„å ´åˆã¯ sales ã‚’è§¦ã‚‰ãšã€Œå®Œäº†ã€ã«ã§ãã‚‹ï¼ˆé‹ç”¨æ¬¡ç¬¬ï¼‰
          if(Object.keys(updateData).length > 0){
            await updateDoc(doc(db, "sales", sale.id), updateData);
          }

          await updateDoc(doc(db, "sales_fix_requests", pending.id), {
            status: "å®Œäº†",
            resolvedAt: serverTimestamp(),
            resolvedBy: (currentUser?.email || currentUser?.uid || "")
          });

          toast("åæ˜ ã—ã¦å®Œäº†ã«ã—ã¾ã—ãŸ");
          closeModal(modal);
          await loadAll(true);
          return;
        }

        // ---- ã‚¹ã‚¿ãƒƒãƒ•ï¼šä¿®æ­£ä¾é ¼ã‚’é€ã‚‹ï¼ˆsalesã¯è§¦ã‚‰ãªã„ï¼‰
        const requestText = safeStr(modal.querySelector("#requestText").value || "").trim();
        if(!requestText){
          toast("ä¾é ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥ã‚Œã¦ã­");
          return;
        }

        await addDoc(collection(db, "sales_fix_requests"), {
          saleId: sale.id,
          status: "ä¾é ¼ä¸­",
          requestText,
          createdAt: serverTimestamp(),
          createdBy: (currentUser?.email || currentUser?.uid || ""),

          snapshot: {
            buyerName: sale.buyerName || "",
            orderDate: sale.orderDate || "",
            channel: sale.channel || "",
            paymentMethod: sale.paymentMethod || "",
            memo: sale.memo || "",
            shippingOption: sale.shippingOption || "",
            kind: sale.kind || "",
            total: Number(sale.total || 0),
            items: (sale.items || []).map(it=>({
              name: it.name || "",
              qty: Number(it.qty||0),
              price: Number(it.price||0),
              subtotal: Number(it.subtotal||0)
            }))
          },

          proposed: {
            buyerName,
            createdAtLocal: createdAtDate.toISOString(),
            paymentMethod,
            channel,
            memo,
            shippingOption,
            kind,
            items,
            total
          }
        });

        toast("ä¿å­˜ã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã¸ç¢ºèªä¾é ¼ã®é€£çµ¡ã‚’ãŠé¡˜ã„ã—ã¾ã™");
        closeModal(modal);
        await loadAll(true);

      }catch(err){
        console.error(err);
        toast("ä¿å­˜å¤±æ•—ï¼ˆãƒ«ãƒ¼ãƒ«ç¢ºèªï¼‰");
      }
    };

    // åˆæœŸãƒ¬ãƒ³ãƒ€
    renderItems();
  }


  // ---- auth gate (ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãªã‘ã‚Œã° login.html ã¸)
  onAuthStateChanged(auth, (user)=>{
    if(!user){
      authStateEl.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³ â†’ login.html ã¸";
      setTimeout(()=> location.href = "login.html", 250);
      return;
    }
    currentUser = user;
    isAdminUser = isAdminEmail(user.email);
    authStateEl.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${user.email || "user"}${isAdminUser ? "ï¼ˆç®¡ç†è€…ï¼‰" : ""}`;
    loadAll();
  });
</script>

</body>
</html>
