<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>e.nue æ”¯å‡ºç®¡ç†</title>
  <style>
    :root{
      /* ===== base (monthly beige+white) ===== */
      --bg0:#f3ede4;
      --bg1:#f7f2ea;
      --bg2:#ffffff;

      --glass: rgba(255,255,255,.78);
      --glass2: rgba(255,255,255,.92);

      --line: rgba(120,90,40,.18);
      --line2: rgba(120,90,40,.28);

      --shadow: 0 18px 40px rgba(120,90,40,.18);

      --text:#2f2a22;
      --sub: rgba(47,42,34,.65);
      --muted: rgba(47,42,34,.45);

      --accent:#2f2a22;
      --good:#4fa38a;
      --warn:#d89a2a;

      --r:18px;
      --maxw:980px;
    }
*{ box-sizing:border-box; }
    html,body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI","Noto Sans JP",sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(255,255,255,.55), transparent 55%),
        radial-gradient(1200px 800px at 90% 0%, rgba(255,255,255,.35), transparent 52%),
        linear-gradient(135deg,var(--bg0),var(--bg1));
    }

body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI","Noto Sans JP",sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(255,255,255,.08), transparent 55%),
        radial-gradient(1200px 800px at 90% 0%, rgba(255,255,255,.06), transparent 52%),
        linear-gradient(135deg,var(--bg0),var(--bg2));
    }

    .safe{
      padding:max(14px,env(safe-area-inset-top)) 14px max(18px,env(safe-area-inset-bottom));
      max-width:var(--maxw);
      margin:0 auto;
    }

    .topbar{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin:6px 0 14px; }
    .brand{ font-weight:1000; letter-spacing:.06em; }

    .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      appearance:none;
      border:1px solid var(--line);
      background:rgba(255,255,255,.85);
      color:var(--text);
      border-radius:999px;
      padding:10px 12px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      -webkit-tap-highlight-color: transparent;
    }
    .pill:active{ transform: translateY(1px); }
    .pillPrimary{ background:rgba(255,255,255,.92); color:#0b0d12; border-color: rgba(255,255,255,.92); }

    .card{
      background:linear-gradient(180deg,var(--glass),var(--glass2));
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .head{ padding:14px 14px 10px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; gap:10px; }
    .h1{ font-weight:1000; font-size:14px; letter-spacing:.06em; }
    .sub{ font-size:12px; color:var(--muted); margin-top:2px; }

    .filters{ padding:12px 14px 14px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .field{
      display:flex; gap:8px; align-items:center;
      background:rgba(255,255,255,.85);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 10px;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
    }
    .field label{ font-weight:1000; font-size:12px; color:var(--sub); white-space:nowrap; }
    .field input,.field select{
      appearance:none;
      border:1px solid var(--line2);
      background:rgba(255,255,255,.85);
      color:var(--text);
      border-radius:12px;
      padding:10px 10px;
      font-weight:900;
      font-size:12px;
      outline:none;
    }
    .field select{ min-width: 150px; }
    .field input{ min-width: 140px; }

    .sumRow{ padding:0 14px 14px; display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; justify-content:space-between; }
    .sumBox{
      background:rgba(255,255,255,.85);
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 12px;
      min-width: 210px;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
    }
    .sumBox .k{ font-size:11px; font-weight:1000; color:var(--muted); }
    .sumBox .v{ font-size:18px; font-weight:1100; margin-top:2px; }

    .tableWrap{ padding:0 22px 16px; overflow-x:auto; -webkit-overflow-scrolling:touch; }
    table{ width:100%; border-collapse:collapse; table-layout:fixed; min-width:880px; }
    th,td{ padding:10px; font-size:13px; vertical-align:middle; white-space:nowrap; }
    th{ text-align:left; background:rgba(255,255,255,.75); position:sticky; top:0; z-index:1; }
    tr+tr td{ border-top:1px solid var(--line); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-weight:900; }
    .mutedText{ color:var(--muted); font-weight:900; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.85);
      font-size:12px;
      font-weight:900;
      color:var(--sub);
    }
    .badge.good{ border-color: rgba(56,217,169,.35); color: rgba(56,217,169,.95); background: rgba(56,217,169,.10); }
    .badge.warn{ border-color: rgba(255,176,32,.35); color: rgba(255,176,32,.95); background: rgba(255,176,32,.10); }

    .tap{
      display:inline-flex; align-items:center; gap:6px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line2);
      background:rgba(255,255,255,.78);
      color:var(--text);
      font-weight:1000;
      cursor:pointer;
      user-select:none;
    }
    .tap:active{ transform: translateY(1px); }

    .empty{ padding:18px 14px; color:var(--muted); font-weight:900; }

    /* Bottom sheet */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:flex-end; z-index:999; padding:10px; }
    .overlay.show{ display:flex; }
    .sheet{ width:min(820px,100%); margin:0 auto; background: rgba(255,255,255,.95); border:1px solid var(--line); border-radius:22px; box-shadow:0 30px 90px rgba(0,0,0,.55); overflow:hidden; display:flex; flex-direction:column; max-height: calc(100vh - 20px); }
    .sheetHead{ padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.10); display:flex; align-items:center; justify-content:space-between; gap:10px; font-weight:1000; }
    .sheetBody{ padding:12px 14px; overflow-y:auto; -webkit-overflow-scrolling:touch; flex:1 1 auto; }
    .sheetFoot{ padding:12px 14px; border-top:1px solid var(--line); display:flex; gap:10px; }
    .btn{ flex:1; border:none; border-radius:14px; padding:12px 12px; font-weight:1000; cursor:pointer; }
    .btnGhost{ background:rgba(255,255,255,.08); color:var(--text); }
    .btnPrimary{ background:rgba(255,255,255,.92); color:#0b0d12; }
    .btnDanger{ background:rgba(255,107,107,.18); color:#ffb3b3; border:1px solid rgba(255,107,107,.30); }
    .btn:active{ transform: translateY(1px); }

    .grid2{ display:grid; grid-template-columns: 120px 1fr; gap:10px 12px; font-size:13px; align-items:center; }
    .grid2 .k{ color:var(--muted); font-weight:1000; }
    .grid2 input, .grid2 select, .grid2 textarea{
      appearance:none;
      border:1px solid var(--line2);
      background:rgba(255,255,255,.85);
      color:var(--text);
      border-radius:12px;
      padding:10px 10px;
      font-weight:900;
      font-size:13px;
      outline:none;
      width:100%;
    }
    .grid2 textarea{ min-height: 76px; resize: vertical; font-weight:800; }

    .lines{ margin-top:12px; border-top:1px solid var(--line); padding-top:12px; }
    .lineHead{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .lineTitle{ font-weight:1000; font-size:13px; color:var(--sub); }
    .lineTableWrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; margin-top:10px; }
    .lineTable{ width:100%; min-width: 820px; border-collapse:collapse; table-layout:fixed; }
    .lineTable th,.lineTable td{ padding:8px; font-size:12px; white-space:nowrap; }
    .lineTable th{ background:rgba(255,255,255,.85); }
    .lineTable tr+tr td{ border-top:1px solid var(--line); }
    .lineInp{ width:100%; }
    .mini{ padding:8px 10px; border-radius:12px; border:1px solid var(--line2); background:rgba(255,255,255,.85); color:var(--text); font-weight:900; cursor:pointer; }

    .unitWrap{ display:flex; align-items:center; gap:6px; }
    .signBtn{
      flex:0 0 auto;
      width:34px;
      height:34px;
      border-radius:12px;
      border:1px solid var(--line2);
      background:rgba(255,255,255,.90);
      color:var(--text);
      font-weight:1100;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,.12);
      -webkit-tap-highlight-color: transparent;
    }
    .signBtn:active{ transform: translateY(1px); }

    .mini:active{ transform: translateY(1px); }

    .checkRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .check{ display:flex; gap:8px; align-items:center; border:1px solid var(--line); background:rgba(255,255,255,.85); padding:10px 12px; border-radius:14px; font-weight:1000; }
    .check input{ width:18px; height:18px; }

    /* ===== é ˜åç”³è«‹ï¼šãƒ©ã‚¸ã‚ªé¢¨ãƒã‚§ãƒƒã‚¯ï¼ˆä¸¸ã®ä¸­ã«é»’ä¸¸ï¼‰ ===== */
    .claimOption{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.85);
      border-radius:14px;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
    }
    .claimOption:active{ transform: translateY(1px); }
    .claimOption input{ display:none; }
    .claimCircle{
      width:18px;
      height:18px;
      border-radius:50%;
      border:2px solid var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
    }
    .claimCircle::after{
      content:"";
      width:8px;
      height:8px;
      border-radius:50%;
      background:var(--text);
      opacity:0;
      transition: opacity .15s ease;
    }
    .claimOption input:checked + .claimCircle::after{
      opacity:1;
    }

    @media (max-width: 420px){
      .grid2{ grid-template-columns: 1fr; }
      .field input{ min-width: 120px; }
      .field select{ min-width: 140px; }
      .sumBox{ min-width: 180px; }
    }
  
.unit-price.vertical {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.unit-price.vertical .pm-btn {
  align-self: flex-start;
}
</style>

</head>
<body>
  <div class="safe">
    <div class="topbar">
      <div class="brand">e.nue</div>
      <div class="actions">
        <button class="pill" id="backBtn" type="button">â† æˆ»ã‚‹</button>
        <button class="pill" id="claimsBtn" type="button">ğŸ§¾ é ˜åç”³è«‹</button>
        <button class="pill pillPrimary" id="addBtn" type="button">ï¼‹ ãƒ¬ã‚·ãƒ¼ãƒˆè¿½åŠ </button>
      </div>
    </div>

    <main class="card">
      <div class="head">
        <div>
          <div class="h1">æ”¯å‡ºç®¡ç†ï¼ˆãƒ¬ã‚·ãƒ¼ãƒˆå˜ä½ï¼‰</div>
          <div class="sub">è³¼å…¥åº—ã”ã¨ã«ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ç™»éŒ² â†’ æ˜ç´°è¡Œã«ã‚«ãƒ†ã‚´ãƒªã‚’ä»˜ä¸</div>
        </div>
      </div>

      <div class="filters">
        <div class="field">
          <label for="yearSel">å¹´</label>
          <select id="yearSel"></select>
        </div>
        <div class="field">
          <label for="monthSel">æœˆ</label>
          <select id="monthSel"></select>
        </div>
        <div class="field">
          <label for="qInput">æ¤œç´¢</label>
          <input id="qInput" type="text" placeholder="åº—å/ãƒ¡ãƒ¢/æ˜ç´°å" />
        </div>
        <button class="pill" id="refreshBtn" type="button">æ›´æ–°</button>
      </div>

      <div class="sumRow">
        <div class="sumBox">
          <div class="k">è¡¨ç¤ºä¸­ åˆè¨ˆ</div>
          <div class="v" id="sumAmount">â€”</div>
        </div>
        <div class="sumBox">
          <div class="k">è¡¨ç¤ºä»¶æ•°ï¼ˆãƒ¬ã‚·ãƒ¼ãƒˆï¼‰</div>
          <div class="v" id="sumCount">â€”</div>
        </div>
      </div>

      <div class="tableWrap">
        <table aria-label="receipts table">
          <colgroup>
            <col style="width: 14%;" />
            <col style="width: 20%;" />
            <col style="width: 14%;" />
            <col style="width: 34%;" />
            <col style="width: 18%;" />
          </colgroup>
          <thead>
            <tr>
              <th>æ—¥ä»˜</th>
              <th>è³¼å…¥åº—</th>
              <th>åˆè¨ˆ</th>
              <th>ãƒ¡ãƒ¢</th>
              <th style="text-align:right;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="empty" id="empty" style="display:none;">è¡¨ç¤ºã§ãã‚‹æ”¯å‡ºãŒã‚ã‚Šã¾ã›ã‚“</div>
      </div>
    </main>
  </div>

  <!-- Sheet -->
  <div class="overlay" id="overlay" aria-modal="true" role="dialog">
    <div class="sheet" onclick="event.stopPropagation()">
      <div class="sheetHead">
        <div id="sheetTitle">ç·¨é›†</div>
        <button class="btn btnGhost" id="closeBtn" style="flex:0 0 auto;">é–‰ã˜ã‚‹</button>
      </div>
      <div class="sheetBody" id="sheetBody"></div>
      <div class="sheetFoot" id="sheetFoot" style="display:none;">
        <button class="btn btnGhost" id="cancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btnPrimary" id="saveBtn">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      getDocs,
      addDoc,
      updateDoc,
      deleteDoc,
      query,
      where,
      orderBy,
      limit,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    /* ===== Firebase ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyAhPCgPoJK6S6BWVcBZOruYqMPXVQXQFRk",
      authDomain: "handmade-pos.firebaseapp.com",
      projectId: "handmade-pos",
      storageBucket: "handmade-pos.firebasestorage.app",
      messagingSenderId: "174873514252",
      appId: "1:174873514252:web:c26659bffca850d475f929"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* ===== DOM ===== */
    const backBtn = document.getElementById("backBtn");
    const claimsBtn = document.getElementById("claimsBtn");
    const addBtn = document.getElementById("addBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const yearSel = document.getElementById("yearSel");
    const monthSel = document.getElementById("monthSel");
    const qInput = document.getElementById("qInput");
    const tbody = document.getElementById("tbody");
    const empty = document.getElementById("empty");
    const sumAmount = document.getElementById("sumAmount");
    const sumCount = document.getElementById("sumCount");

    const overlay = document.getElementById("overlay");
    const sheetTitle = document.getElementById("sheetTitle");
    const sheetBody = document.getElementById("sheetBody");
    const sheetFoot = document.getElementById("sheetFoot");
    const closeBtn = document.getElementById("closeBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const saveBtn = document.getElementById("saveBtn");

    /* ===== helpers ===== */
    const pad2 = n => String(n).padStart(2,"0");
    const ymd = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const formatJPY = n => {
      const v = Math.round(Number(n||0));
      const abs = Math.abs(v).toLocaleString("ja-JP");
      return (v<0) ? ("-Â¥" + abs) : ("Â¥" + abs);
    };
    const safeText = v => (v===null||v===undefined) ? "" : String(v);
    const esc = (s)=> String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");

    function openOverlay(){
      overlay.classList.add("show");
      overlay.onclick = (e)=>{ if(e.target===overlay) closeOverlay(); };
      window.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeOverlay(); }, { once:true });
    }
    function closeOverlay(){
      overlay.classList.remove("show");
      sheetBody.innerHTML = "";
      sheetFoot.style.display = "none";
      cancelBtn.onclick = null;
      saveBtn.onclick = null;
    }
    closeBtn.onclick = closeOverlay;

    function showFooter(onCancel, onSave){
      sheetFoot.style.display = "flex";
      cancelBtn.onclick = onCancel;
      saveBtn.onclick = onSave;
    }

    /* ===== categories from JSON (GitHub) ===== */
    let categories = []; // {id,label,active,order}
    async function loadCategories(){
      // 1) repoåŒéšå±¤: data/expense_categories.json ã«ç½®ãæƒ³å®š
      const urls = [
        "data/expense_categories.json",
        "expense_categories.json"
      ];
      for(const u of urls){
        try{
          const res = await fetch(u, { cache:"no-store" });
          if(!res.ok) continue;
          const js = await res.json();
          const list = Array.isArray(js?.categories) ? js.categories : [];
          categories = list.map(x=>({
            id: safeText(x.id).trim(),
            label: safeText(x.label).trim(),
            active: (x.active===false)?false:true,
            order: (safeText(x.id).trim()==="materials" || safeText(x.label).trim()==="ææ–™è²»") ? -100 : (Number.isFinite(Number(x.order)) ? Number(x.order) : 9999)
          })).filter(x=>x.id && x.label);
          categories.sort((a,b)=> (a.order-b.order) || a.label.localeCompare(b.label,"ja"));
          return;
        }catch(_e){}
      }
      // fallback
      categories = [
        { id:"materials", label:"ææ–™è²»", active:true, order:1 },
        { id:"misc", label:"é›‘è²»", active:true, order:2 },
        { id:"parking", label:"é§è»Šå ´ä»£", active:true, order:3 },
        { id:"booth", label:"å‡ºåº—æ–™", active:true, order:4 },
        { id:"salary", label:"çµ¦æ–™", active:true, order:5 }
      ];
    }

    function buildCatOptions(selectedId){
      const opts = categories.filter(c=>c.active).map(c=>
        `<option value="${esc(c.id)}">${esc(c.label)}</option>`
      ).join("");
      return opts || `<option value="misc">é›‘è²»</option>`;
    }

    /* ===== receipt statuses from JSON (GitHub) ===== */
    // é ˜åç”³è«‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆãƒ¬ã‚·ãƒ¼ãƒˆå˜ä½ï¼‰
    // ä¾‹: applying(ç”³è«‹ä¸­) / payer_confirm(ç²¾ç®—è€…ç¢ºèª) / received_confirm(å—å–ç¢ºèª)
    let receiptStatuses = []; // {id,label,active,order}
    async function loadReceiptStatuses(){
      const urls = [
        "data/receipt_statuses.json",
        "receipt_statuses.json"
      ];
      for(const u of urls){
        try{
          const res = await fetch(u, { cache:"no-store" });
          if(!res.ok) continue;
          const js = await res.json();
          const list = Array.isArray(js?.statuses) ? js.statuses : [];
          receiptStatuses = list.map(x=>({
            id: safeText(x.id).trim(),
            label: safeText(x.label).trim(),
            active: (x.active===false)?false:true,
            order: (safeText(x.id).trim()==="materials" || safeText(x.label).trim()==="ææ–™è²»") ? -100 : (Number.isFinite(Number(x.order)) ? Number(x.order) : 9999)
          })).filter(x=>x.id && x.label);
          receiptStatuses.sort((a,b)=> (a.order-b.order) || a.label.localeCompare(b.label,"ja"));
          return;
        }catch(_e){}
      }
      // fallback
      receiptStatuses = [
        { id:"applying", label:"ç”³è«‹ä¸­", active:true, order:1 },
        { id:"payer_confirm", label:"ç²¾ç®—è€…ç¢ºèª", active:true, order:2 },
        { id:"received_confirm", label:"å—å–ç¢ºèª", active:true, order:3 }
      ];
    }

    function statusLabel(id){
      return receiptStatuses.find(s=>s.id===id)?.label || "";
    }

    function buildStatusOptions(selectedId){
      const opts = receiptStatuses.filter(s=>s.active).map(s=>
        `<option value="${esc(s.id)}">${esc(s.label)}</option>`
      ).join("");
      // ç©ºï¼ˆæœªè¨­å®šï¼‰ã‚‚é¸ã¹ã‚‹ã‚ˆã†ã«ã™ã‚‹
      return `<option value="">(æœªè¨­å®š)</option>` + (opts || "");
    }

    /* ===== state ===== */
    const COL = "expense_receipts";
    let receipts = []; // normalized
    let currentUser = null;

    function normalizeDoc(d){
      const x = d.data();
      const lines = Array.isArray(x.lines) ? x.lines : [];
      const sum = Number(x.sum || 0);
      return {
        id: d.id,
        date: safeText(x.date).trim() || "",
        year: Number(x.year || 0),
        month: Number(x.month || 0),
        store: safeText(x.store).trim() || "(æœªè¨­å®š)",
        memo: safeText(x.memo),
        claimKawahara: !!x.claimKawahara,
        claimFujiwara: !!x.claimFujiwara,
        receiptStatus: safeText(x.receiptStatus).trim() || "",
        sum,
        lines: lines.map(li=>({
          name: safeText(li.name).trim(),
          categoryId: safeText(li.categoryId).trim(),
          categoryLabel: safeText(li.categoryLabel).trim(),
          qty: Number(li.qty || 0),
          unitPrice: Number(li.unitPrice || 0),
          total: Number(li.total || 0),
          memo: safeText(li.memo || "")
        }))
      };
    }

    function applyFilters(){
      const q = (qInput.value || "").trim().toLowerCase();
      let list = [...receipts];

      if(q){
        list = list.filter(r=>{
          const s = `${r.store} ${r.memo} ${(r.lines||[]).map(x=>x.name).join(" ")}`.toLowerCase();
          return s.includes(q);
        });
      }
      return list;
    }

    function render(){
      const list = applyFilters();
      tbody.innerHTML = "";
      empty.style.display = list.length ? "none" : "";

      let sum = 0;
      for(const r of list) sum += (Number(r.sum)||0);
      sumAmount.textContent = formatJPY(sum);
      sumCount.textContent = String(list.length);

      for(const r of list){
        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        tdDate.textContent = r.date || "-";

        const tdStore = document.createElement("td");
        tdStore.innerHTML = `<span class="mono">${esc(r.store)}</span>`;

        const tdSum = document.createElement("td");
        tdSum.innerHTML = `<span class="mono">${esc(formatJPY(r.sum))}</span>`;

        const tdMemo = document.createElement("td");
        const badges = [];
        if(r.claimKawahara) badges.push(`<span class="badge warn">é ˜å(å·åŸ)</span>`);
        if(r.claimFujiwara) badges.push(`<span class="badge warn">é ˜å(è—¤åŸ)</span>`);
        if(r.receiptStatus){
          badges.push(`<span class="badge good">${esc(statusLabel(r.receiptStatus) || r.receiptStatus)}</span>`);
        }
        tdMemo.innerHTML = `${badges.join(" ")} <span class="mutedText">${esc((r.memo||"").slice(0,40))}</span>`;

        const tdAct = document.createElement("td");
        tdAct.style.textAlign = "right";
        const b1 = document.createElement("button");
        b1.className = "tap";
        b1.type = "button";
        b1.textContent = "ç·¨é›†";
        b1.onclick = ()=> openReceiptEditor(r);
        tdAct.appendChild(b1);

        tr.appendChild(tdDate);
        tr.appendChild(tdStore);
        tr.appendChild(tdSum);
        tr.appendChild(tdMemo);
        tr.appendChild(tdAct);
        tbody.appendChild(tr);
      }
    }

    /* ===== Firestore load ===== */
    async function loadReceipts(){
      const y = Number(yearSel.value);
      const m = monthSel.value;

      let qy;
      if(m === "all"){
        qy = query(
          collection(db, COL),
          where("year","==", y),
          orderBy("date","desc"),
          limit(600)
        );
      }else{
        const mm = Number(m);
        qy = query(
          collection(db, COL),
          where("year","==", y),
          where("month","==", mm),
          orderBy("date","desc"),
          limit(600)
        );
      }

      const snap = await getDocs(qy);
      receipts = snap.docs.map(normalizeDoc);
    }

    /* ===== editor ===== */
    function openReceiptEditor(row){
      const isNew = !row;
      const now = new Date();
      const defaultDate = ymd(now);

      const initial = row || {
        id: null,
        date: defaultDate,
        store: "",
        memo: "",
        claimKawahara: false,
        claimFujiwara: false,
        lines: [
          { name:"", categoryId: categories[0]?.id || "misc", categoryLabel: categories[0]?.label || "é›‘è²»", qty:1, unitPrice:"", total:0, memo:"" }
        ],
        sum: 0
      };

      sheetTitle.textContent = isNew ? "ãƒ¬ã‚·ãƒ¼ãƒˆã‚’è¿½åŠ " : "ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ç·¨é›†";

      const catOpts = buildCatOptions();
      const statusOpts = buildStatusOptions();

      function lineRowHTML(li, idx){
        return `
          <tr data-idx="${idx}">
            <td><input class="lineInp" data-k="name" type="text" value="${esc(li.name||"")}" placeholder="ä¾‹ï¼šåŒ…è£…ç´™"></td>
            <td>
              <select class="lineInp" data-k="categoryId">
                ${catOpts}
              </select>
            </td>
            <td><input class="lineInp" data-k="qty" type="number" inputmode="numeric" value="${esc(String(li.qty??0))}" style="width:50px"></td>
            <td><input class="lineInp" data-k="unitPrice" type="number" inputmode="numeric" value="${esc((li.unitPrice===0||li.unitPrice===null||li.unitPrice===undefined||li.unitPrice==="") ? "" : String(li.unitPrice))}" style="width:110px"></td>
            <td class="mono" data-k="total">${esc(formatJPY(li.total||0))}</td>
            <td><input class="lineInp" data-k="memo" type="text" value="${esc(li.memo||"")}" placeholder="ãƒ¡ãƒ¢"></td>
            <td style="text-align:right;">
              <button class="mini" type="button" data-act="del">å‰Šé™¤</button>
            </td>
          </tr>
        `;
      }

      sheetBody.innerHTML = `
        <div class="grid2">
          <div class="k">æ—¥ä»˜</div>
          <div><input id="fDate" type="date" value="${esc(initial.date)}"></div>

          <div class="k">è³¼å…¥åº—</div>
          <div><input id="fStore" type="text" value="${esc(initial.store||"")}" placeholder="ä¾‹ï¼šãƒ€ã‚¤ã‚½ãƒ¼ / ã‚³ãƒ¼ãƒŠãƒ³"></div>

          <div class="k">ãƒ¡ãƒ¢</div>
          <div><textarea id="fMemo" placeholder="ãƒ¬ã‚·ãƒ¼ãƒˆå…¨ä½“ã®ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰">${esc(initial.memo||"")}</textarea></div>

          <div class="k">é ˜åç”³è«‹</div>
          <div class="checkRow">
            <label class="claimOption">
              <input id="fClaimF" type="checkbox" ${initial.claimFujiwara ? "checked":""}>
              <span class="claimCircle"></span>
              é ˜åç”³è«‹(è—¤åŸ)
            </label>
            <label class="claimOption">
              <input id="fClaimK" type="checkbox" ${initial.claimKawahara ? "checked":""}>
              <span class="claimCircle"></span>
              é ˜åç”³è«‹(å·åŸ)
            </label>
          </div>

          <div class="k">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
          <div>
            <select id="fStatus">
              ${statusOpts}
            </select>
            <div class="sub" style="margin-top:6px;">â€»é ˜åç”³è«‹ã«ãƒã‚§ãƒƒã‚¯ãŒã‚ã‚‹å ´åˆã®ã¿æœ‰åŠ¹ï¼ˆä¿å­˜æ™‚ã«æœªè¨­å®šãªã‚‰ã€Œç”³è«‹ä¸­ã€ã«ãªã‚Šã¾ã™ï¼‰</div>
          </div>
</div>
        </div>

        <div class="lines">
          <div class="lineHead">
            <div class="lineTitle">æ˜ç´°</div>
            <div style="display:flex; gap:8px; align-items:center;">
              <span class="badge good" id="sumBadge">åˆè¨ˆï¼šâ€”</span>
              <button class="mini" id="addLineBtn" type="button">ï¼‹ æ˜ç´°è¿½åŠ </button>
            </div>
          </div>

          <div class="lineTableWrap">
            <table class="lineTable" aria-label="line items">
              <colgroup>
                <col style="width: 20%;" />
                <col style="width: 18%;" />
                <col style="width: 10%;" />
                <col style="width: 14%;" />
                <col style="width: 12%;" />
                <col style="width: 20%;" />
                <col style="width: 6%;" />
              </colgroup>
              <thead>
                <tr>
                  <th>åå‰</th>
                  <th>ã‚«ãƒ†ã‚´ãƒª</th>
                  <th>æ•°é‡</th>
                  <th>å˜ä¾¡</th>
                  <th>åˆè¨ˆ</th>
                  <th>ãƒ¡ãƒ¢æ›¸ã</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="lineTbody">
                ${(initial.lines||[]).map(lineRowHTML).join("")}
              </tbody>
            </table>
          </div>

          ${!isNew ? `
            <div style="margin-top:12px; display:flex; justify-content:space-between; align-items:center; gap:10px; border-top:1px solid var(--line); padding-top:12px;">
              <button class="btn btnDanger" id="delReceiptBtn" type="button" style="flex:0 0 auto; padding:10px 14px;">ã“ã®ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤</button>
              <div class="mutedText">â€»å‰Šé™¤ã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼ˆå¿…è¦ãªã‚‰ç®¡ç†è€…é‹ç”¨ã«ï¼‰</div>
            </div>
          ` : ""}
        </div>
      `;

      // set category selects
      const lineTbody = sheetBody.querySelector("#lineTbody");
      [...lineTbody.querySelectorAll("tr")].forEach((tr, idx)=>{
        const li = initial.lines[idx];
        const sel = tr.querySelector('select[data-k="categoryId"]');
        if(sel){
          sel.value = li.categoryId || (categories[0]?.id || "misc");
          if(!sel.value) sel.value = categories[0]?.id || "misc";
        }
      });


      // set status select
      const statusSel = sheetBody.querySelector("#fStatus");
      if(statusSel){
        statusSel.value = initial.receiptStatus || "";
      }

      function recompute(){
        // read all lines from DOM
        const rows = [...lineTbody.querySelectorAll("tr")];
        const out = [];
        let sum = 0;

        for(const tr of rows){
          const name = tr.querySelector('[data-k="name"]').value || "";
          const categoryId = tr.querySelector('select[data-k="categoryId"]').value || "";
          const categoryLabel = categories.find(c=>c.id===categoryId)?.label || "";
          const qty = Number(tr.querySelector('[data-k="qty"]').value || 0);
          const unitInp = tr.querySelector('[data-k="unitPrice"]');
          const rawUnit = (unitInp?.value ?? "").toString().trim();
          let unitPrice = (rawUnit === "") ? 0 : Number(rawUnit);

          // ã‚«ãƒ†ã‚´ãƒªã«ã€Œå‰²å¼•ã€ãŒå…¥ã£ãŸæ™‚ã®ã¿ã€å˜ä¾¡ã‚’è‡ªå‹•ã§ãƒã‚¤ãƒŠã‚¹è¡¨è¨˜ã«ã™ã‚‹ï¼ˆå¤–ã‚ŒãŸã‚‰ãƒ—ãƒ©ã‚¹ã«æˆ»ã™ï¼‰
          const isDiscount = (categoryLabel && categoryLabel.includes("å‰²å¼•"));
          if(rawUnit !== "" && Number.isFinite(unitPrice)){
            const adjusted = isDiscount ? -Math.abs(unitPrice) : Math.abs(unitPrice);
            if(adjusted !== unitPrice){
              unitPrice = adjusted;
              if(unitInp) unitInp.value = String(adjusted);
            }
          }
          const memo = tr.querySelector('[data-k="memo"]').value || "";
          const total = Math.round((qty||0) * (unitPrice||0));
          tr.querySelector('[data-k="total"]').textContent = formatJPY(total);
          sum += total;

          out.push({ name, categoryId, categoryLabel, qty, unitPrice, total, memo });
        }

        sheetBody.querySelector("#sumBadge").textContent = "åˆè¨ˆï¼š" + formatJPY(sum);
        return { lines: out, sum };
      }

      // attach listeners
      function attachRowHandlers(tr){
        tr.addEventListener("input", ()=>{ recompute(); });

        const del = tr.querySelector('[data-act="del"]');
        del.onclick = ()=>{ tr.remove(); recompute(); };
      }
      [...lineTbody.querySelectorAll("tr")].forEach(attachRowHandlers);

      sheetBody.querySelector("#addLineBtn").onclick = ()=>{
        const idx = lineTbody.querySelectorAll("tr").length;
        const li = { name:"", categoryId: categories[0]?.id || "misc", categoryLabel: categories[0]?.label || "é›‘è²»", qty:1, unitPrice:"", total:0, memo:"" };
        const temp = document.createElement("tbody");
        temp.innerHTML = lineRowHTML(li, idx);
        const tr = temp.firstElementChild;
        lineTbody.appendChild(tr);
        // set select
        const sel = tr.querySelector('select[data-k="categoryId"]');
        if(sel) sel.value = li.categoryId;
        attachRowHandlers(tr);
        recompute();
      };

      // delete receipt
      const delReceiptBtn = sheetBody.querySelector("#delReceiptBtn");
      if(delReceiptBtn){
        delReceiptBtn.onclick = async ()=>{
          if(!confirm("ã“ã®ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
          try{
            await deleteDoc(doc(db, COL, initial.id));
            closeOverlay();
            await refreshAll();
          }catch(e){
            console.error(e);
            alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™/ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¢ºèªï¼‰");
          }
        };
      }

      // initial compute
      recompute();

      showFooter(
        ()=> closeOverlay(),
        async ()=>{
          try{
            const d = sheetBody.querySelector("#fDate").value || defaultDate;
            const dt = new Date(d);
            if(isNaN(dt.getTime())) throw new Error("invalid date");

            const store = (sheetBody.querySelector("#fStore").value || "").trim();
            const memo = sheetBody.querySelector("#fMemo").value || "";
            const claimFujiwara = !!sheetBody.querySelector("#fClaimF").checked;
            const claimKawahara = !!sheetBody.querySelector("#fClaimK").checked;
            const pickedStatus = (sheetBody.querySelector("#fStatus")?.value || "").trim();

            const { lines, sum } = recompute();

            // ç©ºè¡Œé™¤å»ï¼ˆåå‰ãŒç©ºã®è¡Œã¯æ¨ã¦ã‚‹ï¼‰
            const cleaned = lines
              .map(x=>({
                ...x,
                name: (x.name||"").trim(),
                categoryId: (x.categoryId||"").trim(),
                categoryLabel: (x.categoryLabel||"").trim(),
                memo: (x.memo||"")
              }))
              .filter(x=> x.name || x.total || x.memo);

            const year = dt.getFullYear();
            const month = dt.getMonth()+1;

            // é ˜åç”³è«‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼šé ˜åç”³è«‹ãŒONã®ã¨ãã®ã¿ä¿æŒ
            let receiptStatus = pickedStatus;
            const claimed = (claimFujiwara || claimKawahara);
            if(claimed){
              if(!receiptStatus) receiptStatus = "applying"; // æœªè¨­å®šãªã‚‰ç”³è«‹ä¸­
            }else{
              receiptStatus = ""; // é ˜åç”³è«‹ãªã—ãªã‚‰ã‚¯ãƒªã‚¢
            }

            const payload = {
              date: d,
              year,
              month,
              store: store || "(æœªè¨­å®š)",
              memo,
              lines: cleaned,
              sum: Math.round(sum||0),
              claimFujiwara,
              claimKawahara,
              receiptStatus,
              updatedAt: serverTimestamp(),
              updatedBy: currentUser?.uid || ""
            };

            if(isNew){
              await addDoc(collection(db, COL), {
                ...payload,
                createdAt: serverTimestamp(),
                createdBy: currentUser?.uid || ""
              });
            }else{
              await updateDoc(doc(db, COL, initial.id), payload);
            }

            closeOverlay();
            await refreshAll();
          }catch(e){
            console.error(e);
            alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆå…¥åŠ›/æ¨©é™/ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¢ºèªï¼‰");
          }
        }
      );

      openOverlay();
    }

    /* ===== init selects ===== */
    function initYearMonth(){
      const now = new Date();
      const curY = now.getFullYear();
      const years = [];
      for(let y=curY-2; y<=curY+1; y++) years.push(y);

      yearSel.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join("");
      yearSel.value = String(curY);

      const months = [
        {v:"all", t:"ã™ã¹ã¦ï¼ˆå¹´åˆè¨ˆï¼‰"},
        ...Array.from({length:12}, (_,i)=>({v:String(i+1), t:`${i+1}æœˆ`}))
      ];
      monthSel.innerHTML = months.map(m=>`<option value="${m.v}">${m.t}</option>`).join("");
      monthSel.value = String(now.getMonth()+1);
    }

    async function refreshAll(){
      await loadReceipts();
      render();
    }

    /* ===== events ===== */
    backBtn.onclick = ()=> location.href = "index.html";
    claimsBtn.onclick = ()=> location.href = "receipt_claims.html";
    addBtn.onclick = ()=> openReceiptEditor(null);
    refreshBtn.onclick = ()=> refreshAll();
    qInput.addEventListener("input", ()=> render());
    yearSel.addEventListener("change", ()=> refreshAll());
    monthSel.addEventListener("change", ()=> refreshAll());

    /* ===== auth gate ===== */
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        const redirect = encodeURIComponent("expenses.html");
        location.href = `login.html?redirect=${redirect}`;
        return;
      }
      currentUser = user;

      initYearMonth();
      await loadCategories();
      await loadReceiptStatuses();

      try{
        await refreshAll();
      }catch(e){
        console.error(e);
        alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™/ã‚¯ã‚¨ãƒª/ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¢ºèªï¼‰");
      }
    });
  </script>
</body>
</html>
