<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>e.nue 支出管理（レシート単位）</title>
<style>
:root{
  --bg0:#f3ede4; --bg1:#f7f2ea;
  --glass:rgba(255,255,255,.88); --glass2:rgba(255,255,255,.96);
  --line:rgba(120,90,40,.18);
  --shadow:0 18px 40px rgba(120,90,40,.18);
  --text:#2f2a22; --muted:rgba(47,42,34,.45);
  --r:18px;
}
*{box-sizing:border-box}
body{
  margin:0; color:var(--text);
  font-family:system-ui,-apple-system,"Segoe UI","Noto Sans JP",sans-serif;
  background:linear-gradient(135deg,var(--bg0),var(--bg1));
}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
.card{
  background:linear-gradient(180deg,var(--glass),var(--glass2));
  border-radius:var(--r); box-shadow:var(--shadow); padding:16px;
}
h1{margin:0 0 6px;font-size:18px}
.sub{color:var(--muted);font-size:13px;margin-bottom:12px}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
th{background:#faf8f5}
.empty{padding:20px;color:var(--muted)}
.btn{
  border:none;border-radius:999px;padding:10px 14px;background:#fff;
  box-shadow:var(--shadow);cursor:pointer;font-weight:700;
}
.top{display:flex;justify-content:space-between;align-items:center}

/* =========================
   レシート追加（モーダル）
========================= */
.actions{margin-top:12px;display:flex;gap:10px;justify-content:flex-end}
.modal-backdrop{
  position:fixed;inset:0;display:none;align-items:center;justify-content:center;
  background:rgba(10,10,10,.25);padding:16px;z-index:999;
}
.modal{
  width:min(980px,100%);
  background:linear-gradient(180deg,var(--glass),var(--glass2));
  border-radius:22px;box-shadow:0 24px 60px rgba(0,0,0,.18);
  border:1px solid var(--line);
  overflow:hidden;
}
.modal-h{
  display:flex;justify-content:space-between;align-items:center;
  padding:14px 16px;border-bottom:1px solid var(--line);
}
.modal-h b{font-size:16px}
.close-x{background:transparent;border:none;font-weight:800;cursor:pointer;color:var(--text)}
.modal-b{padding:14px 16px;max-height:min(78vh,780px);overflow:auto}
.grid{display:grid;grid-template-columns:140px 1fr;gap:10px 14px;align-items:start}
.lbl{color:var(--muted);font-weight:700;font-size:13px;padding-top:10px}
.in{
  width:100%;padding:10px 12px;border-radius:12px;
  border:1px solid var(--line);background:#fff;
  font:inherit;color:inherit;
}
textarea.in{min-height:74px;resize:vertical}

/* 領収申請：選択した方の丸の中に黒い● ＋ 背景薄グレー */
.claim-wrap{display:flex;gap:10px;flex-wrap:wrap}
.claim{
  display:flex;align-items:center;gap:10px;
  padding:10px 14px;border-radius:999px;
  border:1px solid var(--line);
  background:#fff;cursor:pointer;user-select:none;
  box-shadow:0 10px 24px rgba(120,90,40,.10);
}
.claim input{position:absolute;opacity:0;pointer-events:none}
.dot{
  width:18px;height:18px;border-radius:999px;
  border:2px solid rgba(47,42,34,.35);
  display:inline-flex;align-items:center;justify-content:center;
}
.dot::after{
  content:"";width:8px;height:8px;border-radius:999px;
  background:#111;transform:scale(0);
  transition:transform .12s ease;
}
.claim:has(input:checked){background:rgba(0,0,0,.06)}
.claim:has(input:checked) .dot::after{transform:scale(1)}
.claim:has(input:checked) .dot{border-color:#111}

/* :has が使えない環境向け（JSで .is-checked を付与） */
.claim.is-checked{background:rgba(0,0,0,.06)}
.claim.is-checked .dot::after{transform:scale(1)}
.claim.is-checked .dot{border-color:#111}

.modal-f{
  display:flex;gap:10px;justify-content:space-between;
  padding:14px 16px;border-top:1px solid var(--line);
}
.btn-ghost{background:transparent;border:1px solid var(--line);box-shadow:none}
.btn-primary{background:#fff}

@media (max-width:720px){
  .grid{grid-template-columns:1fr;}
  .lbl{padding-top:0}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1>支出管理（レシート単位）</h1>
    <div>
      <button class="btn" onclick="location.href='index.html'">← 戻る</button>
      <button class="btn" onclick="location.href='receipt_claims.html'">領収申請</button>
      <button class="btn" id="openAdd">＋ レシート追加</button>
    </div>
  </div>

  <div class="card">
    <div class="sub">購入店ごとにレシートを登録 → 明細にカテゴリを付与</div>
    <table>
      <thead>
        <tr><th>日付</th><th>購入店</th><th>合計</th><th>メモ</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div id="empty" class="empty" style="display:none">表示できる支出がありません</div>
  </div>
</div>

<!-- レシート追加（モーダル） -->
<div class="modal-backdrop" id="backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <div class="modal-h">
      <b id="mTitle">レシートを追加</b>
      <button class="close-x" id="closeAdd">閉じる</button>
    </div>
    <div class="modal-b">
      <div class="grid">
        <div class="lbl">日付</div>
        <input class="in" id="rDate" type="date" />

        <div class="lbl">購入店</div>
        <input class="in" id="rStore" placeholder="例：ダイソー / コーナン" />

        <div class="lbl">メモ</div>
        <textarea class="in" id="rMemo" placeholder="レシート全体のメモ（任意）"></textarea>

        <div class="lbl">領収申請</div>
        <div class="claim-wrap" role="radiogroup" aria-label="領収申請">
          <label class="claim">
            <input type="radio" name="claim" value="fujiwara" />
            <span class="dot" aria-hidden="true"></span>
            <span>領収申請(藤原)</span>
          </label>
          <label class="claim">
            <input type="radio" name="claim" value="kawahara" />
            <span class="dot" aria-hidden="true"></span>
            <span>領収申請(川原)</span>
          </label>
        </div>
      </div>

      <div class="actions">
        <span class="sub" style="margin:0">※ 選択すると丸の中に黒い●が付きます</span>
      </div>
    </div>
    <div class="modal-f">
      <button class="btn btn-ghost" id="cancelAdd">キャンセル</button>
      <button class="btn btn-primary" id="saveAdd">保存</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getFirestore,collection,getDocs,query,orderBy,addDoc,serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAhPCgPoJK6S6BWVcBZOruYqMPXVQXQFRk",
  authDomain: "handmade-pos.firebaseapp.com",
  projectId: "handmade-pos",
  storageBucket: "handmade-pos.firebasestorage.app",
  messagingSenderId: "174873514252",
  appId: "1:174873514252:web:c26659bffca850d475f929"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ===== モーダル開閉 =====
const backdrop = document.getElementById('backdrop');
const openAdd = document.getElementById('openAdd');
const closeAdd = document.getElementById('closeAdd');
const cancelAdd = document.getElementById('cancelAdd');
const saveAdd = document.getElementById('saveAdd');

function openModal(){
  backdrop.style.display = 'flex';
  backdrop.setAttribute('aria-hidden','false');
}
function closeModal(){
  backdrop.style.display = 'none';
  backdrop.setAttribute('aria-hidden','true');
}
openAdd.addEventListener('click', ()=>{
  // 初期値：今日
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  document.getElementById('rDate').value = `${yyyy}-${mm}-${dd}`;
  document.getElementById('rStore').value = '';
  document.getElementById('rMemo').value = '';
  document.querySelectorAll('input[name="claim"]').forEach(i=>i.checked=false);
  syncClaimUI();
  openModal();
});
closeAdd.addEventListener('click', closeModal);
cancelAdd.addEventListener('click', closeModal);
backdrop.addEventListener('click', (e)=>{
  if(e.target === backdrop) closeModal();
});
window.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && backdrop.style.display === 'flex') closeModal();
});

function syncClaimUI(){
  document.querySelectorAll('.claim').forEach(lb=>lb.classList.remove('is-checked'));
  document.querySelectorAll('input[name="claim"]').forEach(i=>{
    if(i.checked) i.closest('.claim')?.classList.add('is-checked');
  });
}

document.querySelectorAll('input[name="claim"]').forEach(i=>{
  i.addEventListener('change', syncClaimUI);
});

async function load(){
  const qy = query(collection(db,"expense_receipts"), orderBy("date","desc"));
  const snap = await getDocs(qy);
  const tbody = document.getElementById("tbody");
  const empty = document.getElementById("empty");
  tbody.innerHTML = "";
  if(snap.empty){ empty.style.display=""; return; }
  empty.style.display="none";
  snap.forEach(d=>{
    const r = d.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.date||"-"}</td><td>${r.store||""}</td><td>¥${(r.sum||0).toLocaleString()}</td><td>${r.memo||""}</td>`;
    tbody.appendChild(tr);
  });
}

async function saveReceipt(){
  const dateEl = document.getElementById('rDate');
  const storeEl = document.getElementById('rStore');
  const memoEl = document.getElementById('rMemo');
  const claim = document.querySelector('input[name="claim"]:checked')?.value || "";

  // date は "YYYY-MM-DD" → 画面表示の形式に合わせて "YYYY/MM/DD" にして保存
  const d = (dateEl.value||"").replaceAll('-','/');
  await addDoc(collection(db,"expense_receipts"),{
    date: d,
    store: (storeEl.value||"").trim(),
    memo: (memoEl.value||"").trim(),
    claimTo: claim, // "fujiwara" | "kawahara" | ""
    sum: 0,
    createdAt: serverTimestamp()
  });
}

saveAdd.addEventListener('click', async ()=>{
  saveAdd.disabled = true;
  try{
    await saveReceipt();
    closeModal();
    await load();
  }catch(err){
    console.error(err);
    alert('保存に失敗しました。もう一度お試しください。');
  }finally{
    saveAdd.disabled = false;
  }
});

onAuthStateChanged(auth, async (u)=>{
  if(!u){ location.href="login.html"; return; }
  await load();
});
</script>
</body>
</html>
