<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>e.nue æ”¯å‡ºç®¡ç†</title>
  <style>
    :root{
      --bg0:#e3ddd4;
      --bg1:#e3ddd4;
      --bg2:#d4ccc1;

      --glass: rgba(255,255,255,.86);
      --glass2: rgba(255,255,255,.78);
      --line: rgba(0,0,0,.06);
      --line2: rgba(0,0,0,.10);
      --shadow: 0 18px 45px rgba(0,0,0,.14);

      --text:#222222;
      --sub:#555555;
      --muted: rgba(34,34,34,.58);

      --accent:#e18a6a;
      --good:#2e9f7a;
      --warn:#d89a2a;

      --r:18px;
      --maxw:980px;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }

    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI","Noto Sans JP",sans-serif;
      color:var(--text-main);
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      }

    .safe{
      padding:max(14px,env(safe-area-inset-top)) 14px max(18px,env(safe-area-inset-bottom));
      max-width:var(--maxw);
      margin:0 auto;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin:6px 0 14px;
      gap:10px;
    }
    .brand{ font-weight:900; letter-spacing:.02em; }

    .topActions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pillBtn{
      appearance:none;
      border:1px solid rgba(0,0,0,.10);
      background:rgba(255,255,255,.70);
      border-radius:999px;
      padding:10px 12px;
      font-weight:900;
      font-size:12px;
      box-shadow: 0 10px 18px rgba(0,0,0,.10);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .pillBtn:active{ transform: translateY(1px); }
    .pillBtnPrimary{
      background: rgba(17,17,17,.92);
      color:#fff;
      border-color: rgba(17,17,17,.92);
    }

    .grid{ display:flex; flex-direction:column; gap:14px; }

    .card{
      background:linear-gradient(180deg,var(--glass-bg),var(--glass-bg2));
      border:1px solid var(--glass-border);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
    }

    .cardHead{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    .title .h{ font-weight:1000; font-size:14px; letter-spacing:.06em; }
    .title .s{ font-size:12px; color:rgba(34,34,34,.6); margin-top:2px; }

    .filters{
      padding:12px 14px 14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .field{
      display:flex;
      gap:8px;
      align-items:center;
      background:rgba(255,255,255,.68);
      border:1px solid rgba(0,0,0,.10);
      border-radius:14px;
      padding:10px 10px;
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
    }
    .field label{
      font-weight:1000;
      font-size:12px;
      color:rgba(34,34,34,.70);
      white-space:nowrap;
    }
    .field input, .field select{
      appearance:none;
      border:1px solid rgba(0,0,0,.12);
      background:rgba(255,255,255,.92);
      border-radius:12px;
      padding:10px 10px;
      font-weight:900;
      font-size:12px;
      outline:none;
    }
    .field input{ min-width: 140px; }
    .field select{ min-width: 160px; }

    .sumRow{
      padding:0 14px 14px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-end;
      flex-wrap:wrap;
    }
    .sumBox{
      background:rgba(255,255,255,.72);
      border:1px solid rgba(0,0,0,.10);
      border-radius:16px;
      padding:10px 12px;
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
      min-width: 210px;
    }
    .sumBox .k{ font-size:11px; font-weight:1000; color:rgba(34,34,34,.55); }
    .sumBox .v{ font-size:18px; font-weight:1100; margin-top:2px; }

    /* table */
    .tableWrap{
      display:block;
      width:100%;
      box-sizing:border-box;
      padding:0 22px 16px;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling:touch;
    }
    table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      min-width:780px; /* iPhone: æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    }
    th, td{
      padding:10px;
      font-size:13px;
      vertical-align:middle;
      white-space:nowrap;
    }
    th{
      text-align:left;
      background:#f3f3f3;
      position:sticky;
      top:0;
      z-index:1;
    }
    tr+tr td{ border-top:1px solid rgba(0,0,0,.06); }

    .tap{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.14);
      background:rgba(255,255,255,.88);
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .tap:active{ transform: translateY(1px); }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-weight:900; }
    .muted{ color: rgba(34,34,34,.55); font-weight:900; }

    .empty{
      padding:18px 14px;
      color:rgba(0,0,0,.55);
      font-weight:900;
    }

    /* Bottom sheet */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      align-items:flex-end;
      z-index:999;
      padding:10px;
    }
    .overlay.show{ display:flex; }

    .sheet{
      width:min(720px,100%);
      margin:0 auto;
      background:#fff;
      border-radius:22px;
      box-shadow:0 30px 80px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .sheetHead{
      padding:12px 14px;
      border-bottom:1px solid rgba(0,0,0,.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:1000;
    }
    .sheetBody{ padding:12px 14px; }
    .sheetFoot{
      padding:12px 14px;
      border-top:1px solid rgba(0,0,0,.08);
      display:flex; gap:10px;
    }
    .btn{
      flex:1;
      border:none;
      border-radius:14px;
      padding:12px 12px;
      font-weight:1000;
      cursor:pointer;
    }
    .btnGhost{ background:rgba(0,0,0,.06); }
    .btnPrimary{ background:#111; color:#fff; }
    .btnDanger{ background:rgba(208,100,99,.18); color:#9a2f2c; }
    .btn:active{ transform: translateY(1px); }

    .form{
      display:grid;
      grid-template-columns: 110px 1fr;
      gap:10px 12px;
      font-size:13px;
      align-items:center;
    }
    .form .k{ color:rgba(0,0,0,.55); font-weight:1000; }
    .form input, .form select, .form textarea{
      appearance:none;
      border:1px solid rgba(0,0,0,.14);
      border-radius:12px;
      padding:10px 10px;
      background: rgba(255,255,255,.95);
      font-weight:900;
      font-size:13px;
      outline:none;
      width:100%;
    }
    .form textarea{ min-height: 84px; resize: vertical; font-weight:800; }

    .helpRow{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .hint{
      font-size:11px;
      color:rgba(0,0,0,.55);
      font-weight:900;
    }

    .optList{ display:grid; gap:10px; }
    .opt{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.12);
      cursor:pointer;
      user-select:none;
    }
    .opt:active{ transform: translateY(1px); }
    .opt .left{ display:flex; align-items:center; gap:10px; font-weight:1000; }
    .opt .right{ color:rgba(0,0,0,.55); font-weight:900; font-size:12px; }

    .toggle{
      width:18px; height:18px;
      border-radius:6px;
      border:2px solid rgba(0,0,0,.25);
      display:inline-flex; align-items:center; justify-content:center;
      font-size:12px; font-weight:1000;
    }
    .toggle.on{ background:#111; border-color:#111; color:#fff; }

    .rowLine{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center;
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid rgba(0,0,0,.08);
    }

    @media (max-width: 420px){
      .form{ grid-template-columns: 1fr; }
      .form .k{ font-size:12px; }
      .field input{ min-width: 120px; }
      .field select{ min-width: 140px; }
      .sumBox{ min-width: 180px; }
    }
  </style>
</head>
<body>
  <div class="safe">
    <div class="topbar">
      <div class="brand">e.nue</div>
      <div class="topActions">
        <button class="pillBtn" id="backBtn" type="button">â† æˆ»ã‚‹</button>
        <button class="pillBtn" id="catBtn" type="button">âš™ ã‚«ãƒ†ã‚´ãƒªãƒ¼</button>
        <button class="pillBtn" id="payBtn" type="button">ğŸ’´ æ”¯æ‰•æ–¹æ³•</button>
        <button class="pillBtn" id="csvBtn" type="button">â¬‡ CSV</button>
        <button class="pillBtn pillBtnPrimary" id="addBtn" type="button">ï¼‹ æ”¯å‡ºè¿½åŠ </button>
      </div>
    </div>

    <main class="grid">
      <section class="card">
        <div class="cardHead">
          <div class="title">
            <div class="h">æ”¯å‡ºç®¡ç†</div>
            <div class="s">å½“æœˆè¡¨ç¤º / è¿½åŠ ãƒ»ç·¨é›† / ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¯è‡ªç”±ã«ç·¨é›†ï¼ˆå°†æ¥ãƒãƒ³ãƒ‰ãƒ«å¯¾å¿œï¼‰</div>
          </div>
        </div>

        <div class="filters">
          <div class="field">
            <label for="monthInput">æœˆ</label>
            <input id="monthInput" type="month" />
          </div>
          <div class="field">
            <label for="catFilter">ã‚«ãƒ†ã‚´ãƒª</label>
            <select id="catFilter"></select>
          </div>
          <div class="field">
            <label for="qInput">æ¤œç´¢</label>
            <input id="qInput" type="text" placeholder="ãƒ¡ãƒ¢/æ”¯æ‰•æ–¹æ³•" />
          </div>
          <button class="pillBtn" id="refreshBtn" type="button">æ›´æ–°</button>
        </div>

        <div class="sumRow">
          <div class="sumBox">
            <div class="k">è¡¨ç¤ºä¸­ åˆè¨ˆ</div>
            <div class="v" id="sumAmount">â€”</div>
          </div>
          <div class="sumBox">
            <div class="k">è¡¨ç¤ºä»¶æ•°</div>
            <div class="v" id="sumCount">â€”</div>
          </div>
        </div>

        <div class="tableWrap">
          <table aria-label="expenses table">
            <colgroup>
              <col style="width: 12%;" />
              <col style="width: 14%;" />
              <col style="width: 18%;" />
              <col style="width: 28%;" />
              <col style="width: 16%;" />
              <col style="width: 12%;" />
            </colgroup>
            <thead>
              <tr>
                <th>æ—¥ä»˜</th>
                <th>é‡‘é¡</th>
                <th>ã‚«ãƒ†ã‚´ãƒªãƒ¼</th>
                <th>å†…å®¹</th>
                <th>æ”¯æ‰•æ–¹æ³•</th>
                <th style="text-align:right;">ç·¨é›†</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
          <div class="empty" id="empty" style="display:none;">è¡¨ç¤ºã§ãã‚‹æ”¯å‡ºãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
      </section>
    </main>
  </div>

  <!-- Sheet -->
  <div class="overlay" id="overlay" aria-modal="true" role="dialog">
    <div class="sheet" onclick="event.stopPropagation()">
      <div class="sheetHead">
        <div id="sheetTitle">ç·¨é›†</div>
        <button class="btn btnGhost" id="closeBtn" style="flex:0 0 auto;">é–‰ã˜ã‚‹</button>
      </div>
      <div class="sheetBody" id="sheetBody"></div>
      <div class="sheetFoot" id="sheetFoot" style="display:none;">
        <button class="btn btnGhost" id="cancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btnPrimary" id="saveBtn">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      getDocs,
      addDoc,
      setDoc,
      writeBatch,
      updateDoc,
      deleteDoc,
      query,
      where,
      orderBy,
      limit,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    /* ===== Firebase (æœ¬ç•ª) ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyAhPCgPoJK6S6BWVcBZOruYqMPXVQXQFRk",
      authDomain: "handmade-pos.firebaseapp.com",
      projectId: "handmade-pos",
      storageBucket: "handmade-pos.firebasestorage.app",
      messagingSenderId: "174873514252",
      appId: "1:174873514252:web:c26659bffca850d475f929"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* ===== DOM ===== */
    const backBtn = document.getElementById("backBtn");
    const addBtn = document.getElementById("addBtn");
    const catBtn = document.getElementById("catBtn");
    const payBtn = document.getElementById("payBtn");
    const csvBtn = document.getElementById("csvBtn");
    const refreshBtn = document.getElementById("refreshBtn");

    const monthInput = document.getElementById("monthInput");
    const catFilter = document.getElementById("catFilter");
    const qInput = document.getElementById("qInput");

    const tbody = document.getElementById("tbody");
    const empty = document.getElementById("empty");
    const sumAmount = document.getElementById("sumAmount");
    const sumCount = document.getElementById("sumCount");

    const overlay = document.getElementById("overlay");
    const sheetTitle = document.getElementById("sheetTitle");
    const sheetBody = document.getElementById("sheetBody");
    const sheetFoot = document.getElementById("sheetFoot");
    const closeBtn = document.getElementById("closeBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const saveBtn = document.getElementById("saveBtn");

    /* ===== helpers ===== */
    const pad2 = n => String(n).padStart(2,"0");
    const ymd = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const ym = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;

    function toDate(v){
      try{
        if(!v) return null;
        if(typeof v.toDate === "function") return v.toDate();
        if(v instanceof Date) return v;
        if(typeof v === "number") return new Date(v);
        if(typeof v === "string"){ const d=new Date(v); return isNaN(d.getTime())?null:d; }
        return null;
      }catch{ return null; }
    }

    const formatJPY = (n)=> "Â¥" + Math.round(n||0).toLocaleString("ja-JP");
    const safeText = (v)=> (v===null||v===undefined) ? "-" : (String(v).trim()||"-");

    function monthRange(ymStr){
      // ymStr: "YYYY-MM"
      const [Y,M] = ymStr.split("-").map(Number);
      const start = new Date(Y, M-1, 1);
      const end = new Date(Y, M, 1);
      return { start, end };
    }

    function openOverlay(){
      overlay.classList.add("show");
      overlay.onclick = (e)=>{ if(e.target===overlay) closeOverlay(); };
      window.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeOverlay(); }, { once:true });
    }
    function closeOverlay(){
      overlay.classList.remove("show");
      sheetBody.innerHTML = "";
      sheetFoot.style.display = "none";
      cancelBtn.onclick = null;
      saveBtn.onclick = null;
    }
    closeBtn.onclick = closeOverlay;

    function showFooter(onCancel, onSave){
      sheetFoot.style.display = "flex";
      cancelBtn.onclick = onCancel;
      saveBtn.onclick = onSave;
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    /* ===== state ===== */
    let categories = []; // {id, name, order, active}
    let paymentMethods = []; // {id, name, order, active}
    let expenses = [];   // {id, date, amount, categoryId, categoryName, memo, paymentMethod, createdAt}
    let currentUser = null;

    /* ===== Category ===== */
    async function loadCategories(){
      const qy = query(collection(db, "expense_categories"), orderBy("order","asc"), orderBy("name","asc"), limit(500));
      const snap = await getDocs(qy);
      categories = snap.docs.map(d=>({ id:d.id, ...d.data() }))
        .map(c=>({
          id:c.id,
          name: (c.name ?? "").toString().trim() || "(æœªè¨­å®š)",
          order: Number.isFinite(Number(c.order)) ? Number(c.order) : 9999,
          active: (c.active === false) ? false : true
        }));
    }

    function buildCatFilter(){
      catFilter.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "";
      optAll.textContent = "ã™ã¹ã¦";
      catFilter.appendChild(optAll);

      categories.filter(c=>c.active).forEach(c=>{
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.name;
        catFilter.appendChild(opt);
      });
    }

    async function ensureDefaultCategories(){
      // åˆå›ç”¨ï¼šã‚«ãƒ†ã‚´ãƒªãŒ0ä»¶ãªã‚‰æœ€ä½é™ã ã‘ä½œã‚‹ï¼ˆé‚ªé­”ãªã‚‰æ¶ˆã—ã¦OKï¼‰
      if(categories.length) return;
      const seeds = ["ææ–™è²»","å¤–æ³¨è²»","é€æ–™","äº¤é€šè²»","æ¶ˆè€—å“","åºƒå‘Š","ãã®ä»–"];
      for(let i=0;i<seeds.length;i++){
        await addDoc(collection(db, "expense_categories"), {
          name: seeds[i],
          order: i+1,
          active: true,
          createdAt: serverTimestamp()
        });
      }
      await loadCategories();
    }

    
    /* ===== Payment Method ===== */
    async function loadPaymentMethods(){
      const qy = query(collection(db, "expense_payment_methods"), orderBy("order","asc"), orderBy("name","asc"), limit(200));
      const snap = await getDocs(qy);
      paymentMethods = snap.docs.map(d=>({ id:d.id, ...d.data() }))
        .map(p=>({
          id:p.id,
          name: (p.name ?? "").toString().trim() || "(æœªè¨­å®š)",
          order: Number.isFinite(Number(p.order)) ? Number(p.order) : 9999,
          active: (p.active === false) ? false : true
        }));
    }

    async function ensureDefaultPaymentMethods(){
      // åˆå›ç”¨ï¼š0ä»¶ãªã‚‰ã€Œç¾é‡‘ã€ã€ŒPayPayã€ã ã‘ä½œã‚‹ï¼ˆé‚ªé­”ãªã‚‰æ¶ˆã—ã¦OKï¼‰
      if(paymentMethods.length) return;
      const seeds = ["ç¾é‡‘","PayPay"];
      for(let i=0;i<seeds.length;i++){
        await addDoc(collection(db, "expense_payment_methods"), {
          name: seeds[i],
          order: i+1,
          active: true,
          createdAt: serverTimestamp()
        });
      }
      await loadPaymentMethods();
    }

/* ===== Expenses ===== */
    async function loadExpensesForMonth(ymStr){
      const { start, end } = monthRange(ymStr);

      // Firestoreã® "date" ã¯ "YYYY-MM-DD" æ–‡å­—åˆ—ã§ä¿å­˜ï¼ˆãƒãƒ³ãƒ‰ãƒ«åŒ–ã—ã‚„ã™ã„ï¼‰
      const startKey = ymd(start);
      const endKey = ymd(new Date(end.getFullYear(), end.getMonth(), end.getDate()-1)); // æœˆæœ«
      const qy = query(
        collection(db, "expenses"),
        where("date", ">=", startKey),
        where("date", "<=", endKey),
        orderBy("date","desc"),
        limit(500)
      );

      const snap = await getDocs(qy);
      expenses = snap.docs.map(d=>({ id:d.id, ...d.data() })).map(x=>({
        id:x.id,
        date: safeText(x.date),
        amount: Number(x.amount || 0),
        categoryId: x.categoryId || "",
        categoryName: (x.categoryName ?? "").toString().trim() || "(æœªè¨­å®š)",
        memo: (x.memo ?? "").toString(),
        paymentMethodId: x.paymentMethodId || "",
        paymentMethodName: (x.paymentMethodName ?? "").toString().trim() || (x.paymentMethod ?? "").toString().trim(),
        paymentMethod: (x.paymentMethod ?? "").toString(), // legacy
        createdAt: x.createdAt
      }));
    }

    function applyFilters(){
      const catId = catFilter.value || "";
      const q = (qInput.value || "").trim().toLowerCase();

      let list = [...expenses];

      if(catId){
        list = list.filter(x=>x.categoryId === catId);
      }
      if(q){
        list = list.filter(x=>{
          const a = (x.memo || "").toLowerCase();
          const b = (x.paymentMethodName || x.paymentMethod || "").toLowerCase();
          const c = (x.categoryName || "").toLowerCase();
          return a.includes(q) || b.includes(q) || c.includes(q);
        });
      }
      return list;
    }

    function render(){
      const list = applyFilters();
      tbody.innerHTML = "";

      if(list.length === 0){
        empty.style.display = "";
      }else{
        empty.style.display = "none";
      }

      let sum = 0;
      list.forEach(x=> sum += (Number(x.amount) || 0));
      sumAmount.textContent = formatJPY(sum);
      sumCount.textContent = String(list.length);

      for(const x of list){
        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        tdDate.textContent = safeText(x.date);

        const tdAmt = document.createElement("td");
        tdAmt.innerHTML = `<span class="mono">${escapeHtml(formatJPY(x.amount))}</span>`;

        const tdCat = document.createElement("td");
        tdCat.textContent = safeText(x.categoryName);

        const tdMemo = document.createElement("td");
        tdMemo.textContent = safeText(x.memo);

        const tdPay = document.createElement("td");
        tdPay.textContent = safeText(x.paymentMethodName || x.paymentMethod);

        const tdEdit = document.createElement("td");
        tdEdit.style.textAlign = "right";
        const btn = document.createElement("div");
        btn.className = "tap";
        btn.textContent = "ç·¨é›†";
        btn.onclick = ()=> openExpenseEditor(x);
        tdEdit.appendChild(btn);

        tr.appendChild(tdDate);
        tr.appendChild(tdAmt);
        tr.appendChild(tdCat);
        tr.appendChild(tdMemo);
        tr.appendChild(tdPay);
        tr.appendChild(tdEdit);
        tbody.appendChild(tr);
      }
    }

    /* ===== Sheets ===== */
    function openExpenseEditor(row){
      const isNew = !row;
      const now = new Date();
      const defaultDate = ymd(now);

      const activeCats = categories.filter(c=>c.active);
      const catOptions = activeCats.map(c=>`<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)}</option>`).join("");

      const activePays = paymentMethods.filter(p=>p.active);
      const payOptions = activePays.map(p=>`<option value="${escapeHtml(p.id)}">${escapeHtml(p.name)}</option>`).join("");

      const initial = row || {
        id: null,
        date: defaultDate,
        amount: 0,
        categoryId: activeCats[0]?.id || "",
        categoryName: activeCats[0]?.name || "(æœªè¨­å®š)",
        memo: "",
        paymentMethodId: activePays[0]?.id || "",
        paymentMethodName: activePays[0]?.name || "",
        paymentMethod: "" // legacy
      };

      sheetTitle.textContent = isNew ? "æ”¯å‡ºã‚’è¿½åŠ " : "æ”¯å‡ºã‚’ç·¨é›†";
      sheetBody.innerHTML = `
        <div class="form">
          <div class="k">æ—¥ä»˜</div>
          <div><input id="fDate" type="date" value="${escapeHtml(initial.date)}"></div>

          <div class="k">é‡‘é¡</div>
          <div><input id="fAmount" type="number" inputmode="numeric" value="${escapeHtml(String(initial.amount||0))}" placeholder="ä¾‹ï¼š1200"></div>

          <div class="k">ã‚«ãƒ†ã‚´ãƒªãƒ¼</div>
          <div>
            <select id="fCategory">
              ${catOptions || `<option value="">(æœªè¨­å®š)</option>`}
            </select>
            <div class="helpRow" style="margin-top:8px;">
              <div class="hint">â€»ã‚«ãƒ†ã‚´ãƒªã¯å³ä¸Šã€Œâš™ ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€ã§è¿½åŠ ãƒ»ä¿®æ­£ã§ãã¾ã™</div>
              <button class="pillBtn" id="miniCatBtn" type="button" style="padding:9px 10px;">âš™ ç®¡ç†</button>
            </div>
          </div>

          <div class="k">æ”¯æ‰•æ–¹æ³•</div>
          <div>
            <select id="fPay">
              ${payOptions || `<option value="">(æœªè¨­å®š)</option>`}
            </select>
            <div class="helpRow" style="margin-top:8px;">
              <div class="hint">â€»æ”¯æ‰•æ–¹æ³•ã¯å³ä¸Šã€ŒğŸ’´ æ”¯æ‰•æ–¹æ³•ã€ã§è¿½åŠ ãƒ»ä¿®æ­£ã§ãã¾ã™</div>
              <button class="pillBtn" id="miniPayBtn" type="button" style="padding:9px 10px;">ğŸ’´ ç®¡ç†</button>
            </div>
          </div>

          <div class="k">å†…å®¹</div>
          <div><textarea id="fMemo" placeholder="ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰">${escapeHtml(initial.memo)}</textarea></div>
        </div>

        ${!isNew ? `
          <div class="rowLine">
            <button class="btn btnDanger" id="delBtn" type="button" style="flex:0 0 auto; padding:12px 14px;">å‰Šé™¤</button>
            <div class="hint">â€»å‰Šé™¤ã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“</div>
          </div>
        ` : ""}
      `;

      // set selected
      const sel = sheetBody.querySelector("#fCategory");
      if(sel){
        sel.value = initial.categoryId || "";
        if(!sel.value && activeCats[0]?.id) sel.value = activeCats[0].id;
      }

      const paySel = sheetBody.querySelector("#fPay");
      if(paySel){
        // æ—¢å­˜ãŒIDãªã‚‰ãã‚Œå„ªå…ˆã€‚ç„¡ã‘ã‚Œã°åå‰ãƒãƒƒãƒã‚’è©¦ã™
        const id = initial.paymentMethodId || "";
        const name = (initial.paymentMethodName || initial.paymentMethod || "").trim();
        if(id){
          paySel.value = id;
        }else if(name){
          const hit = activePays.find(p=>p.name===name);
          paySel.value = hit ? hit.id : (activePays[0]?.id || "");
        }else{
          paySel.value = activePays[0]?.id || "";
        }
      }

      const miniCatBtn = sheetBody.querySelector("#miniCatBtn");
      if(miniCatBtn){
        miniCatBtn.onclick = (e)=>{ e.stopPropagation(); closeOverlay(); openCategoryManager(); };
      }

      const miniPayBtn = sheetBody.querySelector("#miniPayBtn");
      if(miniPayBtn){
        miniPayBtn.onclick = (e)=>{ e.stopPropagation(); closeOverlay(); openPaymentManager(); };
      }

      const delBtn = sheetBody.querySelector("#delBtn");
      if(delBtn){
        delBtn.onclick = async ()=>{
          if(!confirm("ã“ã®æ”¯å‡ºã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
          try{
            await deleteDoc(doc(db, "expenses", initial.id));
            closeOverlay();
            await refreshAll();
          }catch(e){
            console.error(e);
            alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™/ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¢ºèªï¼‰");
          }
        };
      }

      showFooter(
        ()=> closeOverlay(),
        async ()=>{
          try{
            const date = sheetBody.querySelector("#fDate").value || defaultDate;
            const amount = Number(sheetBody.querySelector("#fAmount").value || 0);
            const categoryId = sheetBody.querySelector("#fCategory").value || "";
            const categoryName = (categories.find(c=>c.id===categoryId)?.name) || "(æœªè¨­å®š)";
            const paymentMethodId = sheetBody.querySelector("#fPay").value || "";
            const paymentMethodName = (paymentMethods.find(p=>p.id===paymentMethodId)?.name) || "";
            const paymentMethod = paymentMethodName || ""; // legacy
            const memo = sheetBody.querySelector("#fMemo").value || "";

            const payload = {
              date,
              amount,
              categoryId,
              categoryName, // å†—é•·ä¿æŒï¼ˆå°†æ¥ãƒãƒ³ãƒ‰ãƒ«ç”¨ï¼‰
              paymentMethodId,
              paymentMethodName,
              paymentMethod,
              memo,
              updatedAt: serverTimestamp()
            };

            if(isNew){
              await addDoc(collection(db, "expenses"), {
                ...payload,
                createdAt: serverTimestamp()
              });
            }else{
              await updateDoc(doc(db, "expenses", initial.id), payload);
            }

            closeOverlay();
            await refreshAll();
          }catch(e){
            console.error(e);
            alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™/å…¥åŠ›/ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¢ºèªï¼‰");
          }
        }
      );

      openOverlay();
    }

    function openCategoryManager(){
      sheetTitle.textContent = "ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç†";
      sheetBody.innerHTML = `
        <div class="hint">è¿½åŠ  / åç§°å¤‰æ›´ / è¡¨ç¤ºONOFF / ä¸¦ã³é †ï¼ˆå°ã•ã„ã»ã©ä¸Šï¼‰</div>
        <div class="rowLine" style="border-top:none; padding-top:0; margin-top:10px;">
          <input id="newCatName" type="text" placeholder="æ–°è¦ã‚«ãƒ†ã‚´ãƒªãƒ¼å" style="flex:1; border:1px solid rgba(0,0,0,.14); border-radius:12px; padding:12px 10px; font-weight:900;">
          <button class="pillBtn pillBtnPrimary" id="addCatDo" type="button" style="padding:12px 12px;">è¿½åŠ </button>
        </div>
        <div class="optList" id="catList" style="margin-top:12px;"></div>
      `;

      const catList = sheetBody.querySelector("#catList");

      function renderCats(){
        catList.innerHTML = "";
        const list = [...categories].sort((a,b)=> (a.order-b.order) || a.name.localeCompare(b.name,"ja"));
        for(const c of list){
          const row = document.createElement("div");
          row.className = "opt";
          row.innerHTML = `
            <div class="left">
              <span class="toggle ${c.active ? "on" : ""}">${c.active ? "âœ“" : ""}</span>
              <span>${escapeHtml(c.name)}</span>
            </div>
            <div class="right">
              <span class="muted">order</span>
              <span class="mono">${escapeHtml(String(c.order))}</span>
            </div>
          `;
          row.onclick = ()=> openCategoryEditor(c);
          catList.appendChild(row);
        }
      }

      async function addCategory(){
        const nameEl = sheetBody.querySelector("#newCatName");
        const name = (nameEl.value || "").trim();
        if(!name){ alert("ã‚«ãƒ†ã‚´ãƒªãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

        const maxOrder = categories.reduce((m,c)=> Math.max(m, Number(c.order)||0), 0);
        try{
          await addDoc(collection(db, "expense_categories"), {
            name,
            order: maxOrder + 1,
            active: true,
            createdAt: serverTimestamp()
          });
          nameEl.value = "";
          await loadCategories();
          buildCatFilter();
          renderCats();
        }catch(e){
          console.error(e);
          alert("è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™/ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¢ºèªï¼‰");
        }
      }

      sheetBody.querySelector("#addCatDo").onclick = addCategory;

      // footer: close only
      sheetFoot.style.display = "none";
      openOverlay();
      renderCats();
    }

    function openCategoryEditor(cat){
      sheetTitle.textContent = "ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ç·¨é›†";
      sheetBody.innerHTML = `
        <div class="form">
          <div class="k">åç§°</div>
          <div><input id="cName" type="text" value="${escapeHtml(cat.name)}"></div>

          <div class="k">order</div>
          <div><input id="cOrder" type="number" inputmode="numeric" value="${escapeHtml(String(cat.order))}"></div>

          <div class="k">è¡¨ç¤º</div>
          <div>
            <select id="cActive">
              <option value="true">è¡¨ç¤º</option>
              <option value="false">éè¡¨ç¤º</option>
            </select>
            <div class="hint" style="margin-top:6px;">â€»éè¡¨ç¤ºã«ã—ã¦ã‚‚éå»æ”¯å‡ºã® categoryName ã¯æ®‹ã‚Šã¾ã™</div>
          </div>
        </div>
      `;

      const sel = sheetBody.querySelector("#cActive");
      sel.value = cat.active ? "true" : "false";

      showFooter(
        ()=>{ closeOverlay(); openCategoryManager(); },
        async ()=>{
          try{
            const name = (sheetBody.querySelector("#cName").value || "").trim() || "(æœªè¨­å®š)";
            const order = Number(sheetBody.querySelector("#cOrder").value || 9999);
            const active = (sheetBody.querySelector("#cActive").value === "true");

            await updateDoc(doc(db, "expense_categories", cat.id), {
              name, order, active, updatedAt: serverTimestamp()
            });

            closeOverlay();
            await loadCategories();
            buildCatFilter();
            // æ³¨æ„ï¼šæ—¢å­˜æ”¯å‡ºã® categoryName ã¯æ›´æ–°ã—ãªã„ï¼ˆå†—é•·ä¿æŒæ€æƒ³ï¼‰
            await refreshAll();
          }catch(e){
            console.error(e);
            alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™/ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¢ºèªï¼‰");
          }
        }
      );

      openOverlay();
    }


    /* ===== Payment Method Sheets ===== */
    function openPaymentManager(){
      sheetTitle.textContent = "æ”¯æ‰•æ–¹æ³• ç®¡ç†";
      sheetBody.innerHTML = `
        <div class="hint">è¿½åŠ  / åç§°å¤‰æ›´ / è¡¨ç¤ºONOFF / ä¸¦ã³é †ï¼ˆå°ã•ã„ã»ã©ä¸Šï¼‰</div>
        <div class="rowLine" style="border-top:none; padding-top:0; margin-top:10px;">
          <input id="newPayName" type="text" placeholder="æ–°è¦ æ”¯æ‰•æ–¹æ³•å" style="flex:1; border:1px solid rgba(0,0,0,.14); border-radius:12px; padding:12px 10px; font-weight:900;">
          <button class="pillBtn pillBtnPrimary" id="addPayDo" type="button" style="padding:12px 12px;">è¿½åŠ </button>
        </div>
        <div class="optList" id="payList" style="margin-top:12px;"></div>
      `;

      const payList = sheetBody.querySelector("#payList");

      function renderPays(){
        payList.innerHTML = "";
        const list = [...paymentMethods].sort((a,b)=> (a.order-b.order) || a.name.localeCompare(b.name,"ja"));
        for(const p of list){
          const row = document.createElement("div");
          row.className = "opt";
          row.innerHTML = `
            <div class="left">
              <span class="toggle ${p.active ? "on" : ""}">${p.active ? "âœ“" : ""}</span>
              <span>${escapeHtml(p.name)}</span>
            </div>
            <div class="right">
              <span class="muted">order</span>
              <span class="mono">${escapeHtml(String(p.order))}</span>
            </div>
          `;
          row.onclick = ()=> openPaymentEditor(p);
          payList.appendChild(row);
        }
      }

      async function addPay(){
        const nameEl = sheetBody.querySelector("#newPayName");
        const name = (nameEl.value || "").trim();
        if(!name){ alert("æ”¯æ‰•æ–¹æ³•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

        const maxOrder = paymentMethods.reduce((m,p)=> Math.max(m, Number(p.order)||0), 0);
        try{
          await addDoc(collection(db, "expense_payment_methods"), {
            name,
            order: maxOrder + 1,
            active: true,
            createdAt: serverTimestamp()
          });
          nameEl.value = "";
          await loadPaymentMethods();
          renderPays();
        }catch(e){
          console.error(e);
          alert("è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™/ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¢ºèªï¼‰");
        }
      }

      sheetBody.querySelector("#addPayDo").onclick = addPay;

      sheetFoot.style.display = "none";
      openOverlay();
      renderPays();
    }

    function openPaymentEditor(pay){
      sheetTitle.textContent = "æ”¯æ‰•æ–¹æ³•ã‚’ç·¨é›†";
      sheetBody.innerHTML = `
        <div class="form">
          <div class="k">åç§°</div>
          <div><input id="pName" type="text" value="${escapeHtml(pay.name)}"></div>

          <div class="k">order</div>
          <div><input id="pOrder" type="number" inputmode="numeric" value="${escapeHtml(String(pay.order))}"></div>

          <div class="k">è¡¨ç¤º</div>
          <div>
            <select id="pActive">
              <option value="true">è¡¨ç¤º</option>
              <option value="false">éè¡¨ç¤º</option>
            </select>
            <div class="hint" style="margin-top:6px;">â€»éè¡¨ç¤ºã«ã—ã¦ã‚‚éå»æ”¯å‡ºã® paymentMethodName ã¯æ®‹ã‚Šã¾ã™</div>
          </div>
        </div>
      `;

      const sel = sheetBody.querySelector("#pActive");
      sel.value = pay.active ? "true" : "false";

      showFooter(
        ()=>{ closeOverlay(); openPaymentManager(); },
        async ()=>{
          try{
            const name = (sheetBody.querySelector("#pName").value || "").trim() || "(æœªè¨­å®š)";
            const order = Number(sheetBody.querySelector("#pOrder").value || 9999);
            const active = (sheetBody.querySelector("#pActive").value === "true");

            await updateDoc(doc(db, "expense_payment_methods", pay.id), {
              name, order, active, updatedAt: serverTimestamp()
            });

            closeOverlay();
            await loadPaymentMethods();
            await refreshAll();
          }catch(e){
            console.error(e);
            alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™/ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¢ºèªï¼‰");
          }
        }
      );

      openOverlay();
    }


    /* ===== CSV ===== */
    function csvEscape(v){
      const s = (v===null||v===undefined) ? "" : String(v);
      // keep line breaks inside quotes
      if(/[",\n\r]/.test(s)){
        return '"' + s.replaceAll('"','""') + '"';
      }
      return s;
    }

    function buildCSV(headers, rows){
      const lines = [];
      lines.push(headers.map(csvEscape).join(","));
      for(const r of rows){
        lines.push(headers.map(h=>csvEscape(r[h])).join(","));
      }
      // Excelå¯¾ç­–BOM
      return "\ufeff" + lines.join("\r\n");
    }

    function downloadText(filename, text, mime="text/csv"){
      const blob = new Blob([text], { type: `${mime};charset=utf-8` });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 1500);
    }

    function parseCSV(text){
      // RFC4180ç°¡æ˜“ï¼šã‚«ãƒ³ãƒ/æ”¹è¡Œ/ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œ
      const s = (text || "").replace(/^\ufeff/,"");
      const rows = [];
      let row = [];
      let cur = "";
      let i = 0;
      let inQ = false;

      const pushCell = ()=>{ row.push(cur); cur=""; };
      const pushRow  = ()=>{ rows.push(row); row=[]; };

      while(i < s.length){
        const ch = s[i];

        if(inQ){
          if(ch === '"'){
            if(s[i+1] === '"'){ cur += '"'; i += 2; continue; }
            inQ = false; i++; continue;
          }else{
            cur += ch; i++; continue;
          }
        }else{
          if(ch === '"'){ inQ = true; i++; continue; }
          if(ch === ","){ pushCell(); i++; continue; }
          if(ch === "\r"){
            if(s[i+1] === "\n"){ pushCell(); pushRow(); i += 2; continue; }
            pushCell(); pushRow(); i++; continue;
          }
          if(ch === "\n"){ pushCell(); pushRow(); i++; continue; }
          cur += ch; i++; continue;
        }
      }
      pushCell();
      pushRow();

      // æœ«å°¾ã®ç©ºè¡Œã‚’é™¤å»
      while(rows.length && rows[rows.length-1].every(c=> String(c||"").trim()==="")){
        rows.pop();
      }
      return rows;
    }

    function normalizeHeader(h){
      const x = (h||"").trim();
      // æ—¥æœ¬èªãƒ˜ãƒƒãƒ€äº’æ›
      const map = {
        "æ—¥ä»˜":"date",
        "é‡‘é¡":"amount",
        "ã‚«ãƒ†ã‚´ãƒªãƒ¼":"categoryName",
        "å†…å®¹":"memo",
        "æ”¯æ‰•æ–¹æ³•":"paymentMethodName",
        "id":"id",
        "date":"date",
        "amount":"amount",
        "categoryId":"categoryId",
        "categoryName":"categoryName",
        "memo":"memo",
        "paymentMethodId":"paymentMethodId",
        "paymentMethodName":"paymentMethodName",
        "createdAt":"createdAt"
      };
      return map[x] || x;
    }

    function rowsToObjects(parsed){
      if(!parsed || parsed.length < 2) return [];
      const headersRaw = parsed[0];
      const headers = headersRaw.map(normalizeHeader);
      const out = [];
      for(let r=1;r<parsed.length;r++){
        const obj = {};
        for(let c=0;c<headers.length;c++){
          obj[headers[c]] = parsed[r][c] ?? "";
        }
        out.push(obj);
      }
      return out;
    }

    function exportCSV(mode){
      // mode: "month" | "filtered"
      const ymStr = monthInput.value || ym(new Date());
      const list = (mode==="filtered") ? applyFilters() : [...expenses];

      const headers = [
        "id","date","amount","categoryId","categoryName","memo",
        "paymentMethodId","paymentMethodName","createdAt"
      ];

      const rows = list
        .slice()
        .sort((a,b)=> (a.date||"").localeCompare(b.date||"ja") || String(a.id||"").localeCompare(String(b.id||"")))
        .map(x=>({
          id: x.id || "",
          date: safeText(x.date),
          amount: Number(x.amount||0),
          categoryId: x.categoryId || "",
          categoryName: safeText(x.categoryName),
          memo: (x.memo ?? ""),
          paymentMethodId: x.paymentMethodId || "",
          paymentMethodName: safeText(x.paymentMethodName || x.paymentMethod),
          createdAt: (()=> {
            const d = toDate(x.createdAt);
            return d ? d.toISOString() : "";
          })()
        }));

      const csv = buildCSV(headers, rows);
      const suffix = (mode==="filtered") ? "filtered" : "month";
      downloadText(`expenses_${ymStr}_${suffix}.csv`, csv);
    }

    async function importCSVFile(file){
      const text = await file.text();
      const parsed = parseCSV(text);
      const objs = rowsToObjects(parsed);

      if(!objs.length){
        alert("CSVã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
        return;
      }

      // æœ€æ–°ã‚«ãƒ†ã‚´ãƒª/æ”¯æ‰•æ–¹æ³•ã‚’èª­ã¿ç›´ã™ï¼ˆåå‰ãƒãƒƒãƒç”¨ï¼‰
      await loadCategories();
      await ensureDefaultCategories();
      await loadPaymentMethods();
      await ensureDefaultPaymentMethods();

      // åå‰â†’IDè£œå®Œï¼ˆç„¡ã„å ´åˆã¯è‡ªå‹•è¿½åŠ ï¼‰
      async function ensureCategoryByName(name){
        const nm = (name||"").trim();
        if(!nm) return { id:"", name:"(æœªè¨­å®š)" };
        let hit = categories.find(c=>c.name===nm);
        if(hit) return { id: hit.id, name: hit.name };

        // è‡ªå‹•è¿½åŠ ï¼ˆé †ç•ªã¯æœ«å°¾ï¼‰
        const maxOrder = categories.reduce((m,c)=> Math.max(m, Number(c.order)||0), 0);
        const ref = await addDoc(collection(db, "expense_categories"), {
          name: nm, order: maxOrder+1, active: true, createdAt: serverTimestamp()
        });
        await loadCategories();
        hit = categories.find(c=>c.id===ref.id);
        return { id: hit?.id || "", name: hit?.name || nm };
      }

      async function ensurePayByName(name){
        const nm = (name||"").trim();
        if(!nm) return { id:"", name:"" };
        let hit = paymentMethods.find(p=>p.name===nm);
        if(hit) return { id: hit.id, name: hit.name };

        const maxOrder = paymentMethods.reduce((m,p)=> Math.max(m, Number(p.order)||0), 0);
        const ref = await addDoc(collection(db, "expense_payment_methods"), {
          name: nm, order: maxOrder+1, active: true, createdAt: serverTimestamp()
        });
        await loadPaymentMethods();
        hit = paymentMethods.find(p=>p.id===ref.id);
        return { id: hit?.id || "", name: hit?.name || nm };
      }

      // æ›¸ãè¾¼ã¿ï¼ˆ400ä»¶ãšã¤ãƒãƒƒãƒï¼‰
      const total = objs.length;
      let done = 0;

      for(let offset=0; offset<total; offset+=400){
        const batch = writeBatch(db);
        const chunk = objs.slice(offset, offset+400);

        for(const r of chunk){
          const date = (r.date || "").trim();
          if(!date) continue;

          const amount = Number(String(r.amount||"0").replace(/,/g,"")) || 0;
          const memo = (r.memo || "").toString();

          // category
          let categoryId = (r.categoryId || "").trim();
          let categoryName = (r.categoryName || "").trim();
          if(!categoryId && categoryName){
            const c = await ensureCategoryByName(categoryName);
            categoryId = c.id;
            categoryName = c.name;
          }else if(categoryId && !categoryName){
            categoryName = (categories.find(c=>c.id===categoryId)?.name) || "(æœªè¨­å®š)";
          }else if(!categoryId && !categoryName){
            categoryName = "(æœªè¨­å®š)";
          }

          // payment
          let paymentMethodId = (r.paymentMethodId || "").trim();
          let paymentMethodName = (r.paymentMethodName || "").trim();
          if(!paymentMethodId && paymentMethodName){
            const p = await ensurePayByName(paymentMethodName);
            paymentMethodId = p.id;
            paymentMethodName = p.name;
          }else if(paymentMethodId && !paymentMethodName){
            paymentMethodName = (paymentMethods.find(p=>p.id===paymentMethodId)?.name) || "";
          }

          const payload = {
            date,
            amount,
            categoryId,
            categoryName,
            paymentMethodId,
            paymentMethodName,
            paymentMethod: paymentMethodName || "",
            memo,
            updatedAt: serverTimestamp()
          };

          const id = (r.id || "").trim();
          if(id){
            // idæŒ‡å®šï¼šä¸Šæ›¸ãï¼ˆmergeï¼‰
            const ref = doc(db, "expenses", id);
            batch.set(ref, payload, { merge:true });
          }else{
            // idç„¡ã—ï¼šæ–°è¦
            const ref = doc(collection(db, "expenses"));
            batch.set(ref, { ...payload, createdAt: serverTimestamp() });
          }
        }

        await batch.commit();
        done += chunk.length;
      }

      alert(`CSVå–è¾¼ å®Œäº†ï¼š${done}ä»¶ï¼ˆç©ºè¡Œã¯é™¤å¤–ï¼‰`);
      await refreshAll();
    }

    function openCSVManager(){
      sheetTitle.textContent = "CSV";
      const ymStr = monthInput.value || ym(new Date());

      sheetBody.innerHTML = `
        <div class="hint">
          éå»åˆ†ã‚’ã€Œæœˆã”ã¨ã«CSVã§é€€é¿ â†’ å¿…è¦æ™‚ã«å¾©å…ƒã€ã—ã‚„ã™ã„ã‚ˆã†ã«ã€CSVå‡ºåŠ›/å–è¾¼ã‚’ç”¨æ„ã—ã¾ã—ãŸã€‚
        </div>

        <div class="rowLine" style="border-top:none; padding-top:0; margin-top:12px;">
          <button class="pillBtn pillBtnPrimary" id="csvExportMonth" type="button" style="padding:12px 12px;">ã“ã®æœˆã‚’CSVå‡ºåŠ›</button>
          <button class="pillBtn" id="csvExportFiltered" type="button" style="padding:12px 12px;">è¡¨ç¤ºä¸­(ãƒ•ã‚£ãƒ«ã‚¿)ã‚’CSVå‡ºåŠ›</button>
        </div>

        <div class="rowLine" style="justify-content:flex-start;">
          <div class="hint">å¯¾è±¡æœˆï¼š<span class="mono">${escapeHtml(ymStr)}</span></div>
        </div>

        <div class="rowLine" style="justify-content:flex-start;">
          <input id="csvFile" type="file" accept=".csv,text/csv" style="flex:1;">
          <button class="pillBtn" id="csvImportDo" type="button" style="padding:12px 12px;">CSVå–è¾¼</button>
        </div>

        <div class="hint" style="margin-top:10px;">
          â€»å–è¾¼ã¯ <span class="mono">date/amount/categoryId/categoryName/memo/paymentMethodId/paymentMethodName</span> ã‚’èª­ã¿ã¾ã™ã€‚<br/>
          â€»ã€Œæ—¥ä»˜/é‡‘é¡/ã‚«ãƒ†ã‚´ãƒªãƒ¼/å†…å®¹/æ”¯æ‰•æ–¹æ³•ã€ã®æ—¥æœ¬èªãƒ˜ãƒƒãƒ€ã§ã‚‚OKï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ¼/æ”¯æ‰•æ–¹æ³•ã¯åå‰ã§ç´ã¥ã‘ï¼‰ã€‚
        </div>
      `;

      sheetFoot.style.display = "none";
      openOverlay();

      sheetBody.querySelector("#csvExportMonth").onclick = ()=> exportCSV("month");
      sheetBody.querySelector("#csvExportFiltered").onclick = ()=> exportCSV("filtered");

      sheetBody.querySelector("#csvImportDo").onclick = async ()=>{
        const f = sheetBody.querySelector("#csvFile").files?.[0];
        if(!f){ alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
        if(!confirm("CSVã‚’å–ã‚Šè¾¼ã¿ã¾ã™ã€‚é‡è¤‡ãŒã‚ã‚‹å ´åˆã¯ id æŒ‡å®šã®è¡Œã®ã¿ä¸Šæ›¸ãï¼ˆmergeï¼‰ã•ã‚Œã¾ã™ã€‚ç¶šã‘ã¾ã™ã‹ï¼Ÿ")) return;
        try{
          await importCSVFile(f);
          closeOverlay();
        }catch(e){
          console.error(e);
          alert("CSVå–è¾¼ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆå½¢å¼/æ¨©é™/ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¢ºèªï¼‰");
        }
      };
    }


    /* ===== refresh ===== */
    async function refreshAll(){
      const ymStr = monthInput.value || ym(new Date());
      await loadCategories();
      await ensureDefaultCategories();
      buildCatFilter();

      await loadPaymentMethods();
      await ensureDefaultPaymentMethods();

      await loadExpensesForMonth(ymStr);
      render();
    }

    /* ===== Events ===== */
    backBtn.onclick = ()=> location.href = "index.html";
    addBtn.onclick = ()=> openExpenseEditor(null);
    catBtn.onclick = ()=> openCategoryManager();
    payBtn.onclick = ()=> openPaymentManager();
    csvBtn.onclick = ()=> openCSVManager();
    refreshBtn.onclick = ()=> refreshAll();

    qInput.addEventListener("input", ()=> render());
    catFilter.addEventListener("change", ()=> render());
    monthInput.addEventListener("change", ()=> refreshAll());

    /* ===== Auth gate ===== */
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        const redirect = encodeURIComponent("expenses.html");
        location.href = `login.html?redirect=${redirect}`;
        return;
      }
      currentUser = user;

      // default month = current
      monthInput.value = ym(new Date());

      try{
        await refreshAll();
      }catch(e){
        console.error(e);
        alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™/ã‚¯ã‚¨ãƒª/ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¢ºèªï¼‰");
      }
    });
  </script>
</body>
</html>
